"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

require("source-map-support/register");

var _appiumIosDriver = require("appium-ios-driver");

var _appiumRemoteDebugger = require("appium-remote-debugger");

var _appiumBaseDriver = require("appium-base-driver");

var _appiumSupport = require("appium-support");

var _logger = _interopRequireDefault(require("../logger"));

var _asyncbox = require("asyncbox");

var _lodash = _interopRequireDefault(require("lodash"));

const WEBVIEW_BASE = `${_appiumIosDriver.WEBVIEW_WIN}_`;
let commands = {},
    helpers = {},
    extensions = {};
Object.assign(extensions, _appiumIosDriver.iosCommands.context);

extensions.closeAlertBeforeTest = async function closeAlertBeforeTest() {
  return true;
};

extensions.navToInitialWebview = async function navToInitialWebview() {
  if (this.useNewSafari()) {
    await this.typeAndNavToUrl();
  } else if (!this.isRealDevice() && this.opts.safari) {
    await this.navToViewThroughFavorites();
  } else {
    await this.navToViewWithTitle(/.*/);
  }
};

extensions.getLatestWebviewContextForTitle = async function getLatestWebviewContextForTitle(regExp) {
  const currentUrl = this.getCurrentUrl();

  const contexts = _lodash.default.filter(await this.getContextsAndViews(), 'view');

  if (currentUrl) {
    for (const ctx of contexts) {
      if ((ctx.view.url || '') === this.getCurrentUrl()) {
        return ctx.id;
      }
    }
  }

  for (const ctx of contexts) {
    if (ctx.view.title && regExp.test(ctx.view.title) || ctx.view.url && regExp.test(ctx.view.url)) {
      return ctx.id;
    }
  }
};

extensions.isWebContext = function isWebContext() {
  return !!this.curContext && this.curContext !== _appiumIosDriver.iosCommands.context.NATIVE_WIN;
};

extensions.isWebview = function isWebview() {
  return this.isWebContext();
};

extensions.getNewRemoteDebugger = async function getNewRemoteDebugger() {
  let socketPath;

  if (!this.isRealDevice()) {
    socketPath = await this.opts.device.getWebInspectorSocket();
  }

  return (0, _appiumRemoteDebugger.createRemoteDebugger)({
    bundleId: this.opts.bundleId,
    additionalBundleIds: this.opts.additionalWebviewBundleIds,
    isSafari: this.isSafari(),
    includeSafari: this.opts.includeSafariInWebviews,
    useNewSafari: this.useNewSafari(),
    pageLoadMs: this.pageLoadMs,
    platformVersion: this.opts.platformVersion,
    socketPath,
    remoteDebugProxy: this.opts.remoteDebugProxy,
    garbageCollectOnExecute: _appiumSupport.util.hasValue(this.opts.safariGarbageCollect) ? !!this.opts.safariGarbageCollect : false,
    udid: this.opts.udid,
    logAllCommunication: this.opts.safariLogAllCommunication,
    logAllCommunicationHexDump: this.opts.safariLogAllCommunicationHexDump,
    socketChunkSize: this.opts.safariSocketChunkSize,
    webInspectorMaxFrameLength: this.opts.safariWebInspectorMaxFrameLength
  }, this.isRealDevice());
};

commands.setContext = async function setContext(name, callback, skipReadyCheck) {
  function alreadyInContext(desired, current) {
    return desired === current || desired === null && current === _appiumIosDriver.NATIVE_WIN || desired === _appiumIosDriver.NATIVE_WIN && current === null;
  }

  function isNativeContext(context) {
    return context === _appiumIosDriver.NATIVE_WIN || context === null;
  }

  if (name && name.id) {
    name = name.id;
  }

  _logger.default.debug(`Attempting to set context to '${name || _appiumIosDriver.NATIVE_WIN}' from '${this.curContext ? this.curContext : _appiumIosDriver.NATIVE_WIN}'`);

  if (alreadyInContext(name, this.curContext) || alreadyInContext(_lodash.default.replace(name, WEBVIEW_BASE, ''), this.curContext)) {
    _logger.default.debug(`Already in '${name || _appiumIosDriver.NATIVE_WIN}' context. Doing nothing.`);

    return;
  }

  if (isNativeContext(name)) {
    this.curContext = null;
    return;
  }

  if (_lodash.default.isUndefined(this.contexts)) {
    await this.getContexts();
  }

  let contextId = _lodash.default.replace(name, WEBVIEW_BASE, '');

  if (contextId === '') {
    contextId = this.contexts[1];
  }

  if (!_lodash.default.includes(this.contexts, contextId)) {
    throw new _appiumBaseDriver.errors.NoSuchContextError();
  }

  const oldContext = this.curContext;
  this.curContext = this.curWindowHandle = contextId;

  const [appIdKey, pageIdKey] = _lodash.default.map(contextId.split('.'), id => parseInt(id, 10));

  try {
    this.selectingNewPage = true;
    await this.remote.selectPage(appIdKey, pageIdKey, skipReadyCheck);
  } catch (err) {
    this.curContext = this.curWindowHandle = oldContext;
    throw err;
  } finally {
    this.selectingNewPage = false;
  }

  if (this.opts.enablePerformanceLogging && this.remote) {
    _logger.default.debug(`Starting performance log on '${this.curContext}'`);

    this.logs.performance = new _appiumIosDriver.IOSPerformanceLog(this.remote);
    await this.logs.performance.startCapture();
  }

  if (name && name !== _appiumIosDriver.NATIVE_WIN && this.logs) {
    if (this.logs.safariConsole) {
      await this.remote.startConsole(this.logs.safariConsole.addLogLine.bind(this.logs.safariConsole));
    }

    if (this.logs.safariNetwork) {
      await this.remote.startNetwork(this.logs.safariNetwork.addLogLine.bind(this.logs.safariNetwork));
    }
  }
};

extensions.connectToRemoteDebugger = async function connectToRemoteDebugger() {
  this.remote = await this.getNewRemoteDebugger();
  this.remote.on(_appiumRemoteDebugger.RemoteDebugger.EVENT_PAGE_CHANGE, this.onPageChange.bind(this));
  this.remote.on(_appiumRemoteDebugger.RemoteDebugger.EVENT_FRAMES_DETACHED, () => {
    if (!_lodash.default.isEmpty(this.curWebFrames)) {
      _logger.default.debug(`Clearing ${_appiumSupport.util.pluralize('frame', this.curWebFrames.length, true)}: ${this.curWebFrames.join(', ')}`);
    }

    this.curWebFrames = [];
  });
  await this.remote.connect(this.opts.webviewConnectTimeout);
};

extensions.listWebFrames = async function listWebFrames(useUrl = true) {
  if (!this.opts.bundleId) {
    _logger.default.errorAndThrow('Cannot enter web frame without a bundle ID');
  }

  useUrl = useUrl && !this.isRealDevice() && !!this.getCurrentUrl();

  _logger.default.debug(`Selecting by url: ${useUrl} ${useUrl ? `(expected url: '${this.getCurrentUrl()}')` : ''}`);

  const currentUrl = useUrl ? this.getCurrentUrl() : undefined;
  let pageArray = [];

  const getWebviewPages = async () => {
    try {
      return await this.remote.selectApp(currentUrl, this.opts.webviewConnectRetries, this.opts.ignoreAboutBlankUrl);
    } catch (err) {
      _logger.default.debug(`No available web pages: ${err.message}`);

      return [];
    }
  };

  if (this.remote && this.remote.appIdKey) {
    pageArray = await getWebviewPages();
  } else {
    if (!this.remote) {
      await this.connectToRemoteDebugger();
    }

    await this.remote.setConnectionKey();
    pageArray = await getWebviewPages();
    const alertErrorMsg = 'Close alert failed. Retry.';

    try {
      await (0, _asyncbox.retryInterval)(6, 1000, async () => {
        if (!(await this.closeAlertBeforeTest())) {
          throw new Error(alertErrorMsg);
        }
      });
    } catch (err) {
      if (err.message !== alertErrorMsg) {
        _logger.default.errorAndThrow(err);
      }
    }
  }

  if (pageArray.length === 0) {
    _logger.default.debug('No web frames found.');
  }

  return pageArray;
};

commands.getContexts = async function getContexts() {
  _logger.default.debug('Getting list of available contexts');

  const contexts = await this.getContextsAndViews(false);
  const mapFn = this.opts.fullContextList ? function (context) {
    return {
      id: context.id.toString(),
      title: context.view.title,
      url: context.view.url,
      bundleId: context.view.bundleId
    };
  } : context => context.id.toString();
  return contexts.map(mapFn);
};

extensions.mobileGetContexts = async function mobileGetContexts(opts = {}) {
  let {
    waitForWebviewMs = 0
  } = opts;

  if (!_lodash.default.isNumber(waitForWebviewMs)) {
    waitForWebviewMs = parseInt(waitForWebviewMs, 10);

    if (isNaN(waitForWebviewMs)) {
      waitForWebviewMs = 0;
    }
  }

  const curOpt = this.opts.fullContextList;
  this.opts.fullContextList = true;
  const timer = new _appiumSupport.timing.Timer().start();

  try {
    let contexts;

    do {
      contexts = await this.getContexts();

      if (contexts.length >= 2) {
        _logger.default.debug(`Found webview context after ${timer.getDuration().asMilliSeconds.toFixed(0)}ms`);

        return contexts;
      }

      _logger.default.debug(`No webviews found in ${timer.getDuration().asMilliSeconds.toFixed(0)}ms`);
    } while (timer.getDuration().asMilliSeconds < waitForWebviewMs);

    return contexts;
  } finally {
    this.opts.fullContextList = curOpt;
  }
};

commands.setWindow = async function setWindow(name, skipReadyCheck) {
  try {
    await this.setContext(name, _lodash.default.noop, skipReadyCheck);
  } catch (err) {
    throw (0, _appiumBaseDriver.isErrorType)(err, _appiumBaseDriver.errors.NoSuchContextError) ? new _appiumBaseDriver.errors.NoSuchWindowError() : err;
  }
};

commands.getWindowHandle = async function getWindowHandle() {
  if (!this.isWebContext()) {
    throw new _appiumBaseDriver.errors.NotImplementedError();
  }

  _logger.default.debug(`Getting current window handle`);

  return this.curContext;
};

commands.getWindowHandles = async function getWindowHandles() {
  if (!this.isWebContext()) {
    throw new _appiumBaseDriver.errors.NotImplementedError();
  }

  _logger.default.debug('Getting list of available window handles');

  const contexts = await this.getContextsAndViews(false);
  return contexts.filter(context => context.id !== _appiumIosDriver.NATIVE_WIN).map(context => context.view.id.toString());
};

extensions.onPageChange = async function onPageChange(pageChangeNotification) {
  _logger.default.debug(`Remote debugger notified us of a new page listing: ${JSON.stringify(pageChangeNotification)}`);

  if (this.selectingNewPage) {
    _logger.default.debug('We are in the middle of selecting a page, ignoring');

    return;
  }

  if (!this.remote || !this.remote.isConnected) {
    _logger.default.debug('We have not yet connected, ignoring');

    return;
  }

  const {
    appIdKey,
    pageArray
  } = pageChangeNotification;
  let newIds = [];
  let newPages = [];
  let keyId = null;

  function isUrlIgnored(url, safariIgnoreWebHostnames) {
    const ignoredHosts = (safariIgnoreWebHostnames || '').split(',').map(b => b.trim()).filter(b => !_lodash.default.isEmpty(b));

    for (const ignoredHost of ignoredHosts) {
      if (ignoredHost === 'about:blank' && url === 'about:blank') {
        return true;
      } else {
        try {
          const hostname = new URL(url).hostname;

          if (hostname === ignoredHost) {
            return true;
          }
        } catch (ign) {}
      }
    }

    return false;
  }

  for (const page of pageArray) {
    const id = page.id.toString();
    newIds.push(id);

    if (page.isKey) {
      keyId = id;
    }

    const contextId = `${appIdKey}.${id}`;

    if (!_lodash.default.includes(this.contexts, contextId)) {
      if (isUrlIgnored(page.url, this.opts.safariIgnoreWebHostnames)) {
        _logger.default.info(`Not tracking '${page.url}' page because it is blacklisted. ` + `'safariIgnoreWebHostnames'=${this.opts.safariIgnoreWebHostnames}`);
      } else {
        newPages.push(id);
        this.contexts.push(contextId);
      }
    }
  }

  if (!keyId) {
    _logger.default.debug('No key id found. Choosing first id from page array');

    keyId = newIds[0] || null;
  }

  if (!_appiumSupport.util.hasValue(this.curContext)) {
    _logger.default.debug('We do not appear to have window set yet, ignoring');

    return;
  }

  const [curAppIdKey, curPageIdKey] = this.curContext.split('.');

  if (curAppIdKey !== appIdKey) {
    _logger.default.debug('Page change not referring to currently selected app, ignoring.');

    return;
  }

  let newPage = null;

  if (newPages.length) {
    newPage = _lodash.default.last(newPages);

    _logger.default.debug(`We have new pages, selecting page '${newPage}'`);
  } else if (!_lodash.default.includes(newIds, curPageIdKey)) {
    _logger.default.debug('New page listing from remote debugger does not contain ' + 'current window; assuming it is closed');

    if (!_appiumSupport.util.hasValue(keyId)) {
      _logger.default.error('Do not have our current window anymore, and there ' + 'are not any more to load! Doing nothing...');

      this.setCurrentUrl(undefined);
      return;
    }

    _logger.default.debug(`Debugger already selected page '${keyId}', ` + `confirming that choice.`);

    this.curContext = `${appIdKey}.${keyId}`;
    newPage = keyId;
  } else {
    _logger.default.debug('Checking if page needs to load');

    const needsPageLoad = (() => {
      const contextArray = _lodash.default.map(pageArray, page => `${appIdKey}.${page.id}`);

      return !_lodash.default.isEqual(_lodash.default.find(this.contexts, this.curContext), _lodash.default.find(contextArray, this.curContext));
    })();

    if (needsPageLoad) {
      _logger.default.debug('Page load needed. Loading...');

      await this.remote.pageLoad();
    }

    _logger.default.debug('New page listing is same as old, doing nothing');
  }

  if (_appiumSupport.util.hasValue(this.curContext)) {
    let currentPageId = parseInt(_lodash.default.last(this.curContext.split('.')), 10);

    let page = _lodash.default.find(pageArray, p => parseInt(p.id, 10) === currentPageId);

    if (page && page.url !== this.getCurrentUrl()) {
      _logger.default.debug(`Redirected from '${this.getCurrentUrl()}' to '${page.url}'`);

      this.setCurrentUrl(page.url);
    }
  }

  if (_appiumSupport.util.hasValue(newPage)) {
    this.selectingNewPage = true;
    const oldContext = this.curContext;
    this.curContext = `${appIdKey}.${newPage}`;
    this.remote.selectPage(appIdKey, parseInt(newPage, 10)).catch(err => {
      _logger.default.warn(`Failed to select page: ${err.message}`);

      this.curContext = oldContext;
    });
    this.selectingNewPage = false;
  }

  this.windowHandleCache = pageArray;
};

Object.assign(extensions, commands, helpers);
var _default = extensions;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9jb21tYW5kcy9jb250ZXh0LmpzIl0sIm5hbWVzIjpbIldFQlZJRVdfQkFTRSIsIldFQlZJRVdfV0lOIiwiY29tbWFuZHMiLCJoZWxwZXJzIiwiZXh0ZW5zaW9ucyIsIk9iamVjdCIsImFzc2lnbiIsImlvc0NvbW1hbmRzIiwiY29udGV4dCIsImNsb3NlQWxlcnRCZWZvcmVUZXN0IiwibmF2VG9Jbml0aWFsV2VidmlldyIsInVzZU5ld1NhZmFyaSIsInR5cGVBbmROYXZUb1VybCIsImlzUmVhbERldmljZSIsIm9wdHMiLCJzYWZhcmkiLCJuYXZUb1ZpZXdUaHJvdWdoRmF2b3JpdGVzIiwibmF2VG9WaWV3V2l0aFRpdGxlIiwiZ2V0TGF0ZXN0V2Vidmlld0NvbnRleHRGb3JUaXRsZSIsInJlZ0V4cCIsImN1cnJlbnRVcmwiLCJnZXRDdXJyZW50VXJsIiwiY29udGV4dHMiLCJfIiwiZmlsdGVyIiwiZ2V0Q29udGV4dHNBbmRWaWV3cyIsImN0eCIsInZpZXciLCJ1cmwiLCJpZCIsInRpdGxlIiwidGVzdCIsImlzV2ViQ29udGV4dCIsImN1ckNvbnRleHQiLCJOQVRJVkVfV0lOIiwiaXNXZWJ2aWV3IiwiZ2V0TmV3UmVtb3RlRGVidWdnZXIiLCJzb2NrZXRQYXRoIiwiZGV2aWNlIiwiZ2V0V2ViSW5zcGVjdG9yU29ja2V0IiwiYnVuZGxlSWQiLCJhZGRpdGlvbmFsQnVuZGxlSWRzIiwiYWRkaXRpb25hbFdlYnZpZXdCdW5kbGVJZHMiLCJpc1NhZmFyaSIsImluY2x1ZGVTYWZhcmkiLCJpbmNsdWRlU2FmYXJpSW5XZWJ2aWV3cyIsInBhZ2VMb2FkTXMiLCJwbGF0Zm9ybVZlcnNpb24iLCJyZW1vdGVEZWJ1Z1Byb3h5IiwiZ2FyYmFnZUNvbGxlY3RPbkV4ZWN1dGUiLCJ1dGlsIiwiaGFzVmFsdWUiLCJzYWZhcmlHYXJiYWdlQ29sbGVjdCIsInVkaWQiLCJsb2dBbGxDb21tdW5pY2F0aW9uIiwic2FmYXJpTG9nQWxsQ29tbXVuaWNhdGlvbiIsImxvZ0FsbENvbW11bmljYXRpb25IZXhEdW1wIiwic2FmYXJpTG9nQWxsQ29tbXVuaWNhdGlvbkhleER1bXAiLCJzb2NrZXRDaHVua1NpemUiLCJzYWZhcmlTb2NrZXRDaHVua1NpemUiLCJ3ZWJJbnNwZWN0b3JNYXhGcmFtZUxlbmd0aCIsInNhZmFyaVdlYkluc3BlY3Rvck1heEZyYW1lTGVuZ3RoIiwic2V0Q29udGV4dCIsIm5hbWUiLCJjYWxsYmFjayIsInNraXBSZWFkeUNoZWNrIiwiYWxyZWFkeUluQ29udGV4dCIsImRlc2lyZWQiLCJjdXJyZW50IiwiaXNOYXRpdmVDb250ZXh0IiwibG9nIiwiZGVidWciLCJyZXBsYWNlIiwiaXNVbmRlZmluZWQiLCJnZXRDb250ZXh0cyIsImNvbnRleHRJZCIsImluY2x1ZGVzIiwiZXJyb3JzIiwiTm9TdWNoQ29udGV4dEVycm9yIiwib2xkQ29udGV4dCIsImN1cldpbmRvd0hhbmRsZSIsImFwcElkS2V5IiwicGFnZUlkS2V5IiwibWFwIiwic3BsaXQiLCJwYXJzZUludCIsInNlbGVjdGluZ05ld1BhZ2UiLCJyZW1vdGUiLCJzZWxlY3RQYWdlIiwiZXJyIiwiZW5hYmxlUGVyZm9ybWFuY2VMb2dnaW5nIiwibG9ncyIsInBlcmZvcm1hbmNlIiwiSU9TUGVyZm9ybWFuY2VMb2ciLCJzdGFydENhcHR1cmUiLCJzYWZhcmlDb25zb2xlIiwic3RhcnRDb25zb2xlIiwiYWRkTG9nTGluZSIsImJpbmQiLCJzYWZhcmlOZXR3b3JrIiwic3RhcnROZXR3b3JrIiwiY29ubmVjdFRvUmVtb3RlRGVidWdnZXIiLCJvbiIsIlJlbW90ZURlYnVnZ2VyIiwiRVZFTlRfUEFHRV9DSEFOR0UiLCJvblBhZ2VDaGFuZ2UiLCJFVkVOVF9GUkFNRVNfREVUQUNIRUQiLCJpc0VtcHR5IiwiY3VyV2ViRnJhbWVzIiwicGx1cmFsaXplIiwibGVuZ3RoIiwiam9pbiIsImNvbm5lY3QiLCJ3ZWJ2aWV3Q29ubmVjdFRpbWVvdXQiLCJsaXN0V2ViRnJhbWVzIiwidXNlVXJsIiwiZXJyb3JBbmRUaHJvdyIsInVuZGVmaW5lZCIsInBhZ2VBcnJheSIsImdldFdlYnZpZXdQYWdlcyIsInNlbGVjdEFwcCIsIndlYnZpZXdDb25uZWN0UmV0cmllcyIsImlnbm9yZUFib3V0QmxhbmtVcmwiLCJtZXNzYWdlIiwic2V0Q29ubmVjdGlvbktleSIsImFsZXJ0RXJyb3JNc2ciLCJFcnJvciIsIm1hcEZuIiwiZnVsbENvbnRleHRMaXN0IiwidG9TdHJpbmciLCJtb2JpbGVHZXRDb250ZXh0cyIsIndhaXRGb3JXZWJ2aWV3TXMiLCJpc051bWJlciIsImlzTmFOIiwiY3VyT3B0IiwidGltZXIiLCJ0aW1pbmciLCJUaW1lciIsInN0YXJ0IiwiZ2V0RHVyYXRpb24iLCJhc01pbGxpU2Vjb25kcyIsInRvRml4ZWQiLCJzZXRXaW5kb3ciLCJub29wIiwiTm9TdWNoV2luZG93RXJyb3IiLCJnZXRXaW5kb3dIYW5kbGUiLCJOb3RJbXBsZW1lbnRlZEVycm9yIiwiZ2V0V2luZG93SGFuZGxlcyIsInBhZ2VDaGFuZ2VOb3RpZmljYXRpb24iLCJKU09OIiwic3RyaW5naWZ5IiwiaXNDb25uZWN0ZWQiLCJuZXdJZHMiLCJuZXdQYWdlcyIsImtleUlkIiwiaXNVcmxJZ25vcmVkIiwic2FmYXJpSWdub3JlV2ViSG9zdG5hbWVzIiwiaWdub3JlZEhvc3RzIiwiYiIsInRyaW0iLCJpZ25vcmVkSG9zdCIsImhvc3RuYW1lIiwiVVJMIiwiaWduIiwicGFnZSIsInB1c2giLCJpc0tleSIsImluZm8iLCJjdXJBcHBJZEtleSIsImN1clBhZ2VJZEtleSIsIm5ld1BhZ2UiLCJsYXN0IiwiZXJyb3IiLCJzZXRDdXJyZW50VXJsIiwibmVlZHNQYWdlTG9hZCIsImNvbnRleHRBcnJheSIsImlzRXF1YWwiLCJmaW5kIiwicGFnZUxvYWQiLCJjdXJyZW50UGFnZUlkIiwicCIsImNhdGNoIiwid2FybiIsIndpbmRvd0hhbmRsZUNhY2hlIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7OztBQUFBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUdB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LEtBQXVCc0osYUFBaEQsQ0FBWDs7QUFDQSxRQUFJZixJQUFJLElBQUlBLElBQUksQ0FBQ3hJLEdBQUwsS0FBYSxLQUFLUCxhQUFMLEVBQXpCLEVBQStDO0FBQzdDaUQsc0JBQUlDLEtBQUosQ0FBVyxvQkFBbUIsS0FBS2xELGFBQUwsRUFBcUIsU0FBUStJLElBQUksQ0FBQ3hJLEdBQUksR0FBcEU7O0FBQ0EsV0FBS2lKLGFBQUwsQ0FBbUJULElBQUksQ0FBQ3hJLEdBQXhCO0FBQ0Q7QUFDRjs7QUFFRCxNQUFJc0Isb0JBQUtDLFFBQUwsQ0FBY3VILE9BQWQsQ0FBSixFQUE0QjtBQUMxQixTQUFLcEYsZ0JBQUwsR0FBd0IsSUFBeEI7QUFDQSxVQUFNUCxVQUFVLEdBQUcsS0FBSzlDLFVBQXhCO0FBQ0EsU0FBS0EsVUFBTCxHQUFtQixHQUFFZ0QsUUFBUyxJQUFHeUYsT0FBUSxFQUF6QztBQUVBLFNBQUtuRixNQUFMLENBQVlDLFVBQVosQ0FBdUJQLFFBQXZCLEVBQWlDSSxRQUFRLENBQUNxRixPQUFELEVBQVUsRUFBVixDQUF6QyxFQUNHVyxLQURILENBQ1U1RixHQUFELElBQVM7QUFDZG5CLHNCQUFJZ0gsSUFBSixDQUFVLDBCQUF5QjdGLEdBQUcsQ0FBQ2tDLE9BQVEsRUFBL0M7O0FBQ0EsV0FBSzFGLFVBQUwsR0FBa0I4QyxVQUFsQjtBQUNELEtBSkg7QUFLQSxTQUFLTyxnQkFBTCxHQUF3QixLQUF4QjtBQUNEOztBQUNELE9BQUtpRyxpQkFBTCxHQUF5QmpFLFNBQXpCO0FBQ0QsQ0E3SUQ7O0FBZ0pBakgsTUFBTSxDQUFDQyxNQUFQLENBQWNGLFVBQWQsRUFBMEJGLFFBQTFCLEVBQW9DQyxPQUFwQztlQUNlQyxVIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgaW9zQ29tbWFuZHMsIElPU1BlcmZvcm1hbmNlTG9nLCBOQVRJVkVfV0lOLCBXRUJWSUVXX1dJTiB9IGZyb20gJ2FwcGl1bS1pb3MtZHJpdmVyJztcbmltcG9ydCB7IGNyZWF0ZVJlbW90ZURlYnVnZ2VyLCBSZW1vdGVEZWJ1Z2dlciB9IGZyb20gJ2FwcGl1bS1yZW1vdGUtZGVidWdnZXInO1xuaW1wb3J0IHsgZXJyb3JzLCBpc0Vycm9yVHlwZSB9IGZyb20gJ2FwcGl1bS1iYXNlLWRyaXZlcic7XG5pbXBvcnQgeyB1dGlsLCB0aW1pbmcgfSBmcm9tICdhcHBpdW0tc3VwcG9ydCc7XG5pbXBvcnQgbG9nIGZyb20gJy4uL2xvZ2dlcic7XG5pbXBvcnQgeyByZXRyeUludGVydmFsIH0gZnJvbSAnYXN5bmNib3gnO1xuaW1wb3J0IF8gZnJvbSAnbG9kYXNoJztcblxuXG5jb25zdCBXRUJWSUVXX0JBU0UgPSBgJHtXRUJWSUVXX1dJTn1fYDtcblxubGV0IGNvbW1hbmRzID0ge30sIGhlbHBlcnMgPSB7fSwgZXh0ZW5zaW9ucyA9IHt9O1xuXG5PYmplY3QuYXNzaWduKGV4dGVuc2lvbnMsIGlvc0NvbW1hbmRzLmNvbnRleHQpO1xuXG4vLyBvdmVycmlkZSwgYXMgYXBwaXVtLWlvcy1kcml2ZXIncyB2ZXJzaW9uIHVzZXMgVUkgQXV0b21hdGlvbiB0byBjbG9zZVxuZXh0ZW5zaW9ucy5jbG9zZUFsZXJ0QmVmb3JlVGVzdCA9IGFzeW5jIGZ1bmN0aW9uIGNsb3NlQWxlcnRCZWZvcmVUZXN0ICgpIHsgLy8gZXNsaW50LWRpc2FibGUtbGluZSByZXF1aXJlLWF3YWl0XG4gIHJldHVybiB0cnVlO1xufTtcblxuLy8gdGhlIGFwcGl1bS1pb3MtZHJpdmVyIHZlcnNpb24gaGFzIGEgd2FpdCBvbiByZWFsIGRldmljZXMsIHdoaWNoIGlzIG5vIGxvbmdlclxuLy8gbmVjZXNzYXJ5XG5leHRlbnNpb25zLm5hdlRvSW5pdGlhbFdlYnZpZXcgPSBhc3luYyBmdW5jdGlvbiBuYXZUb0luaXRpYWxXZWJ2aWV3ICgpIHtcbiAgaWYgKHRoaXMudXNlTmV3U2FmYXJpKCkpIHtcbiAgICBhd2FpdCB0aGlzLnR5cGVBbmROYXZUb1VybCgpO1xuICB9IGVsc2UgaWYgKCF0aGlzLmlzUmVhbERldmljZSgpICYmIHRoaXMub3B0cy5zYWZhcmkpIHtcbiAgICBhd2FpdCB0aGlzLm5hdlRvVmlld1Rocm91Z2hGYXZvcml0ZXMoKTtcbiAgfSBlbHNlIHtcbiAgICBhd2FpdCB0aGlzLm5hdlRvVmlld1dpdGhUaXRsZSgvLiovKTtcbiAgfVxufTtcblxuLy8gdGhlIGFwcGl1bS1pb3MtZHJpdmVyIHZlcnNpb24gb2YgdGhpcyBmdW5jdGlvbiBmYWlscyBpbiBDSSxcbi8vIGFuZCB0aGUgd3Jvbmcgd2VidmlldyBpcyBhbG1vc3QgYWx3YXlzIHJldHJpZXZlZFxuLy8gYWxzbyBvdmVycmlkZSBzbyB0aGF0IHRoZSBjYXNlIHdoZXJlIHRoZSBTREsgdmVyc2lvbiBpcyBub3Qgc2V0IGRvZXMgbm90IGZhaWxcbmV4dGVuc2lvbnMuZ2V0TGF0ZXN0V2Vidmlld0NvbnRleHRGb3JUaXRsZSA9IGFzeW5jIGZ1bmN0aW9uIGdldExhdGVzdFdlYnZpZXdDb250ZXh0Rm9yVGl0bGUgKHJlZ0V4cCkge1xuICBjb25zdCBjdXJyZW50VXJsID0gdGhpcy5nZXRDdXJyZW50VXJsKCk7XG5cbiAgY29uc3QgY29udGV4dHMgPSBfLmZpbHRlcihhd2FpdCB0aGlzLmdldENvbnRleHRzQW5kVmlld3MoKSwgJ3ZpZXcnKTtcblxuICBpZiAoY3VycmVudFVybCkge1xuICAgIC8vIGZpcnN0IHRyeSB0byBtYXRjaCBieSBjdXJyZW50IHVybFxuICAgIGZvciAoY29uc3QgY3R4IG9mIGNvbnRleHRzKSB7XG4gICAgICBpZiAoKGN0eC52aWV3LnVybCB8fCAnJykgPT09IHRoaXMuZ2V0Q3VycmVudFVybCgpKSB7XG4gICAgICAgIHJldHVybiBjdHguaWQ7XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgLy8gaWYgbm90LCB0cnkgdG8gbWF0Y2ggYnkgcmVndWxhciBleHByZXNzaW9uXG4gIGZvciAoY29uc3QgY3R4IG9mIGNvbnRleHRzKSB7XG4gICAgaWYgKChjdHgudmlldy50aXRsZSAmJiByZWdFeHAudGVzdChjdHgudmlldy50aXRsZSkpIHx8IChjdHgudmlldy51cmwgJiYgcmVnRXhwLnRlc3QoY3R4LnZpZXcudXJsKSkpIHtcbiAgICAgIHJldHVybiBjdHguaWQ7XG4gICAgfVxuICB9XG59O1xuXG5leHRlbnNpb25zLmlzV2ViQ29udGV4dCA9IGZ1bmN0aW9uIGlzV2ViQ29udGV4dCAoKSB7XG4gIHJldHVybiAhIXRoaXMuY3VyQ29udGV4dCAmJiB0aGlzLmN1ckNvbnRleHQgIT09IGlvc0NvbW1hbmRzLmNvbnRleHQuTkFUSVZFX1dJTjtcbn07XG5cbmV4dGVuc2lvbnMuaXNXZWJ2aWV3ID0gZnVuY3Rpb24gaXNXZWJ2aWV3ICgpIHtcbiAgcmV0dXJuIHRoaXMuaXNXZWJDb250ZXh0KCk7XG59O1xuXG5leHRlbnNpb25zLmdldE5ld1JlbW90ZURlYnVnZ2VyID0gYXN5bmMgZnVuY3Rpb24gZ2V0TmV3UmVtb3RlRGVidWdnZXIgKCkge1xuICBsZXQgc29ja2V0UGF0aDtcbiAgaWYgKCF0aGlzLmlzUmVhbERldmljZSgpKSB7XG4gICAgc29ja2V0UGF0aCA9IGF3YWl0IHRoaXMub3B0cy5kZXZpY2UuZ2V0V2ViSW5zcGVjdG9yU29ja2V0KCk7XG4gIH1cbiAgcmV0dXJuIGNyZWF0ZVJlbW90ZURlYnVnZ2VyKHtcbiAgICBidW5kbGVJZDogdGhpcy5vcHRzLmJ1bmRsZUlkLFxuICAgIGFkZGl0aW9uYWxCdW5kbGVJZHM6IHRoaXMub3B0cy5hZGRpdGlvbmFsV2Vidmlld0J1bmRsZUlkcyxcbiAgICBpc1NhZmFyaTogdGhpcy5pc1NhZmFyaSgpLFxuICAgIGluY2x1ZGVTYWZhcmk6IHRoaXMub3B0cy5pbmNsdWRlU2FmYXJpSW5XZWJ2aWV3cyxcbiAgICB1c2VOZXdTYWZhcmk6IHRoaXMudXNlTmV3U2FmYXJpKCksXG4gICAgcGFnZUxvYWRNczogdGhpcy5wYWdlTG9hZE1zLFxuICAgIHBsYXRmb3JtVmVyc2lvbjogdGhpcy5vcHRzLnBsYXRmb3JtVmVyc2lvbixcbiAgICBzb2NrZXRQYXRoLFxuICAgIHJlbW90ZURlYnVnUHJveHk6IHRoaXMub3B0cy5yZW1vdGVEZWJ1Z1Byb3h5LFxuICAgIGdhcmJhZ2VDb2xsZWN0T25FeGVjdXRlOiB1dGlsLmhhc1ZhbHVlKHRoaXMub3B0cy5zYWZhcmlHYXJiYWdlQ29sbGVjdClcbiAgICAgID8gISF0aGlzLm9wdHMuc2FmYXJpR2FyYmFnZUNvbGxlY3RcbiAgICAgIDogZmFsc2UsXG4gICAgdWRpZDogdGhpcy5vcHRzLnVkaWQsXG4gICAgbG9nQWxsQ29tbXVuaWNhdGlvbjogdGhpcy5vcHRzLnNhZmFyaUxvZ0FsbENvbW11bmljYXRpb24sXG4gICAgbG9nQWxsQ29tbXVuaWNhdGlvbkhleER1bXA6IHRoaXMub3B0cy5zYWZhcmlMb2dBbGxDb21tdW5pY2F0aW9uSGV4RHVtcCxcbiAgICBzb2NrZXRDaHVua1NpemU6IHRoaXMub3B0cy5zYWZhcmlTb2NrZXRDaHVua1NpemUsXG4gICAgd2ViSW5zcGVjdG9yTWF4RnJhbWVMZW5ndGg6IHRoaXMub3B0cy5zYWZhcmlXZWJJbnNwZWN0b3JNYXhGcmFtZUxlbmd0aFxuICB9LCB0aGlzLmlzUmVhbERldmljZSgpKTtcbn07XG5cbi8qKlxuICogU2V0IGNvbnRleHRcbiAqXG4gKiBAcGFyYW0gez9zdHJpbmd9IG5hbWUgLSBUaGUgbmFtZSBvZiBjb250ZXh0IHRvIHNldC4gSXQgY291bGQgYmUgJ251bGwnIGFzIE5BVElWRV9XSU4uXG4gKiBAcGFyYW0ge2NhbGxiYWNrfSBjYWxsYmFjayBUaGUgY2FsbGJhY2suIChJdCBpcyBub3QgY2FsbGVkIGluIHRoaXMgbWV0aG9kKVxuICogQHBhcmFtIHtib29sZWFufSBza2lwUmVhZHlDaGVjayAtIFdoZXRoZXIgaXQgd2FpdHMgZm9yIHRoZSBuZXcgY29udGV4dCBpcyByZWFkeVxuICovXG5jb21tYW5kcy5zZXRDb250ZXh0ID0gYXN5bmMgZnVuY3Rpb24gc2V0Q29udGV4dCAobmFtZSwgY2FsbGJhY2ssIHNraXBSZWFkeUNoZWNrKSB7XG4gIGZ1bmN0aW9uIGFscmVhZHlJbkNvbnRleHQgKGRlc2lyZWQsIGN1cnJlbnQpIHtcbiAgICByZXR1cm4gKGRlc2lyZWQgPT09IGN1cnJlbnQgfHxcbiAgICAgICAgICAgKGRlc2lyZWQgPT09IG51bGwgJiYgY3VycmVudCA9PT0gTkFUSVZFX1dJTikgfHxcbiAgICAgICAgICAgKGRlc2lyZWQgPT09IE5BVElWRV9XSU4gJiYgY3VycmVudCA9PT0gbnVsbCkpO1xuICB9XG4gIGZ1bmN0aW9uIGlzTmF0aXZlQ29udGV4dCAoY29udGV4dCkge1xuICAgIHJldHVybiBjb250ZXh0ID09PSBOQVRJVkVfV0lOIHx8IGNvbnRleHQgPT09IG51bGw7XG4gIH1cblxuICAvLyBhbGxvdyB0aGUgZnVsbCBjb250ZXh0IGxpc3QgdG8gYmUgcGFzc2VkIGluXG4gIGlmIChuYW1lICYmIG5hbWUuaWQpIHtcbiAgICBuYW1lID0gbmFtZS5pZDtcbiAgfVxuXG4gIGxvZy5kZWJ1ZyhgQXR0ZW1wdGluZyB0byBzZXQgY29udGV4dCB0byAnJHtuYW1lIHx8IE5BVElWRV9XSU59JyBmcm9tICcke3RoaXMuY3VyQ29udGV4dCA/IHRoaXMuY3VyQ29udGV4dCA6IE5BVElWRV9XSU59J2ApO1xuXG4gIGlmIChhbHJlYWR5SW5Db250ZXh0KG5hbWUsIHRoaXMuY3VyQ29udGV4dCkgfHwgYWxyZWFkeUluQ29udGV4dChfLnJlcGxhY2UobmFtZSwgV0VCVklFV19CQVNFLCAnJyksIHRoaXMuY3VyQ29udGV4dCkpIHtcbiAgICAvLyBhbHJlYWR5IGluIHRoZSBuYW1lZCBjb250ZXh0LCBubyBuZWVkIHRvIGRvIGFueXRoaW5nXG4gICAgbG9nLmRlYnVnKGBBbHJlYWR5IGluICcke25hbWUgfHwgTkFUSVZFX1dJTn0nIGNvbnRleHQuIERvaW5nIG5vdGhpbmcuYCk7XG4gICAgcmV0dXJuO1xuICB9XG4gIGlmIChpc05hdGl2ZUNvbnRleHQobmFtZSkpIHtcbiAgICAvLyBzd2l0Y2hpbmcgaW50byB0aGUgbmF0aXZlIGNvbnRleHRcbiAgICB0aGlzLmN1ckNvbnRleHQgPSBudWxsO1xuICAgIHJldHVybjtcbiAgfVxuXG4gIC8vIHN3aXRjaGluZyBpbnRvIGEgd2VidmlldyBjb250ZXh0XG5cbiAgLy8gaWYgY29udGV4dHMgaGF2ZSBub3QgYWxyZWFkeSBiZWVuIHJldHJpZXZlZCwgZ2V0IHRoZW1cbiAgaWYgKF8uaXNVbmRlZmluZWQodGhpcy5jb250ZXh0cykpIHtcbiAgICBhd2FpdCB0aGlzLmdldENvbnRleHRzKCk7XG4gIH1cblxuICBsZXQgY29udGV4dElkID0gXy5yZXBsYWNlKG5hbWUsIFdFQlZJRVdfQkFTRSwgJycpO1xuICBpZiAoY29udGV4dElkID09PSAnJykge1xuICAgIC8vIGFsbG93IHVzZXIgdG8gcGFzcyBpbiBcIldFQlZJRVdcIiB3aXRob3V0IGFuIGluZGV4XG4gICAgLy8gdGhlIHNlY29uZCBjb250ZXh0IHdpbGwgYmUgdGhlIGZpcnN0IHdlYnZpZXcgYXNcbiAgICAvLyB0aGUgZmlyc3QgaXMgYWx3YXlzIE5BVElWRV9BUFBcbiAgICBjb250ZXh0SWQgPSB0aGlzLmNvbnRleHRzWzFdO1xuICB9XG4gIGlmICghXy5pbmNsdWRlcyh0aGlzLmNvbnRleHRzLCBjb250ZXh0SWQpKSB7XG4gICAgdGhyb3cgbmV3IGVycm9ycy5Ob1N1Y2hDb250ZXh0RXJyb3IoKTtcbiAgfVxuXG4gIGNvbnN0IG9sZENvbnRleHQgPSB0aGlzLmN1ckNvbnRleHQ7XG4gIHRoaXMuY3VyQ29udGV4dCA9IHRoaXMuY3VyV2luZG93SGFuZGxlID0gY29udGV4dElkO1xuXG4gIC8vIGBjb250ZXh0SWRgIHdpbGwgYmUgaW4gdGhlIGZvcm0gb2YgYGFwcElkLnBhZ2VJZGAgaW4gdGhpcyBjYXNlXG4gIGNvbnN0IFthcHBJZEtleSwgcGFnZUlkS2V5XSA9IF8ubWFwKGNvbnRleHRJZC5zcGxpdCgnLicpLCAoaWQpID0+IHBhcnNlSW50KGlkLCAxMCkpO1xuICB0cnkge1xuICAgIHRoaXMuc2VsZWN0aW5nTmV3UGFnZSA9IHRydWU7XG4gICAgYXdhaXQgdGhpcy5yZW1vdGUuc2VsZWN0UGFnZShhcHBJZEtleSwgcGFnZUlkS2V5LCBza2lwUmVhZHlDaGVjayk7XG4gIH0gY2F0Y2ggKGVycikge1xuICAgIHRoaXMuY3VyQ29udGV4dCA9IHRoaXMuY3VyV2luZG93SGFuZGxlID0gb2xkQ29udGV4dDtcbiAgICB0aHJvdyBlcnI7XG4gIH0gZmluYWxseSB7XG4gICAgdGhpcy5zZWxlY3RpbmdOZXdQYWdlID0gZmFsc2U7XG4gIH1cblxuICAvLyBhdHRlbXB0IHRvIHN0YXJ0IHBlcmZvcm1hbmNlIGxvZ2dpbmcsIGlmIHJlcXVlc3RlZFxuICBpZiAodGhpcy5vcHRzLmVuYWJsZVBlcmZvcm1hbmNlTG9nZ2luZyAmJiB0aGlzLnJlbW90ZSkge1xuICAgIGxvZy5kZWJ1ZyhgU3RhcnRpbmcgcGVyZm9ybWFuY2UgbG9nIG9uICcke3RoaXMuY3VyQ29udGV4dH0nYCk7XG4gICAgdGhpcy5sb2dzLnBlcmZvcm1hbmNlID0gbmV3IElPU1BlcmZvcm1hbmNlTG9nKHRoaXMucmVtb3RlKTtcbiAgICBhd2FpdCB0aGlzLmxvZ3MucGVyZm9ybWFuY2Uuc3RhcnRDYXB0dXJlKCk7XG4gIH1cblxuICAvLyBzdGFydCBzYWZhcmkgbG9nZ2luZyBpZiB0aGUgbG9ncyBoYW5kbGVycyBhcmUgYWN0aXZlXG4gIGlmIChuYW1lICYmIG5hbWUgIT09IE5BVElWRV9XSU4gJiYgdGhpcy5sb2dzKSB7XG4gICAgaWYgKHRoaXMubG9ncy5zYWZhcmlDb25zb2xlKSB7XG4gICAgICBhd2FpdCB0aGlzLnJlbW90ZS5zdGFydENvbnNvbGUodGhpcy5sb2dzLnNhZmFyaUNvbnNvbGUuYWRkTG9nTGluZS5iaW5kKHRoaXMubG9ncy5zYWZhcmlDb25zb2xlKSk7XG4gICAgfVxuICAgIGlmICh0aGlzLmxvZ3Muc2FmYXJpTmV0d29yaykge1xuICAgICAgYXdhaXQgdGhpcy5yZW1vdGUuc3RhcnROZXR3b3JrKHRoaXMubG9ncy5zYWZhcmlOZXR3b3JrLmFkZExvZ0xpbmUuYmluZCh0aGlzLmxvZ3Muc2FmYXJpTmV0d29yaykpO1xuICAgIH1cbiAgfVxufTtcblxuZXh0ZW5zaW9ucy5jb25uZWN0VG9SZW1vdGVEZWJ1Z2dlciA9IGFzeW5jIGZ1bmN0aW9uIGNvbm5lY3RUb1JlbW90ZURlYnVnZ2VyICgpIHtcbiAgdGhpcy5yZW1vdGUgPSBhd2FpdCB0aGlzLmdldE5ld1JlbW90ZURlYnVnZ2VyKCk7XG5cbiAgdGhpcy5yZW1vdGUub24oUmVtb3RlRGVidWdnZXIuRVZFTlRfUEFHRV9DSEFOR0UsIHRoaXMub25QYWdlQ2hhbmdlLmJpbmQodGhpcykpO1xuICB0aGlzLnJlbW90ZS5vbihSZW1vdGVEZWJ1Z2dlci5FVkVOVF9GUkFNRVNfREVUQUNIRUQsICgpID0+IHtcbiAgICBpZiAoIV8uaXNFbXB0eSh0aGlzLmN1cldlYkZyYW1lcykpIHtcbiAgICAgIGxvZy5kZWJ1ZyhgQ2xlYXJpbmcgJHt1dGlsLnBsdXJhbGl6ZSgnZnJhbWUnLCB0aGlzLmN1cldlYkZyYW1lcy5sZW5ndGgsIHRydWUpfTogJHt0aGlzLmN1cldlYkZyYW1lcy5qb2luKCcsICcpfWApO1xuICAgIH1cbiAgICB0aGlzLmN1cldlYkZyYW1lcyA9IFtdO1xuICB9KTtcblxuICBhd2FpdCB0aGlzLnJlbW90ZS5jb25uZWN0KHRoaXMub3B0cy53ZWJ2aWV3Q29ubmVjdFRpbWVvdXQpO1xufTtcblxuZXh0ZW5zaW9ucy5saXN0V2ViRnJhbWVzID0gYXN5bmMgZnVuY3Rpb24gbGlzdFdlYkZyYW1lcyAodXNlVXJsID0gdHJ1ZSkge1xuICBpZiAoIXRoaXMub3B0cy5idW5kbGVJZCkge1xuICAgIGxvZy5lcnJvckFuZFRocm93KCdDYW5ub3QgZW50ZXIgd2ViIGZyYW1lIHdpdGhvdXQgYSBidW5kbGUgSUQnKTtcbiAgfVxuXG4gIHVzZVVybCA9IHVzZVVybCAmJiAhdGhpcy5pc1JlYWxEZXZpY2UoKSAmJiAhIXRoaXMuZ2V0Q3VycmVudFVybCgpO1xuICBsb2cuZGVidWcoYFNlbGVjdGluZyBieSB1cmw6ICR7dXNlVXJsfSAke3VzZVVybCA/IGAoZXhwZWN0ZWQgdXJsOiAnJHt0aGlzLmdldEN1cnJlbnRVcmwoKX0nKWAgOiAnJ31gKTtcblxuICBjb25zdCBjdXJyZW50VXJsID0gdXNlVXJsID8gdGhpcy5nZXRDdXJyZW50VXJsKCkgOiB1bmRlZmluZWQ7XG4gIGxldCBwYWdlQXJyYXkgPSBbXTtcbiAgY29uc3QgZ2V0V2Vidmlld1BhZ2VzID0gYXN5bmMgKCkgPT4ge1xuICAgIHRyeSB7XG4gICAgICByZXR1cm4gYXdhaXQgdGhpcy5yZW1vdGUuc2VsZWN0QXBwKGN1cnJlbnRVcmwsIHRoaXMub3B0cy53ZWJ2aWV3Q29ubmVjdFJldHJpZXMsIHRoaXMub3B0cy5pZ25vcmVBYm91dEJsYW5rVXJsKTtcbiAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgIGxvZy5kZWJ1ZyhgTm8gYXZhaWxhYmxlIHdlYiBwYWdlczogJHtlcnIubWVzc2FnZX1gKTtcbiAgICAgIHJldHVybiBbXTtcbiAgICB9XG4gIH07XG5cbiAgaWYgKHRoaXMucmVtb3RlICYmIHRoaXMucmVtb3RlLmFwcElkS2V5KSB7XG4gICAgLy8gYWxyZWFkeSBjb25uZWN0ZWRcbiAgICBwYWdlQXJyYXkgPSBhd2FpdCBnZXRXZWJ2aWV3UGFnZXMoKTtcbiAgfSBlbHNlIHtcbiAgICBpZiAoIXRoaXMucmVtb3RlKSB7XG4gICAgICBhd2FpdCB0aGlzLmNvbm5lY3RUb1JlbW90ZURlYnVnZ2VyKCk7XG4gICAgfVxuICAgIGF3YWl0IHRoaXMucmVtb3RlLnNldENvbm5lY3Rpb25LZXkoKTtcblxuICAgIHBhZ2VBcnJheSA9IGF3YWl0IGdldFdlYnZpZXdQYWdlcygpO1xuXG4gICAgY29uc3QgYWxlcnRFcnJvck1zZyA9ICdDbG9zZSBhbGVydCBmYWlsZWQuIFJldHJ5Lic7XG4gICAgdHJ5IHtcbiAgICAgIGF3YWl0IHJldHJ5SW50ZXJ2YWwoNiwgMTAwMCwgYXN5bmMgKCkgPT4ge1xuICAgICAgICBpZiAoIWF3YWl0IHRoaXMuY2xvc2VBbGVydEJlZm9yZVRlc3QoKSkge1xuICAgICAgICAgIHRocm93IG5ldyBFcnJvcihhbGVydEVycm9yTXNnKTtcbiAgICAgICAgfVxuICAgICAgfSk7XG4gICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICAvLyBpZiB0aGUgbG9vcCB0byBjbG9zZSBhbGVydHMgZmFpbGVkIHRvIGRpc21pc3MsIGlnbm9yZSxcbiAgICAgIC8vIG90aGVyd2lzZSBsb2cgYW5kIHRocm93IHRoZSBlcnJvclxuICAgICAgaWYgKGVyci5tZXNzYWdlICE9PSBhbGVydEVycm9yTXNnKSB7XG4gICAgICAgIGxvZy5lcnJvckFuZFRocm93KGVycik7XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgaWYgKHBhZ2VBcnJheS5sZW5ndGggPT09IDApIHtcbiAgICAvLyB3ZSBoYXZlIG5vIHdlYiBmcmFtZXMsIGJ1dCBjb250aW51ZSBhbnl3YXlcbiAgICBsb2cuZGVidWcoJ05vIHdlYiBmcmFtZXMgZm91bmQuJyk7XG4gIH1cbiAgcmV0dXJuIHBhZ2VBcnJheTtcbn07XG5cbmNvbW1hbmRzLmdldENvbnRleHRzID0gYXN5bmMgZnVuY3Rpb24gZ2V0Q29udGV4dHMgKCkge1xuICBsb2cuZGVidWcoJ0dldHRpbmcgbGlzdCBvZiBhdmFpbGFibGUgY29udGV4dHMnKTtcbiAgY29uc3QgY29udGV4dHMgPSBhd2FpdCB0aGlzLmdldENvbnRleHRzQW5kVmlld3MoZmFsc2UpO1xuXG4gIGNvbnN0IG1hcEZuID0gdGhpcy5vcHRzLmZ1bGxDb250ZXh0TGlzdFxuICAgID8gZnVuY3Rpb24gKGNvbnRleHQpIHtcbiAgICAgIHJldHVybiB7XG4gICAgICAgIGlkOiBjb250ZXh0LmlkLnRvU3RyaW5nKCksXG4gICAgICAgIHRpdGxlOiBjb250ZXh0LnZpZXcudGl0bGUsXG4gICAgICAgIHVybDogY29udGV4dC52aWV3LnVybCxcbiAgICAgICAgYnVuZGxlSWQ6IGNvbnRleHQudmlldy5idW5kbGVJZCxcbiAgICAgIH07XG4gICAgfVxuICAgIDogKGNvbnRleHQpID0+IGNvbnRleHQuaWQudG9TdHJpbmcoKTtcbiAgcmV0dXJuIGNvbnRleHRzLm1hcChtYXBGbik7XG59O1xuXG4vKipcbiAqIEB0eXBlZGVmIHtPYmplY3R9IENvbnRleHRcbiAqXG4gKiBAcHJvcGVydHkge3N0cmluZ30gaWQgLSBUaGUgaWRlbnRpZmllciBvZiB0aGUgY29udGV4dC4gVGhlIG5hdGl2ZSBjb250ZXh0XG4gKiAgICAgICAgICAgICAgICAgICAgICAgICAgd2lsbCBiZSAnTkFUSVZFX0FQUCcgYW5kIHRoZSB3ZWJ2aWV3cyB3aWxsIGJlXG4gKiAgICAgICAgICAgICAgICAgICAgICAgICAgJ1dFQlZJRVdfeHh4J1xuICogQHByb3BlcnR5IHs/c3RyaW5nfSB0aXRsZSAtIFRoZSB0aXRsZSBhc3NvY2lhdGVkIHdpdGggdGhlIHdlYnZpZXcgY29udGVudFxuICogQHByb3BlcnR5IHs/c3RyaW5nfSB1cmwgLSBUaGUgdXJsIGFzc29jaWF0ZWQgd2l0aCB0aGUgd2VidmlldyBjb250ZW50XG4gKi9cblxuLyoqXG4gKiBHZXQgdGhlIGNvbnRleHRzIGF2YWlsYWJsZSwgd2l0aCBpbmZvcm1hdGlvbiBhYm91dCB0aGUgdXJsIGFuZCB0aXRsZSBvZiBlYWNoXG4gKiB3ZWJ2aWV3XG4gKlxuICogQHBhcmFtIHtPYmplY3R9IG9wdHMgLSBPcHRpb25zIHNldCwgd2hpY2ggY2FuIGluY2x1ZGUgYHdhaXRGb3JXZWJ2aWV3TXNgIHRvXG4gKiAgICAgICAgICAgICAgICAgICAgICAgIHNwZWNpZnkgdGhlIHBlcmlvZCB0byBwb2xsIGZvciBhdmFpbGFibGUgd2Vidmlld3NcbiAqIEByZXR1cm5zIHtBcnJheX0gTGlzdCBvZiBDb250ZXh0IG9iamVjdHNcbiAqL1xuZXh0ZW5zaW9ucy5tb2JpbGVHZXRDb250ZXh0cyA9IGFzeW5jIGZ1bmN0aW9uIG1vYmlsZUdldENvbnRleHRzIChvcHRzID0ge30pIHtcbiAgbGV0IHtcbiAgICB3YWl0Rm9yV2Vidmlld01zID0gMCxcbiAgfSA9IG9wdHM7XG5cbiAgLy8gbWFrZSBzdXJlIGl0IGlzIGEgbnVtYmVyLCBzbyB0aGUgZHVyYXRpb24gY2hlY2sgd29ya3MgcHJvcGVybHlcbiAgaWYgKCFfLmlzTnVtYmVyKHdhaXRGb3JXZWJ2aWV3TXMpKSB7XG4gICAgd2FpdEZvcldlYnZpZXdNcyA9IHBhcnNlSW50KHdhaXRGb3JXZWJ2aWV3TXMsIDEwKTtcbiAgICBpZiAoaXNOYU4od2FpdEZvcldlYnZpZXdNcykpIHtcbiAgICAgIHdhaXRGb3JXZWJ2aWV3TXMgPSAwO1xuICAgIH1cbiAgfVxuXG4gIGNvbnN0IGN1ck9wdCA9IHRoaXMub3B0cy5mdWxsQ29udGV4dExpc3Q7XG4gIC8vIGBhcHBpdW0taW9zLWRyaXZlciNnZXRDb250ZXh0c2AgcmV0dXJucyB0aGUgZnVsbCBsaXN0IG9mIGNvbnRleHRzXG4gIC8vIGlmIHRoaXMgb3B0aW9uIGlzIG9uXG4gIHRoaXMub3B0cy5mdWxsQ29udGV4dExpc3QgPSB0cnVlO1xuXG4gIGNvbnN0IHRpbWVyID0gbmV3IHRpbWluZy5UaW1lcigpLnN0YXJ0KCk7XG4gIHRyeSB7XG4gICAgbGV0IGNvbnRleHRzO1xuICAgIGRvIHtcbiAgICAgIGNvbnRleHRzID0gYXdhaXQgdGhpcy5nZXRDb250ZXh0cygpO1xuXG4gICAgICBpZiAoY29udGV4dHMubGVuZ3RoID49IDIpIHtcbiAgICAgICAgbG9nLmRlYnVnKGBGb3VuZCB3ZWJ2aWV3IGNvbnRleHQgYWZ0ZXIgJHt0aW1lci5nZXREdXJhdGlvbigpLmFzTWlsbGlTZWNvbmRzLnRvRml4ZWQoMCl9bXNgKTtcbiAgICAgICAgcmV0dXJuIGNvbnRleHRzO1xuICAgICAgfVxuICAgICAgbG9nLmRlYnVnKGBObyB3ZWJ2aWV3cyBmb3VuZCBpbiAke3RpbWVyLmdldER1cmF0aW9uKCkuYXNNaWxsaVNlY29uZHMudG9GaXhlZCgwKX1tc2ApO1xuICAgIH0gd2hpbGUgKHRpbWVyLmdldER1cmF0aW9uKCkuYXNNaWxsaVNlY29uZHMgPCB3YWl0Rm9yV2Vidmlld01zKTtcbiAgICByZXR1cm4gY29udGV4dHM7XG4gIH0gZmluYWxseSB7XG4gICAgLy8gcmVzZXQgdGhlIG9wdGlvbiBzbyB0aGVyZSBhcmUgbm8gc2lkZSBlZmZlY3RzXG4gICAgdGhpcy5vcHRzLmZ1bGxDb250ZXh0TGlzdCA9IGN1ck9wdDtcbiAgfVxufTtcblxuY29tbWFuZHMuc2V0V2luZG93ID0gYXN5bmMgZnVuY3Rpb24gc2V0V2luZG93IChuYW1lLCBza2lwUmVhZHlDaGVjaykge1xuICB0cnkge1xuICAgIGF3YWl0IHRoaXMuc2V0Q29udGV4dChuYW1lLCBfLm5vb3AsIHNraXBSZWFkeUNoZWNrKTtcbiAgfSBjYXRjaCAoZXJyKSB7XG4gICAgLy8gdHJhbnNsYXRlIHRoZSBlcnJvciBpbiB0ZXJtcyBvZiB3aW5kb3dzXG4gICAgdGhyb3cgaXNFcnJvclR5cGUoZXJyLCBlcnJvcnMuTm9TdWNoQ29udGV4dEVycm9yKVxuICAgICAgPyBuZXcgZXJyb3JzLk5vU3VjaFdpbmRvd0Vycm9yKClcbiAgICAgIDogZXJyO1xuICB9XG59O1xuXG5jb21tYW5kcy5nZXRXaW5kb3dIYW5kbGUgPSBhc3luYyBmdW5jdGlvbiBnZXRXaW5kb3dIYW5kbGUgKCkgeyAvLyBlc2xpbnQtZGlzYWJsZS1saW5lIHJlcXVpcmUtYXdhaXRcbiAgaWYgKCF0aGlzLmlzV2ViQ29udGV4dCgpKSB7XG4gICAgdGhyb3cgbmV3IGVycm9ycy5Ob3RJbXBsZW1lbnRlZEVycm9yKCk7XG4gIH1cbiAgbG9nLmRlYnVnKGBHZXR0aW5nIGN1cnJlbnQgd2luZG93IGhhbmRsZWApO1xuICByZXR1cm4gdGhpcy5jdXJDb250ZXh0O1xufTtcblxuY29tbWFuZHMuZ2V0V2luZG93SGFuZGxlcyA9IGFzeW5jIGZ1bmN0aW9uIGdldFdpbmRvd0hhbmRsZXMgKCkge1xuICBpZiAoIXRoaXMuaXNXZWJDb250ZXh0KCkpIHtcbiAgICB0aHJvdyBuZXcgZXJyb3JzLk5vdEltcGxlbWVudGVkRXJyb3IoKTtcbiAgfVxuICBsb2cuZGVidWcoJ0dldHRpbmcgbGlzdCBvZiBhdmFpbGFibGUgd2luZG93IGhhbmRsZXMnKTtcbiAgY29uc3QgY29udGV4dHMgPSBhd2FpdCB0aGlzLmdldENvbnRleHRzQW5kVmlld3MoZmFsc2UpO1xuICByZXR1cm4gY29udGV4dHNcbiAgICAvLyBnZXQgcmlkIG9mIHRoZSBuYXRpdmUgYXBwIGNvbnRleHRcbiAgICAuZmlsdGVyKChjb250ZXh0KSA9PiBjb250ZXh0LmlkICE9PSBOQVRJVkVfV0lOKVxuICAgIC8vIGdldCB0aGUgYGFwcC5pZGAgZm9ybWF0IGV4cGVjdGVkXG4gICAgLm1hcCgoY29udGV4dCkgPT4gY29udGV4dC52aWV3LmlkLnRvU3RyaW5nKCkpO1xufTtcblxuZXh0ZW5zaW9ucy5vblBhZ2VDaGFuZ2UgPSBhc3luYyBmdW5jdGlvbiBvblBhZ2VDaGFuZ2UgKHBhZ2VDaGFuZ2VOb3RpZmljYXRpb24pIHtcbiAgbG9nLmRlYnVnKGBSZW1vdGUgZGVidWdnZXIgbm90aWZpZWQgdXMgb2YgYSBuZXcgcGFnZSBsaXN0aW5nOiAke0pTT04uc3RyaW5naWZ5KHBhZ2VDaGFuZ2VOb3RpZmljYXRpb24pfWApO1xuICBpZiAodGhpcy5zZWxlY3RpbmdOZXdQYWdlKSB7XG4gICAgbG9nLmRlYnVnKCdXZSBhcmUgaW4gdGhlIG1pZGRsZSBvZiBzZWxlY3RpbmcgYSBwYWdlLCBpZ25vcmluZycpO1xuICAgIHJldHVybjtcbiAgfVxuICBpZiAoIXRoaXMucmVtb3RlIHx8ICF0aGlzLnJlbW90ZS5pc0Nvbm5lY3RlZCkge1xuICAgIGxvZy5kZWJ1ZygnV2UgaGF2ZSBub3QgeWV0IGNvbm5lY3RlZCwgaWdub3JpbmcnKTtcbiAgICByZXR1cm47XG4gIH1cblxuICBjb25zdCB7YXBwSWRLZXksIHBhZ2VBcnJheX0gPSBwYWdlQ2hhbmdlTm90aWZpY2F0aW9uO1xuXG4gIGxldCBuZXdJZHMgPSBbXTtcbiAgbGV0IG5ld1BhZ2VzID0gW107XG4gIGxldCBrZXlJZCA9IG51bGw7XG5cbiAgLy8gQ2hlY2tzIGlmIGEgVVJMIGlzIGJsYWNrbGlzdGVkIGluIHRoZSAnc2FmYXJpSWdub3JlV2ViSG9zdG5hbWVzJyBjYXBhYmlsaXR5XG4gIGZ1bmN0aW9uIGlzVXJsSWdub3JlZCAodXJsLCBzYWZhcmlJZ25vcmVXZWJIb3N0bmFtZXMpIHtcbiAgICBjb25zdCBpZ25vcmVkSG9zdHMgPSAoc2FmYXJpSWdub3JlV2ViSG9zdG5hbWVzIHx8ICcnKVxuICAgICAgLnNwbGl0KCcsJylcbiAgICAgIC5tYXAoKGIpID0+IGIudHJpbSgpKVxuICAgICAgLmZpbHRlcigoYikgPT4gIV8uaXNFbXB0eShiKSk7XG4gICAgZm9yIChjb25zdCBpZ25vcmVkSG9zdCBvZiBpZ25vcmVkSG9zdHMpIHtcbiAgICAgIGlmIChpZ25vcmVkSG9zdCA9PT0gJ2Fib3V0OmJsYW5rJyAmJiB1cmwgPT09ICdhYm91dDpibGFuaycpIHtcbiAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICB0cnkge1xuICAgICAgICAgIGNvbnN0IGhvc3RuYW1lID0gbmV3IFVSTCh1cmwpLmhvc3RuYW1lO1xuICAgICAgICAgIGlmIChob3N0bmFtZSA9PT0gaWdub3JlZEhvc3QpIHtcbiAgICAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgICAgIH1cbiAgICAgICAgfSBjYXRjaCAoaWduKSB7XG4gICAgICAgICAgLy8gZG8gbm90aGluZyBpZiBpbnZhbGlkIFVSTFxuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuICAgIHJldHVybiBmYWxzZTtcbiAgfVxuXG4gIGZvciAoY29uc3QgcGFnZSBvZiBwYWdlQXJyYXkpIHtcbiAgICBjb25zdCBpZCA9IHBhZ2UuaWQudG9TdHJpbmcoKTtcbiAgICBuZXdJZHMucHVzaChpZCk7XG4gICAgaWYgKHBhZ2UuaXNLZXkpIHtcbiAgICAgIGtleUlkID0gaWQ7XG4gICAgfVxuICAgIGNvbnN0IGNvbnRleHRJZCA9IGAke2FwcElkS2V5fS4ke2lkfWA7XG5cbiAgICAvLyBhZGQgaWYgdGhpcyBpcyBhIG5ldyBwYWdlXG4gICAgaWYgKCFfLmluY2x1ZGVzKHRoaXMuY29udGV4dHMsIGNvbnRleHRJZCkpIHtcbiAgICAgIGlmIChpc1VybElnbm9yZWQocGFnZS51cmwsIHRoaXMub3B0cy5zYWZhcmlJZ25vcmVXZWJIb3N0bmFtZXMpKSB7XG4gICAgICAgIGxvZy5pbmZvKGBOb3QgdHJhY2tpbmcgJyR7cGFnZS51cmx9JyBwYWdlIGJlY2F1c2UgaXQgaXMgYmxhY2tsaXN0ZWQuIGAgK1xuICAgICAgICAgIGAnc2FmYXJpSWdub3JlV2ViSG9zdG5hbWVzJz0ke3RoaXMub3B0cy5zYWZhcmlJZ25vcmVXZWJIb3N0bmFtZXN9YCk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBuZXdQYWdlcy5wdXNoKGlkKTtcbiAgICAgICAgdGhpcy5jb250ZXh0cy5wdXNoKGNvbnRleHRJZCk7XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgaWYgKCFrZXlJZCkge1xuICAgIC8vIGlmIHRoZXJlIGlzIG5vIGtleSBpZCwgcHVsbCB0aGUgZmlyc3QgaWQgZnJvbSB0aGUgcGFnZSBhcnJheSBhbmQgdXNlIHRoYXRcbiAgICAvLyBhcyBhIHN0YW5kIGluXG4gICAgbG9nLmRlYnVnKCdObyBrZXkgaWQgZm91bmQuIENob29zaW5nIGZpcnN0IGlkIGZyb20gcGFnZSBhcnJheScpO1xuICAgIGtleUlkID0gbmV3SWRzWzBdIHx8IG51bGw7XG4gIH1cblxuICBpZiAoIXV0aWwuaGFzVmFsdWUodGhpcy5jdXJDb250ZXh0KSkge1xuICAgIGxvZy5kZWJ1ZygnV2UgZG8gbm90IGFwcGVhciB0byBoYXZlIHdpbmRvdyBzZXQgeWV0LCBpZ25vcmluZycpO1xuICAgIHJldHVybjtcbiAgfVxuXG4gIGNvbnN0IFtjdXJBcHBJZEtleSwgY3VyUGFnZUlkS2V5XSA9IHRoaXMuY3VyQ29udGV4dC5zcGxpdCgnLicpO1xuXG4gIGlmIChjdXJBcHBJZEtleSAhPT0gYXBwSWRLZXkpIHtcbiAgICBsb2cuZGVidWcoJ1BhZ2UgY2hhbmdlIG5vdCByZWZlcnJpbmcgdG8gY3VycmVudGx5IHNlbGVjdGVkIGFwcCwgaWdub3JpbmcuJyk7XG4gICAgcmV0dXJuO1xuICB9XG5cbiAgbGV0IG5ld1BhZ2UgPSBudWxsO1xuICBpZiAobmV3UGFnZXMubGVuZ3RoKSB7XG4gICAgbmV3UGFnZSA9IF8ubGFzdChuZXdQYWdlcyk7XG4gICAgbG9nLmRlYnVnKGBXZSBoYXZlIG5ldyBwYWdlcywgc2VsZWN0aW5nIHBhZ2UgJyR7bmV3UGFnZX0nYCk7XG4gIH0gZWxzZSBpZiAoIV8uaW5jbHVkZXMobmV3SWRzLCBjdXJQYWdlSWRLZXkpKSB7XG4gICAgbG9nLmRlYnVnKCdOZXcgcGFnZSBsaXN0aW5nIGZyb20gcmVtb3RlIGRlYnVnZ2VyIGRvZXMgbm90IGNvbnRhaW4gJyArXG4gICAgICAgICAgICAgICAgICdjdXJyZW50IHdpbmRvdzsgYXNzdW1pbmcgaXQgaXMgY2xvc2VkJyk7XG4gICAgaWYgKCF1dGlsLmhhc1ZhbHVlKGtleUlkKSkge1xuICAgICAgbG9nLmVycm9yKCdEbyBub3QgaGF2ZSBvdXIgY3VycmVudCB3aW5kb3cgYW55bW9yZSwgYW5kIHRoZXJlICcgK1xuICAgICAgICAgICAgICAgICAgICdhcmUgbm90IGFueSBtb3JlIHRvIGxvYWQhIERvaW5nIG5vdGhpbmcuLi4nKTtcbiAgICAgIHRoaXMuc2V0Q3VycmVudFVybCh1bmRlZmluZWQpO1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGxvZy5kZWJ1ZyhgRGVidWdnZXIgYWxyZWFkeSBzZWxlY3RlZCBwYWdlICcke2tleUlkfScsIGAgK1xuICAgICAgICAgICAgICAgICBgY29uZmlybWluZyB0aGF0IGNob2ljZS5gKTtcbiAgICB0aGlzLmN1ckNvbnRleHQgPSBgJHthcHBJZEtleX0uJHtrZXlJZH1gO1xuICAgIG5ld1BhZ2UgPSBrZXlJZDtcbiAgfSBlbHNlIHtcbiAgICAvLyBhdCB0aGlzIHBvaW50LCB0aGVyZSBhcmUgbm8gbmV3IHBhZ2VzLCBhbmQgdGhlIGN1cnJlbnQgcGFnZSBzdGlsbCBleGlzdHNcbiAgICBsb2cuZGVidWcoJ0NoZWNraW5nIGlmIHBhZ2UgbmVlZHMgdG8gbG9hZCcpO1xuICAgIC8vIElmIGEgd2luZG93IG5hdmlnYXRlcyB0byBhbiBhbmNob3IgaXQgZG9lc24ndCBhbHdheXMgZmlyZSBhIHBhZ2VcbiAgICAvLyBjYWxsYmFjayBldmVudC4gTGV0J3MgY2hlY2sgaWYgd2Ugd291bmQgdXAgaW4gc3VjaCBhIHNpdHVhdGlvbi5cbiAgICBjb25zdCBuZWVkc1BhZ2VMb2FkID0gKCgpID0+IHtcbiAgICAgIC8vIG5lZWQgdG8gbWFwIHRoZSBwYWdlIGlkcyB0byBjb250ZXh0IGlkc1xuICAgICAgY29uc3QgY29udGV4dEFycmF5ID0gXy5tYXAocGFnZUFycmF5LCAocGFnZSkgPT4gYCR7YXBwSWRLZXl9LiR7cGFnZS5pZH1gKTtcbiAgICAgIC8vIGNoZWNrIGlmIHRoZSBjdXJyZW50IGNvbnRleHQgZXhpc3RzIGluIGJvdGggb3VyIHJlY29yZGVkIGNvbnRleHRzLFxuICAgICAgLy8gYW5kIHRoZSBwYWdlIGFycmF5XG4gICAgICByZXR1cm4gIV8uaXNFcXVhbChfLmZpbmQodGhpcy5jb250ZXh0cywgdGhpcy5jdXJDb250ZXh0KSwgXy5maW5kKGNvbnRleHRBcnJheSwgdGhpcy5jdXJDb250ZXh0KSk7XG4gICAgfSkoKTtcblxuICAgIGlmIChuZWVkc1BhZ2VMb2FkKSB7XG4gICAgICBsb2cuZGVidWcoJ1BhZ2UgbG9hZCBuZWVkZWQuIExvYWRpbmcuLi4nKTtcbiAgICAgIGF3YWl0IHRoaXMucmVtb3RlLnBhZ2VMb2FkKCk7XG4gICAgfVxuXG4gICAgbG9nLmRlYnVnKCdOZXcgcGFnZSBsaXN0aW5nIGlzIHNhbWUgYXMgb2xkLCBkb2luZyBub3RoaW5nJyk7XG4gIH1cblxuICAvLyBtYWtlIHN1cmUgdGhhdCB0aGUgcGFnZSBsaXN0aW5nIGlzbid0IGluZGljYXRpbmcgYSByZWRpcmVjdFxuICBpZiAodXRpbC5oYXNWYWx1ZSh0aGlzLmN1ckNvbnRleHQpKSB7XG4gICAgbGV0IGN1cnJlbnRQYWdlSWQgPSBwYXJzZUludChfLmxhc3QodGhpcy5jdXJDb250ZXh0LnNwbGl0KCcuJykpLCAxMCk7XG4gICAgbGV0IHBhZ2UgPSBfLmZpbmQocGFnZUFycmF5LCAocCkgPT4gcGFyc2VJbnQocC5pZCwgMTApID09PSBjdXJyZW50UGFnZUlkKTtcbiAgICBpZiAocGFnZSAmJiBwYWdlLnVybCAhPT0gdGhpcy5nZXRDdXJyZW50VXJsKCkpIHtcbiAgICAgIGxvZy5kZWJ1ZyhgUmVkaXJlY3RlZCBmcm9tICcke3RoaXMuZ2V0Q3VycmVudFVybCgpfScgdG8gJyR7cGFnZS51cmx9J2ApO1xuICAgICAgdGhpcy5zZXRDdXJyZW50VXJsKHBhZ2UudXJsKTtcbiAgICB9XG4gIH1cblxuICBpZiAodXRpbC5oYXNWYWx1ZShuZXdQYWdlKSkge1xuICAgIHRoaXMuc2VsZWN0aW5nTmV3UGFnZSA9IHRydWU7XG4gICAgY29uc3Qgb2xkQ29udGV4dCA9IHRoaXMuY3VyQ29udGV4dDtcbiAgICB0aGlzLmN1ckNvbnRleHQgPSBgJHthcHBJZEtleX0uJHtuZXdQYWdlfWA7XG4gICAgLy8gZG8gbm90IHdhaXQsIGFzIHRoaXMgY2FuIHRha2UgYSBsb25nIHRpbWUsIGFuZCB0aGUgcmVzcG9uc2UgaXMgbm90IG5lY2Vzc2FyeVxuICAgIHRoaXMucmVtb3RlLnNlbGVjdFBhZ2UoYXBwSWRLZXksIHBhcnNlSW50KG5ld1BhZ2UsIDEwKSlcbiAgICAgIC5jYXRjaCgoZXJyKSA9PiB7IC8vIGVzbGludC1kaXNhYmxlLWxpbmUgcHJvbWlzZS9wcmVmZXItYXdhaXQtdG8tY2FsbGJhY2tzXG4gICAgICAgIGxvZy53YXJuKGBGYWlsZWQgdG8gc2VsZWN0IHBhZ2U6ICR7ZXJyLm1lc3NhZ2V9YCk7XG4gICAgICAgIHRoaXMuY3VyQ29udGV4dCA9IG9sZENvbnRleHQ7XG4gICAgICB9KTtcbiAgICB0aGlzLnNlbGVjdGluZ05ld1BhZ2UgPSBmYWxzZTtcbiAgfVxuICB0aGlzLndpbmRvd0hhbmRsZUNhY2hlID0gcGFnZUFycmF5O1xufTtcblxuXG5PYmplY3QuYXNzaWduKGV4dGVuc2lvbnMsIGNvbW1hbmRzLCBoZWxwZXJzKTtcbmV4cG9ydCBkZWZhdWx0IGV4dGVuc2lvbnM7XG4iXSwiZmlsZSI6ImxpYi9jb21tYW5kcy9jb250ZXh0LmpzIiwic291cmNlUm9vdCI6Ii4uLy4uLy4uIn0=
