"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = exports.commands = void 0;

require("source-map-support/register");

var _lodash = _interopRequireDefault(require("lodash"));

var _path = _interopRequireDefault(require("path"));

var _appiumSupport = require("appium-support");

var _teen_process = require("teen_process");

var _logger = _interopRequireDefault(require("../logger"));

var _utils = require("../utils");

var _asyncbox = require("asyncbox");

var _bluebird = _interopRequireDefault(require("bluebird"));

const commands = {};
exports.commands = commands;
const PERF_RECORD_FEAT_NAME = 'perf_record';
const PERF_RECORD_SECURITY_MESSAGE = 'Performance measurement requires relaxing security for simulator. ' + `Please set '--relaxed-security' or '--allow-insecure' with '${PERF_RECORD_FEAT_NAME}' ` + 'referencing https://github.com/appium/appium/blob/master/docs/en/writing-running-appium/security.md for more details.';
const DEFAULT_TIMEOUT_MS = 5 * 60 * 1000;
const STOP_TIMEOUT_MS = 3 * 60 * 1000;
const STARTUP_TIMEOUT_MS = 60 * 1000;
const DEFAULT_PROFILE_NAME = 'Activity Monitor';
const DEFAULT_EXT = '.trace';
const DEFAULT_PID = 'current';
const INSTRUMENTS = 'instruments';
const XCRUN = 'xcrun';
const XCTRACE = 'xctrace';

async function requireXctrace() {
  let xcrunPath;

  try {
    xcrunPath = await _appiumSupport.fs.which(XCRUN);
  } catch (e) {
    _logger.default.errorAndThrow(`${XCRUN} has not been found in PATH. ` + `Please make sure XCode development tools are installed`);
  }

  try {
    await (0, _teen_process.exec)(xcrunPath, [XCTRACE, 'help']);
  } catch (e) {
    _logger.default.errorAndThrow(`${XCTRACE} is not available for the active Xcode version. ` + `Please make sure XCode is up to date. Original error: ${e.stderr || e.message}`);
  }

  return xcrunPath;
}

async function requireInstruments() {
  try {
    return await _appiumSupport.fs.which(INSTRUMENTS);
  } catch (e) {
    _logger.default.errorAndThrow(`${INSTRUMENTS} has not been found in PATH. ` + `Please make sure XCode development tools are installed`);
  }
}

class PerfRecorder {
  constructor(reportRoot, udid, opts = {}) {
    this._process = null;
    this._zippedReportPath = '';
    this._timeout = opts.timeout && opts.timeout > 0 ? opts.timeout : DEFAULT_TIMEOUT_MS;
    this._profileName = opts.profileName || DEFAULT_PROFILE_NAME;
    this._reportPath = _path.default.resolve(reportRoot, `appium_perf__${this._profileName.replace(/\W/g, '_')}__${Date.now()}${DEFAULT_EXT}`);
    this._pid = opts.pid;
    this._udid = udid;
    this._logger = _appiumSupport.logger.getLogger(`${_lodash.default.truncate(this._profileName, {
      length: 10
    })}@${this._udid.substring(0, 8)}`);
    this._archivePromise = null;
  }

  get profileName() {
    return this._profileName;
  }

  async getOriginalReportPath() {
    return (await _appiumSupport.fs.exists(this._reportPath)) ? this._reportPath : '';
  }

  async getZippedReportPath() {
    if (!this._archivePromise) {
      this._archivePromise = (async () => {
        const originalReportPath = await this.getOriginalReportPath();

        if (!originalReportPath) {
          return '';
        }

        const zippedReportPath = await _appiumSupport.tempDir.path({
          prefix: _path.default.parse(originalReportPath).name,
          suffix: '.zip'
        });
        await _appiumSupport.zip.toArchive(zippedReportPath, {
          cwd: _path.default.dirname(this._reportPath)
        });
        await _appiumSupport.fs.rimraf(_path.default.dirname(this._reportPath));
        this._zippedReportPath = zippedReportPath;
        return this._zippedReportPath;
      })();
    }

    return await this._archivePromise;
  }

  isRunning() {
    var _this$_process;

    return !!((_this$_process = this._process) !== null && _this$_process !== void 0 && _this$_process.isRunning);
  }

  async _enforceTermination() {
    if (this._process && this.isRunning()) {
      this._logger.debug('Force-stopping the currently running perf recording');

      try {
        await this._process.stop('SIGKILL');
      } catch (ign) {}
    }

    this._process = null;

    const performCleanup = async () => {
      try {
        await _bluebird.default.all([this._zippedReportPath, _path.default.dirname(this._reportPath)].filter(Boolean).map(x => _appiumSupport.fs.rimraf(x)));
      } catch (e) {
        this._logger.warn(e.message);
      }
    };

    if (this._archivePromise) {
      this._archivePromise.finally(async () => {
        await performCleanup();
        this._archivePromise = null;
      }).catch(() => {});
    }

    await performCleanup();
    return '';
  }

  async start() {
    let binaryPath;

    try {
      binaryPath = await requireXctrace();
    } catch (e) {
      _logger.default.debug(e.message);

      _logger.default.info(`Defaulting to ${INSTRUMENTS} usage`);

      binaryPath = await requireInstruments();
    }

    const args = [];
    const toolName = _path.default.basename(binaryPath) === XCRUN ? XCTRACE : INSTRUMENTS;

    if (toolName === XCTRACE) {
      args.push(XCTRACE, 'record', '--device', this._udid, '--template', this._profileName, '--output', this._reportPath, '--time-limit', `${this._timeout}ms`);

      if (this._pid) {
        args.push('--attach', `${this._pid}`);
      } else {
        args.push('--all-processes');
      }
    } else {
      args.push('-w', this._udid, '-t', this._profileName, '-D', this._reportPath, '-l', `${this._timeout}`);

      if (this._pid) {
        args.push('-p', `${this._pid}`);
      }
    }

    const fullCmd = [binaryPath, ...args];
    this._process = new _teen_process.SubProcess(fullCmd[0], fullCmd.slice(1));
    this._archivePromise = null;

    this._logger.debug(`Starting performance recording: ${_appiumSupport.util.quote(fullCmd)}`);

    this._process.on('output', (stdout, stderr) => {
      if (_lodash.default.trim(stdout || stderr)) {
        this._logger.debug(`[${toolName}] ${stdout || stderr}`);
      }
    });

    this._process.once('exit', async (code, signal) => {
      this._process = null;

      if (code === 0) {
        this._logger.debug('Performance recording exited without errors');

        try {
          await this.getZippedReportPath();
        } catch (e) {
          this._logger.warn(e);
        }
      } else {
        await this._enforceTermination();

        this._logger.warn(`Performance recording exited with error code ${code}, signal ${signal}`);
      }
    });

    await this._process.start(0);

    try {
      await (0, _asyncbox.waitForCondition)(async () => {
        if (await this.getOriginalReportPath()) {
          return true;
        }

        if (!this._process) {
          throw new Error(`${toolName} process died unexpectedly`);
        }

        return false;
      }, {
        waitMs: STARTUP_TIMEOUT_MS,
        intervalMs: 500
      });
    } catch (e) {
      await this._enforceTermination();
      const listProfilesCommand = toolName === XCTRACE ? `${XCRUN} ${XCTRACE} list templates` : `${INSTRUMENTS} -s`;

      this._logger.errorAndThrow(`There is no ${DEFAULT_EXT} file found for performance profile ` + `'${this._profileName}'. Make sure the profile is supported on this device. ` + `You could use '${listProfilesCommand}' command to see the list of all available profiles. ` + `Check the server log for more details`);
    }

    this._logger.info(`The performance recording has started. Will timeout in ${this._timeout}ms`);
  }

  async stop(force = false) {
    if (force) {
      return await this._enforceTermination();
    }

    if (!this.isRunning()) {
      this._logger.debug('Performance recording is not running. Returning the recent result');

      return await this.getZippedReportPath();
    }

    try {
      await this._process.stop('SIGINT', STOP_TIMEOUT_MS);
    } catch (e) {
      this._logger.errorAndThrow(`Performance recording has failed to exit after ${STOP_TIMEOUT_MS}ms`);
    }

    return await this.getZippedReportPath();
  }

}

commands.mobileStartPerfRecord = async function mobileStartPerfRecord(opts = {}) {
  if (!this.isFeatureEnabled(PERF_RECORD_FEAT_NAME) && !this.isRealDevice()) {
    _logger.default.errorAndThrow(PERF_RECORD_SECURITY_MESSAGE);
  }

  const {
    timeout = DEFAULT_TIMEOUT_MS,
    profileName = DEFAULT_PROFILE_NAME,
    pid
  } = opts;

  if (!_lodash.default.isEmpty(this._perfRecorders)) {
    for (const recorder of this._perfRecorders.filter(x => x.profileName === profileName)) {
      if (recorder.isRunning()) {
        _logger.default.debug(`Performance recorder for '${profileName}' on device '${this.opts.device.udid}' ` + ` is already running. Doing nothing`);

        return;
      }

      _lodash.default.pull(this._perfRecorders, recorder);

      await recorder.stop(true);
    }
  }

  let realPid;

  if (pid) {
    if (_lodash.default.toLower(pid) === DEFAULT_PID) {
      const appInfo = await this.proxyCommand('/wda/activeAppInfo', 'GET');
      realPid = appInfo.pid;
    } else {
      realPid = pid;
    }
  }

  const recorder = new PerfRecorder(await _appiumSupport.tempDir.openDir(), this.opts.device.udid, {
    timeout: parseInt(timeout, 10),
    profileName,
    pid: parseInt(realPid, 10)
  });
  await recorder.start();
  this._perfRecorders = [...(this._perfRecorders || []), recorder];
};

commands.mobileStopPerfRecord = async function mobileStopPerfRecord(opts = {}) {
  if (!this.isFeatureEnabled(PERF_RECORD_FEAT_NAME) && !this.isRealDevice()) {
    _logger.default.errorAndThrow(PERF_RECORD_SECURITY_MESSAGE);
  }

  if (_lodash.default.isEmpty(this._perfRecorders)) {
    _logger.default.info('No performance recorders have been started. Doing nothing');

    return '';
  }

  const {
    profileName = DEFAULT_PROFILE_NAME,
    remotePath
  } = opts;

  const recorders = this._perfRecorders.filter(x => x.profileName === profileName);

  if (_lodash.default.isEmpty(recorders)) {
    _logger.default.errorAndThrow(`There are no records for performance profile '${profileName}' ` + `and device ${this.opts.device.udid}. Have you started the profiling before?`);
  }

  const recorder = _lodash.default.first(recorders);

  const resultPath = await recorder.stop();

  if (!(await _appiumSupport.fs.exists(resultPath))) {
    _logger.default.errorAndThrow(`There is no ${DEFAULT_EXT} file found for performance profile '${profileName}' ` + `and device ${this.opts.device.udid}. Make sure the selected profile is supported on this device`);
  }

  const result = await (0, _utils.encodeBase64OrUpload)(resultPath, remotePath, opts);

  _lodash.default.pull(this._perfRecorders, recorder);

  await _appiumSupport.fs.rimraf(resultPath);
  return result;
};

var _default = commands;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9jb21tYW5kcy9wZXJmb3JtYW5jZS5qcyJdLCJuYW1lcyI6WyJjb21tYW5kcyIsIlBFUkZfUkVDT1JEX0ZFQVRfTkFNRSIsIlBFUkZfUkVDT1JEX1NFQ1VSSVRZX01FU1NBR0UiLCJERUZBVUxUX1RJTUVPVVRfTVMiLCJTVE9QX1RJTUVPVVRfTVMiLCJTVEFSVFVQX1RJTUVPVVRfTVMiLCJERUZBVUxUX1BST0ZJTEVfTkFNRSIsIkRFRkFVTFRfRVhUIiwiREVGQVVMVF9QSUQiLCJJTlNUUlVNRU5UUyIsIlhDUlVOIiwiWENUUkFDRSIsInJlcXVpcmVYY3RyYWNlIiwieGNydW5QYXRoIiwiZnMiLCJ3aGljaCIsImUiLCJsb2ciLCJlcnJvckFuZFRocm93Iiwic3RkZXJyIiwibWVzc2FnZSIsInJlcXVpcmVJbnN0cnVtZW50cyIsIlBlcmZSZWNvcmRlciIsImNvbnN0cnVjdG9yIiwicmVwb3J0Um9vdCIsInVkaWQiLCJvcHRzIiwiX3Byb2Nlc3MiLCJfemlwcGVkUmVwb3J0UGF0aCIsIl90aW1lb3V0IiwidGltZW91dCIsIl9wcm9maWxlTmFtZSIsInByb2ZpbGVOYW1lIiwiX3JlcG9ydFBhdGgiLCJwYXRoIiwicmVzb2x2ZSIsInJlcGxhY2UiLCJEYXRlIiwibm93IiwiX3BpZCIsInBpZCIsIl91ZGlkIiwiX2xvZ2dlciIsImxvZ2dlciIsImdldExvZ2dlciIsIl8iLCJ0cnVuY2F0ZSIsImxlbmd0aCIsInN1YnN0cmluZyIsIl9hcmNoaXZlUHJvbWlzZSIsImdldE9yaWdpbmFsUmVwb3J0UGF0aCIsImV4aXN0cyIsImdldFppcHBlZFJlcG9ydFBhdGgiLCJvcmlnaW5hbFJlcG9ydFBhdGgiLCJ6aXBwZWRSZXBvcnRQYXRoIiwidGVtcERpciIsInByZWZpeCIsInBhcnNlIiwibmFtZSIsInN1ZmZpeCIsInppcCIsInRvQXJjaGl2ZSIsImN3ZCIsImRpcm5hbWUiLCJyaW1yYWYiLCJpc1J1bm5pbmciLCJfZW5mb3JjZVRlcm1pbmF0aW9uIiwiZGVidWciLCJzdG9wIiwiaWduIiwicGVyZm9ybUNsZWFudXAiLCJCIiwiYWxsIiwiZmlsdGVyIiwiQm9vbGVhbiIsIm1hcCIsIngiLCJ3YXJuIiwiZmluYWxseSIsImNhdGNoIiwic3RhcnQiLCJiaW5hcnlQYXRoIiwiaW5mbyIsImFyZ3MiLCJ0b29sTmFtZSIsImJhc2VuYW1lIiwicHVzaCIsImZ1bGxDbWQiLCJTdWJQcm9jZXNzIiwic2xpY2UiLCJ1dGlsIiwicXVvdGUiLCJvbiIsInN0ZG91dCIsInRyaW0iLCJvbmNlIiwiY29kZSIsInNpZ25hbCIsIkVycm9yIiwid2FpdE1zIiwiaW50ZXJ2YWxNcyIsImxpc3RQcm9maWxlc0NvbW1hbmQiLCJmb3JjZSIsIm1vYmlsZVN0YXJ0UGVyZlJlY29yZCIsImlzRmVhdHVyZUVuYWJsZWQiLCJpc1JlYWxEZXZpY2UiLCJpc0VtcHR5IiwiX3BlcmZSZWNvcmRlcnMiLCJyZWNvcmRlciIsImRldmljZSIsInB1bGwiLCJyZWFsUGlkIiwidG9Mb3dlciIsImFwcEluZm8iLCJwcm94eUNvbW1hbmQiLCJvcGVuRGlyIiwicGFyc2VJbnQiLCJtb2JpbGVTdG9wUGVyZlJlY29yZCIsInJlbW90ZVBhdGgiLCJyZWNvcmRlcnMiLCJmaXJzdCIsInJlc3VsdFBhdGgiLCJyZXN1bHQiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7O0FBQUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBRUEsTUFBTUEsUUFBUSxHQUFHLEVBQWpCOztBQUVBLE1BQU1DLHFCQUFxQixHQUFHLGFBQTlCO0FBQ0EsTUFBTUMsNEJBQTRCLEdBQUcsdUVBQ2xDLCtEQUE4REQscUJBQXNCLElBRGxELEdBRW5DLHVIQUZGO0FBR0EsTUFBTUUsa0JBQWtCLEdBQUcsSUFBSSxFQUFKLEdBQVMsSUFBcEM7QUFDQSxNQUFNQyxlQUFlLEdBQUcsSUFBSSxFQUFKLEdBQVMsSUFBakM7QUFDQSxNQUFNQyxrQkFBa0IsR0FBRyxLQUFLLElBQWhDO0FBQ0EsTUFBTUMsb0JBQW9CLEdBQUcs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QWxCOztBQUNBLE1BQUlhLGdCQUFFNkQsT0FBRixDQUFVYSxTQUFWLENBQUosRUFBMEI7QUFDeEJ0RyxvQkFBSUMsYUFBSixDQUFtQixpREFBZ0RjLFdBQVksSUFBN0QsR0FDZixjQUFhLEtBQUtOLElBQUwsQ0FBVW1GLE1BQVYsQ0FBaUJwRixJQUFLLDBDQUR0QztBQUVEOztBQUVELFFBQU1tRixRQUFRLEdBQUcvRCxnQkFBRTJFLEtBQUYsQ0FBUUQsU0FBUixDQUFqQjs7QUFDQSxRQUFNRSxVQUFVLEdBQUcsTUFBTWIsUUFBUSxDQUFDeEMsSUFBVCxFQUF6Qjs7QUFDQSxNQUFJLEVBQUMsTUFBTXRELGtCQUFHcUMsTUFBSCxDQUFVc0UsVUFBVixDQUFQLENBQUosRUFBa0M7QUFDaEN4RyxvQkFBSUMsYUFBSixDQUFtQixlQUFjWCxXQUFZLHdDQUF1Q3lCLFdBQVksSUFBOUUsR0FDZixjQUFhLEtBQUtOLElBQUwsQ0FBVW1GLE1BQVYsQ0FBaUJwRixJQUFLLDhEQUR0QztBQUVEOztBQUVELFFBQU1pRyxNQUFNLEdBQUcsTUFBTSxpQ0FBcUJELFVBQXJCLEVBQWlDSCxVQUFqQyxFQUE2QzVGLElBQTdDLENBQXJCOztBQUNBbUIsa0JBQUVpRSxJQUFGLENBQU8sS0FBS0gsY0FBWixFQUE0QkMsUUFBNUI7O0FBQ0EsUUFBTTlGLGtCQUFHa0QsTUFBSCxDQUFVeUQsVUFBVixDQUFOO0FBQ0EsU0FBT0MsTUFBUDtBQUNELENBaENEOztlQW9DZTFILFEiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgXyBmcm9tICdsb2Rhc2gnO1xuaW1wb3J0IHBhdGggZnJvbSAncGF0aCc7XG5pbXBvcnQgeyBmcywgemlwLCBsb2dnZXIsIHV0aWwsIHRlbXBEaXIgfSBmcm9tICdhcHBpdW0tc3VwcG9ydCc7XG5pbXBvcnQgeyBTdWJQcm9jZXNzLCBleGVjIH0gZnJvbSAndGVlbl9wcm9jZXNzJztcbmltcG9ydCBsb2cgZnJvbSAnLi4vbG9nZ2VyJztcbmltcG9ydCB7IGVuY29kZUJhc2U2NE9yVXBsb2FkIH0gZnJvbSAnLi4vdXRpbHMnO1xuaW1wb3J0IHsgd2FpdEZvckNvbmRpdGlvbiB9IGZyb20gJ2FzeW5jYm94JztcbmltcG9ydCBCIGZyb20gJ2JsdWViaXJkJztcblxuY29uc3QgY29tbWFuZHMgPSB7fTtcblxuY29uc3QgUEVSRl9SRUNPUkRfRkVBVF9OQU1FID0gJ3BlcmZfcmVjb3JkJztcbmNvbnN0IFBFUkZfUkVDT1JEX1NFQ1VSSVRZX01FU1NBR0UgPSAnUGVyZm9ybWFuY2UgbWVhc3VyZW1lbnQgcmVxdWlyZXMgcmVsYXhpbmcgc2VjdXJpdHkgZm9yIHNpbXVsYXRvci4gJyArXG4gIGBQbGVhc2Ugc2V0ICctLXJlbGF4ZWQtc2VjdXJpdHknIG9yICctLWFsbG93LWluc2VjdXJlJyB3aXRoICcke1BFUkZfUkVDT1JEX0ZFQVRfTkFNRX0nIGAgK1xuICAncmVmZXJlbmNpbmcgaHR0cHM6Ly9naXRodWIuY29tL2FwcGl1bS9hcHBpdW0vYmxvYi9tYXN0ZXIvZG9jcy9lbi93cml0aW5nLXJ1bm5pbmctYXBwaXVtL3NlY3VyaXR5Lm1kIGZvciBtb3JlIGRldGFpbHMuJztcbmNvbnN0IERFRkFVTFRfVElNRU9VVF9NUyA9IDUgKiA2MCAqIDEwMDA7XG5jb25zdCBTVE9QX1RJTUVPVVRfTVMgPSAzICogNjAgKiAxMDAwO1xuY29uc3QgU1RBUlRVUF9USU1FT1VUX01TID0gNjAgKiAxMDAwO1xuY29uc3QgREVGQVVMVF9QUk9GSUxFX05BTUUgPSAnQWN0aXZpdHkgTW9uaXRvcic7XG5jb25zdCBERUZBVUxUX0VYVCA9ICcudHJhY2UnO1xuY29uc3QgREVGQVVMVF9QSUQgPSAnY3VycmVudCc7XG5jb25zdCBJTlNUUlVNRU5UUyA9ICdpbnN0cnVtZW50cyc7XG5jb25zdCBYQ1JVTiA9ICd4Y3J1bic7XG5jb25zdCBYQ1RSQUNFID0gJ3hjdHJhY2UnO1xuXG5cbmFzeW5jIGZ1bmN0aW9uIHJlcXVpcmVYY3RyYWNlICgpIHtcbiAgbGV0IHhjcnVuUGF0aDtcbiAgdHJ5IHtcbiAgICB4Y3J1blBhdGggPSBhd2FpdCBmcy53aGljaChYQ1JVTik7XG4gIH0gY2F0Y2ggKGUpIHtcbiAgICBsb2cuZXJyb3JBbmRUaHJvdyhgJHtYQ1JVTn0gaGFzIG5vdCBiZWVuIGZvdW5kIGluIFBBVEguIGAgK1xuICAgICAgYFBsZWFzZSBtYWtlIHN1cmUgWENvZGUgZGV2ZWxvcG1lbnQgdG9vbHMgYXJlIGluc3RhbGxlZGApO1xuICB9XG4gIHRyeSB7XG4gICAgYXdhaXQgZXhlYyh4Y3J1blBhdGgsIFtYQ1RSQUNFLCAnaGVscCddKTtcbiAgfSBjYXRjaCAoZSkge1xuICAgIGxvZy5lcnJvckFuZFRocm93KGAke1hDVFJBQ0V9IGlzIG5vdCBhdmFpbGFibGUgZm9yIHRoZSBhY3RpdmUgWGNvZGUgdmVyc2lvbi4gYCArXG4gICAgICBgUGxlYXNlIG1ha2Ugc3VyZSBYQ29kZSBpcyB1cCB0byBkYXRlLiBPcmlnaW5hbCBlcnJvcjogJHtlLnN0ZGVyciB8fCBlLm1lc3NhZ2V9YCk7XG4gIH1cbiAgcmV0dXJuIHhjcnVuUGF0aDtcbn1cblxuYXN5bmMgZnVuY3Rpb24gcmVxdWlyZUluc3RydW1lbnRzICgpIHtcbiAgdHJ5IHtcbiAgICByZXR1cm4gYXdhaXQgZnMud2hpY2goSU5TVFJVTUVOVFMpO1xuICB9IGNhdGNoIChlKSB7XG4gICAgbG9nLmVycm9yQW5kVGhyb3coYCR7SU5TVFJVTUVOVFN9IGhhcyBub3QgYmVlbiBmb3VuZCBpbiBQQVRILiBgICtcbiAgICAgIGBQbGVhc2UgbWFrZSBzdXJlIFhDb2RlIGRldmVsb3BtZW50IHRvb2xzIGFyZSBpbnN0YWxsZWRgKTtcbiAgfVxufVxuXG5cbmNsYXNzIFBlcmZSZWNvcmRlciB7XG4gIGNvbnN0cnVjdG9yIChyZXBvcnRSb290LCB1ZGlkLCBvcHRzID0ge30pIHtcbiAgICB0aGlzLl9wcm9jZXNzID0gbnVsbDtcbiAgICB0aGlzLl96aXBwZWRSZXBvcnRQYXRoID0gJyc7XG4gICAgdGhpcy5fdGltZW91dCA9IChvcHRzLnRpbWVvdXQgJiYgb3B0cy50aW1lb3V0ID4gMCkgPyBvcHRzLnRpbWVvdXQgOiBERUZBVUxUX1RJTUVPVVRfTVM7XG4gICAgdGhpcy5fcHJvZmlsZU5hbWUgPSBvcHRzLnByb2ZpbGVOYW1lIHx8IERFRkFVTFRfUFJPRklMRV9OQU1FO1xuICAgIHRoaXMuX3JlcG9ydFBhdGggPSBwYXRoLnJlc29sdmUocmVwb3J0Um9vdCxcbiAgICAgIGBhcHBpdW1fcGVyZl9fJHt0aGlzLl9wcm9maWxlTmFtZS5yZXBsYWNlKC9cXFcvZywgJ18nKX1fXyR7RGF0ZS5ub3coKX0ke0RFRkFVTFRfRVhUfWApO1xuICAgIHRoaXMuX3BpZCA9IG9wdHMucGlkO1xuICAgIHRoaXMuX3VkaWQgPSB1ZGlkO1xuICAgIHRoaXMuX2xvZ2dlciA9IGxvZ2dlci5nZXRMb2dnZXIoXG4gICAgICBgJHtfLnRydW5jYXRlKHRoaXMuX3Byb2ZpbGVOYW1lLCB7bGVuZ3RoOiAxMH0pfUAke3RoaXMuX3VkaWQuc3Vic3RyaW5nKDAsIDgpfWApO1xuICAgIHRoaXMuX2FyY2hpdmVQcm9taXNlID0gbnVsbDtcbiAgfVxuXG4gIGdldCBwcm9maWxlTmFtZSAoKSB7XG4gICAgcmV0dXJuIHRoaXMuX3Byb2ZpbGVOYW1lO1xuICB9XG5cbiAgYXN5bmMgZ2V0T3JpZ2luYWxSZXBvcnRQYXRoICgpIHtcbiAgICByZXR1cm4gKGF3YWl0IGZzLmV4aXN0cyh0aGlzLl9yZXBvcnRQYXRoKSkgPyB0aGlzLl9yZXBvcnRQYXRoIDogJyc7XG4gIH1cblxuICBhc3luYyBnZXRaaXBwZWRSZXBvcnRQYXRoICgpIHtcbiAgICAvLyBUaGlzIGlzIHRvIHByZXZlbnQgcG9zc2libGUgcmFjZSBjb25kaXRpb25zLCBiZWNhdXNlIHRoZSBhcmNoaXZlIG9wZXJhdGlvblxuICAgIC8vIGNvdWxkIGJlIHByZXR0eSB0aW1lLWludGVuc2l2ZVxuICAgIGlmICghdGhpcy5fYXJjaGl2ZVByb21pc2UpIHtcbiAgICAgIHRoaXMuX2FyY2hpdmVQcm9taXNlID0gKGFzeW5jICgpID0+IHtcbiAgICAgICAgY29uc3Qgb3JpZ2luYWxSZXBvcnRQYXRoID0gYXdhaXQgdGhpcy5nZXRPcmlnaW5hbFJlcG9ydFBhdGgoKTtcbiAgICAgICAgaWYgKCFvcmlnaW5hbFJlcG9ydFBhdGgpIHtcbiAgICAgICAgICByZXR1cm4gJyc7XG4gICAgICAgIH1cbiAgICAgICAgY29uc3QgemlwcGVkUmVwb3J0UGF0aCA9IGF3YWl0IHRlbXBEaXIucGF0aCh7XG4gICAgICAgICAgcHJlZml4OiBwYXRoLnBhcnNlKG9yaWdpbmFsUmVwb3J0UGF0aCkubmFtZSxcbiAgICAgICAgICBzdWZmaXg6ICcuemlwJ1xuICAgICAgICB9KTtcbiAgICAgICAgYXdhaXQgemlwLnRvQXJjaGl2ZSh6aXBwZWRSZXBvcnRQYXRoLCB7XG4gICAgICAgICAgY3dkOiBwYXRoLmRpcm5hbWUodGhpcy5fcmVwb3J0UGF0aCksXG4gICAgICAgIH0pO1xuICAgICAgICBhd2FpdCBmcy5yaW1yYWYocGF0aC5kaXJuYW1lKHRoaXMuX3JlcG9ydFBhdGgpKTtcbiAgICAgICAgdGhpcy5femlwcGVkUmVwb3J0UGF0aCA9IHppcHBlZFJlcG9ydFBhdGg7XG4gICAgICAgIHJldHVybiB0aGlzLl96aXBwZWRSZXBvcnRQYXRoO1xuICAgICAgfSkoKTtcbiAgICB9XG4gICAgcmV0dXJuIGF3YWl0IHRoaXMuX2FyY2hpdmVQcm9taXNlO1xuICB9XG5cbiAgaXNSdW5uaW5nICgpIHtcbiAgICByZXR1cm4gISEodGhpcy5fcHJvY2Vzcz8uaXNSdW5uaW5nKTtcbiAgfVxuXG4gIGFzeW5jIF9lbmZvcmNlVGVybWluYXRpb24gKCkge1xuICAgIGlmICh0aGlzLl9wcm9jZXNzICYmIHRoaXMuaXNSdW5uaW5nKCkpIHtcbiAgICAgIHRoaXMuX2xvZ2dlci5kZWJ1ZygnRm9yY2Utc3RvcHBpbmcgdGhlIGN1cnJlbnRseSBydW5uaW5nIHBlcmYgcmVjb3JkaW5nJyk7XG4gICAgICB0cnkge1xuICAgICAgICBhd2FpdCB0aGlzLl9wcm9jZXNzLnN0b3AoJ1NJR0tJTEwnKTtcbiAgICAgIH0gY2F0Y2ggKGlnbikge31cbiAgICB9XG4gICAgdGhpcy5fcHJvY2VzcyA9IG51bGw7XG4gICAgY29uc3QgcGVyZm9ybUNsZWFudXAgPSBhc3luYyAoKSA9PiB7XG4gICAgICB0cnkge1xuICAgICAgICBhd2FpdCBCLmFsbChbdGhpcy5femlwcGVkUmVwb3J0UGF0aCwgcGF0aC5kaXJuYW1lKHRoaXMuX3JlcG9ydFBhdGgpXVxuICAgICAgICAgIC5maWx0ZXIoQm9vbGVhbikubWFwKCh4KSA9PiBmcy5yaW1yYWYoeCkpKTtcbiAgICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgdGhpcy5fbG9nZ2VyLndhcm4oZS5tZXNzYWdlKTtcbiAgICAgIH1cbiAgICB9O1xuICAgIGlmICh0aGlzLl9hcmNoaXZlUHJvbWlzZSkge1xuICAgICAgdGhpcy5fYXJjaGl2ZVByb21pc2VcbiAgICAgICAgLmZpbmFsbHkoYXN5bmMgKCkgPT4ge1xuICAgICAgICAgIGF3YWl0IHBlcmZvcm1DbGVhbnVwKCk7XG4gICAgICAgICAgdGhpcy5fYXJjaGl2ZVByb21pc2UgPSBudWxsO1xuICAgICAgICB9KVxuICAgICAgICAuY2F0Y2goKCkgPT4ge30pO1xuICAgIH1cbiAgICBhd2FpdCBwZXJmb3JtQ2xlYW51cCgpO1xuICAgIHJldHVybiAnJztcbiAgfVxuXG4gIGFzeW5jIHN0YXJ0ICgpIHtcbiAgICBsZXQgYmluYXJ5UGF0aDtcbiAgICB0cnkge1xuICAgICAgYmluYXJ5UGF0aCA9IGF3YWl0IHJlcXVpcmVYY3RyYWNlKCk7XG4gICAgfSBjYXRjaCAoZSkge1xuICAgICAgbG9nLmRlYnVnKGUubWVzc2FnZSk7XG4gICAgICBsb2cuaW5mbyhgRGVmYXVsdGluZyB0byAke0lOU1RSVU1FTlRTfSB1c2FnZWApO1xuICAgICAgYmluYXJ5UGF0aCA9IGF3YWl0IHJlcXVpcmVJbnN0cnVtZW50cygpO1xuICAgIH1cblxuICAgIGNvbnN0IGFyZ3MgPSBbXTtcbiAgICBjb25zdCB0b29sTmFtZSA9IHBhdGguYmFzZW5hbWUoYmluYXJ5UGF0aCkgPT09IFhDUlVOID8gWENUUkFDRSA6IElOU1RSVU1FTlRTO1xuICAgIGlmICh0b29sTmFtZSA9PT0gWENUUkFDRSkge1xuICAgICAgYXJncy5wdXNoKFxuICAgICAgICBYQ1RSQUNFLCAncmVjb3JkJyxcbiAgICAgICAgJy0tZGV2aWNlJywgdGhpcy5fdWRpZCxcbiAgICAgICAgJy0tdGVtcGxhdGUnLCB0aGlzLl9wcm9maWxlTmFtZSxcbiAgICAgICAgJy0tb3V0cHV0JywgdGhpcy5fcmVwb3J0UGF0aCxcbiAgICAgICAgJy0tdGltZS1saW1pdCcsIGAke3RoaXMuX3RpbWVvdXR9bXNgLFxuICAgICAgKTtcbiAgICAgIGlmICh0aGlzLl9waWQpIHtcbiAgICAgICAgYXJncy5wdXNoKCctLWF0dGFjaCcsIGAke3RoaXMuX3BpZH1gKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGFyZ3MucHVzaCgnLS1hbGwtcHJvY2Vzc2VzJyk7XG4gICAgICB9XG4gICAgfSBlbHNlIHtcbiAgICAgIC8vIGh0dHBzOi8vaGVscC5hcHBsZS5jb20vaW5zdHJ1bWVudHMvbWFjL2N1cnJlbnQvIy9kZXZiMTRmZmFhNVxuICAgICAgYXJncy5wdXNoKFxuICAgICAgICAnLXcnLCB0aGlzLl91ZGlkLFxuICAgICAgICAnLXQnLCB0aGlzLl9wcm9maWxlTmFtZSxcbiAgICAgICAgJy1EJywgdGhpcy5fcmVwb3J0UGF0aCxcbiAgICAgICAgJy1sJywgYCR7dGhpcy5fdGltZW91dH1gLFxuICAgICAgKTtcbiAgICAgIGlmICh0aGlzLl9waWQpIHtcbiAgICAgICAgYXJncy5wdXNoKCctcCcsIGAke3RoaXMuX3BpZH1gKTtcbiAgICAgIH1cbiAgICB9XG4gICAgY29uc3QgZnVsbENtZCA9IFtiaW5hcnlQYXRoLCAuLi5hcmdzXTtcbiAgICB0aGlzLl9wcm9jZXNzID0gbmV3IFN1YlByb2Nlc3MoZnVsbENtZFswXSwgZnVsbENtZC5zbGljZSgxKSk7XG4gICAgdGhpcy5fYXJjaGl2ZVByb21pc2UgPSBudWxsO1xuICAgIHRoaXMuX2xvZ2dlci5kZWJ1ZyhgU3RhcnRpbmcgcGVyZm9ybWFuY2UgcmVjb3JkaW5nOiAke3V0aWwucXVvdGUoZnVsbENtZCl9YCk7XG4gICAgdGhpcy5fcHJvY2Vzcy5vbignb3V0cHV0JywgKHN0ZG91dCwgc3RkZXJyKSA9PiB7XG4gICAgICBpZiAoXy50cmltKHN0ZG91dCB8fCBzdGRlcnIpKSB7XG4gICAgICAgIHRoaXMuX2xvZ2dlci5kZWJ1ZyhgWyR7dG9vbE5hbWV9XSAke3N0ZG91dCB8fCBzdGRlcnJ9YCk7XG4gICAgICB9XG4gICAgfSk7XG4gICAgdGhpcy5fcHJvY2Vzcy5vbmNlKCdleGl0JywgYXN5bmMgKGNvZGUsIHNpZ25hbCkgPT4ge1xuICAgICAgdGhpcy5fcHJvY2VzcyA9IG51bGw7XG4gICAgICBpZiAoY29kZSA9PT0gMCkge1xuICAgICAgICB0aGlzLl9sb2dnZXIuZGVidWcoJ1BlcmZvcm1hbmNlIHJlY29yZGluZyBleGl0ZWQgd2l0aG91dCBlcnJvcnMnKTtcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAvLyBjYWNoZSB6aXBwZWQgcmVwb3J0XG4gICAgICAgICAgYXdhaXQgdGhpcy5nZXRaaXBwZWRSZXBvcnRQYXRoKCk7XG4gICAgICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgICB0aGlzLl9sb2dnZXIud2FybihlKTtcbiAgICAgICAgfVxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgYXdhaXQgdGhpcy5fZW5mb3JjZVRlcm1pbmF0aW9uKCk7XG4gICAgICAgIHRoaXMuX2xvZ2dlci53YXJuKGBQZXJmb3JtYW5jZSByZWNvcmRpbmcgZXhpdGVkIHdpdGggZXJyb3IgY29kZSAke2NvZGV9LCBzaWduYWwgJHtzaWduYWx9YCk7XG4gICAgICB9XG4gICAgfSk7XG4gICAgYXdhaXQgdGhpcy5fcHJvY2Vzcy5zdGFydCgwKTtcbiAgICB0cnkge1xuICAgICAgYXdhaXQgd2FpdEZvckNvbmRpdGlvbihhc3luYyAoKSA9PiB7XG4gICAgICAgIGlmIChhd2FpdCB0aGlzLmdldE9yaWdpbmFsUmVwb3J0UGF0aCgpKSB7XG4gICAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKCF0aGlzLl9wcm9jZXNzKSB7XG4gICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGAke3Rvb2xOYW1lfSBwcm9jZXNzIGRpZWQgdW5leHBlY3RlZGx5YCk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgfSwge1xuICAgICAgICB3YWl0TXM6IFNUQVJUVVBfVElNRU9VVF9NUyxcbiAgICAgICAgaW50ZXJ2YWxNczogNTAwLFxuICAgICAgfSk7XG4gICAgfSBjYXRjaCAoZSkge1xuICAgICAgYXdhaXQgdGhpcy5fZW5mb3JjZVRlcm1pbmF0aW9uKCk7XG4gICAgICBjb25zdCBsaXN0UHJvZmlsZXNDb21tYW5kID0gdG9vbE5hbWUgPT09IFhDVFJBQ0VcbiAgICAgICAgPyBgJHtYQ1JVTn0gJHtYQ1RSQUNFfSBsaXN0IHRlbXBsYXRlc2BcbiAgICAgICAgOiBgJHtJTlNUUlVNRU5UU30gLXNgO1xuICAgICAgdGhpcy5fbG9nZ2VyLmVycm9yQW5kVGhyb3coYFRoZXJlIGlzIG5vICR7REVGQVVMVF9FWFR9IGZpbGUgZm91bmQgZm9yIHBlcmZvcm1hbmNlIHByb2ZpbGUgYCArXG4gICAgICAgIGAnJHt0aGlzLl9wcm9maWxlTmFtZX0nLiBNYWtlIHN1cmUgdGhlIHByb2ZpbGUgaXMgc3VwcG9ydGVkIG9uIHRoaXMgZGV2aWNlLiBgICtcbiAgICAgICAgYFlvdSBjb3VsZCB1c2UgJyR7bGlzdFByb2ZpbGVzQ29tbWFuZH0nIGNvbW1hbmQgdG8gc2VlIHRoZSBsaXN0IG9mIGFsbCBhdmFpbGFibGUgcHJvZmlsZXMuIGAgK1xuICAgICAgICBgQ2hlY2sgdGhlIHNlcnZlciBsb2cgZm9yIG1vcmUgZGV0YWlsc2ApO1xuICAgIH1cbiAgICB0aGlzLl9sb2dnZXIuaW5mbyhgVGhlIHBlcmZvcm1hbmNlIHJlY29yZGluZyBoYXMgc3RhcnRlZC4gV2lsbCB0aW1lb3V0IGluICR7dGhpcy5fdGltZW91dH1tc2ApO1xuICB9XG5cbiAgYXN5bmMgc3RvcCAoZm9yY2UgPSBmYWxzZSkge1xuICAgIGlmIChmb3JjZSkge1xuICAgICAgcmV0dXJuIGF3YWl0IHRoaXMuX2VuZm9yY2VUZXJtaW5hdGlvbigpO1xuICAgIH1cblxuICAgIGlmICghdGhpcy5pc1J1bm5pbmcoKSkge1xuICAgICAgdGhpcy5fbG9nZ2VyLmRlYnVnKCdQZXJmb3JtYW5jZSByZWNvcmRpbmcgaXMgbm90IHJ1bm5pbmcuIFJldHVybmluZyB0aGUgcmVjZW50IHJlc3VsdCcpO1xuICAgICAgcmV0dXJuIGF3YWl0IHRoaXMuZ2V0WmlwcGVkUmVwb3J0UGF0aCgpO1xuICAgIH1cblxuICAgIHRyeSB7XG4gICAgICBhd2FpdCB0aGlzLl9wcm9jZXNzLnN0b3AoJ1NJR0lOVCcsIFNUT1BfVElNRU9VVF9NUyk7XG4gICAgfSBjYXRjaCAoZSkge1xuICAgICAgdGhpcy5fbG9nZ2VyLmVycm9yQW5kVGhyb3coYFBlcmZvcm1hbmNlIHJlY29yZGluZyBoYXMgZmFpbGVkIHRvIGV4aXQgYWZ0ZXIgJHtTVE9QX1RJTUVPVVRfTVN9bXNgKTtcbiAgICB9XG4gICAgcmV0dXJuIGF3YWl0IHRoaXMuZ2V0WmlwcGVkUmVwb3J0UGF0aCgpO1xuICB9XG59XG5cblxuLyoqXG4gKiBAdHlwZWRlZiB7T2JqZWN0fSBTdGFydFBlcmZSZWNvcmRPcHRpb25zXG4gKlxuICogQHByb3BlcnR5IHs/bnVtYmVyfHN0cmluZ30gdGltZW91dCBbMzAwMDAwXSAtIFRoZSBtYXhpbXVtIGNvdW50IG9mIG1pbGxpc2Vjb25kcyB0byByZWNvcmQgdGhlIHByb2ZpbGluZyBpbmZvcm1hdGlvbi5cbiAqIEBwcm9wZXJ0eSB7P3N0cmluZ30gcHJvZmlsZU5hbWUgW0FjdGl2aXR5IE1vbml0b3JdIC0gVGhlIG5hbWUgb2YgZXhpc3RpbmcgcGVyZm9ybWFuY2UgcHJvZmlsZSB0byBhcHBseS5cbiAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgQ2FuIGFsc28gY29udGFpbiB0aGUgZnVsbCBwYXRoIHRvIHRoZSBjaG9zZW4gdGVtcGxhdGUgb24gdGhlIHNlcnZlciBmaWxlIHN5c3RlbS5cbiAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgTm90ZSwgdGhhdCBub3QgYWxsIHByb2ZpbGVzIGFyZSBzdXBwb3J0ZWQgb24gbW9iaWxlIGRldmljZXMuXG4gKiBAcHJvcGVydHkgez9zdHJpbmd8bnVtYmVyfSBwaWQgLSBUaGUgSUQgb2YgdGhlIHByb2Nlc3MgdG8gbWVhc3VyZSB0aGUgcGVyZm9ybWFuY2UgZm9yLlxuICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgU2V0IGl0IHRvIGBjdXJyZW50YCBpbiBvcmRlciB0byBtZWFzdXJlIHRoZSBwZXJmb3JtYW5jZSBvZlxuICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhlIHByb2Nlc3MsIHdoaWNoIGJlbG9uZ3MgdG8gdGhlIGN1cnJlbnRseSBhY3RpdmUgYXBwbGljYXRpb24uXG4gKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBBbGwgcHJvY2Vzc2VzIHJ1bm5pbmcgb24gdGhlIGRldmljZSBhcmUgbWVhc3VyZWQgaWZcbiAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBpZCBpcyB1bnNldCAodGhlIGRlZmF1bHQgc2V0dGluZykuXG4gKi9cblxuLyoqXG4gKiBTdGFydHMgcGVyZm9ybWFuY2UgcHJvZmlsaW5nIGZvciB0aGUgZGV2aWNlIHVuZGVyIHRlc3QuXG4gKiBSZWxheGluZyBzZWN1cml0eSBpcyBtYW5kYXRvcnkgZm9yIHNpbXVsYXRvcnMuIEl0IGNhbiBhbHdheXMgd29yayBmb3IgcmVhbCBkZXZpY2VzLlxuICpcbiAqIFNpbmNlIFhDb2RlIDE0IHRoZSBtZXRob2QgdHJpZXMgdG8gdXNlIGB4Y3RyYWNlYCB0b29sIHRvIHJlY29yZCBwZXJmb3JtYW5jZSBzdGF0cy5cbiAqIFRoZSBgaW5zdHJ1bWVudHNgIGRldmVsb3BlciB1dGlsaXR5IGlzIHVzZWQgYXMgYSBmYWxsYmFjayBmb3IgdGhpcyBwdXJwb3NlIGlmIGB4Y3RyYWNlYFxuICogaXMgbm90IGF2YWlsYWJsZS5cbiAqIEl0IGlzIHBvc3NpYmxlIHRvIHJlY29yZCBtdWx0aXBsZSBwcm9maWxlcyBhdCB0aGUgc2FtZSB0aW1lLlxuICogUmVhZCBodHRwczovL2RldmVsb3Blci5hcHBsZS5jb20vbGlicmFyeS9jb250ZW50L2RvY3VtZW50YXRpb24vRGV2ZWxvcGVyVG9vbHMvQ29uY2VwdHVhbC9JbnN0cnVtZW50c1VzZXJHdWlkZS9SZWNvcmRpbmcsUGF1c2luZyxhbmRTdG9wcGluZ1RyYWNlcy5odG1sXG4gKiBmb3IgbW9yZSBkZXRhaWxzLlxuICpcbiAqIEBwYXJhbSB7P1N0YXJ0UGVyZlJlY29yZE9wdGlvbnN9IG9wdHMgLSBUaGUgc2V0IG9mIHBvc3NpYmxlIHN0YXJ0IHJlY29yZCBvcHRpb25zXG4gKi9cbmNvbW1hbmRzLm1vYmlsZVN0YXJ0UGVyZlJlY29yZCA9IGFzeW5jIGZ1bmN0aW9uIG1vYmlsZVN0YXJ0UGVyZlJlY29yZCAob3B0cyA9IHt9KSB7XG4gIGlmICghdGhpcy5pc0ZlYXR1cmVFbmFibGVkKFBFUkZfUkVDT1JEX0ZFQVRfTkFNRSkgJiYgIXRoaXMuaXNSZWFsRGV2aWNlKCkpIHtcbiAgICBsb2cuZXJyb3JBbmRUaHJvdyhQRVJGX1JFQ09SRF9TRUNVUklUWV9NRVNTQUdFKTtcbiAgfVxuXG4gIGNvbnN0IHtcbiAgICB0aW1lb3V0ID0gREVGQVVMVF9USU1FT1VUX01TLFxuICAgIHByb2ZpbGVOYW1lID0gREVGQVVMVF9QUk9GSUxFX05BTUUsXG4gICAgcGlkLFxuICB9ID0gb3B0cztcblxuICBpZiAoIV8uaXNFbXB0eSh0aGlzLl9wZXJmUmVjb3JkZXJzKSkge1xuICAgIGZvciAoY29uc3QgcmVjb3JkZXIgb2YgdGhpcy5fcGVyZlJlY29yZGVycy5maWx0ZXIoKHgpID0+IHgucHJvZmlsZU5hbWUgPT09IHByb2ZpbGVOYW1lKSkge1xuICAgICAgaWYgKHJlY29yZGVyLmlzUnVubmluZygpKSB7XG4gICAgICAgIGxvZy5kZWJ1ZyhgUGVyZm9ybWFuY2UgcmVjb3JkZXIgZm9yICcke3Byb2ZpbGVOYW1lfScgb24gZGV2aWNlICcke3RoaXMub3B0cy5kZXZpY2UudWRpZH0nIGAgK1xuICAgICAgICAgIGAgaXMgYWxyZWFkeSBydW5uaW5nLiBEb2luZyBub3RoaW5nYCk7XG4gICAgICAgIHJldHVybjtcbiAgICAgIH1cbiAgICAgIF8ucHVsbCh0aGlzLl9wZXJmUmVjb3JkZXJzLCByZWNvcmRlcik7XG4gICAgICBhd2FpdCByZWNvcmRlci5zdG9wKHRydWUpO1xuICAgIH1cbiAgfVxuXG4gIGxldCByZWFsUGlkO1xuICBpZiAocGlkKSB7XG4gICAgaWYgKF8udG9Mb3dlcihwaWQpID09PSBERUZBVUxUX1BJRCkge1xuICAgICAgY29uc3QgYXBwSW5mbyA9IGF3YWl0IHRoaXMucHJveHlDb21tYW5kKCcvd2RhL2FjdGl2ZUFwcEluZm8nLCAnR0VUJyk7XG4gICAgICByZWFsUGlkID0gYXBwSW5mby5waWQ7XG4gICAgfSBlbHNlIHtcbiAgICAgIHJlYWxQaWQgPSBwaWQ7XG4gICAgfVxuICB9XG4gIGNvbnN0IHJlY29yZGVyID0gbmV3IFBlcmZSZWNvcmRlcihhd2FpdCB0ZW1wRGlyLm9wZW5EaXIoKSwgdGhpcy5vcHRzLmRldmljZS51ZGlkLCB7XG4gICAgdGltZW91dDogcGFyc2VJbnQodGltZW91dCwgMTApLFxuICAgIHByb2ZpbGVOYW1lLFxuICAgIHBpZDogcGFyc2VJbnQocmVhbFBpZCwgMTApLFxuICB9KTtcbiAgYXdhaXQgcmVjb3JkZXIuc3RhcnQoKTtcbiAgdGhpcy5fcGVyZlJlY29yZGVycyA9IFsuLi4odGhpcy5fcGVyZlJlY29yZGVycyB8fCBbXSksIHJlY29yZGVyXTtcbn07XG5cbi8qKlxuICogQHR5cGVkZWYge09iamVjdH0gU3RvcFJlY29yZGluZ09wdGlvbnNcbiAqXG4gKiBAcHJvcGVydHkgez9zdHJpbmd9IHJlbW90ZVBhdGggLSBUaGUgcGF0aCB0byB0aGUgcmVtb3RlIGxvY2F0aW9uLCB3aGVyZSB0aGUgcmVzdWx0aW5nIHppcHBlZCAudHJhY2UgZmlsZSBzaG91bGQgYmUgdXBsb2FkZWQuXG4gKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBUaGUgZm9sbG93aW5nIHByb3RvY29scyBhcmUgc3VwcG9ydGVkOiBodHRwL2h0dHBzLCBmdHAuXG4gKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBOdWxsIG9yIGVtcHR5IHN0cmluZyB2YWx1ZSAodGhlIGRlZmF1bHQgc2V0dGluZykgbWVhbnMgdGhlIGNvbnRlbnQgb2YgcmVzdWx0aW5nXG4gKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmaWxlIHNob3VsZCBiZSB6aXBwZWQsIGVuY29kZWQgYXMgQmFzZTY0IGFuZCBwYXNzZWQgYXMgdGhlIGVuZHBvaW50IHJlc3BvbnNlIHZhbHVlLlxuICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgQW4gZXhjZXB0aW9uIHdpbGwgYmUgdGhyb3duIGlmIHRoZSBnZW5lcmF0ZWQgZmlsZSBpcyB0b28gYmlnIHRvXG4gKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmaXQgaW50byB0aGUgYXZhaWxhYmxlIHByb2Nlc3MgbWVtb3J5LlxuICogQHByb3BlcnR5IHs/c3RyaW5nfSB1c2VyIC0gVGhlIG5hbWUgb2YgdGhlIHVzZXIgZm9yIHRoZSByZW1vdGUgYXV0aGVudGljYXRpb24uIE9ubHkgd29ya3MgaWYgYHJlbW90ZVBhdGhgIGlzIHByb3ZpZGVkLlxuICogQHByb3BlcnR5IHs/c3RyaW5nfSBwYXNzIC0gVGhlIHBhc3N3b3JkIGZvciB0aGUgcmVtb3RlIGF1dGhlbnRpY2F0aW9uLiBPbmx5IHdvcmtzIGlmIGByZW1vdGVQYXRoYCBpcyBwcm92aWRlZC5cbiAqIEBwcm9wZXJ0eSB7P3N0cmluZ30gbWV0aG9kIFtQVVRdIC0gVGhlIGh0dHAgbXVsdGlwYXJ0IHVwbG9hZCBtZXRob2QgbmFtZS4gT25seSB3b3JrcyBpZiBgcmVtb3RlUGF0aGAgaXMgcHJvdmlkZWQuXG4gKiBAcHJvcGVydHkgez9zdHJpbmd9IHByb2ZpbGVOYW1lIFtBY3Rpdml0eSBNb25pdG9yXSAtIFRoZSBuYW1lIG9mIGFuIGV4aXN0aW5nIHBlcmZvcm1hbmNlIHByb2ZpbGUgZm9yIHdoaWNoIHRoZSByZWNvcmRpbmcgaGFzIGJlZW4gbWFkZS5cbiAqIEBwcm9wZXJ0eSB7P09iamVjdH0gaGVhZGVycyAtIEFkZGl0aW9uYWwgaGVhZGVycyBtYXBwaW5nIGZvciBtdWx0aXBhcnQgaHR0cChzKSB1cGxvYWRzXG4gKiBAcHJvcGVydHkgez9zdHJpbmd9IGZpbGVGaWVsZE5hbWUgW2ZpbGVdIC0gVGhlIG5hbWUgb2YgdGhlIGZvcm0gZmllbGQsIHdoZXJlIHRoZSBmaWxlIGNvbnRlbnQgQkxPQiBzaG91bGQgYmUgc3RvcmVkIGZvclxuICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGh0dHAocykgdXBsb2Fkc1xuICogQHByb3BlcnR5IHs/T2JqZWN0fEFycmF5PFBhaXI+fSBmb3JtRmllbGRzIC0gQWRkaXRpb25hbCBmb3JtIGZpZWxkcyBmb3IgbXVsdGlwYXJ0IGh0dHAocykgdXBsb2Fkc1xuICovXG5cbi8qKlxuICogU3RvcHMgcGVyZm9ybWFuY2UgcHJvZmlsaW5nIGZvciB0aGUgZGV2aWNlIHVuZGVyIHRlc3QuXG4gKiBUaGUgcmVzdWx0aW5nIGZpbGUgaW4gLnRyYWNlIGZvcm1hdCBjYW4gYmUgZWl0aGVyIHJldHVybmVkXG4gKiBkaXJlY3RseSBhcyBiYXNlNjQtZW5jb2RlZCB6aXAgYXJjaGl2ZSBvciB1cGxvYWRlZCB0byBhIHJlbW90ZSBsb2NhdGlvblxuICogKHN1Y2ggZmlsZXMgY2FuIGJlIHByZXR0eSBsYXJnZSkuIEFmdGVyd2FyZHMgaXQgaXMgcG9zc2libGUgdG8gdW5hcmNoaXZlIGFuZFxuICogb3BlbiBzdWNoIGZpbGUgd2l0aCBYY29kZSBEZXYgVG9vbHMuXG4gKlxuICogQHBhcmFtIHs/U3RvcFJlY29yZGluZ09wdGlvbnN9IG9wdHMgLSBUaGUgc2V0IG9mIHBvc3NpYmxlIHN0b3AgcmVjb3JkIG9wdGlvbnNcbiAqIEByZXR1cm4ge3N0cmluZ30gRWl0aGVyIGFuIGVtcHR5IHN0cmluZyBpZiB0aGUgdXBsb2FkIHdhcyBzdWNjZXNzZnVsIG9yIGJhc2UtNjQgZW5jb2RlZFxuICogY29udGVudCBvZiB6aXBwZWQgLnRyYWNlIGZpbGUuXG4gKiBAdGhyb3dzIHtFcnJvcn0gSWYgbm8gcGVyZm9ybWFuY2UgcmVjb3JkaW5nIHdpdGggZ2l2ZW4gcHJvZmlsZSBuYW1lL2RldmljZSB1ZGlkIGNvbWJpbmF0aW9uXG4gKiBoYXMgYmVlbiBzdGFydGVkIGJlZm9yZSBvciB0aGUgcmVzdWx0aW5nIC50cmFjZSBmaWxlIGhhcyBub3QgYmVlbiBnZW5lcmF0ZWQgcHJvcGVybHkuXG4gKi9cbmNvbW1hbmRzLm1vYmlsZVN0b3BQZXJmUmVjb3JkID0gYXN5bmMgZnVuY3Rpb24gbW9iaWxlU3RvcFBlcmZSZWNvcmQgKG9wdHMgPSB7fSkge1xuICBpZiAoIXRoaXMuaXNGZWF0dXJlRW5hYmxlZChQRVJGX1JFQ09SRF9GRUFUX05BTUUpICYmICF0aGlzLmlzUmVhbERldmljZSgpKSB7XG4gICAgbG9nLmVycm9yQW5kVGhyb3coUEVSRl9SRUNPUkRfU0VDVVJJVFlfTUVTU0FHRSk7XG4gIH1cblxuICBpZiAoXy5pc0VtcHR5KHRoaXMuX3BlcmZSZWNvcmRlcnMpKSB7XG4gICAgbG9nLmluZm8oJ05vIHBlcmZvcm1hbmNlIHJlY29yZGVycyBoYXZlIGJlZW4gc3RhcnRlZC4gRG9pbmcgbm90aGluZycpO1xuICAgIHJldHVybiAnJztcbiAgfVxuXG4gIGNvbnN0IHtcbiAgICBwcm9maWxlTmFtZSA9IERFRkFVTFRfUFJPRklMRV9OQU1FLFxuICAgIHJlbW90ZVBhdGgsXG4gIH0gPSBvcHRzO1xuXG4gIGNvbnN0IHJlY29yZGVycyA9IHRoaXMuX3BlcmZSZWNvcmRlcnMuZmlsdGVyKCh4KSA9PiB4LnByb2ZpbGVOYW1lID09PSBwcm9maWxlTmFtZSk7XG4gIGlmIChfLmlzRW1wdHkocmVjb3JkZXJzKSkge1xuICAgIGxvZy5lcnJvckFuZFRocm93KGBUaGVyZSBhcmUgbm8gcmVjb3JkcyBmb3IgcGVyZm9ybWFuY2UgcHJvZmlsZSAnJHtwcm9maWxlTmFtZX0nIGAgK1xuICAgICAgYGFuZCBkZXZpY2UgJHt0aGlzLm9wdHMuZGV2aWNlLnVkaWR9LiBIYXZlIHlvdSBzdGFydGVkIHRoZSBwcm9maWxpbmcgYmVmb3JlP2ApO1xuICB9XG5cbiAgY29uc3QgcmVjb3JkZXIgPSBfLmZpcnN0KHJlY29yZGVycyk7XG4gIGNvbnN0IHJlc3VsdFBhdGggPSBhd2FpdCByZWNvcmRlci5zdG9wKCk7XG4gIGlmICghYXdhaXQgZnMuZXhpc3RzKHJlc3VsdFBhdGgpKSB7XG4gICAgbG9nLmVycm9yQW5kVGhyb3coYFRoZXJlIGlzIG5vICR7REVGQVVMVF9FWFR9IGZpbGUgZm91bmQgZm9yIHBlcmZvcm1hbmNlIHByb2ZpbGUgJyR7cHJvZmlsZU5hbWV9JyBgICtcbiAgICAgIGBhbmQgZGV2aWNlICR7dGhpcy5vcHRzLmRldmljZS51ZGlkfS4gTWFrZSBzdXJlIHRoZSBzZWxlY3RlZCBwcm9maWxlIGlzIHN1cHBvcnRlZCBvbiB0aGlzIGRldmljZWApO1xuICB9XG5cbiAgY29uc3QgcmVzdWx0ID0gYXdhaXQgZW5jb2RlQmFzZTY0T3JVcGxvYWQocmVzdWx0UGF0aCwgcmVtb3RlUGF0aCwgb3B0cyk7XG4gIF8ucHVsbCh0aGlzLl9wZXJmUmVjb3JkZXJzLCByZWNvcmRlcik7XG4gIGF3YWl0IGZzLnJpbXJhZihyZXN1bHRQYXRoKTtcbiAgcmV0dXJuIHJlc3VsdDtcbn07XG5cblxuZXhwb3J0IHsgY29tbWFuZHMgfTtcbmV4cG9ydCBkZWZhdWx0IGNvbW1hbmRzO1xuIl0sImZpbGUiOiJsaWIvY29tbWFuZHMvcGVyZm9ybWFuY2UuanMiLCJzb3VyY2VSb290IjoiLi4vLi4vLi4ifQ==
