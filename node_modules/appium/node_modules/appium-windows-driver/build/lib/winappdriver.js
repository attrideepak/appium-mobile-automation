"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = exports.WinAppDriver = void 0;

require("source-map-support/register");

var _lodash = _interopRequireDefault(require("lodash"));

var _os = _interopRequireDefault(require("os"));

var _path = _interopRequireDefault(require("path"));

var _appiumBaseDriver = require("appium-base-driver");

var _logger = _interopRequireDefault(require("./logger"));

var _teen_process = require("teen_process");

var _installer = require("./installer");

var _asyncbox = require("asyncbox");

var _child_process = require("child_process");

var _appiumSupport = require("appium-support");

var _portscanner = require("portscanner");

const DEFAULT_BASE = '/wd/hub';
const DEFAULT_HOST = '127.0.0.1';
const WAD_PORT_RANGE = [4724, 4824];
const STARTUP_TIMEOUT_MS = 10000;
const DEFAULT_CREATE_SESSION_TIMEOUT_MS = 20000;

const PORT_ALLOCATION_GUARD = _appiumSupport.util.getLockFileGuard(_path.default.resolve(_os.default.tmpdir(), 'wad_port_guard'), {
  timeout: 5,
  tryRecovery: true
});

class WADProxy extends _appiumBaseDriver.JWProxy {
  async proxyCommand(url, method, body = null) {
    if (this.didProcessExit) {
      throw new _appiumBaseDriver.errors.InvalidContextError(`'${method} ${url}' cannot be proxied to WinAppDriver server because ` + 'its process is not running (probably crashed). Check the Appium log for more details');
    }

    return await super.proxyCommand(url, method, body);
  }

}

class WADProcess {
  constructor(opts = {}) {
    this.base = opts.base;
    this.port = opts.port;
    this.proc = null;
  }

  get isRunning() {
    var _this$proc;

    return !!((_this$proc = this.proc) === null || _this$proc === void 0 ? void 0 : _this$proc.isRunning);
  }

  async start() {
    if (this.isRunning) {
      return;
    }

    if (!this.port) {
      await PORT_ALLOCATION_GUARD(async () => {
        const [startPort, endPort] = WAD_PORT_RANGE;

        try {
          this.port = await (0, _portscanner.findAPortNotInUse)(startPort, endPort);
        } catch (e) {
          _logger.default.errorAndThrow(`Could not find any free port in range ${startPort}..${endPort}. ` + `Please check your system firewall settings or set 'systemPort' capability ` + `to the desired port number`);
        }
      });
    }

    const args = [`${this.port}${this.base}`];
    this.proc = new _teen_process.SubProcess(_installer.WAD_INSTALL_PATH, args, {
      encoding: 'ucs2'
    });
    this.proc.on('output', (stdout, stderr) => {
      const line = _lodash.default.trim(stderr || stdout);

      if (line) {
        _logger.default.debug(line);
      }
    });
    this.proc.on('exit', (code, signal) => {
      _logger.default.info(`WinAppDriver exited with code ${code}, signal ${signal}`);
    });

    _logger.default.info(`Spawning '${_installer.WAD_INSTALL_PATH}' with args: ${JSON.stringify(args)}`);

    await this.proc.start(0);
  }

  async stop() {
    if (this.isRunning) {
      try {
        await this.proc.stop();
      } catch (e) {
        _logger.default.warn(`WinAppDriver process with PID ${this.proc.pid} cannot be stopped. ` + `Original error: ${e.message}`);
      }
    }
  }

}

const RUNNING_PROCESS_IDS = [];
process.once('exit', () => {
  for (const pid of RUNNING_PROCESS_IDS) {
    const command = `taskkill.exe /PID ${pid}`;

    try {
      (0, _child_process.execSync)(command);
    } catch (e) {
      _logger.default.warn(`WinAppDriver process with PID ${pid} cannot be cleaned up. ` + `Original error: ${e.message}`);
    }
  }
});

class WinAppDriver {
  constructor(opts = {}) {
    this.proxyPort = opts.port;
    this.process = null;
    this.proxy = null;
  }

  async start(caps) {
    if (!(await (0, _installer.isWADInstalled)())) {
      throw new Error(`WinAppDriver binary could not be found at the expected path ` + `'${_installer.WAD_INSTALL_PATH}'. Make sure it is installed`);
    }

    if (!(await (0, _installer.isWADChecksumOk)())) {
      _logger.default.warn('WinAppDriver exists, but the checksum did not match. Was it replaced manually?');
    }

    this.process = new WADProcess({
      base: DEFAULT_BASE,
      port: this.proxyPort
    });
    await this.process.start();
    this.proxy = new WADProxy({
      server: DEFAULT_HOST,
      port: this.process.port
    });
    this.proxy.didProcessExit = false;
    this.process.proc.on('exit', () => {
      this.proxy.didProcessExit = true;
    });

    try {
      await (0, _asyncbox.waitForCondition)(async () => {
        try {
          await this.proxy.command('/status', 'GET');
          return true;
        } catch (err) {
          if (this.proxy.didProcessExit) {
            throw new Error(err.message);
          }

          return false;
        }
      }, {
        waitMs: STARTUP_TIMEOUT_MS,
        intervalMs: 1000
      });
    } catch (e) {
      if (/Condition unmet/.test(e.message)) {
        throw new Error(`WinAppDriver server is not listening within ${STARTUP_TIMEOUT_MS}ms timeout. ` + `Make sure it could be started manually`);
      }

      throw e;
    }

    const pid = this.process.proc.pid;
    RUNNING_PROCESS_IDS.push(pid);
    this.process.proc.on('exit', () => void _lodash.default.pull(RUNNING_PROCESS_IDS, pid));
    await this._startSession(caps);
  }

  async _startSession(desiredCapabilities) {
    const {
      createSessionTimeout = DEFAULT_CREATE_SESSION_TIMEOUT_MS
    } = desiredCapabilities;

    _logger.default.debug(`Starting WinAppDriver session. Will timeout in '${createSessionTimeout}' ms.`);

    let retryIteration = 0;
    let lastError;

    const condFn = async () => {
      lastError = null;
      retryIteration++;

      try {
        await this.proxy.command('/session', 'POST', {
          desiredCapabilities
        });
        return true;
      } catch (error) {
        lastError = error;

        _logger.default.warn(`Could not start WinAppDriver session error = '${error.message}', attempt = '${retryIteration}' from '${this.createSessionRetry}'`);

        return false;
      }
    };

    try {
      await (0, _asyncbox.waitForCondition)(condFn, {
        waitMs: createSessionTimeout,
        intervalMs: 500
      });
    } catch (timeoutError) {
      _logger.default.debug(`timeoutError was ${timeoutError.message}`);

      if (lastError) {
        throw lastError;
      }

      throw new Error(`Could not start WinAppDriver session within ${createSessionTimeout} ms.`);
    }
  }

  async stop() {
    var _this$process, _this$proxy;

    if (!((_this$process = this.process) === null || _this$process === void 0 ? void 0 : _this$process.isRunning)) {
      return;
    }

    if ((_this$proxy = this.proxy) === null || _this$proxy === void 0 ? void 0 : _this$proxy.sessionId) {
      _logger.default.debug('Deleting WinAppDriver server session');

      try {
        var _this$proxy2;

        await this.proxy.command(`/session/${(_this$proxy2 = this.proxy) === null || _this$proxy2 === void 0 ? void 0 : _this$proxy2.sessionId}`, 'DELETE');
      } catch (err) {
        _logger.default.warn(`Did not get confirmation WinAppDriver deleteSession worked; ` + `Error was: ${err.message}`);
      }
    }

    await this.process.stop();
  }

  async sendCommand(url, method, body) {
    return await this.proxy.command(url, method, body);
  }

}

exports.WinAppDriver = WinAppDriver;
var _default = WinAppDriver;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi93aW5hcHBkcml2ZXIuanMiXSwibmFtZXMiOlsiREVGQVVMVF9CQVNFIiwiREVGQVVMVF9IT1NUIiwiV0FEX1BPUlRfUkFOR0UiLCJTVEFSVFVQX1RJTUVPVVRfTVMiLCJERUZBVUxUX0NSRUFURV9TRVNTSU9OX1RJTUVPVVRfTVMiLCJQT1JUX0FMTE9DQVRJT05fR1VBUkQiLCJ1dGlsIiwiZ2V0TG9ja0ZpbGVHdWFyZCIsInBhdGgiLCJyZXNvbHZlIiwib3MiLCJ0bXBkaXIiLCJ0aW1lb3V0IiwidHJ5UmVjb3ZlcnkiLCJXQURQcm94eSIsIkpXUHJveHkiLCJwcm94eUNvbW1hbmQiLCJ1cmwiLCJtZXRob2QiLCJib2R5IiwiZGlkUHJvY2Vzc0V4aXQiLCJlcnJvcnMiLCJJbnZhbGlkQ29udGV4dEVycm9yIiwiV0FEUHJvY2VzcyIsImNvbnN0cnVjdG9yIiwib3B0cyIsImJhc2UiLCJwb3J0IiwicHJvYyIsImlzUnVubmluZyIsInN0YXJ0Iiwic3RhcnRQb3J0IiwiZW5kUG9ydCIsImUiLCJsb2ciLCJlcnJvckFuZFRocm93IiwiYXJncyIsIlN1YlByb2Nlc3MiLCJXQURfSU5TVEFMTF9QQVRIIiwiZW5jb2RpbmciLCJvbiIsInN0ZG91dCIsInN0ZGVyciIsImxpbmUiLCJfIiwidHJpbSIsImRlYnVnIiwiY29kZSIsInNpZ25hbCIsImluZm8iLCJKU09OIiwic3RyaW5naWZ5Iiwic3RvcCIsIndhcm4iLCJwaWQiLCJtZXNzYWdlIiwiUlVOTklOR19QUk9DRVNTX0lEUyIsInByb2Nlc3MiLCJvbmNlIiwiY29tbWFuZCIsIldpbkFwcERyaXZlciIsInByb3h5UG9ydCIsInByb3h5IiwiY2FwcyIsIkVycm9yIiwic2VydmVyIiwiZXJyIiwid2FpdE1zIiwiaW50ZXJ2YWxNcyIsInRlc3QiLCJwdXNoIiwicHVsbCIsIl9zdGFydFNlc3Npb24iLCJkZXNpcmVkQ2FwYWJpbGl0aWVzIiwiY3JlYXRlU2Vzc2lvblRpbWVvdXQiLCJyZXRyeUl0ZXJhdGlvbiIsImxhc3RFcnJvciIsImNvbmRGbiIsImVycm9yIiwiY3JlYXRlU2Vzc2lvblJldHJ5IiwidGltZW91dEVycm9yIiwic2Vzc2lvbklkIiwic2VuZENvbW1hbmQiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7O0FBQUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBR0EsTUFBTUEsWUFBWSxHQUFHLFNBQXJCO0FBQ0EsTUFBTUMsWUFBWSxHQUFHLFdBQXJCO0FBQ0EsTUFBTUMsY0FBYyxHQUFHLENBQUMsSUFBRCxFQUFPLElBQVAsQ0FBdkI7QUFDQSxNQUFNQyxrQkFBa0IsR0FBRyxLQUEzQjtBQUNBLE1BQU1DLGlDQUFpQyxHQUFHLEtBQTFDOztBQUdBLE1BQU1DLHFCQUFxQixHQUFHQyxvQkFBS0MsZ0JBQUwsQ0FBc0JDLGNBQUtDLE9BQUwsQ0FBYUMsWUFBR0MsTUFBSCxFQUFiLEVBQTBCLGdCQUExQixDQUF0QixFQUFtRTtBQUMvRkMsRUFBQUEsT0FBTyxFQUFFLENBRHNGO0FBRS9GQyxFQUFBQSxXQUFXLEVBQUU7QUFGa0YsQ0FBbkUsQ0FBOUI7O0FBS0EsTUFBTUMsUUFBTixTQUF1QkMseUJBQXZCLENBQStCO0FBQzdCLFFBQU1DLFlBQU4sQ0FBb0JDLEdBQXBCLEVBQXlCQyxNQUF6QixFQUFpQ0MsSUFBSSxHQUFHLElBQXhDLEVBQThDO0FBQzVDLFFBQUksS0FBS0MsY0FBVCxFQUF5QjtBQUN2QixZQUFNLElBQUlDLHlCQUFPQyxtQkFBWCxDQUNILElBQUdKLE1BQU8sSUFBR0QsR0FBSSxxREFBbEIsR0FDQSxzRkFGSSxDQUFOO0FBR0Q7O0FBQ0QsV0FBTyxNQUFNLE1BQU1ELFlBQU4sQ0FBbUJDLEdBQW5CLEVBQXdCQyxNQUF4QixFQUFnQ0MsSUFBaEMsQ0FBYjtBQUNEOztBQVI0Qjs7QUFXL0IsTUFBTUksVUFBTixDQUFpQjtBQUNmQyxFQUFBQSxXQUFXLENBQUVDLElBQUksR0FBRyxFQUFULEVBQWE7QUFDdEIsU0FBS0MsSUFB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LFlBQUQsZ0JBQVksS0FBS0csS0FBakIsaURBQVksYUFBWW1CLFNBQVUsRUFBckQsRUFBd0QsUUFBeEQsQ0FBTjtBQUNELE9BRkQsQ0FFRSxPQUFPZixHQUFQLEVBQVk7QUFDWmhDLHdCQUFJbUIsSUFBSixDQUFVLDhEQUFELEdBQ04sY0FBYWEsR0FBRyxDQUFDWCxPQUFRLEVBRDVCO0FBRUQ7QUFDRjs7QUFFRCxVQUFNLEtBQUtFLE9BQUwsQ0FBYUwsSUFBYixFQUFOO0FBQ0Q7O0FBRUQsUUFBTThCLFdBQU4sQ0FBbUJqRSxHQUFuQixFQUF3QkMsTUFBeEIsRUFBZ0NDLElBQWhDLEVBQXNDO0FBQ3BDLFdBQU8sTUFBTSxLQUFLMkMsS0FBTCxDQUFXSCxPQUFYLENBQW1CMUMsR0FBbkIsRUFBd0JDLE1BQXhCLEVBQWdDQyxJQUFoQyxDQUFiO0FBQ0Q7O0FBckhnQjs7O2VBeUhKeUMsWSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBfIGZyb20gJ2xvZGFzaCc7XG5pbXBvcnQgb3MgZnJvbSAnb3MnO1xuaW1wb3J0IHBhdGggZnJvbSAncGF0aCc7XG5pbXBvcnQgeyBKV1Byb3h5LCBlcnJvcnMgfSBmcm9tICdhcHBpdW0tYmFzZS1kcml2ZXInO1xuaW1wb3J0IGxvZyBmcm9tICcuL2xvZ2dlcic7XG5pbXBvcnQgeyBTdWJQcm9jZXNzIH0gZnJvbSAndGVlbl9wcm9jZXNzJztcbmltcG9ydCB7IFdBRF9JTlNUQUxMX1BBVEgsIGlzV0FEQ2hlY2tzdW1PaywgaXNXQURJbnN0YWxsZWQgfSBmcm9tICcuL2luc3RhbGxlcic7XG5pbXBvcnQgeyB3YWl0Rm9yQ29uZGl0aW9uIH0gZnJvbSAnYXN5bmNib3gnO1xuaW1wb3J0IHsgZXhlY1N5bmMgfSBmcm9tICdjaGlsZF9wcm9jZXNzJztcbmltcG9ydCB7IHV0aWwgfSBmcm9tICdhcHBpdW0tc3VwcG9ydCc7XG5pbXBvcnQgeyBmaW5kQVBvcnROb3RJblVzZSB9IGZyb20gJ3BvcnRzY2FubmVyJztcblxuXG5jb25zdCBERUZBVUxUX0JBU0UgPSAnL3dkL2h1Yic7XG5jb25zdCBERUZBVUxUX0hPU1QgPSAnMTI3LjAuMC4xJztcbmNvbnN0IFdBRF9QT1JUX1JBTkdFID0gWzQ3MjQsIDQ4MjRdO1xuY29uc3QgU1RBUlRVUF9USU1FT1VUX01TID0gMTAwMDA7XG5jb25zdCBERUZBVUxUX0NSRUFURV9TRVNTSU9OX1RJTUVPVVRfTVMgPSAyMDAwMDsgLy8gcmV0cnkgc3RhcnQgc2Vzc2lvbiBjcmVhdGlvbiBkdXJpbmcgdGhlIHRpbWVvdXQgaW4gbWlsbGlzZWNvbmRzXG4vLyBUaGUgZ3VhcmQgaXMgbmVlZGVkIHRvIGF2b2lkIGR5bmFtaWMgc3lzdGVtIHBvcnQgYWxsb2NhdGlvbiBjb25mbGljdHMgZm9yXG4vLyBwYXJhbGxlbCBkcml2ZXIgc2Vzc2lvbnNcbmNvbnN0IFBPUlRfQUxMT0NBVElPTl9HVUFSRCA9IHV0aWwuZ2V0TG9ja0ZpbGVHdWFyZChwYXRoLnJlc29sdmUob3MudG1wZGlyKCksICd3YWRfcG9ydF9ndWFyZCcpLCB7XG4gIHRpbWVvdXQ6IDUsXG4gIHRyeVJlY292ZXJ5OiB0cnVlLFxufSk7XG5cbmNsYXNzIFdBRFByb3h5IGV4dGVuZHMgSldQcm94eSB7XG4gIGFzeW5jIHByb3h5Q29tbWFuZCAodXJsLCBtZXRob2QsIGJvZHkgPSBudWxsKSB7XG4gICAgaWYgKHRoaXMuZGlkUHJvY2Vzc0V4aXQpIHtcbiAgICAgIHRocm93IG5ldyBlcnJvcnMuSW52YWxpZENvbnRleHRFcnJvcihcbiAgICAgICAgYCcke21ldGhvZH0gJHt1cmx9JyBjYW5ub3QgYmUgcHJveGllZCB0byBXaW5BcHBEcml2ZXIgc2VydmVyIGJlY2F1c2UgYCArXG4gICAgICAgICdpdHMgcHJvY2VzcyBpcyBub3QgcnVubmluZyAocHJvYmFibHkgY3Jhc2hlZCkuIENoZWNrIHRoZSBBcHBpdW0gbG9nIGZvciBtb3JlIGRldGFpbHMnKTtcbiAgICB9XG4gICAgcmV0dXJuIGF3YWl0IHN1cGVyLnByb3h5Q29tbWFuZCh1cmwsIG1ldGhvZCwgYm9keSk7XG4gIH1cbn1cblxuY2xhc3MgV0FEUHJvY2VzcyB7XG4gIGNvbnN0cnVjdG9yIChvcHRzID0ge30pIHtcbiAgICB0aGlzLmJhc2UgPSBvcHRzLmJhc2U7XG4gICAgdGhpcy5wb3J0ID0gb3B0cy5wb3J0O1xuICAgIHRoaXMucHJvYyA9IG51bGw7XG4gIH1cblxuICBnZXQgaXNSdW5uaW5nICgpIHtcbiAgICByZXR1cm4gISEodGhpcy5wcm9jPy5pc1J1bm5pbmcpO1xuICB9XG5cbiAgYXN5bmMgc3RhcnQgKCkge1xuICAgIGlmICh0aGlzLmlzUnVubmluZykge1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGlmICghdGhpcy5wb3J0KSB7XG4gICAgICBhd2FpdCBQT1JUX0FMTE9DQVRJT05fR1VBUkQoYXN5bmMgKCkgPT4ge1xuICAgICAgICBjb25zdCBbc3RhcnRQb3J0LCBlbmRQb3J0XSA9IFdBRF9QT1JUX1JBTkdFO1xuICAgICAgICB0cnkge1xuICAgICAgICAgIHRoaXMucG9ydCA9IGF3YWl0IGZpbmRBUG9ydE5vdEluVXNlKHN0YXJ0UG9ydCwgZW5kUG9ydCk7XG4gICAgICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgICBsb2cuZXJyb3JBbmRUaHJvdyhcbiAgICAgICAgICAgIGBDb3VsZCBub3QgZmluZCBhbnkgZnJlZSBwb3J0IGluIHJhbmdlICR7c3RhcnRQb3J0fS4uJHtlbmRQb3J0fS4gYCArXG4gICAgICAgICAgICBgUGxlYXNlIGNoZWNrIHlvdXIgc3lzdGVtIGZpcmV3YWxsIHNldHRpbmdzIG9yIHNldCAnc3lzdGVtUG9ydCcgY2FwYWJpbGl0eSBgICtcbiAgICAgICAgICAgIGB0byB0aGUgZGVzaXJlZCBwb3J0IG51bWJlcmApO1xuICAgICAgICB9XG4gICAgICB9KTtcbiAgICB9XG5cbiAgICBjb25zdCBhcmdzID0gW2Ake3RoaXMucG9ydH0ke3RoaXMuYmFzZX1gXTtcbiAgICB0aGlzLnByb2MgPSBuZXcgU3ViUHJvY2VzcyhXQURfSU5TVEFMTF9QQVRILCBhcmdzLCB7XG4gICAgICBlbmNvZGluZzogJ3VjczInXG4gICAgfSk7XG4gICAgdGhpcy5wcm9jLm9uKCdvdXRwdXQnLCAoc3Rkb3V0LCBzdGRlcnIpID0+IHtcbiAgICAgIGNvbnN0IGxpbmUgPSBfLnRyaW0oc3RkZXJyIHx8IHN0ZG91dCk7XG4gICAgICBpZiAobGluZSkge1xuICAgICAgICBsb2cuZGVidWcobGluZSk7XG4gICAgICB9XG4gICAgfSk7XG4gICAgdGhpcy5wcm9jLm9uKCdleGl0JywgKGNvZGUsIHNpZ25hbCkgPT4ge1xuICAgICAgbG9nLmluZm8oYFdpbkFwcERyaXZlciBleGl0ZWQgd2l0aCBjb2RlICR7Y29kZX0sIHNpZ25hbCAke3NpZ25hbH1gKTtcbiAgICB9KTtcbiAgICBsb2cuaW5mbyhgU3Bhd25pbmcgJyR7V0FEX0lOU1RBTExfUEFUSH0nIHdpdGggYXJnczogJHtKU09OLnN0cmluZ2lmeShhcmdzKX1gKTtcbiAgICBhd2FpdCB0aGlzLnByb2Muc3RhcnQoMCk7XG4gIH1cblxuICBhc3luYyBzdG9wICgpIHtcbiAgICBpZiAodGhpcy5pc1J1bm5pbmcpIHtcbiAgICAgIHRyeSB7XG4gICAgICAgIGF3YWl0IHRoaXMucHJvYy5zdG9wKCk7XG4gICAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgIGxvZy53YXJuKGBXaW5BcHBEcml2ZXIgcHJvY2VzcyB3aXRoIFBJRCAke3RoaXMucHJvYy5waWR9IGNhbm5vdCBiZSBzdG9wcGVkLiBgICtcbiAgICAgICAgICBgT3JpZ2luYWwgZXJyb3I6ICR7ZS5tZXNzYWdlfWApO1xuICAgICAgfVxuICAgIH1cbiAgfVxufVxuXG5jb25zdCBSVU5OSU5HX1BST0NFU1NfSURTID0gW107XG5wcm9jZXNzLm9uY2UoJ2V4aXQnLCAoKSA9PiB7XG4gIGZvciAoY29uc3QgcGlkIG9mIFJVTk5JTkdfUFJPQ0VTU19JRFMpIHtcbiAgICBjb25zdCBjb21tYW5kID0gYHRhc2traWxsLmV4ZSAvUElEICR7cGlkfWA7XG4gICAgdHJ5IHtcbiAgICAgIGV4ZWNTeW5jKGNvbW1hbmQpO1xuICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgIGxvZy53YXJuKGBXaW5BcHBEcml2ZXIgcHJvY2VzcyB3aXRoIFBJRCAke3BpZH0gY2Fubm90IGJlIGNsZWFuZWQgdXAuIGAgK1xuICAgICAgICBgT3JpZ2luYWwgZXJyb3I6ICR7ZS5tZXNzYWdlfWApO1xuICAgIH1cbiAgfVxufSk7XG5cbmNsYXNzIFdpbkFwcERyaXZlciB7XG4gIGNvbnN0cnVjdG9yIChvcHRzID0ge30pIHtcbiAgICB0aGlzLnByb3h5UG9ydCA9IG9wdHMucG9ydDtcblxuICAgIHRoaXMucHJvY2VzcyA9IG51bGw7XG4gICAgdGhpcy5wcm94eSA9IG51bGw7XG4gIH1cblxuICBhc3luYyBzdGFydCAoY2Fwcykge1xuICAgIGlmICghYXdhaXQgaXNXQURJbnN0YWxsZWQoKSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBXaW5BcHBEcml2ZXIgYmluYXJ5IGNvdWxkIG5vdCBiZSBmb3VuZCBhdCB0aGUgZXhwZWN0ZWQgcGF0aCBgICtcbiAgICAgICAgYCcke1dBRF9JTlNUQUxMX1BBVEh9Jy4gTWFrZSBzdXJlIGl0IGlzIGluc3RhbGxlZGApO1xuICAgIH1cbiAgICBpZiAoIWF3YWl0IGlzV0FEQ2hlY2tzdW1PaygpKSB7XG4gICAgICBsb2cud2FybignV2luQXBwRHJpdmVyIGV4aXN0cywgYnV0IHRoZSBjaGVja3N1bSBkaWQgbm90IG1hdGNoLiBXYXMgaXQgcmVwbGFjZWQgbWFudWFsbHk/Jyk7XG4gICAgfVxuXG4gICAgdGhpcy5wcm9jZXNzID0gbmV3IFdBRFByb2Nlc3Moe1xuICAgICAgLy8gWFhYWUQgVE9ETzogd291bGQgYmUgYmV0dGVyIGlmIFdpbkFwcERyaXZlciBkaWRuJ3QgcmVxdWlyZSBwYXNzaW5nIGluIC93ZC9odWIgYXMgYSBwYXJhbVxuICAgICAgYmFzZTogREVGQVVMVF9CQVNFLFxuICAgICAgcG9ydDogdGhpcy5wcm94eVBvcnQsXG4gICAgfSk7XG4gICAgYXdhaXQgdGhpcy5wcm9jZXNzLnN0YXJ0KCk7XG5cbiAgICB0aGlzLnByb3h5ID0gbmV3IFdBRFByb3h5KHtcbiAgICAgIHNlcnZlcjogREVGQVVMVF9IT1NULFxuICAgICAgcG9ydDogdGhpcy5wcm9jZXNzLnBvcnQsXG4gICAgfSk7XG4gICAgdGhpcy5wcm94eS5kaWRQcm9jZXNzRXhpdCA9IGZhbHNlO1xuICAgIHRoaXMucHJvY2Vzcy5wcm9jLm9uKCdleGl0JywgKCkgPT4ge1xuICAgICAgdGhpcy5wcm94eS5kaWRQcm9jZXNzRXhpdCA9IHRydWU7XG4gICAgfSk7XG5cbiAgICB0cnkge1xuICAgICAgYXdhaXQgd2FpdEZvckNvbmRpdGlvbihhc3luYyAoKSA9PiB7XG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgYXdhaXQgdGhpcy5wcm94eS5jb21tYW5kKCcvc3RhdHVzJywgJ0dFVCcpO1xuICAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgICAgICBpZiAodGhpcy5wcm94eS5kaWRQcm9jZXNzRXhpdCkge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGVyci5tZXNzYWdlKTtcbiAgICAgICAgICB9XG4gICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICB9XG4gICAgICB9LCB7XG4gICAgICAgIHdhaXRNczogU1RBUlRVUF9USU1FT1VUX01TLFxuICAgICAgICBpbnRlcnZhbE1zOiAxMDAwLFxuICAgICAgfSk7XG4gICAgfSBjYXRjaCAoZSkge1xuICAgICAgaWYgKC9Db25kaXRpb24gdW5tZXQvLnRlc3QoZS5tZXNzYWdlKSkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYFdpbkFwcERyaXZlciBzZXJ2ZXIgaXMgbm90IGxpc3RlbmluZyB3aXRoaW4gJHtTVEFSVFVQX1RJTUVPVVRfTVN9bXMgdGltZW91dC4gYCArXG4gICAgICAgICAgYE1ha2Ugc3VyZSBpdCBjb3VsZCBiZSBzdGFydGVkIG1hbnVhbGx5YCk7XG4gICAgICB9XG4gICAgICB0aHJvdyBlO1xuICAgIH1cbiAgICBjb25zdCBwaWQgPSB0aGlzLnByb2Nlc3MucHJvYy5waWQ7XG4gICAgUlVOTklOR19QUk9DRVNTX0lEUy5wdXNoKHBpZCk7XG4gICAgdGhpcy5wcm9jZXNzLnByb2Mub24oJ2V4aXQnLCAoKSA9PiB2b2lkIF8ucHVsbChSVU5OSU5HX1BST0NFU1NfSURTLCBwaWQpKTtcblxuICAgIGF3YWl0IHRoaXMuX3N0YXJ0U2Vzc2lvbihjYXBzKTtcbiAgfVxuXG4gIGFzeW5jIF9zdGFydFNlc3Npb24gKGRlc2lyZWRDYXBhYmlsaXRpZXMpIHtcbiAgICBjb25zdCB7XG4gICAgICBjcmVhdGVTZXNzaW9uVGltZW91dCA9IERFRkFVTFRfQ1JFQVRFX1NFU1NJT05fVElNRU9VVF9NU1xuICAgIH0gPSBkZXNpcmVkQ2FwYWJpbGl0aWVzO1xuICAgIGxvZy5kZWJ1ZyhgU3RhcnRpbmcgV2luQXBwRHJpdmVyIHNlc3Npb24uIFdpbGwgdGltZW91dCBpbiAnJHtjcmVhdGVTZXNzaW9uVGltZW91dH0nIG1zLmApO1xuICAgIGxldCByZXRyeUl0ZXJhdGlvbiA9IDA7XG4gICAgbGV0IGxhc3RFcnJvcjtcblxuICAgIGNvbnN0IGNvbmRGbiA9IGFzeW5jICgpID0+IHtcbiAgICAgIGxhc3RFcnJvciA9IG51bGw7XG4gICAgICByZXRyeUl0ZXJhdGlvbisrO1xuICAgICAgdHJ5IHtcbiAgICAgICAgYXdhaXQgdGhpcy5wcm94eS5jb21tYW5kKCcvc2Vzc2lvbicsICdQT1NUJywge2Rlc2lyZWRDYXBhYmlsaXRpZXN9KTtcbiAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICBsYXN0RXJyb3IgPSBlcnJvcjtcbiAgICAgICAgbG9nLndhcm4oYENvdWxkIG5vdCBzdGFydCBXaW5BcHBEcml2ZXIgc2Vzc2lvbiBlcnJvciA9ICcke2Vycm9yLm1lc3NhZ2V9JywgYXR0ZW1wdCA9ICcke3JldHJ5SXRlcmF0aW9ufScgZnJvbSAnJHt0aGlzLmNyZWF0ZVNlc3Npb25SZXRyeX0nYCk7XG4gICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgIH1cbiAgICB9O1xuXG4gICAgdHJ5IHtcbiAgICAgIGF3YWl0IHdhaXRGb3JDb25kaXRpb24oY29uZEZuLCB7XG4gICAgICAgIHdhaXRNczogY3JlYXRlU2Vzc2lvblRpbWVvdXQsXG4gICAgICAgIGludGVydmFsTXM6IDUwMFxuICAgICAgfSk7XG4gICAgfSBjYXRjaCAodGltZW91dEVycm9yKSB7XG4gICAgICBsb2cuZGVidWcoYHRpbWVvdXRFcnJvciB3YXMgJHt0aW1lb3V0RXJyb3IubWVzc2FnZX1gKTtcbiAgICAgIGlmIChsYXN0RXJyb3IpIHtcbiAgICAgICAgdGhyb3cgKGxhc3RFcnJvcik7XG4gICAgICB9XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYENvdWxkIG5vdCBzdGFydCBXaW5BcHBEcml2ZXIgc2Vzc2lvbiB3aXRoaW4gJHtjcmVhdGVTZXNzaW9uVGltZW91dH0gbXMuYCk7XG4gICAgfVxuICB9XG5cbiAgYXN5bmMgc3RvcCAoKSB7XG4gICAgaWYgKCF0aGlzLnByb2Nlc3M/LmlzUnVubmluZykge1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGlmICh0aGlzLnByb3h5Py5zZXNzaW9uSWQpIHtcbiAgICAgIGxvZy5kZWJ1ZygnRGVsZXRpbmcgV2luQXBwRHJpdmVyIHNlcnZlciBzZXNzaW9uJyk7XG4gICAgICB0cnkge1xuICAgICAgICBhd2FpdCB0aGlzLnByb3h5LmNvbW1hbmQoYC9zZXNzaW9uLyR7dGhpcy5wcm94eT8uc2Vzc2lvbklkfWAsICdERUxFVEUnKTtcbiAgICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgICBsb2cud2FybihgRGlkIG5vdCBnZXQgY29uZmlybWF0aW9uIFdpbkFwcERyaXZlciBkZWxldGVTZXNzaW9uIHdvcmtlZDsgYCArXG4gICAgICAgICAgYEVycm9yIHdhczogJHtlcnIubWVzc2FnZX1gKTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICBhd2FpdCB0aGlzLnByb2Nlc3Muc3RvcCgpO1xuICB9XG5cbiAgYXN5bmMgc2VuZENvbW1hbmQgKHVybCwgbWV0aG9kLCBib2R5KSB7XG4gICAgcmV0dXJuIGF3YWl0IHRoaXMucHJveHkuY29tbWFuZCh1cmwsIG1ldGhvZCwgYm9keSk7XG4gIH1cbn1cblxuZXhwb3J0IHsgV2luQXBwRHJpdmVyIH07XG5leHBvcnQgZGVmYXVsdCBXaW5BcHBEcml2ZXI7XG4iXSwiZmlsZSI6ImxpYi93aW5hcHBkcml2ZXIuanMiLCJzb3VyY2VSb290IjoiLi4vLi4ifQ==
