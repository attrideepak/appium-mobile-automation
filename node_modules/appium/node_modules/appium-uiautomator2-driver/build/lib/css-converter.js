"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

require("source-map-support/register");

var _cssSelectorParser = require("css-selector-parser");

var _lodash = require("lodash");

var _appiumBaseDriver = require("appium-base-driver");

const CssConverter = {};
const parser = new _cssSelectorParser.CssSelectorParser();
parser.registerSelectorPseudos('has');
parser.registerNestingOperators('>', '+', '~');
parser.registerAttrEqualityMods('^', '$', '*', '~');
parser.enableSubstitutes();
const RESOURCE_ID = 'resource-id';
const BOOLEAN_ATTRS = ['checkable', 'checked', 'clickable', 'enabled', 'focusable', 'focused', 'long-clickable', 'scrollable', 'selected'];
const NUMERIC_ATTRS = ['index', 'instance'];
const STR_ATTRS = ['description', RESOURCE_ID, 'text', 'class-name', 'package-name'];
const ALL_ATTRS = [...BOOLEAN_ATTRS, ...NUMERIC_ATTRS, ...STR_ATTRS];
const ATTRIBUTE_ALIASES = [[RESOURCE_ID, ['id']], ['description', ['content-description', 'content-desc', 'desc', 'accessibility-id']], ['index', ['nth-child']]];

function toSnakeCase(str) {
  if (!str) {
    return '';
  }

  const tokens = str.split('-').map(str => str.charAt(0).toUpperCase() + str.slice(1).toLowerCase());
  const out = tokens.join('');
  return out.charAt(0).toLowerCase() + out.slice(1);
}

function assertGetBool(css) {
  var _css$value;

  const val = ((_css$value = css.value) === null || _css$value === void 0 ? void 0 : _css$value.toLowerCase()) || 'true';

  if (['true', 'false'].includes(val)) {
    return val;
  }

  throw new Error(`'${css.name}' must be true, false or empty. Found '${css.value}'`);
}

function assertGetAttrName(css) {
  const attrName = css.name.toLowerCase();

  if (ALL_ATTRS.includes(attrName)) {
    return attrName.toLowerCase();
  }

  for (const [officialAttr, aliasAttrs] of ATTRIBUTE_ALIASES) {
    if (aliasAttrs.includes(attrName)) {
      return officialAttr;
    }
  }

  throw new Error(`'${attrName}' is not a valid attribute. ` + `Supported attributes are '${ALL_ATTRS.join(', ')}'`);
}

function getWordMatcherRegex(word) {
  return `\\b(\\w*${(0, _lodash.escapeRegExp)(word)}\\w*)\\b`;
}

function prependAndroidId(str) {
  return str.startsWith('android:id/') ? str : `android:id/${str}`;
}

function parseAttr(cssAttr) {
  if (cssAttr.valueType && cssAttr.valueType !== 'string') {
    throw new Error(`'${cssAttr.name}=${cssAttr.value}' is an invalid attribute. ` + `Only 'string' and empty attribute types are supported. Found '${cssAttr.valueType}'`);
  }

  const attrName = assertGetAttrName(cssAttr);
  const methodName = toSnakeCase(attrName);

  if (!STR_ATTRS.includes(attrName) && !BOOLEAN_ATTRS.includes(attrName)) {
    throw new Error(`'${attrName}' is not supported. Supported attributes are ` + `'${[...STR_ATTRS, ...BOOLEAN_ATTRS].join(', ')}'`);
  }

  if (BOOLEAN_ATTRS.includes(attrName)) {
    return `.${methodName}(${assertGetBool(cssAttr)})`;
  }

  let value = cssAttr.value || '';

  if (attrName === RESOURCE_ID) {
    value = prependAndroidId(value);
  }

  if (value === '') {
    return `.${methodName}Matches("")`;
  }

  switch (cssAttr.operator) {
    case '=':
      return `.${methodName}("${value}")`;

    case '*=':
      if (['description', 'text'].includes(attrName)) {
        return `.${methodName}Contains("${value}")`;
      }

      return `.${methodName}Matches("${(0, _lodash.escapeRegExp)(value)}")`;

    case '^=':
      if (['description', 'text'].includes(attrName)) {
        return `.${methodName}StartsWith("${value}")`;
      }

      return `.${methodName}Matches("^${(0, _lodash.escapeRegExp)(value)}")`;

    case '$=':
      return `.${methodName}Matches("${(0, _lodash.escapeRegExp)(value)}$")`;

    case '~=':
      return `.${methodName}Matches("${getWordMatcherRegex(value)}")`;

    default:
      throw new Error(`Unsupported CSS attribute operator '${cssAttr.operator}'. ` + ` '=', '*=', '^=', '$=' and '~=' are supported.`);
  }
}

function parsePseudo(cssPseudo) {
  if (cssPseudo.valueType && cssPseudo.valueType !== 'string') {
    throw new Error(`'${cssPseudo.name}=${cssPseudo.value}'. ` + `Unsupported css pseudo class value type: '${cssPseudo.valueType}'. Only 'string' type or empty is supported.`);
  }

  const pseudoName = assertGetAttrName(cssPseudo);

  if (BOOLEAN_ATTRS.includes(pseudoName)) {
    return `.${toSnakeCase(pseudoName)}(${assertGetBool(cssPseudo)})`;
  }

  if (NUMERIC_ATTRS.includes(pseudoName)) {
    return `.${pseudoName}(${cssPseudo.value})`;
  }
}

function parseCssRule(cssRule) {
  const {
    nestingOperator
  } = cssRule;

  if (nestingOperator && nestingOperator !== ' ') {
    throw new Error(`'${nestingOperator}' is not a supported combinator. ` + `Only child combinator (>) and descendant combinator are supported.`);
  }

  let uiAutomatorSelector = 'new UiSelector()';

  if (cssRule.tagName && cssRule.tagName !== '*') {
    let androidClass = [cssRule.tagName];

    if (cssRule.classNames) {
      for (const cssClassNames of cssRule.classNames) {
        androidClass.push(cssClassNames);
      }

      uiAutomatorSelector += `.className("${androidClass.join('.')}")`;
    } else {
      uiAutomatorSelector += `.classNameMatches("${cssRule.tagName}")`;
    }
  } else if (cssRule.classNames) {
    uiAutomatorSelector += `.classNameMatches("${cssRule.classNames.join('\\.')}")`;
  }

  if (cssRule.id) {
    uiAutomatorSelector += `.resourceId("${prependAndroidId(cssRule.id)}")`;
  }

  if (cssRule.attrs) {
    for (const attr of cssRule.attrs) {
      uiAutomatorSelector += parseAttr(attr);
    }
  }

  if (cssRule.pseudos) {
    for (const pseudo of cssRule.pseudos) {
      uiAutomatorSelector += parsePseudo(pseudo);
    }
  }

  if (cssRule.rule) {
    uiAutomatorSelector += `.childSelector(${parseCssRule(cssRule.rule)})`;
  }

  return uiAutomatorSelector;
}

function parseCssObject(css) {
  switch (css.type) {
    case 'rule':
      return parseCssRule(css);

    case 'ruleSet':
      return parseCssObject(css.rule);

    case 'selectors':
      return css.selectors.map(selector => parseCssObject(selector)).join('; ');

    default:
      throw new Error(`UiAutomator does not support '${css.type}' css. Only supports 'rule', 'ruleSet', 'selectors' `);
  }
}

CssConverter.toUiAutomatorSelector = function toUiAutomatorSelector(cssSelector) {
  let cssObj;

  try {
    cssObj = parser.parse(cssSelector);
  } catch (e) {
    throw new _appiumBaseDriver.errors.InvalidSelectorError(`Invalid CSS selector '${cssSelector}'. Reason: '${e}'`);
  }

  try {
    return parseCssObject(cssObj);
  } catch (e) {
    throw new _appiumBaseDriver.errors.InvalidSelectorError(`Unsupported CSS selector '${cssSelector}'. Reason: '${e}'`);
  }
};

var _default = CssConverter;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9jc3MtY29udmVydGVyLmpzIl0sIm5hbWVzIjpbIkNzc0NvbnZlcnRlciIsInBhcnNlciIsIkNzc1NlbGVjdG9yUGFyc2VyIiwicmVnaXN0ZXJTZWxlY3RvclBzZXVkb3MiLCJyZWdpc3Rlck5lc3RpbmdPcGVyYXRvcnMiLCJyZWdpc3RlckF0dHJFcXVhbGl0eU1vZHMiLCJlbmFibGVTdWJzdGl0dXRlcyIsIlJFU09VUkNFX0lEIiwiQk9PTEVBTl9BVFRSUyIsIk5VTUVSSUNfQVRUUlMiLCJTVFJfQVRUUlMiLCJBTExfQVRUUlMiLCJBVFRSSUJVVEVfQUxJQVNFUyIsInRvU25ha2VDYXNlIiwic3RyIiwidG9rZW5zIiwic3BsaXQiLCJtYXAiLCJjaGFyQXQiLCJ0b1VwcGVyQ2FzZSIsInNsaWNlIiwidG9Mb3dlckNhc2UiLCJvdXQiLCJqb2luIiwiYXNzZXJ0R2V0Qm9vbCIsImNzcyIsInZhbCIsInZhbHVlIiwiaW5jbHVkZXMiLCJFcnJvciIsIm5hbWUiLCJhc3NlcnRHZXRBdHRyTmFtZSIsImF0dHJOYW1lIiwib2ZmaWNpYWxBdHRyIiwiYWxpYXNBdHRycyIsImdldFdvcmRNYXRjaGVyUmVnZXgiLCJ3b3JkIiwicHJlcGVuZEFuZHJvaWRJZCIsInN0YXJ0c1dpdGgiLCJwYXJzZUF0dHIiLCJjc3NBdHRyIiwidmFsdWVUeXBlIiwibWV0aG9kTmFtZSIsIm9wZXJhdG9yIiwicGFyc2VQc2V1ZG8iLCJjc3NQc2V1ZG8iLCJwc2V1ZG9OYW1lIiwicGFyc2VDc3NSdWxlIiwiY3NzUnVsZSIsIm5lc3RpbmdPcGVyYXRvciIsInVpQXV0b21hdG9yU2VsZWN0b3IiLCJ0YWdOYW1lIiwiYW5kcm9pZENsYXNzIiwiY2xhc3NOYW1lcyIsImNzc0NsYXNzTmFtZXMiLCJwdXNoIiwiaWQiLCJhdHRycyIsImF0dHIiLCJwc2V1ZG9zIiwicHNldWRvIiwicnVsZSIsInBhcnNlQ3NzT2JqZWN0IiwidHlwZSIsInNlbGVjdG9ycyIsInNlbGVjdG9yIiwidG9VaUF1dG9tYXRvclNlbGVjdG9yIiwiY3NzU2VsZWN0b3IiLCJjc3NPYmoiLCJwYXJzZSIsImUiLCJlcnJvcnMiLCJJbnZhbGlkU2VsZWN0b3JFcnJvciJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7O0FBQUE7O0FBQ0E7O0FBQ0E7O0FBRUEsTUFBTUEsWUFBWSxHQUFHLEVBQXJCO0FBRUEsTUFBTUMsTUFBTSxHQUFHLElBQUlDLG9DQUFKLEVBQWY7QUFDQUQsTUFBTSxDQUFDRSx1QkFBUCxDQUErQixLQUEvQjtBQUNBRixNQUFNLENBQUNHLHdCQUFQLENBQWdDLEdBQWhDLEVBQXFDLEdBQXJDLEVBQTBDLEdBQTFDO0FBQ0FILE1BQU0sQ0FBQ0ksd0JBQVAsQ0FBZ0MsR0FBaEMsRUFBcUMsR0FBckMsRUFBMEMsR0FBMUMsRUFBK0MsR0FBL0M7QUFDQUosTUFBTSxDQUFDSyxpQkFBUDtBQUVBLE1BQU1DLFdBQVcsR0FBRyxhQUFwQjtBQUVBLE1BQU1DLGFBQWEsR0FBRyxDQUNwQixXQURvQixFQUNQLFNBRE8sRUFDSSxXQURKLEVBQ2lCLFNBRGpCLEVBQzRCLFdBRDVCLEVBRXBCLFNBRm9CLEVBRVQsZ0JBRlMsRUFFUyxZQUZULEVBRXVCLFVBRnZCLENBQXRCO0FBS0EsTUFBTUMsYUFBYSxHQUFHLENBQ3BCLE9BRG9CLEVBQ1gsVUFEVyxDQUF0QjtBQUlBLE1BQU1DLFNBQVMsR0FBRyxDQUNoQixhQURnQixFQUNESCxXQURDLEVBQ1ksTUFEWixFQUNvQixZQURwQixFQUNrQyxjQURsQyxDQUFsQjtBQUlBLE1BQU1JLFNBQVMsR0FBRyxDQUNoQixHQUFHSCxhQURhLEVBRWhCLEdBQUdDLGFBRmEsRUFHaEIsR0FBR0MsU0FIYSxDQUFsQjtBQU1BLE1BQU1FLGlCQUFpQixHQUFHLENBQ3hCLENBQUNMLFdBQUQsRUFBYyxDQUFDLElBQUQsQ0FBZCxDQUR3QixFQUV4QixDQUFDLGFBQUQsRUFBZ0IsQ0FDZCxxQkFEYyxFQUNTLGNBRFQsRUFFZCxNQUZjLEVBRU4sa0JBRk0sQ0FBaEIsQ0FGd0IsRUFNeEIsQ0FBQyxPQUFELEVB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QUNNLE1BQUQsQ0FBckI7QUFDRCxHQUZELENBRUUsT0FBT0UsQ0FBUCxFQUFVO0FBQ1YsVUFBTSxJQUFJQyx5QkFBT0Msb0JBQVgsQ0FBaUMsNkJBQTRCTCxXQUFZLGVBQWNHLENBQUUsR0FBekYsQ0FBTjtBQUNEO0FBQ0YsQ0FaRDs7ZUFjZXRFLFkiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBDc3NTZWxlY3RvclBhcnNlciB9IGZyb20gJ2Nzcy1zZWxlY3Rvci1wYXJzZXInO1xuaW1wb3J0IHsgZXNjYXBlUmVnRXhwIH0gZnJvbSAnbG9kYXNoJztcbmltcG9ydCB7IGVycm9ycyB9IGZyb20gJ2FwcGl1bS1iYXNlLWRyaXZlcic7XG5cbmNvbnN0IENzc0NvbnZlcnRlciA9IHt9O1xuXG5jb25zdCBwYXJzZXIgPSBuZXcgQ3NzU2VsZWN0b3JQYXJzZXIoKTtcbnBhcnNlci5yZWdpc3RlclNlbGVjdG9yUHNldWRvcygnaGFzJyk7XG5wYXJzZXIucmVnaXN0ZXJOZXN0aW5nT3BlcmF0b3JzKCc+JywgJysnLCAnficpO1xucGFyc2VyLnJlZ2lzdGVyQXR0ckVxdWFsaXR5TW9kcygnXicsICckJywgJyonLCAnficpO1xucGFyc2VyLmVuYWJsZVN1YnN0aXR1dGVzKCk7XG5cbmNvbnN0IFJFU09VUkNFX0lEID0gJ3Jlc291cmNlLWlkJztcblxuY29uc3QgQk9PTEVBTl9BVFRSUyA9IFtcbiAgJ2NoZWNrYWJsZScsICdjaGVja2VkJywgJ2NsaWNrYWJsZScsICdlbmFibGVkJywgJ2ZvY3VzYWJsZScsXG4gICdmb2N1c2VkJywgJ2xvbmctY2xpY2thYmxlJywgJ3Njcm9sbGFibGUnLCAnc2VsZWN0ZWQnLFxuXTtcblxuY29uc3QgTlVNRVJJQ19BVFRSUyA9IFtcbiAgJ2luZGV4JywgJ2luc3RhbmNlJyxcbl07XG5cbmNvbnN0IFNUUl9BVFRSUyA9IFtcbiAgJ2Rlc2NyaXB0aW9uJywgUkVTT1VSQ0VfSUQsICd0ZXh0JywgJ2NsYXNzLW5hbWUnLCAncGFja2FnZS1uYW1lJ1xuXTtcblxuY29uc3QgQUxMX0FUVFJTID0gW1xuICAuLi5CT09MRUFOX0FUVFJTLFxuICAuLi5OVU1FUklDX0FUVFJTLFxuICAuLi5TVFJfQVRUUlMsXG5dO1xuXG5jb25zdCBBVFRSSUJVVEVfQUxJQVNFUyA9IFtcbiAgW1JFU09VUkNFX0lELCBbJ2lkJ11dLFxuICBbJ2Rlc2NyaXB0aW9uJywgW1xuICAgICdjb250ZW50LWRlc2NyaXB0aW9uJywgJ2NvbnRlbnQtZGVzYycsXG4gICAgJ2Rlc2MnLCAnYWNjZXNzaWJpbGl0eS1pZCcsXG4gIF1dLFxuICBbJ2luZGV4JywgWydudGgtY2hpbGQnXV0sXG5dO1xuXG4vKipcbiAqIENvbnZlcnQgaHlwaGVuIHNlcGFyYXRlZCB3b3JkIHRvIHNuYWtlIGNhc2VcbiAqXG4gKiBAcGFyYW0ge3N0cmluZ30gc3RyXG4gKiBAcmV0dXJucyB7c3RyaW5nfSBUaGUgaHlwaGVuIHNlcGFyYXRlZCB3b3JkIHRyYW5zbGF0ZWQgdG8gc25ha2UgY2FzZVxuICovXG5mdW5jdGlvbiB0b1NuYWtlQ2FzZSAoc3RyKSB7XG4gIGlmICghc3RyKSB7XG4gICAgcmV0dXJuICcnO1xuICB9XG4gIGNvbnN0IHRva2VucyA9IHN0ci5zcGxpdCgnLScpLm1hcCgoc3RyKSA9PiBzdHIuY2hhckF0KDApLnRvVXBwZXJDYXNlKCkgKyBzdHIuc2xpY2UoMSkudG9Mb3dlckNhc2UoKSk7XG4gIGNvbnN0IG91dCA9IHRva2Vucy5qb2luKCcnKTtcbiAgcmV0dXJuIG91dC5jaGFyQXQoMCkudG9Mb3dlckNhc2UoKSArIG91dC5zbGljZSgxKTtcbn1cblxuLyoqXG4gKiBAdHlwZWRlZiB7T2JqZWN0fSBDc3NOYW1lVmFsdWVPYmplY3RcbiAqIEBwcm9wZXJ0eSB7P25hbWV9IG5hbWUgVGhlIG5hbWUgb2YgdGhlIENTUyBvYmplY3RcbiAqIEBwcm9wZXJ0eSB7P3N0cmluZ30gdmFsdWUgVGhlIHZhbHVlIG9mIHRoZSBDU1Mgb2JqZWN0XG4gKi9cblxuLyoqXG4gKiBHZXQgdGhlIGJvb2xlYW4gZnJvbSBhIENTUyBvYmplY3QuIElmIGVtcHR5LCByZXR1cm4gdHJ1ZS4gSWYgbm90IHRydWUvZmFsc2UvZW1wdHksIHRocm93IGV4Y2VwdGlvblxuICpcbiAqIEBwYXJhbSB7Q3NzTmFtZVZhbHVlT2JqZWN0fSBjc3MgQSBDU1Mgb2JqZWN0IHRoYXQgaGFzICduYW1lJyBhbmQgJ3ZhbHVlJ1xuICogQHJldHVybnMge3N0cmluZ30gRWl0aGVyICd0cnVlJyBvciAnZmFsc2UnLiBJZiB2YWx1ZSBpcyBlbXB0eSwgcmV0dXJuICd0cnVlJ1xuICovXG5mdW5jdGlvbiBhc3NlcnRHZXRCb29sIChjc3MpIHtcbiAgY29uc3QgdmFsID0gY3NzLnZhbHVlPy50b0xvd2VyQ2FzZSgpIHx8ICd0cnVlJzsgLy8gYW4gb21pdHRlZCBib29sZWFuIGF0dHJpYnV0ZSBtZWFucyAndHJ1ZScgKGUuZy46IGlucHV0W2NoZWNrZWRdIG1lYW5zIGNoZWNrZWQgaXMgdHJ1ZSlcbiAgaWYgKFsndHJ1ZScsICdmYWxzZSddLmluY2x1ZGVzKHZhbCkpIHtcbiAgICByZXR1cm4gdmFsO1xuICB9XG4gIHRocm93IG5ldyBFcnJvcihgJyR7Y3NzLm5hbWV9JyBtdXN0IGJlIHRydWUsIGZhbHNlIG9yIGVtcHR5LiBGb3VuZCAnJHtjc3MudmFsdWV9J2ApO1xufVxuXG4vKipcbiAqIEdldCB0aGUgY2Fub25pY2FsIGZvcm0gb2YgYSBDU1MgYXR0cmlidXRlIG5hbWVcbiAqXG4gKiBDb252ZXJ0cyB0byBsb3dlcmNhc2UgYW5kIGlmIGFuIGF0dHJpYnV0ZSBuYW1lIGlzIGFuIGFsaWFzIGZvciBzb21ldGhpbmcgZWxzZSwgcmV0dXJuXG4gKiB3aGF0IGl0IGlzIGFuIGFsaWFzIGZvclxuICpcbiAqIEBwYXJhbSB7T2JqZWN0fSBjc3MgQ1NTIG9iamVjdFxuICogQHJldHVybnMge3N0cmluZ30gVGhlIGNhbm9uaWNhbCBhdHRyaWJ1dGUgbmFtZVxuICovXG5mdW5jdGlvbiBhc3NlcnRHZXRBdHRyTmFtZSAoY3NzKSB7XG4gIGNvbnN0IGF0dHJOYW1lID0gY3NzLm5hbWUudG9Mb3dlckNhc2UoKTtcblxuICAvLyBDaGVjayBpZiBpdCdzIHN1cHBvcnRlZCBhbmQgaWYgaXQgaXMsIHJldHVybiBpdFxuICBpZiAoQUxMX0FUVFJTLmluY2x1ZGVzKGF0dHJOYW1lKSkge1xuICAgIHJldHVybiBhdHRyTmFtZS50b0xvd2VyQ2FzZSgpO1xuICB9XG5cbiAgLy8gSWYgYXR0ck5hbWUgaXMgYW4gYWxpYXMgZm9yIHNvbWV0aGluZyBlbHNlLCByZXR1cm4gdGhhdFxuICBmb3IgKGNvbnN0IFtvZmZpY2lhbEF0dHIsIGFsaWFzQXR0cnNdIG9mIEFUVFJJQlVURV9BTElBU0VTKSB7XG4gICAgaWYgKGFsaWFzQXR0cnMuaW5jbHVkZXMoYXR0ck5hbWUpKSB7XG4gICAgICByZXR1cm4gb2ZmaWNpYWxBdHRyO1xuICAgIH1cbiAgfVxuICB0aHJvdyBuZXcgRXJyb3IoYCcke2F0dHJOYW1lfScgaXMgbm90IGEgdmFsaWQgYXR0cmlidXRlLiBgICtcbiAgICBgU3VwcG9ydGVkIGF0dHJpYnV0ZXMgYXJlICcke0FMTF9BVFRSUy5qb2luKCcsICcpfSdgKTtcbn1cblxuLyoqXG4gKiBHZXQgYSByZWdleCB0aGF0IG1hdGNoZXMgYSB3aG9sZSB3b3JkLiBGb3IgdGhlIH49IENTUyBhdHRyaWJ1dGUgc2VsZWN0b3IuXG4gKlxuICogQHBhcmFtIHtzdHJpbmd9IHdvcmRcbiAqIEByZXR1cm5zIHtzdHJpbmd9IEEgcmVnZXggXCJ3b3JkXCIgbWF0Y2hlclxuICovXG5mdW5jdGlvbiBnZXRXb3JkTWF0Y2hlclJlZ2V4ICh3b3JkKSB7XG4gIHJldHVybiBgXFxcXGIoXFxcXHcqJHtlc2NhcGVSZWdFeHAod29yZCl9XFxcXHcqKVxcXFxiYDtcbn1cblxuLyoqXG4gKiBBZGQgYW5kcm9pZDppZC8gdG8gYmVnaW5uaW5nIG9mIHN0cmluZyBpZiBpdCdzIG5vdCB0aGVyZSBhbHJlYWR5XG4gKlxuICogQHBhcmFtIHtzdHJpbmd9IHN0clxuICogQHJldHVybnMge3N0cmluZ30gU3RyaW5nIHdpdGggYGFuZHJvaWQ6aWQvYCBwcmVwZW5kZWQgKGlmIGl0IHdhc24ndCBhbHJlYWR5KVxuICovXG5mdW5jdGlvbiBwcmVwZW5kQW5kcm9pZElkIChzdHIpIHtcbiAgcmV0dXJuIHN0ci5zdGFydHNXaXRoKCdhbmRyb2lkOmlkLycpID8gc3RyIDogYGFuZHJvaWQ6aWQvJHtzdHJ9YDtcbn1cblxuLyoqXG4gKiBAdHlwZWRlZiB7T2JqZWN0fSBDc3NBdHRyXG4gKiBAcHJvcGVydHkgez9zdHJpbmd9IHZhbHVlVHlwZSBUeXBlIG9mIGF0dHJpYnV0ZSAobXVzdCBiZSBzdHJpbmcgb3IgZW1wdHkpXG4gKiBAcHJvcGVydHkgez9zdHJpbmd9IHZhbHVlIFZhbHVlIG9mIHRoZSBhdHRyaWJ1dGVcbiAqIEBwcm9wZXJ0eSB7P3N0cmluZ30gb3BlcmF0b3IgVGhlIG9wZXJhdG9yIGJldHdlZW4gdmFsdWUgYW5kIHZhbHVlIHR5cGUgKD0sICo9LCAsIF49LCAkPSlcbiAqL1xuXG4vKipcbiAqIENvbnZlcnQgYSBDU1MgYXR0cmlidXRlIGludG8gYSBVaVNlbGVjdG9yIG1ldGhvZCBjYWxsXG4gKlxuICogQHBhcmFtIHtDc3NBdHRyfSBjc3NBdHRyIENTUyBhdHRyaWJ1dGUgb2JqZWN0XG4gKiBAcmV0dXJucyB7c3RyaW5nfSBDU1MgYXR0cmlidXRlIHBhcnNlZCBhcyBVaVNlbGVjdG9yXG4gKi9cbmZ1bmN0aW9uIHBhcnNlQXR0ciAoY3NzQXR0cikge1xuICBpZiAoY3NzQXR0ci52YWx1ZVR5cGUgJiYgY3NzQXR0ci52YWx1ZVR5cGUgIT09ICdzdHJpbmcnKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKGAnJHtjc3NBdHRyLm5hbWV9PSR7Y3NzQXR0ci52YWx1ZX0nIGlzIGFuIGludmFsaWQgYXR0cmlidXRlLiBgICtcbiAgICAgIGBPbmx5ICdzdHJpbmcnIGFuZCBlbXB0eSBhdHRyaWJ1dGUgdHlwZXMgYXJlIHN1cHBvcnRlZC4gRm91bmQgJyR7Y3NzQXR0ci52YWx1ZVR5cGV9J2ApO1xuICB9XG4gIGNvbnN0IGF0dHJOYW1lID0gYXNzZXJ0R2V0QXR0ck5hbWUoY3NzQXR0cik7XG4gIGNvbnN0IG1ldGhvZE5hbWUgPSB0b1NuYWtlQ2FzZShhdHRyTmFtZSk7XG5cbiAgLy8gVmFsaWRhdGUgdGhhdCBpdCdzIGEgc3VwcG9ydGVkIGF0dHJpYnV0ZVxuICBpZiAoIVNUUl9BVFRSUy5pbmNsdWRlcyhhdHRyTmFtZSkgJiYgIUJPT0xFQU5fQVRUUlMuaW5jbHVkZXMoYXR0ck5hbWUpKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKGAnJHthdHRyTmFtZX0nIGlzIG5vdCBzdXBwb3J0ZWQuIFN1cHBvcnRlZCBhdHRyaWJ1dGVzIGFyZSBgICtcbiAgICAgIGAnJHtbLi4uU1RSX0FUVFJTLCAuLi5CT09MRUFOX0FUVFJTXS5qb2luKCcsICcpfSdgKTtcbiAgfVxuXG4gIC8vIFBhcnNlIGJvb2xlYW4sIGlmIGl0J3MgYSBib29sZWFuIGF0dHJpYnV0ZVxuICBpZiAoQk9PTEVBTl9BVFRSUy5pbmNsdWRlcyhhdHRyTmFtZSkpIHtcbiAgICByZXR1cm4gYC4ke21ldGhvZE5hbWV9KCR7YXNzZXJ0R2V0Qm9vbChjc3NBdHRyKX0pYDtcbiAgfVxuXG4gIC8vIE90aGVyd2lzZSBwYXJzZSBhcyBzdHJpbmdcbiAgbGV0IHZhbHVlID0gY3NzQXR0ci52YWx1ZSB8fCAnJztcbiAgaWYgKGF0dHJOYW1lID09PSBSRVNPVVJDRV9JRCkge1xuICAgIHZhbHVlID0gcHJlcGVuZEFuZHJvaWRJZCh2YWx1ZSk7XG4gIH1cbiAgaWYgKHZhbHVlID09PSAnJykge1xuICAgIHJldHVybiBgLiR7bWV0aG9kTmFtZX1NYXRjaGVzKFwiXCIpYDtcbiAgfVxuXG4gIHN3aXRjaCAoY3NzQXR0ci5vcGVyYXRvcikge1xuICAgIGNhc2UgJz0nOlxuICAgICAgcmV0dXJuIGAuJHttZXRob2ROYW1lfShcIiR7dmFsdWV9XCIpYDtcbiAgICBjYXNlICcqPSc6XG4gICAgICBpZiAoWydkZXNjcmlwdGlvbicsICd0ZXh0J10uaW5jbHVkZXMoYXR0ck5hbWUpKSB7XG4gICAgICAgIHJldHVybiBgLiR7bWV0aG9kTmFtZX1Db250YWlucyhcIiR7dmFsdWV9XCIpYDtcbiAgICAgIH1cbiAgICAgIHJldHVybiBgLiR7bWV0aG9kTmFtZX1NYXRjaGVzKFwiJHtlc2NhcGVSZWdFeHAodmFsdWUpfVwiKWA7XG4gICAgY2FzZSAnXj0nOlxuICAgICAgaWYgKFsnZGVzY3JpcHRpb24nLCAndGV4dCddLmluY2x1ZGVzKGF0dHJOYW1lKSkge1xuICAgICAgICByZXR1cm4gYC4ke21ldGhvZE5hbWV9U3RhcnRzV2l0aChcIiR7dmFsdWV9XCIpYDtcbiAgICAgIH1cbiAgICAgIHJldHVybiBgLiR7bWV0aG9kTmFtZX1NYXRjaGVzKFwiXiR7ZXNjYXBlUmVnRXhwKHZhbHVlKX1cIilgO1xuICAgIGNhc2UgJyQ9JzpcbiAgICAgIHJldHVybiBgLiR7bWV0aG9kTmFtZX1NYXRjaGVzKFwiJHtlc2NhcGVSZWdFeHAodmFsdWUpfSRcIilgO1xuICAgIGNhc2UgJ349JzpcbiAgICAgIHJldHVybiBgLiR7bWV0aG9kTmFtZX1NYXRjaGVzKFwiJHtnZXRXb3JkTWF0Y2hlclJlZ2V4KHZhbHVlKX1cIilgO1xuICAgIGRlZmF1bHQ6XG4gICAgICAvLyBVbnJlYWNoYWJsZSwgYnV0IGFkZGluZyBlcnJvciBpbiBjYXNlIGEgbmV3IENTUyBhdHRyaWJ1dGUgaXMgYWRkZWQuXG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYFVuc3VwcG9ydGVkIENTUyBhdHRyaWJ1dGUgb3BlcmF0b3IgJyR7Y3NzQXR0ci5vcGVyYXRvcn0nLiBgICtcbiAgICAgICAgYCAnPScsICcqPScsICdePScsICckPScgYW5kICd+PScgYXJlIHN1cHBvcnRlZC5gKTtcbiAgfVxufVxuXG4vKipcbiAqIEB0eXBlZGVmIHtPYmplY3R9IENzc1BzZXVkb1xuICogQHByb3BlcnR5IHs/c3RyaW5nfSB2YWx1ZVR5cGUgVGhlIHR5cGUgb2YgQ1NTIHBzZXVkbyBzZWxlY3RvciAoaHR0cHM6Ly93d3cubnBtanMuY29tL3BhY2thZ2UvY3NzLXNlbGVjdG9yLXBhcnNlciBmb3IgcmVmZXJlbmNlKVxuICogQHByb3BlcnR5IHs/c3RyaW5nfSBuYW1lIFRoZSBuYW1lIG9mIHRoZSBwc2V1ZG8gc2VsZWN0b3JcbiAqIEBwcm9wZXJ0eSB7P3N0cmluZ30gdmFsdWUgVGhlIHZhbHVlIG9mIHRoZSBwc2V1ZG8gc2VsZWN0b3JcbiAqL1xuXG4vKipcbiAqIENvbnZlcnQgYSBDU1MgcHNldWRvIGNsYXNzIHRvIGEgVWlTZWxlY3RvclxuICpcbiAqIEBwYXJhbSB7Q3NzUHNldWRvfSBjc3NQc2V1ZG8gQ1NTIFBzZXVkbyBjbGFzc1xuICogQHJldHVybnMge3N0cmluZ30gUHNldWRvIHNlbGVjdG9yIHBhcnNlZCBhcyBVaVNlbGVjdG9yXG4gKi9cbmZ1bmN0aW9uIHBhcnNlUHNldWRvIChjc3NQc2V1ZG8pIHtcbiAgaWYgKGNzc1BzZXVkby52YWx1ZVR5cGUgJiYgY3NzUHNldWRvLnZhbHVlVHlwZSAhPT0gJ3N0cmluZycpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoYCcke2Nzc1BzZXVkby5uYW1lfT0ke2Nzc1BzZXVkby52YWx1ZX0nLiBgICtcbiAgICAgIGBVbnN1cHBvcnRlZCBjc3MgcHNldWRvIGNsYXNzIHZhbHVlIHR5cGU6ICcke2Nzc1BzZXVkby52YWx1ZVR5cGV9Jy4gT25seSAnc3RyaW5nJyB0eXBlIG9yIGVtcHR5IGlzIHN1cHBvcnRlZC5gKTtcbiAgfVxuXG4gIGNvbnN0IHBzZXVkb05hbWUgPSBhc3NlcnRHZXRBdHRyTmFtZShjc3NQc2V1ZG8pO1xuXG4gIGlmIChCT09MRUFOX0FUVFJTLmluY2x1ZGVzKHBzZXVkb05hbWUpKSB7XG4gICAgcmV0dXJuIGAuJHt0b1NuYWtlQ2FzZShwc2V1ZG9OYW1lKX0oJHthc3NlcnRHZXRCb29sKGNzc1BzZXVkbyl9KWA7XG4gIH1cblxuICBpZiAoTlVNRVJJQ19BVFRSUy5pbmNsdWRlcyhwc2V1ZG9OYW1lKSkge1xuICAgIHJldHVybiBgLiR7cHNldWRvTmFtZX0oJHtjc3NQc2V1ZG8udmFsdWV9KWA7XG4gIH1cbn1cblxuLyoqXG4gKiBAdHlwZWRlZiB7T2JqZWN0fSBDc3NSdWxlXG4gKiBAcHJvcGVydHkgez9zdHJpbmd9IG5lc3RpbmdPcGVyYXRvciBUaGUgbmVzdGluZyBvcGVyYXRvciAoYWthOiBjb21iaW5hdG9yIGh0dHBzOi8vZGV2ZWxvcGVyLm1vemlsbGEub3JnL2VuLVVTL2RvY3MvV2ViL0NTUy9DU1NfU2VsZWN0b3JzKVxuICogQHByb3BlcnR5IHs/c3RyaW5nfSB0YWdOYW1lIFRoZSB0YWcgbmFtZSAoYWthOiB0eXBlIHNlbGVjdG9yIGh0dHBzOi8vZGV2ZWxvcGVyLm1vemlsbGEub3JnL2VuLVVTL2RvY3MvV2ViL0NTUy9UeXBlX3NlbGVjdG9ycylcbiAqIEBwcm9wZXJ0eSB7P3N0cmluZ1tdfSBjbGFzc05hbWVzIEFuIGFycmF5IG9mIENTUyBjbGFzcyBuYW1lc1xuICogQHByb3BlcnR5IHs/Q3NzQXR0cltdfSBhdHRycyBBbiBhcnJheSBvZiBDU1MgYXR0cmlidXRlc1xuICogQHByb3BlcnR5IHs/Q3NzUHNldWRvW119IGF0dHJzIEFuIGFycmF5IG9mIENTUyBwc2V1ZG9zXG4gKiBAcHJvcGVydHkgez9zdHJpbmd9IGlkIENTUyBpZGVudGlmaWVyXG4gKiBAcHJvcGVydHkgez9Dc3NSdWxlfSBydWxlIEEgZGVzY2VuZGFudCBvZiB0aGlzIENTUyBydWxlXG4gKi9cblxuLyoqXG4gKiBDb252ZXJ0IGEgQ1NTIHJ1bGUgdG8gYSBVaVNlbGVjdG9yXG4gKiBAcGFyYW0ge0Nzc1J1bGV9IGNzc1J1bGUgQ1NTIHJ1bGUgZGVmaW5pdGlvblxuICovXG5mdW5jdGlvbiBwYXJzZUNzc1J1bGUgKGNzc1J1bGUpIHtcbiAgY29uc3QgeyBuZXN0aW5nT3BlcmF0b3IgfSA9IGNzc1J1bGU7XG4gIGlmIChuZXN0aW5nT3BlcmF0b3IgJiYgbmVzdGluZ09wZXJhdG9yICE9PSAnICcpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoYCcke25lc3RpbmdPcGVyYXRvcn0nIGlzIG5vdCBhIHN1cHBvcnRlZCBjb21iaW5hdG9yLiBgICtcbiAgICAgIGBPbmx5IGNoaWxkIGNvbWJpbmF0b3IgKD4pIGFuZCBkZXNjZW5kYW50IGNvbWJpbmF0b3IgYXJlIHN1cHBvcnRlZC5gKTtcbiAgfVxuXG4gIGxldCB1aUF1dG9tYXRvclNlbGVjdG9yID0gJ25ldyBVaVNlbGVjdG9yKCknO1xuICBpZiAoY3NzUnVsZS50YWdOYW1lICYmIGNzc1J1bGUudGFnTmFtZSAhPT0gJyonKSB7XG4gICAgbGV0IGFuZHJvaWRDbGFzcyA9IFtjc3NSdWxlLnRhZ05hbWVdO1xuICAgIGlmIChjc3NSdWxlLmNsYXNzTmFtZXMpIHtcbiAgICAgIGZvciAoY29uc3QgY3NzQ2xhc3NOYW1lcyBvZiBjc3NSdWxlLmNsYXNzTmFtZXMpIHtcbiAgICAgICAgYW5kcm9pZENsYXNzLnB1c2goY3NzQ2xhc3NOYW1lcyk7XG4gICAgICB9XG4gICAgICB1aUF1dG9tYXRvclNlbGVjdG9yICs9IGAuY2xhc3NOYW1lKFwiJHthbmRyb2lkQ2xhc3Muam9pbignLicpfVwiKWA7XG4gICAgfSBlbHNlIHtcbiAgICAgIHVpQXV0b21hdG9yU2VsZWN0b3IgKz0gYC5jbGFzc05hbWVNYXRjaGVzKFwiJHtjc3NSdWxlLnRhZ05hbWV9XCIpYDtcbiAgICB9XG4gIH0gZWxzZSBpZiAoY3NzUnVsZS5jbGFzc05hbWVzKSB7XG4gICAgdWlBdXRvbWF0b3JTZWxlY3RvciArPSBgLmNsYXNzTmFtZU1hdGNoZXMoXCIke2Nzc1J1bGUuY2xhc3NOYW1lcy5qb2luKCdcXFxcLicpfVwiKWA7XG4gIH1cbiAgaWYgKGNzc1J1bGUuaWQpIHtcbiAgICB1aUF1dG9tYXRvclNlbGVjdG9yICs9IGAucmVzb3VyY2VJZChcIiR7cHJlcGVuZEFuZHJvaWRJZChjc3NSdWxlLmlkKX1cIilgO1xuICB9XG4gIGlmIChjc3NSdWxlLmF0dHJzKSB7XG4gICAgZm9yIChjb25zdCBhdHRyIG9mIGNzc1J1bGUuYXR0cnMpIHtcbiAgICAgIHVpQXV0b21hdG9yU2VsZWN0b3IgKz0gcGFyc2VBdHRyKGF0dHIpO1xuICAgIH1cbiAgfVxuICBpZiAoY3NzUnVsZS5wc2V1ZG9zKSB7XG4gICAgZm9yIChjb25zdCBwc2V1ZG8gb2YgY3NzUnVsZS5wc2V1ZG9zKSB7XG4gICAgICB1aUF1dG9tYXRvclNlbGVjdG9yICs9IHBhcnNlUHNldWRvKHBzZXVkbyk7XG4gICAgfVxuICB9XG4gIGlmIChjc3NSdWxlLnJ1bGUpIHtcbiAgICB1aUF1dG9tYXRvclNlbGVjdG9yICs9IGAuY2hpbGRTZWxlY3Rvcigke3BhcnNlQ3NzUnVsZShjc3NSdWxlLnJ1bGUpfSlgO1xuICB9XG4gIHJldHVybiB1aUF1dG9tYXRvclNlbGVjdG9yO1xufVxuXG4vKipcbiAqIEB0eXBlZGVmIHtPYmplY3R9IENzc09iamVjdFxuICogQHByb3BlcnR5IHs/c3RyaW5nfSB0eXBlIFR5cGUgb2YgQ1NTIG9iamVjdC4gJ3J1bGUnLCAncnVsZXNldCcgb3IgJ3NlbGVjdG9ycydcbiAqL1xuXG4vKipcbiAqIENvbnZlcnQgQ1NTIG9iamVjdCB0byBVaUF1dG9tYXRvcjIgc2VsZWN0b3JcbiAqIEBwYXJhbSB7Q3NzT2JqZWN0fSBjc3MgQ1NTIG9iamVjdFxuICogQHJldHVybnMge3N0cmluZ30gVGhlIENTUyBvYmplY3QgcGFyc2VkIGFzIGEgVWlTZWxlY3RvclxuICovXG5mdW5jdGlvbiBwYXJzZUNzc09iamVjdCAoY3NzKSB7XG4gIHN3aXRjaCAoY3NzLnR5cGUpIHtcbiAgICBjYXNlICdydWxlJzpcbiAgICAgIHJldHVybiBwYXJzZUNzc1J1bGUoY3NzKTtcbiAgICBjYXNlICdydWxlU2V0JzpcbiAgICAgIHJldHVybiBwYXJzZUNzc09iamVjdChjc3MucnVsZSk7XG4gICAgY2FzZSAnc2VsZWN0b3JzJzpcbiAgICAgIHJldHVybiBjc3Muc2VsZWN0b3JzLm1hcCgoc2VsZWN0b3IpID0+IHBhcnNlQ3NzT2JqZWN0KHNlbGVjdG9yKSkuam9pbignOyAnKTtcblxuICAgIGRlZmF1bHQ6XG4gICAgICAvLyBUaGlzIGlzIG5ldmVyIHJlYWNoYWJsZSwgYnV0IGlmIGl0IGV2ZXIgaXMgZG8gdGhpcy5cbiAgICAgIHRocm93IG5ldyBFcnJvcihgVWlBdXRvbWF0b3IgZG9lcyBub3Qgc3VwcG9ydCAnJHtjc3MudHlwZX0nIGNzcy4gT25seSBzdXBwb3J0cyAncnVsZScsICdydWxlU2V0JywgJ3NlbGVjdG9ycycgYCk7XG4gIH1cbn1cblxuLyoqXG4gKiBDb252ZXJ0IGEgQ1NTIHNlbGVjdG9yIHRvIGEgVWlBdXRvbWF0b3IyIHNlbGVjdG9yXG4gKiBAcGFyYW0ge3N0cmluZ30gY3NzU2VsZWN0b3IgQ1NTIFNlbGVjdG9yXG4gKiBAcmV0dXJucyB7c3RyaW5nfSBUaGUgQ1NTIHNlbGVjdG9yIGNvbnZlcnRlZCB0byBhIFVpU2VsZWN0b3JcbiAqL1xuQ3NzQ29udmVydGVyLnRvVWlBdXRvbWF0b3JTZWxlY3RvciA9IGZ1bmN0aW9uIHRvVWlBdXRvbWF0b3JTZWxlY3RvciAoY3NzU2VsZWN0b3IpIHtcbiAgbGV0IGNzc09iajtcbiAgdHJ5IHtcbiAgICBjc3NPYmogPSBwYXJzZXIucGFyc2UoY3NzU2VsZWN0b3IpO1xuICB9IGNhdGNoIChlKSB7XG4gICAgdGhyb3cgbmV3IGVycm9ycy5JbnZhbGlkU2VsZWN0b3JFcnJvcihgSW52YWxpZCBDU1Mgc2VsZWN0b3IgJyR7Y3NzU2VsZWN0b3J9Jy4gUmVhc29uOiAnJHtlfSdgKTtcbiAgfVxuICB0cnkge1xuICAgIHJldHVybiBwYXJzZUNzc09iamVjdChjc3NPYmopO1xuICB9IGNhdGNoIChlKSB7XG4gICAgdGhyb3cgbmV3IGVycm9ycy5JbnZhbGlkU2VsZWN0b3JFcnJvcihgVW5zdXBwb3J0ZWQgQ1NTIHNlbGVjdG9yICcke2Nzc1NlbGVjdG9yfScuIFJlYXNvbjogJyR7ZX0nYCk7XG4gIH1cbn07XG5cbmV4cG9ydCBkZWZhdWx0IENzc0NvbnZlcnRlcjsiXSwiZmlsZSI6ImxpYi9jc3MtY29udmVydGVyLmpzIiwic291cmNlUm9vdCI6Ii4uLy4uIn0=
