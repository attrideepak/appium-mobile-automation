"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

require("source-map-support/register");

var _lodash = _interopRequireDefault(require("lodash"));

var _asyncbox = require("asyncbox");

var _appiumSupport = require("appium-support");

var _logger = _interopRequireDefault(require("../logger"));

var _teen_process = require("teen_process");

var _bluebird = _interopRequireDefault(require("bluebird"));

const commands = {};
const RETRY_PAUSE = 300;
const RETRY_TIMEOUT = 5000;
const DEFAULT_TIME_LIMIT = 60 * 10;
const PROCESS_SHUTDOWN_TIMEOUT = 10 * 1000;
const DEFAULT_EXT = 'mp4';
const FFMPEG_BINARY = 'ffmpeg';
const DEFAULT_FPS = 15;
const DEFAULT_PRESET = 'veryfast';

async function uploadRecordedMedia(localFile, remotePath = null, uploadOptions = {}) {
  if (_lodash.default.isEmpty(remotePath)) {
    const {
      size
    } = await _appiumSupport.fs.stat(localFile);

    _logger.default.debug(`The size of the resulting screen recording is ${_appiumSupport.util.toReadableSizeString(size)}`);

    return (await _appiumSupport.util.toInMemoryBase64(localFile)).toString();
  }

  const {
    user,
    pass,
    method,
    headers,
    fileFieldName,
    formFields
  } = uploadOptions;
  const options = {
    method: method || 'PUT',
    headers,
    fileFieldName,
    formFields
  };

  if (user && pass) {
    options.auth = {
      user,
      pass
    };
  }

  await _appiumSupport.net.uploadFile(localFile, remotePath, options);
  return '';
}

async function requireFfmpegPath() {
  try {
    return await _appiumSupport.fs.which(FFMPEG_BINARY);
  } catch (e) {
    _logger.default.errorAndThrow(`${FFMPEG_BINARY} has not been found in PATH. ` + `Please make sure it is installed`);
  }
}

class ScreenRecorder {
  constructor(videoPath, opts = {}) {
    this._videoPath = videoPath;
    this._process = null;
    this._fps = opts.fps && opts.fps > 0 ? opts.fps : DEFAULT_FPS;
    this._deviceId = opts.deviceId;
    this._captureCursor = opts.captureCursor;
    this._captureClicks = opts.captureClicks;
    this._preset = opts.preset || DEFAULT_PRESET;
    this._videoFilter = opts.videoFilter;
    this._timeLimit = opts.timeLimit && opts.timeLimit > 0 ? opts.timeLimit : DEFAULT_TIME_LIMIT;
  }

  async getVideoPath() {
    return (await _appiumSupport.fs.exists(this._videoPath)) ? this._videoPath : '';
  }

  isRunning() {
    var _this$_process;

    return !!((_this$_process = this._process) === null || _this$_process === void 0 ? void 0 : _this$_process.isRunning);
  }

  async _enforceTermination() {
    if (this._process && this.isRunning()) {
      _logger.default.debug('Force-stopping the currently running video recording');

      try {
        await this._process.stop('SIGKILL');
      } catch (ign) {}
    }

    this._process = null;
    const videoPath = await this.getVideoPath();

    if (videoPath) {
      await _appiumSupport.fs.rimraf(videoPath);
    }

    return '';
  }

  async start() {
    const ffmpeg = await requireFfmpegPath();
    const args = ['-loglevel', 'error', '-t', `${this._timeLimit}`, '-f', 'avfoundation', ...(this._captureCursor ? ['-capture_cursor', '1'] : []), ...(this._captureClicks ? ['-capture_mouse_clicks', '1'] : []), '-framerate', `${this._fps}`, '-i', this._deviceId, '-vcodec', 'libx264', '-preset', this._preset, '-tune', 'zerolatency', '-pix_fmt', 'yuv420p', '-movflags', '+faststart', '-fflags', 'nobuffer', '-f', DEFAULT_EXT, '-r', `${this._fps}`, ...(this._videoFilter ? ['-filter:v', this._videoFilter] : [])];
    const fullCmd = [ffmpeg, ...args, this._videoPath];
    this._process = new _teen_process.SubProcess(fullCmd[0], fullCmd.slice(1));

    _logger.default.debug(`Starting ${FFMPEG_BINARY}: ${_appiumSupport.util.quote(fullCmd)}`);

    this._process.on('output', (stdout, stderr) => {
      if (_lodash.default.trim(stdout || stderr)) {
        _logger.default.debug(`[${FFMPEG_BINARY}] ${stdout || stderr}`);
      }
    });

    this._process.once('exit', async (code, signal) => {
      this._process = null;

      if (code === 0) {
        _logger.default.debug('Screen recording exited without errors');
      } else {
        await this._enforceTermination();

        _logger.default.warn(`Screen recording exited with error code ${code}, signal ${signal}`);
      }
    });

    await this._process.start(0);

    try {
      await (0, _asyncbox.waitForCondition)(async () => {
        if (await this.getVideoPath()) {
          return true;
        }

        if (!this._process) {
          throw new Error(`${FFMPEG_BINARY} process died unexpectedly`);
        }

        return false;
      }, {
        waitMs: RETRY_TIMEOUT,
        intervalMs: RETRY_PAUSE
      });
    } catch (e) {
      await this._enforceTermination();

      _logger.default.errorAndThrow(`The expected screen record file '${this._videoPath}' does not exist. ` + `Check the server log for more details`);
    }

    _logger.default.info(`The video recording has started. Will timeout in ${_appiumSupport.util.pluralize('second', this._timeLimit, true)}`);
  }

  async stop(force = false) {
    if (force) {
      return await this._enforceTermination();
    }

    if (!this.isRunning()) {
      _logger.default.debug('Screen recording is not running. Returning the recent result');

      return await this.getVideoPath();
    }

    return new _bluebird.default((resolve, reject) => {
      const timer = setTimeout(async () => {
        await this._enforceTermination();
        reject(new Error(`Screen recording has failed to exit after ${PROCESS_SHUTDOWN_TIMEOUT}ms`));
      }, PROCESS_SHUTDOWN_TIMEOUT);

      this._process.once('exit', async (code, signal) => {
        clearTimeout(timer);

        if (code === 0) {
          resolve(await this.getVideoPath());
        } else {
          reject(new Error(`Screen recording exited with error code ${code}, signal ${signal}`));
        }
      });

      this._process.proc.stdin.write('q');

      this._process.proc.stdin.end();
    });
  }

}

commands.startRecordingScreen = async function startRecordingScreen(options = {}) {
  var _this$_screenRecorder, _this$_screenRecorder2;

  const {
    timeLimit,
    videoFilter,
    fps,
    preset,
    captureCursor,
    captureClicks,
    deviceId,
    forceRestart = true
  } = options;

  if (_lodash.default.isNil(deviceId)) {
    throw new Error(`'deviceId' option must be provided. Run 'ffmpeg -f avfoundation -list_devices true -i' ` + 'to fetch the list of available device ids');
  }

  if ((_this$_screenRecorder = this._screenRecorder) === null || _this$_screenRecorder === void 0 ? void 0 : (_this$_screenRecorder2 = _this$_screenRecorder.isRunning) === null || _this$_screenRecorder2 === void 0 ? void 0 : _this$_screenRecorder2.call(_this$_screenRecorder)) {
    _logger.default.debug('The screen recording is already running');

    if (!forceRestart) {
      _logger.default.debug('Doing nothing');

      return;
    }

    _logger.default.debug('Forcing the active screen recording to stop');

    await this._screenRecorder.stop(true);
  }

  this._screenRecorder = null;
  const videoPath = await _appiumSupport.tempDir.path({
    prefix: _appiumSupport.util.uuidV4().substring(0, 8),
    suffix: `.${DEFAULT_EXT}`
  });
  this._screenRecorder = new ScreenRecorder(videoPath, {
    fps: parseInt(fps, 10),
    timeLimit: parseInt(timeLimit, 10),
    preset,
    captureCursor,
    captureClicks,
    videoFilter,
    deviceId
  });

  try {
    await this._screenRecorder.start();
  } catch (e) {
    this._screenRecorder = null;
    throw e;
  }
};

commands.stopRecordingScreen = async function stopRecordingScreen(options = {}) {
  if (!this._screenRecorder) {
    _logger.default.debug('No screen recording has been started. Doing nothing');

    return '';
  }

  _logger.default.debug('Retrieving the resulting video data');

  const videoPath = await this._screenRecorder.stop();

  if (!videoPath) {
    _logger.default.debug('No video data is found. Returning an empty string');

    return '';
  }

  return await uploadRecordedMedia(videoPath, options.remotePath, options);
};

var _default = commands;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9jb21tYW5kcy9yZWNvcmQtc2NyZWVuLmpzIl0sIm5hbWVzIjpbImNvbW1hbmRzIiwiUkVUUllfUEFVU0UiLCJSRVRSWV9USU1FT1VUIiwiREVGQVVMVF9USU1FX0xJTUlUIiwiUFJPQ0VTU19TSFVURE9XTl9USU1FT1VUIiwiREVGQVVMVF9FWFQiLCJGRk1QRUdfQklOQVJZIiwiREVGQVVMVF9GUFMiLCJERUZBVUxUX1BSRVNFVCIsInVwbG9hZFJlY29yZGVkTWVkaWEiLCJsb2NhbEZpbGUiLCJyZW1vdGVQYXRoIiwidXBsb2FkT3B0aW9ucyIsIl8iLCJpc0VtcHR5Iiwic2l6ZSIsImZzIiwic3RhdCIsImxvZyIsImRlYnVnIiwidXRpbCIsInRvUmVhZGFibGVTaXplU3RyaW5nIiwidG9Jbk1lbW9yeUJhc2U2NCIsInRvU3RyaW5nIiwidXNlciIsInBhc3MiLCJtZXRob2QiLCJoZWFkZXJzIiwiZmlsZUZpZWxkTmFtZSIsImZvcm1GaWVsZHMiLCJvcHRpb25zIiwiYXV0aCIsIm5ldCIsInVwbG9hZEZpbGUiLCJyZXF1aXJlRmZtcGVnUGF0aCIsIndoaWNoIiwiZSIsImVycm9yQW5kVGhyb3ciLCJTY3JlZW5SZWNvcmRlciIsImNvbnN0cnVjdG9yIiwidmlkZW9QYXRoIiwib3B0cyIsIl92aWRlb1BhdGgiLCJfcHJvY2VzcyIsIl9mcHMiLCJmcHMiLCJfZGV2aWNlSWQiLCJkZXZpY2VJZCIsIl9jYXB0dXJlQ3Vyc29yIiwiY2FwdHVyZUN1cnNvciIsIl9jYXB0dXJlQ2xpY2tzIiwiY2FwdHVyZUNsaWNrcyIsIl9wcmVzZXQiLCJwcmVzZXQiLCJfdmlkZW9GaWx0ZXIiLCJ2aWRlb0ZpbHRlciIsIl90aW1lTGltaXQiLCJ0aW1lTGltaXQiLCJnZXRWaWRlb1BhdGgiLCJleGlzdHMiLCJpc1J1bm5pbmciLCJfZW5mb3JjZVRlcm1pbmF0aW9uIiwic3RvcCIsImlnbiIsInJpbXJhZiIsInN0YXJ0IiwiZmZtcGVnIiwiYXJncyIsImZ1bGxDbWQiLCJTdWJQcm9jZXNzIiwic2xpY2UiLCJxdW90ZSIsIm9uIiwic3Rkb3V0Iiwic3RkZXJyIiwidHJpbSIsIm9uY2UiLCJjb2RlIiwic2lnbmFsIiwid2FybiIsIkVycm9yIiwid2FpdE1zIiwiaW50ZXJ2YWxNcyIsImluZm8iLCJwbHVyYWxpemUiLCJmb3JjZSIsIkIiLCJyZXNvbHZlIiwicmVqZWN0IiwidGltZXIiLCJzZXRUaW1lb3V0IiwiY2xlYXJUaW1lb3V0IiwicHJvYyIsInN0ZGluIiwid3JpdGUiLCJlbmQiLCJzdGFydFJlY29yZGluZ1NjcmVlbiIsImZvcmNlUmVzdGFydCIsImlzTmlsIiwiX3NjcmVlblJlY29yZGVyIiwidGVtcERpciIsInBhdGgiLCJwcmVmaXgiLCJ1dWlkVjQiLCJzdWJzdHJpbmciLCJzdWZmaXgiLCJwYXJzZUludCIsInN0b3BSZWNvcmRpbmdTY3JlZW4iXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7O0FBQUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBR0EsTUFBTUEsUUFBUSxHQUFHLEVBQWpCO0FBRUEsTUFBTUMsV0FBVyxHQUFHLEdBQXBCO0FBQ0EsTUFBTUMsYUFBYSxHQUFHLElBQXRCO0FBQ0EsTUFBTUMsa0JBQWtCLEdBQUcsS0FBSyxFQUFoQztBQUNBLE1BQU1DLHdCQUF3QixHQUFHLEtBQUssSUFBdEM7QUFDQSxNQUFNQyxXQUFXLEdBQUcsS0FBcEI7QUFDQSxNQUFNQyxhQUFhLEdBQUcsUUFBdEI7QUFDQSxNQUFNQyxXQUFXLEdBQUcsRUFBcEI7QUFDQSxNQUFNQyxjQUFjLEdBQUcsVUFBdkI7O0FBR0EsZUFBZUMsbUJBQWYsQ0FBb0NDLFNBQXBDLEVBQStDQyxVQUFVLEdBQUcsSUFBNUQsRUFBa0VDLGFBQWEsR0FBRyxFQUFsRixFQUFzRjtBQUNwRixNQUFJQyxnQkFBRUMsT0FBRixDQUFVSCxVQUFWLENBQUosRUFBMkI7QUFDekIsVUFBTTtBQUFDSSxNQUFBQTtBQUFELFFBQVMsTUFBTUMsa0JBQUdDLElBQUgsQ0FBUVAsU0FBUixDQUFyQjs7QUFD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LENBQUN0QixTQUFMLEVBQWdCO0FBQ2R0QixvQkFBSUMsS0FBSixDQUFVLG1EQUFWOztBQUNBLFdBQU8sRUFBUDtBQUNEOztBQUNELFNBQU8sTUFBTVYsbUJBQW1CLENBQUMrQixTQUFELEVBQVlWLE9BQU8sQ0FBQ25CLFVBQXBCLEVBQWdDbUIsT0FBaEMsQ0FBaEM7QUFDRCxDQWJEOztlQWVlOUIsUSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBfIGZyb20gJ2xvZGFzaCc7XG5pbXBvcnQgeyB3YWl0Rm9yQ29uZGl0aW9uIH0gZnJvbSAnYXN5bmNib3gnO1xuaW1wb3J0IHsgdXRpbCwgZnMsIG5ldCwgdGVtcERpciB9IGZyb20gJ2FwcGl1bS1zdXBwb3J0JztcbmltcG9ydCBsb2cgZnJvbSAnLi4vbG9nZ2VyJztcbmltcG9ydCB7IFN1YlByb2Nlc3MgfSBmcm9tICd0ZWVuX3Byb2Nlc3MnO1xuaW1wb3J0IEIgZnJvbSAnYmx1ZWJpcmQnO1xuXG5cbmNvbnN0IGNvbW1hbmRzID0ge307XG5cbmNvbnN0IFJFVFJZX1BBVVNFID0gMzAwO1xuY29uc3QgUkVUUllfVElNRU9VVCA9IDUwMDA7XG5jb25zdCBERUZBVUxUX1RJTUVfTElNSVQgPSA2MCAqIDEwOyAvLyAxMCBtaW51dGVzXG5jb25zdCBQUk9DRVNTX1NIVVRET1dOX1RJTUVPVVQgPSAxMCAqIDEwMDA7XG5jb25zdCBERUZBVUxUX0VYVCA9ICdtcDQnO1xuY29uc3QgRkZNUEVHX0JJTkFSWSA9ICdmZm1wZWcnO1xuY29uc3QgREVGQVVMVF9GUFMgPSAxNTtcbmNvbnN0IERFRkFVTFRfUFJFU0VUID0gJ3ZlcnlmYXN0JztcblxuXG5hc3luYyBmdW5jdGlvbiB1cGxvYWRSZWNvcmRlZE1lZGlhIChsb2NhbEZpbGUsIHJlbW90ZVBhdGggPSBudWxsLCB1cGxvYWRPcHRpb25zID0ge30pIHtcbiAgaWYgKF8uaXNFbXB0eShyZW1vdGVQYXRoKSkge1xuICAgIGNvbnN0IHtzaXplfSA9IGF3YWl0IGZzLnN0YXQobG9jYWxGaWxlKTtcbiAgICBsb2cuZGVidWcoYFRoZSBzaXplIG9mIHRoZSByZXN1bHRpbmcgc2NyZWVuIHJlY29yZGluZyBpcyAke3V0aWwudG9SZWFkYWJsZVNpemVTdHJpbmcoc2l6ZSl9YCk7XG4gICAgcmV0dXJuIChhd2FpdCB1dGlsLnRvSW5NZW1vcnlCYXNlNjQobG9jYWxGaWxlKSkudG9TdHJpbmcoKTtcbiAgfVxuXG4gIGNvbnN0IHt1c2VyLCBwYXNzLCBtZXRob2QsIGhlYWRlcnMsIGZpbGVGaWVsZE5hbWUsIGZvcm1GaWVsZHN9ID0gdXBsb2FkT3B0aW9ucztcbiAgY29uc3Qgb3B0aW9ucyA9IHtcbiAgICBtZXRob2Q6IG1ldGhvZCB8fCAnUFVUJyxcbiAgICBoZWFkZXJzLFxuICAgIGZpbGVGaWVsZE5hbWUsXG4gICAgZm9ybUZpZWxkcyxcbiAgfTtcbiAgaWYgKHVzZXIgJiYgcGFzcykge1xuICAgIG9wdGlvbnMuYXV0aCA9IHt1c2VyLCBwYXNzfTtcbiAgfVxuICBhd2FpdCBuZXQudXBsb2FkRmlsZShsb2NhbEZpbGUsIHJlbW90ZVBhdGgsIG9wdGlvbnMpO1xuICByZXR1cm4gJyc7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIHJlcXVpcmVGZm1wZWdQYXRoICgpIHtcbiAgdHJ5IHtcbiAgICByZXR1cm4gYXdhaXQgZnMud2hpY2goRkZNUEVHX0JJTkFSWSk7XG4gIH0gY2F0Y2ggKGUpIHtcbiAgICBsb2cuZXJyb3JBbmRUaHJvdyhgJHtGRk1QRUdfQklOQVJZfSBoYXMgbm90IGJlZW4gZm91bmQgaW4gUEFUSC4gYCArXG4gICAgICBgUGxlYXNlIG1ha2Ugc3VyZSBpdCBpcyBpbnN0YWxsZWRgKTtcbiAgfVxufVxuXG5jbGFzcyBTY3JlZW5SZWNvcmRlciB7XG4gIGNvbnN0cnVjdG9yICh2aWRlb1BhdGgsIG9wdHMgPSB7fSkge1xuICAgIHRoaXMuX3ZpZGVvUGF0aCA9IHZpZGVvUGF0aDtcbiAgICB0aGlzLl9wcm9jZXNzID0gbnVsbDtcbiAgICB0aGlzLl9mcHMgPSAob3B0cy5mcHMgJiYgb3B0cy5mcHMgPiAwKSA/IG9wdHMuZnBzIDogREVGQVVMVF9GUFM7XG4gICAgdGhpcy5fZGV2aWNlSWQgPSBvcHRzLmRldmljZUlkO1xuICAgIHRoaXMuX2NhcHR1cmVDdXJzb3IgPSBvcHRzLmNhcHR1cmVDdXJzb3I7XG4gICAgdGhpcy5fY2FwdHVyZUNsaWNrcyA9IG9wdHMuY2FwdHVyZUNsaWNrcztcbiAgICB0aGlzLl9wcmVzZXQgPSBvcHRzLnByZXNldCB8fCBERUZBVUxUX1BSRVNFVDtcbiAgICB0aGlzLl92aWRlb0ZpbHRlciA9IG9wdHMudmlkZW9GaWx0ZXI7XG4gICAgdGhpcy5fdGltZUxpbWl0ID0gKG9wdHMudGltZUxpbWl0ICYmIG9wdHMudGltZUxpbWl0ID4gMClcbiAgICAgID8gb3B0cy50aW1lTGltaXRcbiAgICAgIDogREVGQVVMVF9USU1FX0xJTUlUO1xuICB9XG5cbiAgYXN5bmMgZ2V0VmlkZW9QYXRoICgpIHtcbiAgICByZXR1cm4gKGF3YWl0IGZzLmV4aXN0cyh0aGlzLl92aWRlb1BhdGgpKSA/IHRoaXMuX3ZpZGVvUGF0aCA6ICcnO1xuICB9XG5cbiAgaXNSdW5uaW5nICgpIHtcbiAgICByZXR1cm4gISEodGhpcy5fcHJvY2Vzcz8uaXNSdW5uaW5nKTtcbiAgfVxuXG4gIGFzeW5jIF9lbmZvcmNlVGVybWluYXRpb24gKCkge1xuICAgIGlmICh0aGlzLl9wcm9jZXNzICYmIHRoaXMuaXNSdW5uaW5nKCkpIHtcbiAgICAgIGxvZy5kZWJ1ZygnRm9yY2Utc3RvcHBpbmcgdGhlIGN1cnJlbnRseSBydW5uaW5nIHZpZGVvIHJlY29yZGluZycpO1xuICAgICAgdHJ5IHtcbiAgICAgICAgYXdhaXQgdGhpcy5fcHJvY2Vzcy5zdG9wKCdTSUdLSUxMJyk7XG4gICAgICB9IGNhdGNoIChpZ24pIHt9XG4gICAgfVxuICAgIHRoaXMuX3Byb2Nlc3MgPSBudWxsO1xuICAgIGNvbnN0IHZpZGVvUGF0aCA9IGF3YWl0IHRoaXMuZ2V0VmlkZW9QYXRoKCk7XG4gICAgaWYgKHZpZGVvUGF0aCkge1xuICAgICAgYXdhaXQgZnMucmltcmFmKHZpZGVvUGF0aCk7XG4gICAgfVxuICAgIHJldHVybiAnJztcbiAgfVxuXG4gIGFzeW5jIHN0YXJ0ICgpIHtcbiAgICBjb25zdCBmZm1wZWcgPSBhd2FpdCByZXF1aXJlRmZtcGVnUGF0aCgpO1xuXG4gICAgY29uc3QgYXJncyA9IFtcbiAgICAgICctbG9nbGV2ZWwnLCAnZXJyb3InLFxuICAgICAgJy10JywgYCR7dGhpcy5fdGltZUxpbWl0fWAsXG4gICAgICAnLWYnLCAnYXZmb3VuZGF0aW9uJyxcbiAgICAgIC4uLih0aGlzLl9jYXB0dXJlQ3Vyc29yID8gWyctY2FwdHVyZV9jdXJzb3InLCAnMSddIDogW10pLFxuICAgICAgLi4uKHRoaXMuX2NhcHR1cmVDbGlja3MgPyBbJy1jYXB0dXJlX21vdXNlX2NsaWNrcycsICcxJ10gOiBbXSksXG4gICAgICAnLWZyYW1lcmF0ZScsIGAke3RoaXMuX2Zwc31gLFxuICAgICAgJy1pJywgdGhpcy5fZGV2aWNlSWQsXG4gICAgICAnLXZjb2RlYycsICdsaWJ4MjY0JyxcbiAgICAgICctcHJlc2V0JywgdGhpcy5fcHJlc2V0LFxuICAgICAgJy10dW5lJywgJ3plcm9sYXRlbmN5JyxcbiAgICAgICctcGl4X2ZtdCcsICd5dXY0MjBwJyxcbiAgICAgICctbW92ZmxhZ3MnLCAnK2Zhc3RzdGFydCcsXG4gICAgICAnLWZmbGFncycsICdub2J1ZmZlcicsXG4gICAgICAnLWYnLCBERUZBVUxUX0VYVCxcbiAgICAgICctcicsIGAke3RoaXMuX2Zwc31gLFxuICAgICAgLi4uKHRoaXMuX3ZpZGVvRmlsdGVyID8gWyctZmlsdGVyOnYnLCB0aGlzLl92aWRlb0ZpbHRlcl0gOiBbXSksXG4gICAgXTtcblxuICAgIGNvbnN0IGZ1bGxDbWQgPSBbXG4gICAgICBmZm1wZWcsXG4gICAgICAuLi5hcmdzLFxuICAgICAgdGhpcy5fdmlkZW9QYXRoLFxuICAgIF07XG4gICAgdGhpcy5fcHJvY2VzcyA9IG5ldyBTdWJQcm9jZXNzKGZ1bGxDbWRbMF0sIGZ1bGxDbWQuc2xpY2UoMSkpO1xuICAgIGxvZy5kZWJ1ZyhgU3RhcnRpbmcgJHtGRk1QRUdfQklOQVJZfTogJHt1dGlsLnF1b3RlKGZ1bGxDbWQpfWApO1xuICAgIHRoaXMuX3Byb2Nlc3Mub24oJ291dHB1dCcsIChzdGRvdXQsIHN0ZGVycikgPT4ge1xuICAgICAgaWYgKF8udHJpbShzdGRvdXQgfHwgc3RkZXJyKSkge1xuICAgICAgICBsb2cuZGVidWcoYFske0ZGTVBFR19CSU5BUll9XSAke3N0ZG91dCB8fCBzdGRlcnJ9YCk7XG4gICAgICB9XG4gICAgfSk7XG4gICAgdGhpcy5fcHJvY2Vzcy5vbmNlKCdleGl0JywgYXN5bmMgKGNvZGUsIHNpZ25hbCkgPT4ge1xuICAgICAgdGhpcy5fcHJvY2VzcyA9IG51bGw7XG4gICAgICBpZiAoY29kZSA9PT0gMCkge1xuICAgICAgICBsb2cuZGVidWcoJ1NjcmVlbiByZWNvcmRpbmcgZXhpdGVkIHdpdGhvdXQgZXJyb3JzJyk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBhd2FpdCB0aGlzLl9lbmZvcmNlVGVybWluYXRpb24oKTtcbiAgICAgICAgbG9nLndhcm4oYFNjcmVlbiByZWNvcmRpbmcgZXhpdGVkIHdpdGggZXJyb3IgY29kZSAke2NvZGV9LCBzaWduYWwgJHtzaWduYWx9YCk7XG4gICAgICB9XG4gICAgfSk7XG4gICAgYXdhaXQgdGhpcy5fcHJvY2Vzcy5zdGFydCgwKTtcbiAgICB0cnkge1xuICAgICAgYXdhaXQgd2FpdEZvckNvbmRpdGlvbihhc3luYyAoKSA9PiB7XG4gICAgICAgIGlmIChhd2FpdCB0aGlzLmdldFZpZGVvUGF0aCgpKSB7XG4gICAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKCF0aGlzLl9wcm9jZXNzKSB7XG4gICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGAke0ZGTVBFR19CSU5BUll9IHByb2Nlc3MgZGllZCB1bmV4cGVjdGVkbHlgKTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICB9LCB7XG4gICAgICAgIHdhaXRNczogUkVUUllfVElNRU9VVCxcbiAgICAgICAgaW50ZXJ2YWxNczogUkVUUllfUEFVU0UsXG4gICAgICB9KTtcbiAgICB9IGNhdGNoIChlKSB7XG4gICAgICBhd2FpdCB0aGlzLl9lbmZvcmNlVGVybWluYXRpb24oKTtcbiAgICAgIGxvZy5lcnJvckFuZFRocm93KGBUaGUgZXhwZWN0ZWQgc2NyZWVuIHJlY29yZCBmaWxlICcke3RoaXMuX3ZpZGVvUGF0aH0nIGRvZXMgbm90IGV4aXN0LiBgICtcbiAgICAgICAgYENoZWNrIHRoZSBzZXJ2ZXIgbG9nIGZvciBtb3JlIGRldGFpbHNgKTtcbiAgICB9XG4gICAgbG9nLmluZm8oYFRoZSB2aWRlbyByZWNvcmRpbmcgaGFzIHN0YXJ0ZWQuIFdpbGwgdGltZW91dCBpbiAke3V0aWwucGx1cmFsaXplKCdzZWNvbmQnLCB0aGlzLl90aW1lTGltaXQsIHRydWUpfWApO1xuICB9XG5cbiAgYXN5bmMgc3RvcCAoZm9yY2UgPSBmYWxzZSkge1xuICAgIGlmIChmb3JjZSkge1xuICAgICAgcmV0dXJuIGF3YWl0IHRoaXMuX2VuZm9yY2VUZXJtaW5hdGlvbigpO1xuICAgIH1cblxuICAgIGlmICghdGhpcy5pc1J1bm5pbmcoKSkge1xuICAgICAgbG9nLmRlYnVnKCdTY3JlZW4gcmVjb3JkaW5nIGlzIG5vdCBydW5uaW5nLiBSZXR1cm5pbmcgdGhlIHJlY2VudCByZXN1bHQnKTtcbiAgICAgIHJldHVybiBhd2FpdCB0aGlzLmdldFZpZGVvUGF0aCgpO1xuICAgIH1cblxuICAgIHJldHVybiBuZXcgQigocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICBjb25zdCB0aW1lciA9IHNldFRpbWVvdXQoYXN5bmMgKCkgPT4ge1xuICAgICAgICBhd2FpdCB0aGlzLl9lbmZvcmNlVGVybWluYXRpb24oKTtcbiAgICAgICAgcmVqZWN0KG5ldyBFcnJvcihgU2NyZWVuIHJlY29yZGluZyBoYXMgZmFpbGVkIHRvIGV4aXQgYWZ0ZXIgJHtQUk9DRVNTX1NIVVRET1dOX1RJTUVPVVR9bXNgKSk7XG4gICAgICB9LCBQUk9DRVNTX1NIVVRET1dOX1RJTUVPVVQpO1xuXG4gICAgICB0aGlzLl9wcm9jZXNzLm9uY2UoJ2V4aXQnLCBhc3luYyAoY29kZSwgc2lnbmFsKSA9PiB7XG4gICAgICAgIGNsZWFyVGltZW91dCh0aW1lcik7XG4gICAgICAgIGlmIChjb2RlID09PSAwKSB7XG4gICAgICAgICAgcmVzb2x2ZShhd2FpdCB0aGlzLmdldFZpZGVvUGF0aCgpKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICByZWplY3QobmV3IEVycm9yKGBTY3JlZW4gcmVjb3JkaW5nIGV4aXRlZCB3aXRoIGVycm9yIGNvZGUgJHtjb2RlfSwgc2lnbmFsICR7c2lnbmFsfWApKTtcbiAgICAgICAgfVxuICAgICAgfSk7XG5cbiAgICAgIHRoaXMuX3Byb2Nlc3MucHJvYy5zdGRpbi53cml0ZSgncScpO1xuICAgICAgdGhpcy5fcHJvY2Vzcy5wcm9jLnN0ZGluLmVuZCgpO1xuICAgIH0pO1xuICB9XG59XG5cblxuLyoqXG4gKiBAdHlwZWRlZiB7T2JqZWN0fSBTdGFydFJlY29yZGluZ09wdGlvbnNcbiAqXG4gKiBAcHJvcGVydHkgez9zdHJpbmd9IHZpZGVvRmlsdGVyIC0gVGhlIHZpZGVvIGZpbHRlciBzcGVjIHRvIGFwcGx5IGZvciBmZm1wZWcuXG4gKiBTZWUgaHR0cHM6Ly90cmFjLmZmbXBlZy5vcmcvd2lraS9GaWx0ZXJpbmdHdWlkZSBmb3IgbW9yZSBkZXRhaWxzIG9uIHRoZSBwb3NzaWJsZSB2YWx1ZXMuXG4gKiBFeGFtcGxlOiBTZXQgaXQgdG8gYHNjYWxlPWlmbm90KGd0ZShpd1xcLDEwMjQpXFwsaXdcXCwxMDI0KTotMmAgaW4gb3JkZXIgdG8gbGltaXQgdGhlIHZpZGVvIHdpZHRoXG4gKiB0byAxMDI0cHguIFRoZSBoZWlnaHQgd2lsbCBiZSBhZGp1c3RlZCBhdXRvbWF0aWNhbGx5IHRvIG1hdGNoIHRoZSBhY3R1YWwgcmF0aW8uXG4gKiBAcHJvcGVydHkge251bWJlcnxzdHJpbmd9IGZwcyBbMTVdIC0gVGhlIGNvdW50IG9mIGZyYW1lcyBwZXIgc2Vjb25kIGluIHRoZSByZXN1bHRpbmcgdmlkZW8uXG4gKiBUaGUgZ3JlYXRlciBmcHMgaXQgaGFzIHRoZSBiaWdnZXIgZmlsZSBzaXplIGlzLlxuICogQHByb3BlcnR5IHtzdHJpbmd9IHByZXNldCBbdmVyeWZhc3RdIC0gT25lIG9mIHRoZSBzdXBwb3J0ZWQgZW5jb2RpbmcgcHJlc2V0cy4gUG9zc2libGUgdmFsdWVzIGFyZTpcbiAqIC0gdWx0cmFmYXN0XG4gKiAtIHN1cGVyZmFzdFxuICogLSB2ZXJ5ZmFzdFxuICogLSBmYXN0ZXJcbiAqIC0gZmFzdFxuICogLSBtZWRpdW1cbiAqIC0gc2xvd1xuICogLSBzbG93ZXJcbiAqIC0gdmVyeXNsb3dcbiAqIEEgcHJlc2V0IGlzIGEgY29sbGVjdGlvbiBvZiBvcHRpb25zIHRoYXQgd2lsbCBwcm92aWRlIGEgY2VydGFpbiBlbmNvZGluZyBzcGVlZCB0byBjb21wcmVzc2lvbiByYXRpby5cbiAqIEEgc2xvd2VyIHByZXNldCB3aWxsIHByb3ZpZGUgYmV0dGVyIGNvbXByZXNzaW9uIChjb21wcmVzc2lvbiBpcyBxdWFsaXR5IHBlciBmaWxlc2l6ZSkuXG4gKiBUaGlzIG1lYW5zIHRoYXQsIGZvciBleGFtcGxlLCBpZiB5b3UgdGFyZ2V0IGEgY2VydGFpbiBmaWxlIHNpemUgb3IgY29uc3RhbnQgYml0IHJhdGUsIHlvdSB3aWxsIGFjaGlldmUgYmV0dGVyXG4gKiBxdWFsaXR5IHdpdGggYSBzbG93ZXIgcHJlc2V0LiBSZWFkIGh0dHBzOi8vdHJhYy5mZm1wZWcub3JnL3dpa2kvRW5jb2RlL0guMjY0IGZvciBtb3JlIGRldGFpbHMuXG4gKiBAcHJvcGVydHkge2Jvb2xlYW59IGNhcHR1cmVDdXJzb3IgW2ZhbHNlXSAtIFdoZXRoZXIgdG8gY2FwdHVyZSB0aGUgbW91c2UgY3Vyc29yIHdoaWxlIHJlY29yZGluZ1xuICogdGhlIHNjcmVlblxuICogQHByb3BlcnR5IHtib29sZWFufSBjYXB0dXJlQ2xpY2tzIFtmYWxzZV0gLSBXaGV0aGVyIHRvIGNhcHR1cmUgbW91c2UgY2xpY2tzIHdoaWxlIHJlY29yZGluZyB0aGVcbiAqIHNjcmVlblxuICogQHByb3BlcnR5IHshc3RyaW5nfG51bWJlcn0gZGV2aWNlSWQgLSBTY3JlZW4gZGV2aWNlIGluZGV4IHRvIHVzZSBmb3IgdGhlIHJlY29yZGluZy5cbiAqIFRoZSBsaXN0IG9mIGF2YWlsYWJsZSBkZXZpY2VzIGNvdWxkIGJlIHJldHJpZXZlZCB1c2luZ1xuICogYGZmbXBlZyAtZiBhdmZvdW5kYXRpb24gLWxpc3RfZGV2aWNlcyB0cnVlIC1pYCBjb21tYW5kLlxuICogQHByb3BlcnR5IHtzdHJpbmd8bnVtYmVyfSB0aW1lTGltaXQgWzYwMF0gLSBUaGUgbWF4aW11bSByZWNvcmRpbmcgdGltZSwgaW4gc2Vjb25kcy4gVGhlIGRlZmF1bHRcbiAqIHZhbHVlIGlzIDYwMCBzZWNvbmRzICgxMCBtaW51dGVzKS5cbiAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gZm9yY2VSZXN0YXJ0IFt0cnVlXSAtIFdoZXRoZXIgdG8gaWdub3JlIHRoZSBjYWxsIGlmIGEgc2NyZWVuIHJlY29yZGluZyBpcyBjdXJyZW50bHkgcnVubmluZ1xuICogKGBmYWxzZWApIG9yIHRvIHN0YXJ0IGEgbmV3IHJlY29yZGluZyBpbW1lZGlhdGVseSBhbmQgdGVybWluYXRlIHRoZSBleGlzdGluZyBvbmUgaWYgcnVubmluZyAoYHRydWVgKS5cbiAqL1xuXG4vKipcbiAqIFJlY29yZCB0aGUgZGlzcGxheSBpbiBiYWNrZ3JvdW5kIHdoaWxlIHRoZSBhdXRvbWF0ZWQgdGVzdCBpcyBydW5uaW5nLlxuICogVGhpcyBtZXRob2QgcmVxdWlyZXMgRkZNUEVHIChodHRwczovL3d3dy5mZm1wZWcub3JnL2Rvd25sb2FkLmh0bWwpIHRvIGJlIGluc3RhbGxlZFxuICogYW5kIHByZXNlbnQgaW4gUEFUSC4gQWxzbywgdGhlIEFwcGl1bSBwcm9jZXNzIG11c3QgYmUgYWxsb3dlZCB0byBhY2Nlc3Mgc2NyZWVuIHJlY29yZGluZ1xuICogaW4gU3lzdGVtIFByZWZlcmVuY2VzLT5TZWN1cml0eSAmIFByaXZhY3ktPlNjcmVlbiBSZWNvcmRpbmcuXG4gKiBUaGUgcmVzdWx0aW5nIHZpZGVvIHVzZXMgSDI2NCBjb2RlYyBhbmQgaXMgcmVhZHkgdG8gYmUgcGxheWVkIGJ5IG1lZGlhIHBsYXllcnMgYnVpbHQtaW4gaW50byB3ZWIgYnJvd3NlcnMuXG4gKlxuICogQHBhcmFtIHs/U3RhcnRSZWNvcmRpbmdPcHRpb25zfSBvcHRpb25zIC0gVGhlIGF2YWlsYWJsZSBvcHRpb25zLlxuICogQHRocm93cyB7RXJyb3J9IElmIHNjcmVlbiByZWNvcmRpbmcgaGFzIGZhaWxlZCB0byBzdGFydCBvciBpcyBub3Qgc3VwcG9ydGVkIG9uIHRoZSBkZXZpY2UgdW5kZXIgdGVzdC5cbiAqL1xuY29tbWFuZHMuc3RhcnRSZWNvcmRpbmdTY3JlZW4gPSBhc3luYyBmdW5jdGlvbiBzdGFydFJlY29yZGluZ1NjcmVlbiAob3B0aW9ucyA9IHt9KSB7XG4gIGNvbnN0IHtcbiAgICB0aW1lTGltaXQsXG4gICAgdmlkZW9GaWx0ZXIsXG4gICAgZnBzLFxuICAgIHByZXNldCxcbiAgICBjYXB0dXJlQ3Vyc29yLFxuICAgIGNhcHR1cmVDbGlja3MsXG4gICAgZGV2aWNlSWQsXG4gICAgZm9yY2VSZXN0YXJ0ID0gdHJ1ZSxcbiAgfSA9IG9wdGlvbnM7XG5cbiAgaWYgKF8uaXNOaWwoZGV2aWNlSWQpKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKGAnZGV2aWNlSWQnIG9wdGlvbiBtdXN0IGJlIHByb3ZpZGVkLiBSdW4gJ2ZmbXBlZyAtZiBhdmZvdW5kYXRpb24gLWxpc3RfZGV2aWNlcyB0cnVlIC1pJyBgICtcbiAgICAgICd0byBmZXRjaCB0aGUgbGlzdCBvZiBhdmFpbGFibGUgZGV2aWNlIGlkcycpO1xuICB9XG5cbiAgaWYgKHRoaXMuX3NjcmVlblJlY29yZGVyPy5pc1J1bm5pbmc/LigpKSB7XG4gICAgbG9nLmRlYnVnKCdUaGUgc2NyZWVuIHJlY29yZGluZyBpcyBhbHJlYWR5IHJ1bm5pbmcnKTtcbiAgICBpZiAoIWZvcmNlUmVzdGFydCkge1xuICAgICAgbG9nLmRlYnVnKCdEb2luZyBub3RoaW5nJyk7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIGxvZy5kZWJ1ZygnRm9yY2luZyB0aGUgYWN0aXZlIHNjcmVlbiByZWNvcmRpbmcgdG8gc3RvcCcpO1xuICAgIGF3YWl0IHRoaXMuX3NjcmVlblJlY29yZGVyLnN0b3AodHJ1ZSk7XG4gIH1cbiAgdGhpcy5fc2NyZWVuUmVjb3JkZXIgPSBudWxsO1xuXG4gIGNvbnN0IHZpZGVvUGF0aCA9IGF3YWl0IHRlbXBEaXIucGF0aCh7XG4gICAgcHJlZml4OiB1dGlsLnV1aWRWNCgpLnN1YnN0cmluZygwLCA4KSxcbiAgICBzdWZmaXg6IGAuJHtERUZBVUxUX0VYVH1gLFxuICB9KTtcbiAgdGhpcy5fc2NyZWVuUmVjb3JkZXIgPSBuZXcgU2NyZWVuUmVjb3JkZXIodmlkZW9QYXRoLCB7XG4gICAgZnBzOiBwYXJzZUludChmcHMsIDEwKSxcbiAgICB0aW1lTGltaXQ6IHBhcnNlSW50KHRpbWVMaW1pdCwgMTApLFxuICAgIHByZXNldCxcbiAgICBjYXB0dXJlQ3Vyc29yLFxuICAgIGNhcHR1cmVDbGlja3MsXG4gICAgdmlkZW9GaWx0ZXIsXG4gICAgZGV2aWNlSWQsXG4gIH0pO1xuICB0cnkge1xuICAgIGF3YWl0IHRoaXMuX3NjcmVlblJlY29yZGVyLnN0YXJ0KCk7XG4gIH0gY2F0Y2ggKGUpIHtcbiAgICB0aGlzLl9zY3JlZW5SZWNvcmRlciA9IG51bGw7XG4gICAgdGhyb3cgZTtcbiAgfVxufTtcblxuLyoqXG4gKiBAdHlwZWRlZiB7T2JqZWN0fSBTdG9wUmVjb3JkaW5nT3B0aW9uc1xuICpcbiAqIEBwcm9wZXJ0eSB7P3N0cmluZ30gcmVtb3RlUGF0aCAtIFRoZSBwYXRoIHRvIHRoZSByZW1vdGUgbG9jYXRpb24sIHdoZXJlIHRoZSByZXN1bHRpbmcgdmlkZW8gc2hvdWxkIGJlIHVwbG9hZGVkLlxuICogVGhlIGZvbGxvd2luZyBwcm90b2NvbHMgYXJlIHN1cHBvcnRlZDogaHR0cC9odHRwcywgZnRwLlxuICogTnVsbCBvciBlbXB0eSBzdHJpbmcgdmFsdWUgKHRoZSBkZWZhdWx0IHNldHRpbmcpIG1lYW5zIHRoZSBjb250ZW50IG9mIHJlc3VsdGluZ1xuICogZmlsZSBzaG91bGQgYmUgZW5jb2RlZCBhcyBCYXNlNjQgYW5kIHBhc3NlZCBhcyB0aGUgZW5kcG9pbnQgcmVzcG9uc2UgdmFsdWUuXG4gKiBBbiBleGNlcHRpb24gd2lsbCBiZSB0aHJvd24gaWYgdGhlIGdlbmVyYXRlZCBtZWRpYSBmaWxlIGlzIHRvbyBiaWcgdG9cbiAqIGZpdCBpbnRvIHRoZSBhdmFpbGFibGUgcHJvY2VzcyBtZW1vcnkuXG4gKiBAcHJvcGVydHkgez9zdHJpbmd9IHVzZXIgLSBUaGUgbmFtZSBvZiB0aGUgdXNlciBmb3IgdGhlIHJlbW90ZSBhdXRoZW50aWNhdGlvbi5cbiAqIEBwcm9wZXJ0eSB7P3N0cmluZ30gcGFzcyAtIFRoZSBwYXNzd29yZCBmb3IgdGhlIHJlbW90ZSBhdXRoZW50aWNhdGlvbi5cbiAqIEBwcm9wZXJ0eSB7P3N0cmluZ30gbWV0aG9kIC0gVGhlIGh0dHAgbXVsdGlwYXJ0IHVwbG9hZCBtZXRob2QgbmFtZS4gVGhlICdQVVQnIG9uZSBpcyB1c2VkIGJ5IGRlZmF1bHQuXG4gKiBAcHJvcGVydHkgez9PYmplY3R9IGhlYWRlcnMgLSBBZGRpdGlvbmFsIGhlYWRlcnMgbWFwcGluZyBmb3IgbXVsdGlwYXJ0IGh0dHAocykgdXBsb2Fkc1xuICogQHByb3BlcnR5IHs/c3RyaW5nfSBmaWxlRmllbGROYW1lIFtmaWxlXSAtIFRoZSBuYW1lIG9mIHRoZSBmb3JtIGZpZWxkLCB3aGVyZSB0aGUgZmlsZSBjb250ZW50IEJMT0Igc2hvdWxkIGJlIHN0b3JlZCBmb3JcbiAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBodHRwKHMpIHVwbG9hZHNcbiAqIEBwcm9wZXJ0eSB7P09iamVjdHxBcnJheTxQYWlyPn0gZm9ybUZpZWxkcyAtIEFkZGl0aW9uYWwgZm9ybSBmaWVsZHMgZm9yIG11bHRpcGFydCBodHRwKHMpIHVwbG9hZHNcbiAqL1xuXG4vKipcbiAqIFN0b3AgcmVjb3JkaW5nIHRoZSBzY3JlZW4uXG4gKiBJZiBubyBzY3JlZW4gcmVjb3JkaW5nIGhhcyBiZWVuIHN0YXJ0ZWQgYmVmb3JlIHRoZW4gdGhlIG1ldGhvZCByZXR1cm5zIGFuIGVtcHR5IHN0cmluZy5cbiAqXG4gKiBAcGFyYW0gez9TdG9wUmVjb3JkaW5nT3B0aW9uc30gb3B0aW9ucyAtIFRoZSBhdmFpbGFibGUgb3B0aW9ucy5cbiAqIEByZXR1cm5zIHtzdHJpbmd9IEJhc2U2NC1lbmNvZGVkIGNvbnRlbnQgb2YgdGhlIHJlY29yZGVkIG1lZGlhIGZpbGUgaWYgJ3JlbW90ZVBhdGgnXG4gKiBwYXJhbWV0ZXIgaXMgZmFsc3kgb3IgYW4gZW1wdHkgc3RyaW5nLlxuICogQHRocm93cyB7RXJyb3J9IElmIHRoZXJlIHdhcyBhbiBlcnJvciB3aGlsZSBnZXR0aW5nIHRoZSBuYW1lIG9mIGEgbWVkaWEgZmlsZVxuICogb3IgdGhlIGZpbGUgY29udGVudCBjYW5ub3QgYmUgdXBsb2FkZWQgdG8gdGhlIHJlbW90ZSBsb2NhdGlvblxuICogb3Igc2NyZWVuIHJlY29yZGluZyBpcyBub3Qgc3VwcG9ydGVkIG9uIHRoZSBkZXZpY2UgdW5kZXIgdGVzdC5cbiAqL1xuY29tbWFuZHMuc3RvcFJlY29yZGluZ1NjcmVlbiA9IGFzeW5jIGZ1bmN0aW9uIHN0b3BSZWNvcmRpbmdTY3JlZW4gKG9wdGlvbnMgPSB7fSkge1xuICBpZiAoIXRoaXMuX3NjcmVlblJlY29yZGVyKSB7XG4gICAgbG9nLmRlYnVnKCdObyBzY3JlZW4gcmVjb3JkaW5nIGhhcyBiZWVuIHN0YXJ0ZWQuIERvaW5nIG5vdGhpbmcnKTtcbiAgICByZXR1cm4gJyc7XG4gIH1cblxuICBsb2cuZGVidWcoJ1JldHJpZXZpbmcgdGhlIHJlc3VsdGluZyB2aWRlbyBkYXRhJyk7XG4gIGNvbnN0IHZpZGVvUGF0aCA9IGF3YWl0IHRoaXMuX3NjcmVlblJlY29yZGVyLnN0b3AoKTtcbiAgaWYgKCF2aWRlb1BhdGgpIHtcbiAgICBsb2cuZGVidWcoJ05vIHZpZGVvIGRhdGEgaXMgZm91bmQuIFJldHVybmluZyBhbiBlbXB0eSBzdHJpbmcnKTtcbiAgICByZXR1cm4gJyc7XG4gIH1cbiAgcmV0dXJuIGF3YWl0IHVwbG9hZFJlY29yZGVkTWVkaWEodmlkZW9QYXRoLCBvcHRpb25zLnJlbW90ZVBhdGgsIG9wdGlvbnMpO1xufTtcblxuZXhwb3J0IGRlZmF1bHQgY29tbWFuZHM7XG4iXSwiZmlsZSI6ImxpYi9jb21tYW5kcy9yZWNvcmQtc2NyZWVuLmpzIiwic291cmNlUm9vdCI6Ii4uLy4uLy4uIn0=
