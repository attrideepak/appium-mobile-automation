"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

require("source-map-support/register");

var _lodash = _interopRequireDefault(require("lodash"));

var _path = _interopRequireDefault(require("path"));

var _appiumBaseDriver = require("appium-base-driver");

var _appiumSupport = require("appium-support");

var _teen_process = require("teen_process");

var _asyncbox = require("asyncbox");

var _portscanner = require("portscanner");

var _child_process = require("child_process");

var _utils = require("./utils");

const log = _appiumSupport.logger.getLogger('WebDriverAgentMac');

const HOST = '127.0.0.1';
const ROOT_DIR = _path.default.basename(__dirname) === 'lib' ? _path.default.resolve(__dirname, process.env.NO_PRECOMPILE ? '..' : '../..') : __dirname;

const WDA_ROOT = _path.default.resolve(ROOT_DIR, 'WebDriverAgentMac');

const WDA_PROJECT_NAME = 'WebDriverAgentMac.xcodeproj';

const WDA_PROJECT = (wdaRoot = WDA_ROOT) => _path.default.resolve(wdaRoot, WDA_PROJECT_NAME);

const RUNNER_SCHEME = 'WebDriverAgentRunner';
const DISABLE_STORE_ARG = 'COMPILER_INDEX_STORE_ENABLE=NO';
const XCODEBUILD = 'xcodebuild';
const STARTUP_TIMEOUT_MS = 120000;
const DEFAULT_SYSTEM_PORT = 10100;
const RUNNING_PROCESS_IDS = [];

const RECENT_UPGRADE_TIMESTAMP_PATH = _path.default.join('.appium', 'webdriveragent_mac', 'upgrade.time');

async function getUpgradeTimestamp() {
  const packageManifest = _path.default.resolve(ROOT_DIR, 'package.json');

  if (!(await _appiumSupport.fs.exists(packageManifest))) {
    return null;
  }

  const {
    mtime
  } = await _appiumSupport.fs.stat(packageManifest);
  return mtime.getTime();
}

async function cleanupObsoleteProcesses() {
  if (!_lodash.default.isEmpty(RUNNING_PROCESS_IDS)) {
    log.debug(`Cleaning up ${RUNNING_PROCESS_IDS.length} obsolete ` + _appiumSupport.util.pluralize('process', RUNNING_PROCESS_IDS.length, false));

    try {
      await (0, _teen_process.exec)('kill', ['-9', ...RUNNING_PROCESS_IDS]);
    } catch (ign) {}

    _lodash.default.pullAll(RUNNING_PROCESS_IDS, RUNNING_PROCESS_IDS);
  }
}

process.once('exit', () => {
  if (!_lodash.default.isEmpty(RUNNING_PROCESS_IDS)) {
    try {
      (0, _child_process.execSync)(`kill -9 ${RUNNING_PROCESS_IDS.join(' ')}`);
    } catch (ign) {}

    _lodash.default.pullAll(RUNNING_PROCESS_IDS, RUNNING_PROCESS_IDS);
  }
});

class WDAMacProxy extends _appiumBaseDriver.JWProxy {
  async proxyCommand(url, method, body = null) {
    if (this.didProcessExit) {
      throw new _appiumBaseDriver.errors.InvalidContextError(`'${method} ${url}' cannot be proxied to Mac2 Driver server because ` + 'its process is not running (probably crashed). Check the Appium log for more details');
    }

    return await super.proxyCommand(url, method, body);
  }

}

class WDAMacProcess {
  constructor() {
    this.showServerLogs = false;
    this.port = DEFAULT_SYSTEM_PORT;
    this.bootstrapRoot = WDA_ROOT;
    this.proc = null;
  }

  get isRunning() {
    var _this$proc;

    return !!((_this$proc = this.proc) === null || _this$proc === void 0 ? void 0 : _this$proc.isRunning);
  }

  get pid() {
    return this.isRunning ? this.proc.pid : null;
  }

  async listChildrenPids() {
    return this.pid ? await (0, _utils.listChildrenProcessIds)(this.pid) : [];
  }

  async isFreshUpgrade() {
    const homeFolder = process.env.HOME;

    if (!homeFolder) {
      log.info('The HOME folder path cannot be determined');
      return false;
    }

    const currentUpgradeTimestamp = await getUpgradeTimestamp();

    if (!_lodash.default.isInteger(currentUpgradeTimestamp)) {
      log.info('It is impossible to determine the timestamp of the package');
      return false;
    }

    const timestampPath = _path.default.resolve(homeFolder, RECENT_UPGRADE_TIMESTAMP_PATH);

    if (await _appiumSupport.fs.exists(timestampPath)) {
      try {
        await _appiumSupport.fs.access(timestampPath, _appiumSupport.fs.W_OK);
      } catch (ign) {
        log.info(`WebDriverAgent upgrade timestamp at '${timestampPath}' is not writeable`);
        return false;
      }

      const recentUpgradeTimestamp = parseInt(await _appiumSupport.fs.readFile(timestampPath, 'utf8'), 10);

      if (_lodash.default.isInteger(recentUpgradeTimestamp)) {
        if (recentUpgradeTimestamp >= currentUpgradeTimestamp) {
          log.info(`WebDriverAgent sources are up to date ` + `(${recentUpgradeTimestamp} >= ${currentUpgradeTimestamp})`);
          return false;
        }

        log.info(`WebDriverAgent sources have been upgraded ` + `(${recentUpgradeTimestamp} < ${currentUpgradeTimestamp})`);
      } else {
        log.warn(`The recent upgrade timestamp at '${timestampPath}' is corrupted. Trying to fix it`);
      }
    }

    try {
      await (0, _appiumSupport.mkdirp)(_path.default.dirname(timestampPath));
      await _appiumSupport.fs.writeFile(timestampPath, `${currentUpgradeTimestamp}`, 'utf8');
      log.debug(`Stored the recent WebDriverAgent upgrade timestamp ${currentUpgradeTimestamp} ` + `at '${timestampPath}'`);
    } catch (e) {
      log.info(`Unable to create the recent WebDriverAgent upgrade timestamp at '${timestampPath}'. ` + `Original error: ${e.message}`);
      return false;
    }

    return true;
  }

  async init(opts = {}) {
    var _opts$showServerLogs, _opts$systemPort, _opts$bootstrapRoot;

    if (this.isRunning) {
      return false;
    }

    this.showServerLogs = (_opts$showServerLogs = opts.showServerLogs) !== null && _opts$showServerLogs !== void 0 ? _opts$showServerLogs : this.showServerLogs;
    this.port = (_opts$systemPort = opts.systemPort) !== null && _opts$systemPort !== void 0 ? _opts$systemPort : this.port;
    this.bootstrapRoot = (_opts$bootstrapRoot = opts.bootstrapRoot) !== null && _opts$bootstrapRoot !== void 0 ? _opts$bootstrapRoot : this.bootstrapRoot;
    log.debug(`Using bootstrap root: ${this.bootstrapRoot}`);

    if (!(await _appiumSupport.fs.exists(WDA_PROJECT(this.bootstrapRoot)))) {
      throw new Error(`${WDA_PROJECT_NAME} does not exist at '${WDA_PROJECT(this.bootstrapRoot)}'. ` + `Was 'bootstrapRoot' set to a proper value?`);
    }

    await cleanupObsoleteProcesses();
    let xcodebuild;

    try {
      xcodebuild = await _appiumSupport.fs.which(XCODEBUILD);
    } catch (e) {
      throw new Error(`${XCODEBUILD} binary cannot be found in PATH. ` + `Please make sure that Xcode is installed on your system`);
    }

    log.debug(`Using ${XCODEBUILD} binary at '${xcodebuild}'`);

    if (await this.isFreshUpgrade()) {
      log.info('Performing project cleanup');
      const args = ['clean', '-project', WDA_PROJECT(this.bootstrapRoot), '-scheme', RUNNER_SCHEME];

      try {
        await (0, _teen_process.exec)(XCODEBUILD, args, {
          cwd: this.bootstrapRoot
        });
      } catch (e) {
        log.warn(`Cannot perform project cleanup. ` + `Original error: ${e.stderr || e.message}`);
      }
    }

    log.debug(`Using port ${this.port}`);
    const isPortBusy = (await (0, _portscanner.checkPortStatus)(this.port, HOST)) === 'open';

    if (isPortBusy) {
      throw new Error(`The port #${this.port} is busy. ` + `Consider setting 'systemPort' capability to another free port number and/or ` + `make sure the previous driver session(s) have been closed properly.`);
    }

    const args = ['build-for-testing', 'test-without-building', '-project', WDA_PROJECT(this.bootstrapRoot), '-scheme', RUNNER_SCHEME, DISABLE_STORE_ARG];
    const env = Object.assign({}, process.env, {
      USE_PORT: `${this.port}`
    });
    this.proc = new _teen_process.SubProcess(xcodebuild, args, {
      cwd: this.bootstrapRoot,
      env
    });

    if (!this.showServerLogs) {
      log.info(`Mac2Driver host process logging is disabled. ` + `All the ${XCODEBUILD} output is going to be suppressed. ` + `Set the 'showServerLogs' capability to 'true' if this is an undesired behavior`);
    }

    this.proc.on('output', (stdout, stderr) => {
      if (!this.showServerLogs) {
        return;
      }

      const line = _lodash.default.trim(stdout || stderr);

      if (line) {
        log.debug(`[${XCODEBUILD}] ${line}`);
      }
    });
    this.proc.on('exit', (code, signal) => {
      log.info(`Mac2Driver host process has exited with code ${code}, signal ${signal}`);
    });
    log.info(`Starting Mac2Driver host process: ${XCODEBUILD} ${_appiumSupport.util.quote(args)}`);
    await this.proc.start(0);
    return true;
  }

  async stop() {
    if (this.isRunning) {
      const childrenPids = await this.listChildrenPids();

      if (!_lodash.default.isEmpty(childrenPids)) {
        try {
          await (0, _teen_process.exec)('kill', childrenPids);
        } catch (ign) {}
      }

      await this.proc.stop('SIGTERM', 3000);
    }
  }

  async kill() {
    if (this.isRunning) {
      const childrenPids = await this.listChildrenPids();

      if (!_lodash.default.isEmpty(childrenPids)) {
        try {
          await (0, _teen_process.exec)('kill', ['-9', ...childrenPids]);
        } catch (ign) {}
      }

      try {
        await this.proc.stop('SIGKILL');
      } catch (ign) {}
    }
  }

}

class WDAMacServer {
  constructor() {
    this.process = new WDAMacProcess();
    this.serverStartupTimeoutMs = STARTUP_TIMEOUT_MS;
    this.proxy = null;
  }

  get isRunning() {
    var _this$process;

    return !!((_this$process = this.process) === null || _this$process === void 0 ? void 0 : _this$process.isRunning);
  }

  async isProxyReady(throwOnExit = true) {
    if (!this.proxy) {
      return false;
    }

    try {
      await this.proxy.command('/status', 'GET');
      return true;
    } catch (err) {
      if (throwOnExit && this.proxy.didProcessExit) {
        throw new Error(err.message);
      }

      return false;
    }
  }

  async startSession(caps) {
    var _caps$serverStartupTi;

    this.serverStartupTimeoutMs = (_caps$serverStartupTi = caps.serverStartupTimeout) !== null && _caps$serverStartupTi !== void 0 ? _caps$serverStartupTi : this.serverStartupTimeoutMs;
    const wasProcessInitNecessary = await this.process.init(caps);

    if (wasProcessInitNecessary || !(await this.isProxyReady(false))) {
      this.proxy = new WDAMacProxy({
        server: HOST,
        port: this.process.port,
        base: '',
        keepAlive: true
      });
      this.proxy.didProcessExit = false;
      this.process.proc.on('exit', () => {
        this.proxy.didProcessExit = true;
      });
      const timer = new _appiumSupport.timing.Timer().start();

      try {
        await (0, _asyncbox.waitForCondition)(async () => await this.isProxyReady(), {
          waitMs: this.serverStartupTimeoutMs,
          intervalMs: 1000
        });
      } catch (e) {
        if (this.process.isRunning) {
          await this.process.kill();
        }

        if (/Condition unmet/.test(e.message)) {
          throw new Error(`Mac2Driver server is not listening within ${this.serverStartupTimeoutMs}ms timeout. ` + `Try to increase the value of 'serverStartupTimeout' capability, check the server logs ` + `and make sure the ${XCODEBUILD} host process could be started manually from a terminal`);
        }

        throw e;
      }

      const pid = this.process.pid;
      const childrenPids = await this.process.listChildrenPids();
      RUNNING_PROCESS_IDS.push(...childrenPids, pid);
      this.process.proc.on('exit', () => void _lodash.default.pull(RUNNING_PROCESS_IDS, pid));
      log.info(`The host process is ready within ${timer.getDuration().asMilliSeconds.toFixed(0)}ms`);
    } else {
      log.info('The host process has already been listening. Proceeding with session creation');
    }

    await this.proxy.command('/session', 'POST', {
      capabilities: {
        firstMatch: [{}],
        alwaysMatch: caps
      }
    });
  }

  async stopSession() {
    var _this$proxy;

    if (!this.isRunning) {
      log.info(`Mac2Driver session cannot be stopped, because the server is not running`);
      return;
    }

    if ((_this$proxy = this.proxy) === null || _this$proxy === void 0 ? void 0 : _this$proxy.sessionId) {
      try {
        await this.proxy.command(`/session/${this.proxy.sessionId}`, 'DELETE');
      } catch (e) {
        log.info(`Mac2Driver session cannot be deleted. Original error: ${e.message}`);
      }
    }
  }

}

const WDA_MAC_SERVER = new WDAMacServer();
var _default = WDA_MAC_SERVER;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi93ZGEtbWFjLmpzIl0sIm5hbWVzIjpbImxvZyIsImxvZ2dlciIsImdldExvZ2dlciIsIkhPU1QiLCJST09UX0RJUiIsInBhdGgiLCJiYXNlbmFtZSIsIl9fZGlybmFtZSIsInJlc29sdmUiLCJwcm9jZXNzIiwiZW52IiwiTk9fUFJFQ09NUElMRSIsIldEQV9ST09UIiwiV0RBX1BST0pFQ1RfTkFNRSIsIldEQV9QUk9KRUNUIiwid2RhUm9vdCIsIlJVTk5FUl9TQ0hFTUUiLCJESVNBQkxFX1NUT1JFX0FSRyIsIlhDT0RFQlVJTEQiLCJTVEFSVFVQX1RJTUVPVVRfTVMiLCJERUZBVUxUX1NZU1RFTV9QT1JUIiwiUlVOTklOR19QUk9DRVNTX0lEUyIsIlJFQ0VOVF9VUEdSQURFX1RJTUVTVEFNUF9QQVRIIiwiam9pbiIsImdldFVwZ3JhZGVUaW1lc3RhbXAiLCJwYWNrYWdlTWFuaWZlc3QiLCJmcyIsImV4aXN0cyIsIm10aW1lIiwic3RhdCIsImdldFRpbWUiLCJjbGVhbnVwT2Jzb2xldGVQcm9jZXNzZXMiLCJfIiwiaXNFbXB0eSIsImRlYnVnIiwibGVuZ3RoIiwidXRpbCIsInBsdXJhbGl6ZSIsImlnbiIsInB1bGxBbGwiLCJvbmNlIiwiV0RBTWFjUHJveHkiLCJKV1Byb3h5IiwicHJveHlDb21tYW5kIiwidXJsIiwibWV0aG9kIiwiYm9keSIsImRpZFByb2Nlc3NFeGl0IiwiZXJyb3JzIiwiSW52YWxpZENvbnRleHRFcnJvciIsIldEQU1hY1Byb2Nlc3MiLCJjb25zdHJ1Y3RvciIsInNob3dTZXJ2ZXJMb2dzIiwicG9ydCIsImJvb3RzdHJhcFJvb3QiLCJwcm9jIiwiaXNSdW5uaW5nIiwicGlkIiwibGlzdENoaWxkcmVuUGlkcyIsImlzRnJlc2hVcGdyYWRlIiwiaG9tZUZvbGRlciIsIkhPTUUiLCJpbmZvIiwiY3VycmVudFVwZ3JhZGVUaW1lc3RhbXAiLCJpc0ludGVnZXIiLCJ0aW1lc3RhbXBQYXRoIiwiYWNjZXNzIiwiV19PSyIsInJlY2VudFVwZ3JhZGVUaW1lc3RhbXAiLCJwYXJzZUludCIsInJlYWRGaWxlIiwid2FybiIsImRpcm5hbWUiLCJ3cml0ZUZpbGUiLCJlIiwibWVzc2FnZSIsImluaXQiLCJvcHRzIiwic3lzdGVtUG9ydCIsIkVycm9yIiwieGNvZGVidWlsZCIsIndoaWNoIiwiYXJncyIsImN3ZCIsInN0ZGVyciIsImlzUG9ydEJ1c3kiLCJPYmplY3QiLCJhc3NpZ24iLCJVU0VfUE9SVCIsIlN1YlByb2Nlc3MiLCJvbiIsInN0ZG91dCIsImxpbmUiLCJ0cmltIiwiY29kZSIsInNpZ25hbCIsInF1b3RlIiwic3RhcnQiLCJzdG9wIiwiY2hpbGRyZW5QaWRzIiwia2lsbCIsIldEQU1hY1NlcnZlciIsInNlcnZlclN0YXJ0dXBUaW1lb3V0TXMiLCJwcm94eSIsImlzUHJveHlSZWFkeSIsInRocm93T25FeGl0IiwiY29tbWFuZCIsImVyciIsInN0YXJ0U2Vzc2lvbiIsImNhcHMiLCJzZXJ2ZXJTdGFydHVwVGltZW91dCIsIndhc1Byb2Nlc3NJbml0TmVjZXNzYXJ5Iiwic2VydmVyIiwiYmFzZSIsImtlZXBBbGl2ZSIsInRpbWVyIiwidGltaW5nIiwiVGltZXIiLCJ3YWl0TXMiLCJpbnRlcnZhbE1zIiwidGVzdCIsInB1c2giLCJwdWxsIiwiZ2V0RHVyYXRpb24iLCJhc01pbGxpU2Vjb25kcyIsInRvRml4ZWQiLCJjYXBhYmlsaXRpZXMiLCJmaXJzdE1hdGNoIiwiYWx3YXlzTWF0Y2giLCJzdG9wU2Vzc2lvbiIsInNlc3Npb25JZCIsIldEQV9NQUNfU0VSVkVSIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7OztBQUFBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUVBLE1BQU1BLEdBQUcsR0FBR0Msc0JBQU9DLFNBQVAsQ0FBaUIsbUJBQWpCLENBQVo7O0FBRUEsTUFBTUMsSUFBSSxHQUFHLFdBQWI7QUFDQSxNQUFNQyxRQUFRLEdBQUdDLGNBQUtDLFFBQUwsQ0FBY0MsU0FBZCxNQUE2QixLQUE3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SyxDQUFDUSxXQUFOLEdBQW9CQyxjQUFwQixDQUFtQ0MsT0FBbkMsQ0FBMkMsQ0FBM0MsQ0FBOEMsSUFBM0Y7QUFDRCxLQW5DRCxNQW1DTztBQUNMN0gsTUFBQUEsR0FBRyxDQUFDOEQsSUFBSixDQUFTLCtFQUFUO0FBQ0Q7O0FBRUQsVUFBTSxLQUFLeUMsS0FBTCxDQUFXRyxPQUFYLENBQW1CLFVBQW5CLEVBQStCLE1BQS9CLEVBQXVDO0FBQzNDb0IsTUFBQUEsWUFBWSxFQUFFO0FBQ1pDLFFBQUFBLFVBQVUsRUFBRSxDQUFDLEVBQUQsQ0FEQTtBQUVaQyxRQUFBQSxXQUFXLEVBQUVuQjtBQUZEO0FBRDZCLEtBQXZDLENBQU47QUFNRDs7QUFFRCxRQUFNb0IsV0FBTixHQUFxQjtBQUFBOztBQUNuQixRQUFJLENBQUMsS0FBS3pFLFNBQVYsRUFBcUI7QUFDbkJ4RCxNQUFBQSxHQUFHLENBQUM4RCxJQUFKLENBQVUseUVBQVY7QUFDQTtBQUNEOztBQUVELHVCQUFJLEtBQUt5QyxLQUFULGdEQUFJLFlBQVkyQixTQUFoQixFQUEyQjtBQUN6QixVQUFJO0FBQ0YsY0FBTSxLQUFLM0IsS0FBTCxDQUFXRyxPQUFYLENBQW9CLFlBQVcsS0FBS0gsS0FBTCxDQUFXMkIsU0FBVSxFQUFwRCxFQUF1RCxRQUF2RCxDQUFOO0FBQ0QsT0FGRCxDQUVFLE9BQU94RCxDQUFQLEVBQVU7QUFDVjFFLFFBQUFBLEdBQUcsQ0FBQzhELElBQUosQ0FBVSx5REFBd0RZLENBQUMsQ0FBQ0MsT0FBUSxFQUE1RTtBQUNEO0FBQ0Y7QUFDRjs7QUEzRmdCOztBQThGbkIsTUFBTXdELGNBQWMsR0FBRyxJQUFJOUIsWUFBSixFQUF2QjtlQUVlOEIsYyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBfIGZyb20gJ2xvZGFzaCc7XG5pbXBvcnQgcGF0aCBmcm9tICdwYXRoJztcbmltcG9ydCB7IEpXUHJveHksIGVycm9ycyB9IGZyb20gJ2FwcGl1bS1iYXNlLWRyaXZlcic7XG5pbXBvcnQgeyBmcywgbG9nZ2VyLCB1dGlsLCB0aW1pbmcsIG1rZGlycCB9IGZyb20gJ2FwcGl1bS1zdXBwb3J0JztcbmltcG9ydCB7IFN1YlByb2Nlc3MsIGV4ZWMgfSBmcm9tICd0ZWVuX3Byb2Nlc3MnO1xuaW1wb3J0IHsgd2FpdEZvckNvbmRpdGlvbiB9IGZyb20gJ2FzeW5jYm94JztcbmltcG9ydCB7IGNoZWNrUG9ydFN0YXR1cyB9IGZyb20gJ3BvcnRzY2FubmVyJztcbmltcG9ydCB7IGV4ZWNTeW5jIH0gZnJvbSAnY2hpbGRfcHJvY2Vzcyc7XG5pbXBvcnQgeyBsaXN0Q2hpbGRyZW5Qcm9jZXNzSWRzIH0gZnJvbSAnLi91dGlscyc7XG5cbmNvbnN0IGxvZyA9IGxvZ2dlci5nZXRMb2dnZXIoJ1dlYkRyaXZlckFnZW50TWFjJyk7XG5cbmNvbnN0IEhPU1QgPSAnMTI3LjAuMC4xJztcbmNvbnN0IFJPT1RfRElSID0gcGF0aC5iYXNlbmFtZShfX2Rpcm5hbWUpID09PSAnbGliJ1xuICA/IHBhdGgucmVzb2x2ZShfX2Rpcm5hbWUsIHByb2Nlc3MuZW52Lk5PX1BSRUNPTVBJTEUgPyAnLi4nIDogJy4uLy4uJylcbiAgOiBfX2Rpcm5hbWU7XG5jb25zdCBXREFfUk9PVCA9IHBhdGgucmVzb2x2ZShST09UX0RJUiwgJ1dlYkRyaXZlckFnZW50TWFjJyk7XG5jb25zdCBXREFfUFJPSkVDVF9OQU1FID0gJ1dlYkRyaXZlckFnZW50TWFjLnhjb2RlcHJvaic7XG5jb25zdCBXREFfUFJPSkVDVCA9ICh3ZGFSb290ID0gV0RBX1JPT1QpID0+IHBhdGgucmVzb2x2ZSh3ZGFSb290LCBXREFfUFJPSkVDVF9OQU1FKTtcbmNvbnN0IFJVTk5FUl9TQ0hFTUUgPSAnV2ViRHJpdmVyQWdlbnRSdW5uZXInO1xuY29uc3QgRElTQUJMRV9TVE9SRV9BUkcgPSAnQ09NUElMRVJfSU5ERVhfU1RPUkVfRU5BQkxFPU5PJztcbmNvbnN0IFhDT0RFQlVJTEQgPSAneGNvZGVidWlsZCc7XG5jb25zdCBTVEFSVFVQX1RJTUVPVVRfTVMgPSAxMjAwMDA7XG5jb25zdCBERUZBVUxUX1NZU1RFTV9QT1JUID0gMTAxMDA7XG5jb25zdCBSVU5OSU5HX1BST0NFU1NfSURTID0gW107XG5jb25zdCBSRUNFTlRfVVBHUkFERV9USU1FU1RBTVBfUEFUSCA9IHBhdGguam9pbignLmFwcGl1bScsXG4gICd3ZWJkcml2ZXJhZ2VudF9tYWMnLCAndXBncmFkZS50aW1lJyk7XG5cblxuYXN5bmMgZnVuY3Rpb24gZ2V0VXBncmFkZVRpbWVzdGFtcCAoKSB7XG4gIGNvbnN0IHBhY2thZ2VNYW5pZmVzdCA9IHBhdGgucmVzb2x2ZShST09UX0RJUiwgJ3BhY2thZ2UuanNvbicpO1xuICBpZiAoIWF3YWl0IGZzLmV4aXN0cyhwYWNrYWdlTWFuaWZlc3QpKSB7XG4gICAgcmV0dXJuIG51bGw7XG4gIH1cbiAgY29uc3Qge210aW1lfSA9IGF3YWl0IGZzLnN0YXQocGFja2FnZU1hbmlmZXN0KTtcbiAgcmV0dXJuIG10aW1lLmdldFRpbWUoKTtcbn1cblxuYXN5bmMgZnVuY3Rpb24gY2xlYW51cE9ic29sZXRlUHJvY2Vzc2VzICgpIHtcbiAgaWYgKCFfLmlzRW1wdHkoUlVOTklOR19QUk9DRVNTX0lEUykpIHtcbiAgICBsb2cuZGVidWcoYENsZWFuaW5nIHVwICR7UlVOTklOR19QUk9DRVNTX0lEUy5sZW5ndGh9IG9ic29sZXRlIGAgK1xuICAgICAgdXRpbC5wbHVyYWxpemUoJ3Byb2Nlc3MnLCBSVU5OSU5HX1BST0NFU1NfSURTLmxlbmd0aCwgZmFsc2UpKTtcbiAgICB0cnkge1xuICAgICAgYXdhaXQgZXhlYygna2lsbCcsIFsnLTknLCAuLi5SVU5OSU5HX1BST0NFU1NfSURTXSk7XG4gICAgfSBjYXRjaCAoaWduKSB7fVxuICAgIF8ucHVsbEFsbChSVU5OSU5HX1BST0NFU1NfSURTLCBSVU5OSU5HX1BST0NFU1NfSURTKTtcbiAgfVxufVxuXG5wcm9jZXNzLm9uY2UoJ2V4aXQnLCAoKSA9PiB7XG4gIGlmICghXy5pc0VtcHR5KFJVTk5JTkdfUFJPQ0VTU19JRFMpKSB7XG4gICAgdHJ5IHtcbiAgICAgIGV4ZWNTeW5jKGBraWxsIC05ICR7UlVOTklOR19QUk9DRVNTX0lEUy5qb2luKCcgJyl9YCk7XG4gICAgfSBjYXRjaCAoaWduKSB7fVxuICAgIF8ucHVsbEFsbChSVU5OSU5HX1BST0NFU1NfSURTLCBSVU5OSU5HX1BST0NFU1NfSURTKTtcbiAgfVxufSk7XG5cblxuY2xhc3MgV0RBTWFjUHJveHkgZXh0ZW5kcyBKV1Byb3h5IHtcbiAgYXN5bmMgcHJveHlDb21tYW5kICh1cmwsIG1ldGhvZCwgYm9keSA9IG51bGwpIHtcbiAgICBpZiAodGhpcy5kaWRQcm9jZXNzRXhpdCkge1xuICAgICAgdGhyb3cgbmV3IGVycm9ycy5JbnZhbGlkQ29udGV4dEVycm9yKFxuICAgICAgICBgJyR7bWV0aG9kfSAke3VybH0nIGNhbm5vdCBiZSBwcm94aWVkIHRvIE1hYzIgRHJpdmVyIHNlcnZlciBiZWNhdXNlIGAgK1xuICAgICAgICAnaXRzIHByb2Nlc3MgaXMgbm90IHJ1bm5pbmcgKHByb2JhYmx5IGNyYXNoZWQpLiBDaGVjayB0aGUgQXBwaXVtIGxvZyBmb3IgbW9yZSBkZXRhaWxzJyk7XG4gICAgfVxuICAgIHJldHVybiBhd2FpdCBzdXBlci5wcm94eUNvbW1hbmQodXJsLCBtZXRob2QsIGJvZHkpO1xuICB9XG59XG5cbmNsYXNzIFdEQU1hY1Byb2Nlc3Mge1xuICBjb25zdHJ1Y3RvciAoKSB7XG4gICAgdGhpcy5zaG93U2VydmVyTG9ncyA9IGZhbHNlO1xuICAgIHRoaXMucG9ydCA9IERFRkFVTFRfU1lTVEVNX1BPUlQ7XG4gICAgdGhpcy5ib290c3RyYXBSb290ID0gV0RBX1JPT1Q7XG4gICAgdGhpcy5wcm9jID0gbnVsbDtcbiAgfVxuXG4gIGdldCBpc1J1bm5pbmcgKCkge1xuICAgIHJldHVybiAhISh0aGlzLnByb2M/LmlzUnVubmluZyk7XG4gIH1cblxuICBnZXQgcGlkICgpIHtcbiAgICByZXR1cm4gdGhpcy5pc1J1bm5pbmcgPyB0aGlzLnByb2MucGlkIDogbnVsbDtcbiAgfVxuXG4gIGFzeW5jIGxpc3RDaGlsZHJlblBpZHMgKCkge1xuICAgIHJldHVybiB0aGlzLnBpZCA/IChhd2FpdCBsaXN0Q2hpbGRyZW5Qcm9jZXNzSWRzKHRoaXMucGlkKSkgOiBbXTtcbiAgfVxuXG4gIGFzeW5jIGlzRnJlc2hVcGdyYWRlICgpIHtcbiAgICBjb25zdCBob21lRm9sZGVyID0gcHJvY2Vzcy5lbnYuSE9NRTtcbiAgICBpZiAoIWhvbWVGb2xkZXIpIHtcbiAgICAgIGxvZy5pbmZvKCdUaGUgSE9NRSBmb2xkZXIgcGF0aCBjYW5ub3QgYmUgZGV0ZXJtaW5lZCcpO1xuICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cblxuICAgIGNvbnN0IGN1cnJlbnRVcGdyYWRlVGltZXN0YW1wID0gYXdhaXQgZ2V0VXBncmFkZVRpbWVzdGFtcCgpO1xuICAgIGlmICghXy5pc0ludGVnZXIoY3VycmVudFVwZ3JhZGVUaW1lc3RhbXApKSB7XG4gICAgICBsb2cuaW5mbygnSXQgaXMgaW1wb3NzaWJsZSB0byBkZXRlcm1pbmUgdGhlIHRpbWVzdGFtcCBvZiB0aGUgcGFja2FnZScpO1xuICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cblxuICAgIGNvbnN0IHRpbWVzdGFtcFBhdGggPSBwYXRoLnJlc29sdmUoaG9tZUZvbGRlciwgUkVDRU5UX1VQR1JBREVfVElNRVNUQU1QX1BBVEgpO1xuICAgIGlmIChhd2FpdCBmcy5leGlzdHModGltZXN0YW1wUGF0aCkpIHtcbiAgICAgIHRyeSB7XG4gICAgICAgIGF3YWl0IGZzLmFjY2Vzcyh0aW1lc3RhbXBQYXRoLCBmcy5XX09LKTtcbiAgICAgIH0gY2F0Y2ggKGlnbikge1xuICAgICAgICBsb2cuaW5mbyhgV2ViRHJpdmVyQWdlbnQgdXBncmFkZSB0aW1lc3RhbXAgYXQgJyR7dGltZXN0YW1wUGF0aH0nIGlzIG5vdCB3cml0ZWFibGVgKTtcbiAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgfVxuICAgICAgY29uc3QgcmVjZW50VXBncmFkZVRpbWVzdGFtcCA9IHBhcnNlSW50KGF3YWl0IGZzLnJlYWRGaWxlKHRpbWVzdGFtcFBhdGgsICd1dGY4JyksIDEwKTtcbiAgICAgIGlmIChfLmlzSW50ZWdlcihyZWNlbnRVcGdyYWRlVGltZXN0YW1wKSkge1xuICAgICAgICBpZiAocmVjZW50VXBncmFkZVRpbWVzdGFtcCA+PSBjdXJyZW50VXBncmFkZVRpbWVzdGFtcCkge1xuICAgICAgICAgIGxvZy5pbmZvKGBXZWJEcml2ZXJBZ2VudCBzb3VyY2VzIGFyZSB1cCB0byBkYXRlIGAgK1xuICAgICAgICAgICAgYCgke3JlY2VudFVwZ3JhZGVUaW1lc3RhbXB9ID49ICR7Y3VycmVudFVwZ3JhZGVUaW1lc3RhbXB9KWApO1xuICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgfVxuICAgICAgICBsb2cuaW5mbyhgV2ViRHJpdmVyQWdlbnQgc291cmNlcyBoYXZlIGJlZW4gdXBncmFkZWQgYCArXG4gICAgICAgICAgYCgke3JlY2VudFVwZ3JhZGVUaW1lc3RhbXB9IDwgJHtjdXJyZW50VXBncmFkZVRpbWVzdGFtcH0pYCk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBsb2cud2FybihgVGhlIHJlY2VudCB1cGdyYWRlIHRpbWVzdGFtcCBhdCAnJHt0aW1lc3RhbXBQYXRofScgaXMgY29ycnVwdGVkLiBUcnlpbmcgdG8gZml4IGl0YCk7XG4gICAgICB9XG4gICAgfVxuXG4gICAgdHJ5IHtcbiAgICAgIGF3YWl0IG1rZGlycChwYXRoLmRpcm5hbWUodGltZXN0YW1wUGF0aCkpO1xuICAgICAgYXdhaXQgZnMud3JpdGVGaWxlKHRpbWVzdGFtcFBhdGgsIGAke2N1cnJlbnRVcGdyYWRlVGltZXN0YW1wfWAsICd1dGY4Jyk7XG4gICAgICBsb2cuZGVidWcoYFN0b3JlZCB0aGUgcmVjZW50IFdlYkRyaXZlckFnZW50IHVwZ3JhZGUgdGltZXN0YW1wICR7Y3VycmVudFVwZ3JhZGVUaW1lc3RhbXB9IGAgK1xuICAgICAgICBgYXQgJyR7dGltZXN0YW1wUGF0aH0nYCk7XG4gICAgfSBjYXRjaCAoZSkge1xuICAgICAgbG9nLmluZm8oYFVuYWJsZSB0byBjcmVhdGUgdGhlIHJlY2VudCBXZWJEcml2ZXJBZ2VudCB1cGdyYWRlIHRpbWVzdGFtcCBhdCAnJHt0aW1lc3RhbXBQYXRofScuIGAgK1xuICAgICAgICBgT3JpZ2luYWwgZXJyb3I6ICR7ZS5tZXNzYWdlfWApO1xuICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cblxuICAgIHJldHVybiB0cnVlO1xuICB9XG5cbiAgYXN5bmMgaW5pdCAob3B0cyA9IHt9KSB7XG4gICAgaWYgKHRoaXMuaXNSdW5uaW5nKSB7XG4gICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuXG4gICAgdGhpcy5zaG93U2VydmVyTG9ncyA9IG9wdHMuc2hvd1NlcnZlckxvZ3MgPz8gdGhpcy5zaG93U2VydmVyTG9ncztcbiAgICB0aGlzLnBvcnQgPSBvcHRzLnN5c3RlbVBvcnQgPz8gdGhpcy5wb3J0O1xuICAgIHRoaXMuYm9vdHN0cmFwUm9vdCA9IG9wdHMuYm9vdHN0cmFwUm9vdCA/PyB0aGlzLmJvb3RzdHJhcFJvb3Q7XG5cbiAgICBsb2cuZGVidWcoYFVzaW5nIGJvb3RzdHJhcCByb290OiAke3RoaXMuYm9vdHN0cmFwUm9vdH1gKTtcbiAgICBpZiAoIWF3YWl0IGZzLmV4aXN0cyhXREFfUFJPSkVDVCh0aGlzLmJvb3RzdHJhcFJvb3QpKSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGAke1dEQV9QUk9KRUNUX05BTUV9IGRvZXMgbm90IGV4aXN0IGF0ICcke1dEQV9QUk9KRUNUKHRoaXMuYm9vdHN0cmFwUm9vdCl9Jy4gYCArXG4gICAgICAgIGBXYXMgJ2Jvb3RzdHJhcFJvb3QnIHNldCB0byBhIHByb3BlciB2YWx1ZT9gKTtcbiAgICB9XG5cbiAgICBhd2FpdCBjbGVhbnVwT2Jzb2xldGVQcm9jZXNzZXMoKTtcblxuICAgIGxldCB4Y29kZWJ1aWxkO1xuICAgIHRyeSB7XG4gICAgICB4Y29kZWJ1aWxkID0gYXdhaXQgZnMud2hpY2goWENPREVCVUlMRCk7XG4gICAgfSBjYXRjaCAoZSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGAke1hDT0RFQlVJTER9IGJpbmFyeSBjYW5ub3QgYmUgZm91bmQgaW4gUEFUSC4gYCArXG4gICAgICAgIGBQbGVhc2UgbWFrZSBzdXJlIHRoYXQgWGNvZGUgaXMgaW5zdGFsbGVkIG9uIHlvdXIgc3lzdGVtYCk7XG4gICAgfVxuICAgIGxvZy5kZWJ1ZyhgVXNpbmcgJHtYQ09ERUJVSUxEfSBiaW5hcnkgYXQgJyR7eGNvZGVidWlsZH0nYCk7XG5cbiAgICBpZiAoYXdhaXQgdGhpcy5pc0ZyZXNoVXBncmFkZSgpKSB7XG4gICAgICBsb2cuaW5mbygnUGVyZm9ybWluZyBwcm9qZWN0IGNsZWFudXAnKTtcbiAgICAgIGNvbnN0IGFyZ3MgPSBbXG4gICAgICAgICdjbGVhbicsXG4gICAgICAgICctcHJvamVjdCcsIFdEQV9QUk9KRUNUKHRoaXMuYm9vdHN0cmFwUm9vdCksXG4gICAgICAgICctc2NoZW1lJywgUlVOTkVSX1NDSEVNRSxcbiAgICAgIF07XG4gICAgICB0cnkge1xuICAgICAgICBhd2FpdCBleGVjKFhDT0RFQlVJTEQsIGFyZ3MsIHtcbiAgICAgICAgICBjd2Q6IHRoaXMuYm9vdHN0cmFwUm9vdCxcbiAgICAgICAgfSk7XG4gICAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgIGxvZy53YXJuKGBDYW5ub3QgcGVyZm9ybSBwcm9qZWN0IGNsZWFudXAuIGAgK1xuICAgICAgICAgIGBPcmlnaW5hbCBlcnJvcjogJHtlLnN0ZGVyciB8fCBlLm1lc3NhZ2V9YCk7XG4gICAgICB9XG4gICAgfVxuXG4gICAgbG9nLmRlYnVnKGBVc2luZyBwb3J0ICR7dGhpcy5wb3J0fWApO1xuICAgIGNvbnN0IGlzUG9ydEJ1c3kgPSAoYXdhaXQgY2hlY2tQb3J0U3RhdHVzKHRoaXMucG9ydCwgSE9TVCkpID09PSAnb3Blbic7XG4gICAgaWYgKGlzUG9ydEJ1c3kpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgVGhlIHBvcnQgIyR7dGhpcy5wb3J0fSBpcyBidXN5LiBgICtcbiAgICAgICAgYENvbnNpZGVyIHNldHRpbmcgJ3N5c3RlbVBvcnQnIGNhcGFiaWxpdHkgdG8gYW5vdGhlciBmcmVlIHBvcnQgbnVtYmVyIGFuZC9vciBgICtcbiAgICAgICAgYG1ha2Ugc3VyZSB0aGUgcHJldmlvdXMgZHJpdmVyIHNlc3Npb24ocykgaGF2ZSBiZWVuIGNsb3NlZCBwcm9wZXJseS5gKTtcbiAgICB9XG5cbiAgICBjb25zdCBhcmdzID0gW1xuICAgICAgJ2J1aWxkLWZvci10ZXN0aW5nJywgJ3Rlc3Qtd2l0aG91dC1idWlsZGluZycsXG4gICAgICAnLXByb2plY3QnLCBXREFfUFJPSkVDVCh0aGlzLmJvb3RzdHJhcFJvb3QpLFxuICAgICAgJy1zY2hlbWUnLCBSVU5ORVJfU0NIRU1FLFxuICAgICAgRElTQUJMRV9TVE9SRV9BUkcsXG4gICAgXTtcbiAgICBjb25zdCBlbnYgPSBPYmplY3QuYXNzaWduKHt9LCBwcm9jZXNzLmVudiwge1xuICAgICAgVVNFX1BPUlQ6IGAke3RoaXMucG9ydH1gLFxuICAgIH0pO1xuICAgIHRoaXMucHJvYyA9IG5ldyBTdWJQcm9jZXNzKHhjb2RlYnVpbGQsIGFyZ3MsIHtcbiAgICAgIGN3ZDogdGhpcy5ib290c3RyYXBSb290LFxuICAgICAgZW52LFxuICAgIH0pO1xuICAgIGlmICghdGhpcy5zaG93U2VydmVyTG9ncykge1xuICAgICAgbG9nLmluZm8oYE1hYzJEcml2ZXIgaG9zdCBwcm9jZXNzIGxvZ2dpbmcgaXMgZGlzYWJsZWQuIGAgK1xuICAgICAgICBgQWxsIHRoZSAke1hDT0RFQlVJTER9IG91dHB1dCBpcyBnb2luZyB0byBiZSBzdXBwcmVzc2VkLiBgICtcbiAgICAgICAgYFNldCB0aGUgJ3Nob3dTZXJ2ZXJMb2dzJyBjYXBhYmlsaXR5IHRvICd0cnVlJyBpZiB0aGlzIGlzIGFuIHVuZGVzaXJlZCBiZWhhdmlvcmApO1xuICAgIH1cbiAgICB0aGlzLnByb2Mub24oJ291dHB1dCcsIChzdGRvdXQsIHN0ZGVycikgPT4ge1xuICAgICAgaWYgKCF0aGlzLnNob3dTZXJ2ZXJMb2dzKSB7XG4gICAgICAgIHJldHVybjtcbiAgICAgIH1cblxuICAgICAgY29uc3QgbGluZSA9IF8udHJpbShzdGRvdXQgfHwgc3RkZXJyKTtcbiAgICAgIGlmIChsaW5lKSB7XG4gICAgICAgIGxvZy5kZWJ1ZyhgWyR7WENPREVCVUlMRH1dICR7bGluZX1gKTtcbiAgICAgIH1cbiAgICB9KTtcbiAgICB0aGlzLnByb2Mub24oJ2V4aXQnLCAoY29kZSwgc2lnbmFsKSA9PiB7XG4gICAgICBsb2cuaW5mbyhgTWFjMkRyaXZlciBob3N0IHByb2Nlc3MgaGFzIGV4aXRlZCB3aXRoIGNvZGUgJHtjb2RlfSwgc2lnbmFsICR7c2lnbmFsfWApO1xuICAgIH0pO1xuICAgIGxvZy5pbmZvKGBTdGFydGluZyBNYWMyRHJpdmVyIGhvc3QgcHJvY2VzczogJHtYQ09ERUJVSUxEfSAke3V0aWwucXVvdGUoYXJncyl9YCk7XG4gICAgYXdhaXQgdGhpcy5wcm9jLnN0YXJ0KDApO1xuICAgIHJldHVybiB0cnVlO1xuICB9XG5cbiAgYXN5bmMgc3RvcCAoKSB7XG4gICAgaWYgKHRoaXMuaXNSdW5uaW5nKSB7XG4gICAgICBjb25zdCBjaGlsZHJlblBpZHMgPSBhd2FpdCB0aGlzLmxpc3RDaGlsZHJlblBpZHMoKTtcbiAgICAgIGlmICghXy5pc0VtcHR5KGNoaWxkcmVuUGlkcykpIHtcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICBhd2FpdCBleGVjKCdraWxsJywgY2hpbGRyZW5QaWRzKTtcbiAgICAgICAgfSBjYXRjaCAoaWduKSB7fVxuICAgICAgfVxuICAgICAgYXdhaXQgdGhpcy5wcm9jLnN0b3AoJ1NJR1RFUk0nLCAzMDAwKTtcbiAgICB9XG4gIH1cblxuICBhc3luYyBraWxsICgpIHtcbiAgICBpZiAodGhpcy5pc1J1bm5pbmcpIHtcbiAgICAgIGNvbnN0IGNoaWxkcmVuUGlkcyA9IGF3YWl0IHRoaXMubGlzdENoaWxkcmVuUGlkcygpO1xuICAgICAgaWYgKCFfLmlzRW1wdHkoY2hpbGRyZW5QaWRzKSkge1xuICAgICAgICB0cnkge1xuICAgICAgICAgIGF3YWl0IGV4ZWMoJ2tpbGwnLCBbJy05JywgLi4uY2hpbGRyZW5QaWRzXSk7XG4gICAgICAgIH0gY2F0Y2ggKGlnbikge31cbiAgICAgIH1cbiAgICAgIHRyeSB7XG4gICAgICAgIGF3YWl0IHRoaXMucHJvYy5zdG9wKCdTSUdLSUxMJyk7XG4gICAgICB9IGNhdGNoIChpZ24pIHt9XG4gICAgfVxuICB9XG59XG5cbmNsYXNzIFdEQU1hY1NlcnZlciB7XG4gIGNvbnN0cnVjdG9yICgpIHtcbiAgICB0aGlzLnByb2Nlc3MgPSBuZXcgV0RBTWFjUHJvY2VzcygpO1xuICAgIHRoaXMuc2VydmVyU3RhcnR1cFRpbWVvdXRNcyA9IFNUQVJUVVBfVElNRU9VVF9NUztcbiAgICB0aGlzLnByb3h5ID0gbnVsbDtcbiAgfVxuXG4gIGdldCBpc1J1bm5pbmcgKCkge1xuICAgIHJldHVybiAhISh0aGlzLnByb2Nlc3M/LmlzUnVubmluZyk7XG4gIH1cblxuICBhc3luYyBpc1Byb3h5UmVhZHkgKHRocm93T25FeGl0ID0gdHJ1ZSkge1xuICAgIGlmICghdGhpcy5wcm94eSkge1xuICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cblxuICAgIHRyeSB7XG4gICAgICBhd2FpdCB0aGlzLnByb3h5LmNvbW1hbmQoJy9zdGF0dXMnLCAnR0VUJyk7XG4gICAgICByZXR1cm4gdHJ1ZTtcbiAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgIGlmICh0aHJvd09uRXhpdCAmJiB0aGlzLnByb3h5LmRpZFByb2Nlc3NFeGl0KSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihlcnIubWVzc2FnZSk7XG4gICAgICB9XG4gICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuICB9XG5cbiAgYXN5bmMgc3RhcnRTZXNzaW9uIChjYXBzKSB7XG4gICAgdGhpcy5zZXJ2ZXJTdGFydHVwVGltZW91dE1zID0gY2Fwcy5zZXJ2ZXJTdGFydHVwVGltZW91dCA/PyB0aGlzLnNlcnZlclN0YXJ0dXBUaW1lb3V0TXM7XG4gICAgY29uc3Qgd2FzUHJvY2Vzc0luaXROZWNlc3NhcnkgPSBhd2FpdCB0aGlzLnByb2Nlc3MuaW5pdChjYXBzKTtcblxuICAgIGlmICh3YXNQcm9jZXNzSW5pdE5lY2Vzc2FyeSB8fCAhKGF3YWl0IHRoaXMuaXNQcm94eVJlYWR5KGZhbHNlKSkpIHtcbiAgICAgIHRoaXMucHJveHkgPSBuZXcgV0RBTWFjUHJveHkoe1xuICAgICAgICBzZXJ2ZXI6IEhPU1QsXG4gICAgICAgIHBvcnQ6IHRoaXMucHJvY2Vzcy5wb3J0LFxuICAgICAgICBiYXNlOiAnJyxcbiAgICAgICAga2VlcEFsaXZlOiB0cnVlLFxuICAgICAgfSk7XG4gICAgICB0aGlzLnByb3h5LmRpZFByb2Nlc3NFeGl0ID0gZmFsc2U7XG4gICAgICB0aGlzLnByb2Nlc3MucHJvYy5vbignZXhpdCcsICgpID0+IHtcbiAgICAgICAgdGhpcy5wcm94eS5kaWRQcm9jZXNzRXhpdCA9IHRydWU7XG4gICAgICB9KTtcblxuICAgICAgY29uc3QgdGltZXIgPSBuZXcgdGltaW5nLlRpbWVyKCkuc3RhcnQoKTtcbiAgICAgIHRyeSB7XG4gICAgICAgIGF3YWl0IHdhaXRGb3JDb25kaXRpb24oYXN5bmMgKCkgPT4gYXdhaXQgdGhpcy5pc1Byb3h5UmVhZHkoKSwge1xuICAgICAgICAgIHdhaXRNczogdGhpcy5zZXJ2ZXJTdGFydHVwVGltZW91dE1zLFxuICAgICAgICAgIGludGVydmFsTXM6IDEwMDAsXG4gICAgICAgIH0pO1xuICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICBpZiAodGhpcy5wcm9jZXNzLmlzUnVubmluZykge1xuICAgICAgICAgIC8vIGF2b2lkIFwiZnJvemVuXCIgcHJvY2Vzc2VzLFxuICAgICAgICAgIGF3YWl0IHRoaXMucHJvY2Vzcy5raWxsKCk7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKC9Db25kaXRpb24gdW5tZXQvLnRlc3QoZS5tZXNzYWdlKSkge1xuICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgTWFjMkRyaXZlciBzZXJ2ZXIgaXMgbm90IGxpc3RlbmluZyB3aXRoaW4gJHt0aGlzLnNlcnZlclN0YXJ0dXBUaW1lb3V0TXN9bXMgdGltZW91dC4gYCArXG4gICAgICAgICAgICBgVHJ5IHRvIGluY3JlYXNlIHRoZSB2YWx1ZSBvZiAnc2VydmVyU3RhcnR1cFRpbWVvdXQnIGNhcGFiaWxpdHksIGNoZWNrIHRoZSBzZXJ2ZXIgbG9ncyBgICtcbiAgICAgICAgICAgIGBhbmQgbWFrZSBzdXJlIHRoZSAke1hDT0RFQlVJTER9IGhvc3QgcHJvY2VzcyBjb3VsZCBiZSBzdGFydGVkIG1hbnVhbGx5IGZyb20gYSB0ZXJtaW5hbGApO1xuICAgICAgICB9XG4gICAgICAgIHRocm93IGU7XG4gICAgICB9XG4gICAgICBjb25zdCBwaWQgPSB0aGlzLnByb2Nlc3MucGlkO1xuICAgICAgY29uc3QgY2hpbGRyZW5QaWRzID0gYXdhaXQgdGhpcy5wcm9jZXNzLmxpc3RDaGlsZHJlblBpZHMoKTtcbiAgICAgIFJVTk5JTkdfUFJPQ0VTU19JRFMucHVzaCguLi5jaGlsZHJlblBpZHMsIHBpZCk7XG4gICAgICB0aGlzLnByb2Nlc3MucHJvYy5vbignZXhpdCcsICgpID0+IHZvaWQgXy5wdWxsKFJVTk5JTkdfUFJPQ0VTU19JRFMsIHBpZCkpO1xuICAgICAgbG9nLmluZm8oYFRoZSBob3N0IHByb2Nlc3MgaXMgcmVhZHkgd2l0aGluICR7dGltZXIuZ2V0RHVyYXRpb24oKS5hc01pbGxpU2Vjb25kcy50b0ZpeGVkKDApfW1zYCk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGxvZy5pbmZvKCdUaGUgaG9zdCBwcm9jZXNzIGhhcyBhbHJlYWR5IGJlZW4gbGlzdGVuaW5nLiBQcm9jZWVkaW5nIHdpdGggc2Vzc2lvbiBjcmVhdGlvbicpO1xuICAgIH1cblxuICAgIGF3YWl0IHRoaXMucHJveHkuY29tbWFuZCgnL3Nlc3Npb24nLCAnUE9TVCcsIHtcbiAgICAgIGNhcGFiaWxpdGllczoge1xuICAgICAgICBmaXJzdE1hdGNoOiBbe31dLFxuICAgICAgICBhbHdheXNNYXRjaDogY2FwcyxcbiAgICAgIH1cbiAgICB9KTtcbiAgfVxuXG4gIGFzeW5jIHN0b3BTZXNzaW9uICgpIHtcbiAgICBpZiAoIXRoaXMuaXNSdW5uaW5nKSB7XG4gICAgICBsb2cuaW5mbyhgTWFjMkRyaXZlciBzZXNzaW9uIGNhbm5vdCBiZSBzdG9wcGVkLCBiZWNhdXNlIHRoZSBzZXJ2ZXIgaXMgbm90IHJ1bm5pbmdgKTtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBpZiAodGhpcy5wcm94eT8uc2Vzc2lvbklkKSB7XG4gICAgICB0cnkge1xuICAgICAgICBhd2FpdCB0aGlzLnByb3h5LmNvbW1hbmQoYC9zZXNzaW9uLyR7dGhpcy5wcm94eS5zZXNzaW9uSWR9YCwgJ0RFTEVURScpO1xuICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICBsb2cuaW5mbyhgTWFjMkRyaXZlciBzZXNzaW9uIGNhbm5vdCBiZSBkZWxldGVkLiBPcmlnaW5hbCBlcnJvcjogJHtlLm1lc3NhZ2V9YCk7XG4gICAgICB9XG4gICAgfVxuICB9XG59XG5cbmNvbnN0IFdEQV9NQUNfU0VSVkVSID0gbmV3IFdEQU1hY1NlcnZlcigpO1xuXG5leHBvcnQgZGVmYXVsdCBXREFfTUFDX1NFUlZFUjtcbiJdLCJmaWxlIjoibGliL3dkYS1tYWMuanMiLCJzb3VyY2VSb290IjoiLi4vLi4ifQ==
