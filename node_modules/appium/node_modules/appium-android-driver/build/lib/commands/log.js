"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = exports.helpers = exports.commands = void 0;

require("source-map-support/register");

var _logger = _interopRequireDefault(require("../logger"));

var _os = _interopRequireDefault(require("os"));

var _lodash = _interopRequireDefault(require("lodash"));

var _ws = _interopRequireDefault(require("ws"));

var _appiumBaseDriver = require("appium-base-driver");

const GET_SERVER_LOGS_FEATURE = 'get_server_logs';
let commands = {},
    helpers = {},
    extensions = {};
exports.helpers = helpers;
exports.commands = commands;

const WEBSOCKET_ENDPOINT = sessionId => `${_appiumBaseDriver.DEFAULT_WS_PATHNAME_PREFIX}/session/${sessionId}/appium/device/logcat`;

function toLogRecord(timestamp, level, message) {
  return {
    timestamp,
    level,
    message
  };
}

extensions.supportedLogTypes = {
  logcat: {
    description: 'Logs for Android applications on real device and emulators via ADB',
    getter: async self => await self.adb.getLogcatLogs()
  },
  bugreport: {
    description: `'adb bugreport' output for advanced issues diagnostic`,
    getter: async self => {
      const output = await self.adb.bugreport();
      const timestamp = Date.now();
      return output.split(_os.default.EOL).map(x => toLogRecord(timestamp, 'ALL', x));
    }
  },
  server: {
    description: 'Appium server logs',
    getter: self => {
      self.ensureFeatureEnabled(GET_SERVER_LOGS_FEATURE);
      const timestamp = Date.now();
      return _logger.default.unwrap().record.map(x => toLogRecord(timestamp, 'ALL', _lodash.default.isEmpty(x.prefix) ? x.message : `[${x.prefix}] ${x.message}`));
    }
  }
};

commands.mobileStartLogsBroadcast = async function mobileStartLogsBroadcast() {
  const pathname = WEBSOCKET_ENDPOINT(this.sessionId);

  if (!_lodash.default.isEmpty(await this.server.getWebSocketHandlers(pathname))) {
    _logger.default.debug(`The logcat broadcasting web socket server is already listening at ${pathname}`);

    return;
  }

  _logger.default.info(`Assigning logcat broadcasting web socket server to ${pathname}`);

  const wss = new _ws.default.Server({
    noServer: true
  });
  wss.on('connection', (ws, req) => {
    if (req) {
      const remoteIp = _lodash.default.isEmpty(req.headers['x-forwarded-for']) ? req.connection.remoteAddress : req.headers['x-forwarded-for'];

      _logger.default.debug(`Established a new logcat listener web socket connection from ${remoteIp}`);
    } else {
      _logger.default.debug('Established a new logcat listener web socket connection');
    }

    if (_lodash.default.isEmpty(this._logcatWebsocketListener)) {
      this._logcatWebsocketListener = logRecord => {
        if (ws && ws.readyState === _ws.default.OPEN) {
          ws.send(logRecord.message);
        }
      };
    }

    this.adb.setLogcatListener(this._logcatWebsocketListener);
    ws.on('close', (code, reason) => {
      if (!_lodash.default.isEmpty(this._logcatWebsocketListener)) {
        try {
          this.adb.removeLogcatListener(this._logcatWebsocketListener);
        } catch (ign) {}

        this._logcatWebsocketListener = null;
      }

      let closeMsg = 'Logcat listener web socket is closed.';

      if (!_lodash.default.isEmpty(code)) {
        closeMsg += ` Code: ${code}.`;
      }

      if (!_lodash.default.isEmpty(reason)) {
        closeMsg += ` Reason: ${reason}.`;
      }

      _logger.default.debug(closeMsg);
    });
  });
  await this.server.addWebSocketHandler(pathname, wss);
};

commands.mobileStopLogsBroadcast = async function mobileStopLogsBroadcast() {
  const pathname = WEBSOCKET_ENDPOINT(this.sessionId);

  if (_lodash.default.isEmpty(await this.server.getWebSocketHandlers(pathname))) {
    return;
  }

  _logger.default.debug('Stopping the logcat broadcasting web socket server');

  await this.server.removeWebSocketHandler(pathname);
};

commands.getLogTypes = async function getLogTypes() {
  const nativeLogTypes = await _appiumBaseDriver.BaseDriver.prototype.getLogTypes.call(this);

  if (this.isWebContext()) {
    const webLogTypes = await this.chromedriver.jwproxy.command('/log/types', 'GET');
    return [...nativeLogTypes, ...webLogTypes];
  }

  return nativeLogTypes;
};

commands.getLog = async function getLog(logType) {
  if (this.isWebContext() && !_lodash.default.keys(this.supportedLogTypes).includes(logType)) {
    return await this.chromedriver.jwproxy.command('/log', 'POST', {
      type: logType
    });
  }

  return await _appiumBaseDriver.BaseDriver.prototype.getLog.call(this, logType);
};

Object.assign(extensions, commands, helpers);
var _default = extensions;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9jb21tYW5kcy9sb2cuanMiXSwibmFtZXMiOlsiR0VUX1NFUlZFUl9MT0dTX0ZFQVRVUkUiLCJjb21tYW5kcyIsImhlbHBlcnMiLCJleHRlbnNpb25zIiwiV0VCU09DS0VUX0VORFBPSU5UIiwic2Vzc2lvbklkIiwiREVGQVVMVF9XU19QQVRITkFNRV9QUkVGSVgiLCJ0b0xvZ1JlY29yZCIsInRpbWVzdGFtcCIsImxldmVsIiwibWVzc2FnZSIsInN1cHBvcnRlZExvZ1R5cGVzIiwibG9nY2F0IiwiZGVzY3JpcHRpb24iLCJnZXR0ZXIiLCJzZWxmIiwiYWRiIiwiZ2V0TG9nY2F0TG9ncyIsImJ1Z3JlcG9ydCIsIm91dHB1dCIsIkRhdGUiLCJub3ciLCJzcGxpdCIsIm9zIiwiRU9MIiwibWFwIiwieCIsInNlcnZlciIsImVuc3VyZUZlYXR1cmVFbmFibGVkIiwibG9nIiwidW53cmFwIiwicmVjb3JkIiwiXyIsImlzRW1wdHkiLCJwcmVmaXgiLCJtb2JpbGVTdGFydExvZ3NCcm9hZGNhc3QiLCJwYXRobmFtZSIsImdldFdlYlNvY2tldEhhbmRsZXJzIiwiZGVidWciLCJpbmZvIiwid3NzIiwiV2ViU29ja2V0IiwiU2VydmVyIiwibm9TZXJ2ZXIiLCJvbiIsIndzIiwicmVxIiwicmVtb3RlSXAiLCJoZWFkZXJzIiwiY29ubmVjdGlvbiIsInJlbW90ZUFkZHJlc3MiLCJfbG9nY2F0V2Vic29ja2V0TGlzdGVuZXIiLCJsb2dSZWNvcmQiLCJyZWFkeVN0YXRlIiwiT1BFTiIsInNlbmQiLCJzZXRMb2djYXRMaXN0ZW5lciIsImNvZGUiLCJyZWFzb24iLCJyZW1vdmVMb2djYXRMaXN0ZW5lciIsImlnbiIsImNsb3NlTXNnIiwiYWRkV2ViU29ja2V0SGFuZGxlciIsIm1vYmlsZVN0b3BMb2dzQnJvYWRjYXN0IiwicmVtb3ZlV2ViU29ja2V0SGFuZGxlciIsImdldExvZ1R5cGVzIiwibmF0aXZlTG9nVHlwZXMiLCJCYXNlRHJpdmVyIiwicHJvdG90eXBlIiwiY2FsbCIsImlzV2ViQ29udGV4dCIsIndlYkxvZ1R5cGVzIiwiY2hyb21lZHJpdmVyIiwiandwcm94eSIsImNvbW1hbmQiLCJnZXRMb2ciLCJsb2dUeXBlIiwia2V5cyIsImluY2x1ZGVzIiwidHlwZSIsIk9iamVjdCIsImFzc2lnbiJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7QUFBQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFFQSxNQUFNQSx1QkFBdUIsR0FBRyxpQkFBaEM7QUFFQSxJQUFJQyxRQUFRLEdBQUcsRUFBZjtBQUFBLElBQW1CQyxPQUFPLEdBQUcsRUFBN0I7QUFBQSxJQUFpQ0MsVUFBVSxHQUFHLEVBQTlDOzs7O0FBRUEsTUFBTUMsa0JBQWtCLEdBQUlDLFNBQUQsSUFBZ0IsR0FBRUMsNENBQTJCLFlBQVdELFNBQVUsdUJBQTdGOztBQUdBLFNBQVNFLFdBQVQsQ0FBc0JDLFNBQXRCLEVBQWlDQyxLQUFqQyxFQUF3Q0MsT0FBeEMsRUFBaUQ7QUFDL0MsU0FBTztBQUNMRixJQUFBQSxTQURLO0FBRUxDLElBQUFBLEtBRks7QUFHTEMsSUFBQUE7QUFISyxHQUFQO0FBS0Q7O0FBRURQLFVBQVUsQ0FBQ1EsaUJBQVgsR0FBK0I7QUFDN0JDLEVBQUFBLE1BQU0sRUFBRTtBQUNOQyxJQUFBQSxXQUFXLEVBQUUsb0VBRFA7QUFFTkMsSUFBQUEsTUFBTSxFQUFFLE1BQU9DLElBQVAsSUFBZ0IsTUFBTUEsSUFBSSxDQUFDQyxHQUFMLENBQVNDLGFBQVQ7QUFGeEIsR0FEcUI7QUFLN0JDLEVBQUFBLFNBQVMsRUFBRTtBQUNUTCxJQUFBQSxXQUFXLEVBQUcsdURBREw7QUFFVEMsSUFBQUEsTUFBTSxFQUFFLE1BQU9DLElBQVAsSUFBZ0I7QUFDdEIsWUFBTUksTUFBTSxHQUFHLE1BQU1KLElBQUksQ0FBQ0MsR0FBTCxDQUFTRSxTQUFULEVBQXJCO0FBQ0EsWUFBTVYsU0FBUyxHQUFHWSxJQUFJLENBQUNDLEdBQUwsRUFBbEI7QUFDQSxhQUFPRixNQUFNLENBQUNHLEtBQVAsQ0FBYUMsWUFBR0MsR0FB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QUosRUFBb0IsR0FBR0ssV0FBdkIsQ0FBUDtBQUNEOztBQUNELFNBQU9MLGNBQVA7QUFDRCxDQVBEOztBQVNBakUsUUFBUSxDQUFDMEUsTUFBVCxHQUFrQixlQUFlQSxNQUFmLENBQXVCQyxPQUF2QixFQUFnQztBQUNoRCxNQUFJLEtBQUtOLFlBQUwsTUFBdUIsQ0FBQ3RDLGdCQUFFNkMsSUFBRixDQUFPLEtBQUtsRSxpQkFBWixFQUErQm1FLFFBQS9CLENBQXdDRixPQUF4QyxDQUE1QixFQUE4RTtBQUM1RSxXQUFPLE1BQU0sS0FBS0osWUFBTCxDQUFrQkMsT0FBbEIsQ0FBMEJDLE9BQTFCLENBQWtDLE1BQWxDLEVBQTBDLE1BQTFDLEVBQWtEO0FBQUNLLE1BQUFBLElBQUksRUFBRUg7QUFBUCxLQUFsRCxDQUFiO0FBQ0Q7O0FBQ0QsU0FBTyxNQUFNVCw2QkFBV0MsU0FBWCxDQUFxQk8sTUFBckIsQ0FBNEJOLElBQTVCLENBQWlDLElBQWpDLEVBQXVDTyxPQUF2QyxDQUFiO0FBQ0QsQ0FMRDs7QUFPQUksTUFBTSxDQUFDQyxNQUFQLENBQWM5RSxVQUFkLEVBQTBCRixRQUExQixFQUFvQ0MsT0FBcEM7ZUFFZUMsVSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBsb2cgZnJvbSAnLi4vbG9nZ2VyJztcbmltcG9ydCBvcyBmcm9tICdvcyc7XG5pbXBvcnQgXyBmcm9tICdsb2Rhc2gnO1xuaW1wb3J0IFdlYlNvY2tldCBmcm9tICd3cyc7XG5pbXBvcnQgeyBERUZBVUxUX1dTX1BBVEhOQU1FX1BSRUZJWCwgQmFzZURyaXZlciB9IGZyb20gJ2FwcGl1bS1iYXNlLWRyaXZlcic7XG5cbmNvbnN0IEdFVF9TRVJWRVJfTE9HU19GRUFUVVJFID0gJ2dldF9zZXJ2ZXJfbG9ncyc7XG5cbmxldCBjb21tYW5kcyA9IHt9LCBoZWxwZXJzID0ge30sIGV4dGVuc2lvbnMgPSB7fTtcblxuY29uc3QgV0VCU09DS0VUX0VORFBPSU5UID0gKHNlc3Npb25JZCkgPT4gYCR7REVGQVVMVF9XU19QQVRITkFNRV9QUkVGSVh9L3Nlc3Npb24vJHtzZXNzaW9uSWR9L2FwcGl1bS9kZXZpY2UvbG9nY2F0YDtcblxuLy8gaHR0cHM6Ly9naXRodWIuY29tL1NlbGVuaXVtSFEvc2VsZW5pdW0vYmxvYi8wZDQyNTY3NmIzYzlkZjI2MWRkNjQxOTE3Zjg2N2Q0ZDVjZTc3NzRkL2phdmEvY2xpZW50L3NyYy9vcmcvb3BlbnFhL3NlbGVuaXVtL2xvZ2dpbmcvTG9nRW50cnkuamF2YVxuZnVuY3Rpb24gdG9Mb2dSZWNvcmQgKHRpbWVzdGFtcCwgbGV2ZWwsIG1lc3NhZ2UpIHtcbiAgcmV0dXJuIHtcbiAgICB0aW1lc3RhbXAsXG4gICAgbGV2ZWwsXG4gICAgbWVzc2FnZSxcbiAgfTtcbn1cblxuZXh0ZW5zaW9ucy5zdXBwb3J0ZWRMb2dUeXBlcyA9IHtcbiAgbG9nY2F0OiB7XG4gICAgZGVzY3JpcHRpb246ICdMb2dzIGZvciBBbmRyb2lkIGFwcGxpY2F0aW9ucyBvbiByZWFsIGRldmljZSBhbmQgZW11bGF0b3JzIHZpYSBBREInLFxuICAgIGdldHRlcjogYXN5bmMgKHNlbGYpID0+IGF3YWl0IHNlbGYuYWRiLmdldExvZ2NhdExvZ3MoKSxcbiAgfSxcbiAgYnVncmVwb3J0OiB7XG4gICAgZGVzY3JpcHRpb246IGAnYWRiIGJ1Z3JlcG9ydCcgb3V0cHV0IGZvciBhZHZhbmNlZCBpc3N1ZXMgZGlhZ25vc3RpY2AsXG4gICAgZ2V0dGVyOiBhc3luYyAoc2VsZikgPT4ge1xuICAgICAgY29uc3Qgb3V0cHV0ID0gYXdhaXQgc2VsZi5hZGIuYnVncmVwb3J0KCk7XG4gICAgICBjb25zdCB0aW1lc3RhbXAgPSBEYXRlLm5vdygpO1xuICAgICAgcmV0dXJuIG91dHB1dC5zcGxpdChvcy5FT0wpXG4gICAgICAgIC5tYXAoKHgpID0+IHRvTG9nUmVjb3JkKHRpbWVzdGFtcCwgJ0FMTCcsIHgpKTtcbiAgICB9LFxuICB9LFxuICBzZXJ2ZXI6IHtcbiAgICBkZXNjcmlwdGlvbjogJ0FwcGl1bSBzZXJ2ZXIgbG9ncycsXG4gICAgZ2V0dGVyOiAoc2VsZikgPT4ge1xuICAgICAgc2VsZi5lbnN1cmVGZWF0dXJlRW5hYmxlZChHRVRfU0VSVkVSX0xPR1NfRkVBVFVSRSk7XG4gICAgICBjb25zdCB0aW1lc3RhbXAgPSBEYXRlLm5vdygpO1xuICAgICAgcmV0dXJuIGxvZy51bndyYXAoKS5yZWNvcmRcbiAgICAgICAgLm1hcCgoeCkgPT4gdG9Mb2dSZWNvcmQodGltZXN0YW1wLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnQUxMJyxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgXy5pc0VtcHR5KHgucHJlZml4KSA/IHgubWVzc2FnZSA6IGBbJHt4LnByZWZpeH1dICR7eC5tZXNzYWdlfWApXG4gICAgICAgICk7XG4gICAgfSxcbiAgfSxcbn07XG5cbi8qKlxuICogU3RhcnRzIEFuZHJvaWQgbG9nY2F0IGJyb2FkY2FzdCB3ZWJzb2NrZXQgb24gdGhlIHNhbWUgaG9zdCBhbmQgcG9ydFxuICogd2hlcmUgQXBwaXVtIHNlcnZlciBpcyBydW5uaW5nIGF0IGAvd3Mvc2Vzc2lvbi86c2Vzc2lvbklkOi9hcHBpdW0vbG9nY2F0YCBlbmRwb2ludC4gVGhlIG1ldGhvZFxuICogd2lsbCByZXR1cm4gaW1tZWRpYXRlbHkgaWYgdGhlIHdlYiBzb2NrZXQgaXMgYWxyZWFkeSBsaXN0ZW5pbmcuXG4gKlxuICogRWFjaCBjb25uZWN0ZWQgd2Vic29ja2V0IGxpc3RlbmVyIHdpbGwgcmVjZWl2ZSBsb2djYXQgbG9nIGxpbmVzXG4gKiBhcyBzb29uIGFzIHRoZXkgYXJlIHZpc2libGUgdG8gQXBwaXVtLlxuICovXG5jb21tYW5kcy5tb2JpbGVTdGFydExvZ3NCcm9hZGNhc3QgPSBhc3luYyBmdW5jdGlvbiBtb2JpbGVTdGFydExvZ3NCcm9hZGNhc3QgKCkge1xuICBjb25zdCBwYXRobmFtZSA9IFdFQlNPQ0tFVF9FTkRQT0lOVCh0aGlzLnNlc3Npb25JZCk7XG4gIGlmICghXy5pc0VtcHR5KGF3YWl0IHRoaXMuc2VydmVyLmdldFdlYlNvY2tldEhhbmRsZXJzKHBhdGhuYW1lKSkpIHtcbiAgICBsb2cuZGVidWcoYFRoZSBsb2djYXQgYnJvYWRjYXN0aW5nIHdlYiBzb2NrZXQgc2VydmVyIGlzIGFscmVhZHkgbGlzdGVuaW5nIGF0ICR7cGF0aG5hbWV9YCk7XG4gICAgcmV0dXJuO1xuICB9XG5cbiAgbG9nLmluZm8oYEFzc2lnbmluZyBsb2djYXQgYnJvYWRjYXN0aW5nIHdlYiBzb2NrZXQgc2VydmVyIHRvICR7cGF0aG5hbWV9YCk7XG4gIC8vIGh0dHBzOi8vZ2l0aHViLmNvbS93ZWJzb2NrZXRzL3dzL2Jsb2IvbWFzdGVyL2RvYy93cy5tZFxuICBjb25zdCB3c3MgPSBuZXcgV2ViU29ja2V0LlNlcnZlcih7XG4gICAgbm9TZXJ2ZXI6IHRydWUsXG4gIH0pO1xuICB3c3Mub24oJ2Nvbm5lY3Rpb24nLCAod3MsIHJlcSkgPT4ge1xuICAgIGlmIChyZXEpIHtcbiAgICAgIGNvbnN0IHJlbW90ZUlwID0gXy5pc0VtcHR5KHJlcS5oZWFkZXJzWyd4LWZvcndhcmRlZC1mb3InXSlcbiAgICAgICAgPyByZXEuY29ubmVjdGlvbi5yZW1vdGVBZGRyZXNzXG4gICAgICAgIDogcmVxLmhlYWRlcnNbJ3gtZm9yd2FyZGVkLWZvciddO1xuICAgICAgbG9nLmRlYnVnKGBFc3RhYmxpc2hlZCBhIG5ldyBsb2djYXQgbGlzdGVuZXIgd2ViIHNvY2tldCBjb25uZWN0aW9uIGZyb20gJHtyZW1vdGVJcH1gKTtcbiAgICB9IGVsc2Uge1xuICAgICAgbG9nLmRlYnVnKCdFc3RhYmxpc2hlZCBhIG5ldyBsb2djYXQgbGlzdGVuZXIgd2ViIHNvY2tldCBjb25uZWN0aW9uJyk7XG4gICAgfVxuXG4gICAgaWYgKF8uaXNFbXB0eSh0aGlzLl9sb2djYXRXZWJzb2NrZXRMaXN0ZW5lcikpIHtcbiAgICAgIHRoaXMuX2xvZ2NhdFdlYnNvY2tldExpc3RlbmVyID0gKGxvZ1JlY29yZCkgPT4ge1xuICAgICAgICBpZiAod3MgJiYgd3MucmVhZHlTdGF0ZSA9PT0gV2ViU29ja2V0Lk9QRU4pIHtcbiAgICAgICAgICB3cy5zZW5kKGxvZ1JlY29yZC5tZXNzYWdlKTtcbiAgICAgICAgfVxuICAgICAgfTtcbiAgICB9XG4gICAgdGhpcy5hZGIuc2V0TG9nY2F0TGlzdGVuZXIodGhpcy5fbG9nY2F0V2Vic29ja2V0TGlzdGVuZXIpO1xuXG4gICAgd3Mub24oJ2Nsb3NlJywgKGNvZGUsIHJlYXNvbikgPT4ge1xuICAgICAgaWYgKCFfLmlzRW1wdHkodGhpcy5fbG9nY2F0V2Vic29ja2V0TGlzdGVuZXIpKSB7XG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgdGhpcy5hZGIucmVtb3ZlTG9nY2F0TGlzdGVuZXIodGhpcy5fbG9nY2F0V2Vic29ja2V0TGlzdGVuZXIpO1xuICAgICAgICB9IGNhdGNoIChpZ24pIHt9XG4gICAgICAgIHRoaXMuX2xvZ2NhdFdlYnNvY2tldExpc3RlbmVyID0gbnVsbDtcbiAgICAgIH1cblxuICAgICAgbGV0IGNsb3NlTXNnID0gJ0xvZ2NhdCBsaXN0ZW5lciB3ZWIgc29ja2V0IGlzIGNsb3NlZC4nO1xuICAgICAgaWYgKCFfLmlzRW1wdHkoY29kZSkpIHtcbiAgICAgICAgY2xvc2VNc2cgKz0gYCBDb2RlOiAke2NvZGV9LmA7XG4gICAgICB9XG4gICAgICBpZiAoIV8uaXNFbXB0eShyZWFzb24pKSB7XG4gICAgICAgIGNsb3NlTXNnICs9IGAgUmVhc29uOiAke3JlYXNvbn0uYDtcbiAgICAgIH1cbiAgICAgIGxvZy5kZWJ1ZyhjbG9zZU1zZyk7XG4gICAgfSk7XG4gIH0pO1xuICBhd2FpdCB0aGlzLnNlcnZlci5hZGRXZWJTb2NrZXRIYW5kbGVyKHBhdGhuYW1lLCB3c3MpO1xufTtcblxuLyoqXG4gKiBTdG9wcyB0aGUgcHJldmlvdXNseSBzdGFydGVkIGxvZ2NhdCBicm9hZGNhc3Rpbmcgd2Vzb2NrZXQgc2VydmVyLlxuICogVGhpcyBtZXRob2Qgd2lsbCByZXR1cm4gaW1tZWRpYXRlbHkgaWYgbm8gc2VydmVyIGlzIHJ1bm5pbmcuXG4gKi9cbmNvbW1hbmRzLm1vYmlsZVN0b3BMb2dzQnJvYWRjYXN0ID0gYXN5bmMgZnVuY3Rpb24gbW9iaWxlU3RvcExvZ3NCcm9hZGNhc3QgKCkge1xuICBjb25zdCBwYXRobmFtZSA9IFdFQlNPQ0tFVF9FTkRQT0lOVCh0aGlzLnNlc3Npb25JZCk7XG4gIGlmIChfLmlzRW1wdHkoYXdhaXQgdGhpcy5zZXJ2ZXIuZ2V0V2ViU29ja2V0SGFuZGxlcnMocGF0aG5hbWUpKSkge1xuICAgIHJldHVybjtcbiAgfVxuXG4gIGxvZy5kZWJ1ZygnU3RvcHBpbmcgdGhlIGxvZ2NhdCBicm9hZGNhc3Rpbmcgd2ViIHNvY2tldCBzZXJ2ZXInKTtcbiAgYXdhaXQgdGhpcy5zZXJ2ZXIucmVtb3ZlV2ViU29ja2V0SGFuZGxlcihwYXRobmFtZSk7XG59O1xuXG5jb21tYW5kcy5nZXRMb2dUeXBlcyA9IGFzeW5jIGZ1bmN0aW9uIGdldExvZ1R5cGVzICgpIHtcbiAgY29uc3QgbmF0aXZlTG9nVHlwZXMgPSBhd2FpdCBCYXNlRHJpdmVyLnByb3RvdHlwZS5nZXRMb2dUeXBlcy5jYWxsKHRoaXMpO1xuICBpZiAodGhpcy5pc1dlYkNvbnRleHQoKSkge1xuICAgIGNvbnN0IHdlYkxvZ1R5cGVzID0gYXdhaXQgdGhpcy5jaHJvbWVkcml2ZXIuandwcm94eS5jb21tYW5kKCcvbG9nL3R5cGVzJywgJ0dFVCcpO1xuICAgIHJldHVybiBbLi4ubmF0aXZlTG9nVHlwZXMsIC4uLndlYkxvZ1R5cGVzXTtcbiAgfVxuICByZXR1cm4gbmF0aXZlTG9nVHlwZXM7XG59O1xuXG5jb21tYW5kcy5nZXRMb2cgPSBhc3luYyBmdW5jdGlvbiBnZXRMb2cgKGxvZ1R5cGUpIHtcbiAgaWYgKHRoaXMuaXNXZWJDb250ZXh0KCkgJiYgIV8ua2V5cyh0aGlzLnN1cHBvcnRlZExvZ1R5cGVzKS5pbmNsdWRlcyhsb2dUeXBlKSkge1xuICAgIHJldHVybiBhd2FpdCB0aGlzLmNocm9tZWRyaXZlci5qd3Byb3h5LmNvbW1hbmQoJy9sb2cnLCAnUE9TVCcsIHt0eXBlOiBsb2dUeXBlfSk7XG4gIH1cbiAgcmV0dXJuIGF3YWl0IEJhc2VEcml2ZXIucHJvdG90eXBlLmdldExvZy5jYWxsKHRoaXMsIGxvZ1R5cGUpO1xufTtcblxuT2JqZWN0LmFzc2lnbihleHRlbnNpb25zLCBjb21tYW5kcywgaGVscGVycyk7XG5leHBvcnQgeyBjb21tYW5kcywgaGVscGVycyB9O1xuZXhwb3J0IGRlZmF1bHQgZXh0ZW5zaW9ucztcbiJdLCJmaWxlIjoibGliL2NvbW1hbmRzL2xvZy5qcyIsInNvdXJjZVJvb3QiOiIuLi8uLi8uLiJ9
