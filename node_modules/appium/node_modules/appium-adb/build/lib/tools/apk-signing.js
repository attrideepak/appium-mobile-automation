"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

require("source-map-support/register");

var _lodash = _interopRequireDefault(require("lodash"));

var _fs2 = _interopRequireDefault(require("fs"));

var _teen_process = require("teen_process");

var _path = _interopRequireDefault(require("path"));

var _logger = _interopRequireDefault(require("../logger.js"));

var _appiumSupport = require("appium-support");

var _helpers = require("../helpers.js");

const DEFAULT_PRIVATE_KEY = _path.default.resolve(_helpers.rootDir, 'keys', 'testkey.pk8');

const DEFAULT_CERTIFICATE = _path.default.resolve(_helpers.rootDir, 'keys', 'testkey.x509.pem');

const BUNDLETOOL_TUTORIAL = 'https://developer.android.com/studio/command-line/bundletool';
const APKSIGNER_VERIFY_FAIL = 'DOES NOT VERIFY';
const SHA1 = 'sha1';
const SHA256 = 'sha256';
const SHA512 = 'sha512';
const MD5 = 'md5';
const DEFAULT_CERT_HASH = {
  [SHA256]: 'a40da80a59d170caa950cf15c18c454d47a39b26989d8b640ecd745ba71bf5dc'
};
const apkSigningMethods = {};

apkSigningMethods.executeApksigner = async function executeApksigner(args = []) {
  const apkSignerJar = await (0, _helpers.getApksignerForOs)(this);
  const fullCmd = [await (0, _helpers.getJavaForOs)(), '-Xmx1024M', '-Xss1m', '-jar', apkSignerJar, ...args];

  _logger.default.debug(`Starting apksigner: ${_appiumSupport.util.quote(fullCmd)}`);

  const {
    stdout,
    stderr
  } = await (0, _teen_process.exec)(fullCmd[0], fullCmd.slice(1), {
    cwd: _path.default.dirname(apkSignerJar)
  });

  for (let [name, stream] of [['stdout', stdout], ['stderr', stderr]]) {
    if (!_lodash.default.trim(stream)) {
      continue;
    }

    if (name === 'stdout') {
      stream = stream.split('\n').filter(line => !line.includes('WARNING:')).join('\n');
    }

    _logger.default.debug(`apksigner ${name}: ${stream}`);
  }

  return stdout;
};

apkSigningMethods.signWithDefaultCert = async function signWithDefaultCert(apk) {
  _logger.default.debug(`Signing '${apk}' with default cert`);

  if (!(await _appiumSupport.fs.exists(apk))) {
    throw new Error(`${apk} file doesn't exist.`);
  }

  const args = ['sign', '--key', DEFAULT_PRIVATE_KEY, '--cert', DEFAULT_CERTIFICATE, apk];

  try {
    await this.executeApksigner(args);
  } catch (e) {
    throw new Error(`Could not sign '${apk}' with the default certificate. ` + `Original error: ${e.stderr || e.stdout || e.message}`);
  }
};

apkSigningMethods.signWithCustomCert = async function signWithCustomCert(apk) {
  _logger.default.debug(`Signing '${apk}' with custom cert`);

  if (!(await _appiumSupport.fs.exists(this.keystorePath))) {
    throw new Error(`Keystore: ${this.keystorePath} doesn't exist.`);
  }

  if (!(await _appiumSupport.fs.exists(apk))) {
    throw new Error(`'${apk}' doesn't exist.`);
  }

  try {
    await this.executeApksigner(['sign', '--ks', this.keystorePath, '--ks-key-alias', this.keyAlias, '--ks-pass', `pass:${this.keystorePassword}`, '--key-pass', `pass:${this.keyPassword}`, apk]);
  } catch (err) {
    _logger.default.warn(`Cannot use apksigner tool for signing. Defaulting to jarsigner. ` + `Original error: ${err.stderr || err.stdout || err.message}`);

    try {
      if (await (0, _helpers.unsignApk)(apk)) {
        _logger.default.debug(`'${apk}' has been successfully unsigned`);
      } else {
        _logger.default.debug(`'${apk}' does not need to be unsigned`);
      }

      const jarsigner = _path.default.resolve(await (0, _helpers.getJavaHome)(), 'bin', `jarsigner${_appiumSupport.system.isWindows() ? '.exe' : ''}`);

      const fullCmd = [jarsigner, '-sigalg', 'MD5withRSA', '-digestalg', 'SHA1', '-keystore', this.keystorePath, '-storepass', this.keystorePassword, '-keypass', this.keyPassword, apk, this.keyAlias];

      _logger.default.debug(`Starting jarsigner: ${_appiumSupport.util.quote(fullCmd)}`);

      await (0, _teen_process.exec)(fullCmd[0], fullCmd.slice(1));
    } catch (e) {
      throw new Error(`Could not sign with custom certificate. ` + `Original error: ${e.stderr || e.message}`);
    }
  }
};

apkSigningMethods.sign = async function sign(appPath) {
  if (appPath.endsWith(_helpers.APKS_EXTENSION)) {
    let message = 'Signing of .apks-files is not supported. ';

    if (this.useKeystore) {
      message += 'Consider manual application bundle signing with the custom keystore ' + `like it is described at ${BUNDLETOOL_TUTORIAL}`;
    } else {
      message += `Consider manual application bundle signing with the key at '${DEFAULT_PRIVATE_KEY}' ` + `and the certificate at '${DEFAULT_CERTIFICATE}'. Read ${BUNDLETOOL_TUTORIAL} for more details.`;
    }

    _logger.default.warn(message);

    return;
  }

  await this.zipAlignApk(appPath);

  if (this.useKeystore) {
    await this.signWithCustomCert(appPath);
  } else {
    await this.signWithDefaultCert(appPath);
  }
};

apkSigningMethods.zipAlignApk = async function zipAlignApk(apk) {
  await this.initZipAlign();

  try {
    await (0, _teen_process.exec)(this.binaries.zipalign, ['-c', '4', apk]);

    _logger.default.debug(`${apk}' is already zip-aligned. Doing nothing`);

    return false;
  } catch (e) {
    _logger.default.debug(`'${apk}' is not zip-aligned. Aligning`);
  }

  try {
    await _appiumSupport.fs.access(apk, _fs2.default.W_OK);
  } catch (e) {
    throw new Error(`The file at '${apk}' is not writeable. ` + `Please grant write permissions to this file or to its parent folder '${_path.default.dirname(apk)}' ` + `for the Appium process, so it can zip-align the file`);
  }

  const alignedApk = await _appiumSupport.tempDir.path({
    prefix: 'appium',
    suffix: '.tmp'
  });
  await (0, _appiumSupport.mkdirp)(_path.default.dirname(alignedApk));

  try {
    await (0, _teen_process.exec)(this.binaries.zipalign, ['-f', '4', apk, alignedApk]);
    await _appiumSupport.fs.mv(alignedApk, apk, {
      mkdirp: true
    });
    return true;
  } catch (e) {
    if (await _appiumSupport.fs.exists(alignedApk)) {
      await _appiumSupport.fs.unlink(alignedApk);
    }

    throw new Error(`zipAlignApk failed. Original error: ${e.stderr || e.message}`);
  }
};

apkSigningMethods.checkApkCert = async function checkApkCert(appPath, pkg, opts = {}) {
  _logger.default.debug(`Checking app cert for ${appPath}`);

  if (!(await _appiumSupport.fs.exists(appPath))) {
    _logger.default.debug(`'${appPath}' does not exist`);

    return false;
  }

  if (_path.default.extname(appPath) === _helpers.APKS_EXTENSION) {
    appPath = await this.extractBaseApk(appPath);
  }

  const expectedHash = this.useKeystore ? await this.getKeystoreHash(appPath, pkg) : DEFAULT_CERT_HASH;

  const hashMatches = apksignerOutput => {
    for (const [name, value] of _lodash.default.toPairs(expectedHash)) {
      if (new RegExp(`digest:\\s+${value}\\b`, 'i').test(apksignerOutput)) {
        _logger.default.debug(`${name} hash did match for '${_path.default.basename(appPath)}'`);

        return true;
      }
    }

    return false;
  };

  const {
    requireDefaultCert = true
  } = opts;

  try {
    await (0, _helpers.getApksignerForOs)(this);
    const output = await this.executeApksigner(['verify', '--print-certs', appPath]);
    const hasMatch = hashMatches(output);

    if (hasMatch) {
      _logger.default.info(`'${appPath}' is signed with the ` + `${this.useKeystore ? 'keystore' : 'default'} certificate`);
    } else {
      _logger.default.info(`'${appPath}' is signed with a ` + `non-${this.useKeystore ? 'keystore' : 'default'} certificate`);
    }

    return !this.useKeystore && !requireDefaultCert || hasMatch;
  } catch (err) {
    if (_lodash.default.includes(err.stderr, APKSIGNER_VERIFY_FAIL)) {
      _logger.default.info(`'${appPath}' is not signed`);

      return false;
    }

    throw new Error(`Cannot verify the signature of '${appPath}'. ` + `Original error: ${err.stderr || err.stdout || err.message}`);
  }
};

apkSigningMethods.getKeystoreHash = async function getKeystoreHash() {
  _logger.default.debug(`Getting hash of the '${this.keystorePath}' keystore`);

  const keytool = _path.default.resolve(await (0, _helpers.getJavaHome)(), 'bin', `keytool${_appiumSupport.system.isWindows() ? '.exe' : ''}`);

  if (!(await _appiumSupport.fs.exists(keytool))) {
    throw new Error(`The keytool utility cannot be found at '${keytool}'`);
  }

  const args = ['-v', '-list', '-alias', this.keyAlias, '-keystore', this.keystorePath, '-storepass', this.keystorePassword];

  _logger.default.info(`Running '${keytool}' with arguments: ${_appiumSupport.util.quote(args)}`);

  try {
    const {
      stdout
    } = await (0, _teen_process.exec)(keytool, args);
    const result = {};

    for (const hashName of [SHA512, SHA256, SHA1, MD5]) {
      const hashRe = new RegExp(`^\\s*${hashName}:\\s*([a-f0-9:]+)`, 'mi');
      const match = hashRe.exec(stdout);

      if (!match) {
        continue;
      }

      result[hashName] = match[1].replace(/:/g, '').toLowerCase();
    }

    if (_lodash.default.isEmpty(result)) {
      _logger.default.debug(stdout);

      throw new Error('Cannot parse the hash value from the keytool output');
    }

    _logger.default.debug(`Keystore hash: ${JSON.stringify(result)}`);

    return result;
  } catch (e) {
    throw new Error(`Cannot get the hash of '${this.keystorePath}' keystore. ` + `Original error: ${e.stderr || e.message}`);
  }
};

var _default = apkSigningMethods;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi90b29scy9hcGstc2lnbmluZy5qcyJdLCJuYW1lcyI6WyJERUZBVUxUX1BSSVZBVEVfS0VZIiwicGF0aCIsInJlc29sdmUiLCJyb290RGlyIiwiREVGQVVMVF9DRVJUSUZJQ0FURSIsIkJVTkRMRVRPT0xfVFVUT1JJQUwiLCJBUEtTSUdORVJfVkVSSUZZX0ZBSUwiLCJTSEExIiwiU0hBMjU2IiwiU0hBNTEyIiwiTUQ1IiwiREVGQVVMVF9DRVJUX0hBU0giLCJhcGtTaWduaW5nTWV0aG9kcyIsImV4ZWN1dGVBcGtzaWduZXIiLCJhcmdzIiwiYXBrU2lnbmVySmFyIiwiZnVsbENtZCIsImxvZyIsImRlYnVnIiwidXRpbCIsInF1b3RlIiwic3Rkb3V0Iiwic3RkZXJyIiwic2xpY2UiLCJjd2QiLCJkaXJuYW1lIiwibmFtZSIsInN0cmVhbSIsIl8iLCJ0cmltIiwic3BsaXQiLCJmaWx0ZXIiLCJsaW5lIiwiaW5jbHVkZXMiLCJqb2luIiwic2lnbldpdGhEZWZhdWx0Q2VydCIsImFwayIsImZzIiwiZXhpc3RzIiwiRXJyb3IiLCJlIiwibWVzc2FnZSIsInNpZ25XaXRoQ3VzdG9tQ2VydCIsImtleXN0b3JlUGF0aCIsImtleUFsaWFzIiwia2V5c3RvcmVQYXNzd29yZCIsImtleVBhc3N3b3JkIiwiZXJyIiwid2FybiIsImphcnNpZ25lciIsInN5c3RlbSIsImlzV2luZG93cyIsInNpZ24iLCJhcHBQYXRoIiwiZW5kc1dpdGgiLCJBUEtTX0VYVEVOU0lPTiIsInVzZUtleXN0b3JlIiwiemlwQWxpZ25BcGsiLCJpbml0WmlwQWxpZ24iLCJiaW5hcmllcyIsInppcGFsaWduIiwiYWNjZXNzIiwiX2ZzIiwiV19PSyIsImFsaWduZWRBcGsiLCJ0ZW1wRGlyIiwicHJlZml4Iiwic3VmZml4IiwibXYiLCJta2RpcnAiLCJ1bmxpbmsiLCJjaGVja0Fwa0NlcnQiLCJwa2ciLCJvcHRzIiwiZXh0bmFtZSIsImV4dHJhY3RCYXNlQXBrIiwiZXhwZWN0ZWRIYXNoIiwiZ2V0S2V5c3RvcmVIYXNoIiwiaGFzaE1hdGNoZXMiLCJhcGtzaWduZXJPdXRwdXQiLCJ2YWx1ZSIsInRvUGFpcnMiLCJSZWdFeHAiLCJ0ZXN0IiwiYmFzZW5hbWUiLCJyZXF1aXJlRGVmYXVsdENlcnQiLCJvdXRwdXQiLCJoYXNNYXRjaCIsImluZm8iLCJrZXl0b29sIiwicmVzdWx0IiwiaGFzaE5hbWUiLCJoYXNoUmUiLCJtYXRjaCIsImV4ZWMiLCJyZXBsYWNlIiwidG9Mb3dlckNhc2UiLCJpc0VtcHR5IiwiSlNPTiIsInN0cmluZ2lmeSJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7QUFBQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFLQSxNQUFNQSxtQkFBbUIsR0FBR0MsY0FBS0MsT0FBTCxDQUFhQyxnQkFBYixFQUFzQixNQUF0QixFQUE4QixhQUE5QixDQUE1Qjs7QUFDQSxNQUFNQyxtQkFBbUIsR0FBR0gsY0FBS0MsT0FBTCxDQUFhQyxnQkFBYixFQUFzQixNQUF0QixFQUE4QixrQkFBOUIsQ0FBNUI7O0FBQ0EsTUFBTUUsbUJBQW1CLEdBQUcsOERBQTVCO0FBQ0EsTUFBTUMscUJBQXFCLEdBQUcsaUJBQTlCO0FBQ0EsTUFBTUMsSUFBSSxHQUFHLE1BQWI7QUFDQSxNQUFNQyxNQUFNLEdBQUcsUUFBZjtBQUNBLE1BQU1DLE1BQU0sR0FBRyxRQUFmO0FBQ0EsTUFBTUMsR0FBRyxHQUFHLEtBQVo7QUFDQSxNQUFNQyxpQkFBaUIsR0FBRztBQUN4QixHQUFDSCxNQUFELEdBQVU7QUFEYyxDQUExQjtBQUtBLE1BQU1JLGlCQUFpQixHQUFHLEVBQTFCOztBQVVBQSxpQkFBaUIsQ0FBQ0MsZ0JBQWxCLEdBQXFDLGVBQWVBLGdCQUFmLENBQWlDQyxJQUFJLEdBQUcsRUFBeEMsRUFBNEM7QUFDL0UsUUFBTUMsWUFBWSxHQUFHLE1BQU0sZ0NBQWtCLElBQWxCLENBQTNCO0FBQ0EsUUFBTUMsT0FBTyxHQUFHLENBQ2QsTUFBTSw0QkFEUSxFQUNRLFdBRFIsRUFDcUIsUUFEckIsRUFF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QUFqQixFQUF1QixFQUF2QixFQUEyQkMsV0FBM0IsRUFBbkI7QUFDRDs7QUFDRCxRQUFJcEUsZ0JBQUVxRSxPQUFGLENBQVVQLE1BQVYsQ0FBSixFQUF1QjtBQUNyQnpFLHNCQUFJQyxLQUFKLENBQVVHLE1BQVY7O0FBQ0EsWUFBTSxJQUFJa0IsS0FBSixDQUFVLHFEQUFWLENBQU47QUFDRDs7QUFDRHRCLG9CQUFJQyxLQUFKLENBQVcsa0JBQWlCZ0YsSUFBSSxDQUFDQyxTQUFMLENBQWVULE1BQWYsQ0FBdUIsRUFBbkQ7O0FBQ0EsV0FBT0EsTUFBUDtBQUNELEdBakJELENBaUJFLE9BQU9sRCxDQUFQLEVBQVU7QUFDVixVQUFNLElBQUlELEtBQUosQ0FBVywyQkFBMEIsS0FBS0ksWUFBYSxjQUE3QyxHQUNiLG1CQUFrQkgsQ0FBQyxDQUFDbEIsTUFBRixJQUFZa0IsQ0FBQyxDQUFDQyxPQUFRLEVBRHJDLENBQU47QUFFRDtBQUNGLENBbkNEOztlQXFDZTdCLGlCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IF8gZnJvbSAnbG9kYXNoJztcbmltcG9ydCBfZnMgZnJvbSAnZnMnO1xuaW1wb3J0IHsgZXhlYyB9IGZyb20gJ3RlZW5fcHJvY2Vzcyc7XG5pbXBvcnQgcGF0aCBmcm9tICdwYXRoJztcbmltcG9ydCBsb2cgZnJvbSAnLi4vbG9nZ2VyLmpzJztcbmltcG9ydCB7IHRlbXBEaXIsIHN5c3RlbSwgbWtkaXJwLCBmcywgdXRpbCB9IGZyb20gJ2FwcGl1bS1zdXBwb3J0JztcbmltcG9ydCB7XG4gIGdldEphdmFGb3JPcywgZ2V0QXBrc2lnbmVyRm9yT3MsIGdldEphdmFIb21lLFxuICByb290RGlyLCBBUEtTX0VYVEVOU0lPTiwgdW5zaWduQXBrLFxufSBmcm9tICcuLi9oZWxwZXJzLmpzJztcblxuY29uc3QgREVGQVVMVF9QUklWQVRFX0tFWSA9IHBhdGgucmVzb2x2ZShyb290RGlyLCAna2V5cycsICd0ZXN0a2V5LnBrOCcpO1xuY29uc3QgREVGQVVMVF9DRVJUSUZJQ0FURSA9IHBhdGgucmVzb2x2ZShyb290RGlyLCAna2V5cycsICd0ZXN0a2V5Lng1MDkucGVtJyk7XG5jb25zdCBCVU5ETEVUT09MX1RVVE9SSUFMID0gJ2h0dHBzOi8vZGV2ZWxvcGVyLmFuZHJvaWQuY29tL3N0dWRpby9jb21tYW5kLWxpbmUvYnVuZGxldG9vbCc7XG5jb25zdCBBUEtTSUdORVJfVkVSSUZZX0ZBSUwgPSAnRE9FUyBOT1QgVkVSSUZZJztcbmNvbnN0IFNIQTEgPSAnc2hhMSc7XG5jb25zdCBTSEEyNTYgPSAnc2hhMjU2JztcbmNvbnN0IFNIQTUxMiA9ICdzaGE1MTInO1xuY29uc3QgTUQ1ID0gJ21kNSc7XG5jb25zdCBERUZBVUxUX0NFUlRfSEFTSCA9IHtcbiAgW1NIQTI1Nl06ICdhNDBkYTgwYTU5ZDE3MGNhYTk1MGNmMTVjMThjNDU0ZDQ3YTM5YjI2OTg5ZDhiNjQwZWNkNzQ1YmE3MWJmNWRjJ1xufTtcblxuXG5jb25zdCBhcGtTaWduaW5nTWV0aG9kcyA9IHt9O1xuXG4vKipcbiAqIEV4ZWN1dGUgYXBrc2lnbmVyIHV0aWxpdHkgd2l0aCBnaXZlbiBhcmd1bWVudHMuXG4gKlxuICogQHBhcmFtIHs/QXJyYXk8U3RyaW5nPn0gYXJncyAtIFRoZSBsaXN0IG9mIHRvb2wgYXJndW1lbnRzLlxuICogQHJldHVybiB7c3RyaW5nfSAtIENvbW1hbmQgc3Rkb3V0XG4gKiBAdGhyb3dzIHtFcnJvcn0gSWYgYXBrc2lnbmVyIGJpbmFyeSBpcyBub3QgcHJlc2VudCBvbiB0aGUgbG9jYWwgZmlsZSBzeXN0ZW1cbiAqICAgICAgICAgICAgICAgICBvciB0aGUgcmV0dXJuIGNvZGUgaXMgbm90IGVxdWFsIHRvIHplcm8uXG4gKi9cbmFwa1NpZ25pbmdNZXRob2RzLmV4ZWN1dGVBcGtzaWduZXIgPSBhc3luYyBmdW5jdGlvbiBleGVjdXRlQXBrc2lnbmVyIChhcmdzID0gW10pIHtcbiAgY29uc3QgYXBrU2lnbmVySmFyID0gYXdhaXQgZ2V0QXBrc2lnbmVyRm9yT3ModGhpcyk7XG4gIGNvbnN0IGZ1bGxDbWQgPSBbXG4gICAgYXdhaXQgZ2V0SmF2YUZvck9zKCksICctWG14MTAyNE0nLCAnLVhzczFtJyxcbiAgICAnLWphcicsIGFwa1NpZ25lckphcixcbiAgICAuLi5hcmdzXG4gIF07XG4gIGxvZy5kZWJ1ZyhgU3RhcnRpbmcgYXBrc2lnbmVyOiAke3V0aWwucXVvdGUoZnVsbENtZCl9YCk7XG4gIC8vIEl0IGlzIG5lY2Vzc2FyeSB0byBzcGVjaWZ5IENXRCBleHBsaWNpdGx5OyBzZWUgaHR0cHM6Ly9naXRodWIuY29tL2FwcGl1bS9hcHBpdW0vaXNzdWVzLzE0NzI0I2lzc3VlY29tbWVudC03Mzc0NDY3MTVcbiAgY29uc3Qge3N0ZG91dCwgc3RkZXJyfSA9IGF3YWl0IGV4ZWMoZnVsbENtZFswXSwgZnVsbENtZC5zbGljZSgxKSwge1xuICAgIGN3ZDogcGF0aC5kaXJuYW1lKGFwa1NpZ25lckphcilcbiAgfSk7XG4gIGZvciAobGV0IFtuYW1lLCBzdHJlYW1dIG9mIFtbJ3N0ZG91dCcsIHN0ZG91dF0sIFsnc3RkZXJyJywgc3RkZXJyXV0pIHtcbiAgICBpZiAoIV8udHJpbShzdHJlYW0pKSB7XG4gICAgICBjb250aW51ZTtcbiAgICB9XG5cbiAgICBpZiAobmFtZSA9PT0gJ3N0ZG91dCcpIHtcbiAgICAgIC8vIE1ha2UgdGhlIG91dHB1dCBsZXNzIHRhbGthdGl2ZVxuICAgICAgc3RyZWFtID0gc3RyZWFtLnNwbGl0KCdcXG4nKVxuICAgICAgICAuZmlsdGVyKChsaW5lKSA9PiAhbGluZS5pbmNsdWRlcygnV0FSTklORzonKSlcbiAgICAgICAgLmpvaW4oJ1xcbicpO1xuICAgIH1cbiAgICBsb2cuZGVidWcoYGFwa3NpZ25lciAke25hbWV9OiAke3N0cmVhbX1gKTtcbiAgfVxuICByZXR1cm4gc3Rkb3V0O1xufTtcblxuLyoqXG4gKiAoUmUpc2lnbiB0aGUgZ2l2ZW4gYXBrIGZpbGUgb24gdGhlIGxvY2FsIGZpbGUgc3lzdGVtIHdpdGggdGhlIGRlZmF1bHQgY2VydGlmaWNhdGUuXG4gKlxuICogQHBhcmFtIHtzdHJpbmd9IGFwayAtIFRoZSBmdWxsIHBhdGggdG8gdGhlIGxvY2FsIGFwayBmaWxlLlxuICogQHRocm93cyB7RXJyb3J9IElmIHNpZ25pbmcgZmFpbHMuXG4gKi9cbmFwa1NpZ25pbmdNZXRob2RzLnNpZ25XaXRoRGVmYXVsdENlcnQgPSBhc3luYyBmdW5jdGlvbiBzaWduV2l0aERlZmF1bHRDZXJ0IChhcGspIHtcbiAgbG9nLmRlYnVnKGBTaWduaW5nICcke2Fwa30nIHdpdGggZGVmYXVsdCBjZXJ0YCk7XG4gIGlmICghKGF3YWl0IGZzLmV4aXN0cyhhcGspKSkge1xuICAgIHRocm93IG5ldyBFcnJvcihgJHthcGt9IGZpbGUgZG9lc24ndCBleGlzdC5gKTtcbiAgfVxuXG4gIGNvbnN0IGFyZ3MgPSBbXG4gICAgJ3NpZ24nLFxuICAgICctLWtleScsIERFRkFVTFRfUFJJVkFURV9LRVksXG4gICAgJy0tY2VydCcsIERFRkFVTFRfQ0VSVElGSUNBVEUsXG4gICAgYXBrLFxuICBdO1xuICB0cnkge1xuICAgIGF3YWl0IHRoaXMuZXhlY3V0ZUFwa3NpZ25lcihhcmdzKTtcbiAgfSBjYXRjaCAoZSkge1xuICAgIHRocm93IG5ldyBFcnJvcihgQ291bGQgbm90IHNpZ24gJyR7YXBrfScgd2l0aCB0aGUgZGVmYXVsdCBjZXJ0aWZpY2F0ZS4gYCArXG4gICAgICBgT3JpZ2luYWwgZXJyb3I6ICR7ZS5zdGRlcnIgfHwgZS5zdGRvdXQgfHwgZS5tZXNzYWdlfWApO1xuICB9XG59O1xuXG4vKipcbiAqIChSZSlzaWduIHRoZSBnaXZlbiBhcGsgZmlsZSBvbiB0aGUgbG9jYWwgZmlsZSBzeXN0ZW0gd2l0aCBhIGN1c3RvbSBjZXJ0aWZpY2F0ZS5cbiAqXG4gKiBAcGFyYW0ge3N0cmluZ30gYXBrIC0gVGhlIGZ1bGwgcGF0aCB0byB0aGUgbG9jYWwgYXBrIGZpbGUuXG4gKiBAdGhyb3dzIHtFcnJvcn0gSWYgc2lnbmluZyBmYWlscy5cbiAqL1xuYXBrU2lnbmluZ01ldGhvZHMuc2lnbldpdGhDdXN0b21DZXJ0ID0gYXN5bmMgZnVuY3Rpb24gc2lnbldpdGhDdXN0b21DZXJ0IChhcGspIHtcbiAgbG9nLmRlYnVnKGBTaWduaW5nICcke2Fwa30nIHdpdGggY3VzdG9tIGNlcnRgKTtcbiAgaWYgKCEoYXdhaXQgZnMuZXhpc3RzKHRoaXMua2V5c3RvcmVQYXRoKSkpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoYEtleXN0b3JlOiAke3RoaXMua2V5c3RvcmVQYXRofSBkb2Vzbid0IGV4aXN0LmApO1xuICB9XG4gIGlmICghKGF3YWl0IGZzLmV4aXN0cyhhcGspKSkge1xuICAgIHRocm93IG5ldyBFcnJvcihgJyR7YXBrfScgZG9lc24ndCBleGlzdC5gKTtcbiAgfVxuXG4gIHRyeSB7XG4gICAgYXdhaXQgdGhpcy5leGVjdXRlQXBrc2lnbmVyKFsnc2lnbicsXG4gICAgICAnLS1rcycsIHRoaXMua2V5c3RvcmVQYXRoLFxuICAgICAgJy0ta3Mta2V5LWFsaWFzJywgdGhpcy5rZXlBbGlhcyxcbiAgICAgICctLWtzLXBhc3MnLCBgcGFzczoke3RoaXMua2V5c3RvcmVQYXNzd29yZH1gLFxuICAgICAgJy0ta2V5LXBhc3MnLCBgcGFzczoke3RoaXMua2V5UGFzc3dvcmR9YCxcbiAgICAgIGFwa10pO1xuICB9IGNhdGNoIChlcnIpIHtcbiAgICBsb2cud2FybihgQ2Fubm90IHVzZSBhcGtzaWduZXIgdG9vbCBmb3Igc2lnbmluZy4gRGVmYXVsdGluZyB0byBqYXJzaWduZXIuIGAgK1xuICAgICAgYE9yaWdpbmFsIGVycm9yOiAke2Vyci5zdGRlcnIgfHwgZXJyLnN0ZG91dCB8fCBlcnIubWVzc2FnZX1gKTtcbiAgICB0cnkge1xuICAgICAgaWYgKGF3YWl0IHVuc2lnbkFwayhhcGspKSB7XG4gICAgICAgIGxvZy5kZWJ1ZyhgJyR7YXBrfScgaGFzIGJlZW4gc3VjY2Vzc2Z1bGx5IHVuc2lnbmVkYCk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBsb2cuZGVidWcoYCcke2Fwa30nIGRvZXMgbm90IG5lZWQgdG8gYmUgdW5zaWduZWRgKTtcbiAgICAgIH1cbiAgICAgIGNvbnN0IGphcnNpZ25lciA9IHBhdGgucmVzb2x2ZShhd2FpdCBnZXRKYXZhSG9tZSgpLCAnYmluJyxcbiAgICAgICAgYGphcnNpZ25lciR7c3lzdGVtLmlzV2luZG93cygpID8gJy5leGUnIDogJyd9YCk7XG4gICAgICBjb25zdCBmdWxsQ21kID0gW2phcnNpZ25lcixcbiAgICAgICAgJy1zaWdhbGcnLCAnTUQ1d2l0aFJTQScsXG4gICAgICAgICctZGlnZXN0YWxnJywgJ1NIQTEnLFxuICAgICAgICAnLWtleXN0b3JlJywgdGhpcy5rZXlzdG9yZVBhdGgsXG4gICAgICAgICctc3RvcmVwYXNzJywgdGhpcy5rZXlzdG9yZVBhc3N3b3JkLFxuICAgICAgICAnLWtleXBhc3MnLCB0aGlzLmtleVBhc3N3b3JkLFxuICAgICAgICBhcGssIHRoaXMua2V5QWxpYXNdO1xuICAgICAgbG9nLmRlYnVnKGBTdGFydGluZyBqYXJzaWduZXI6ICR7dXRpbC5xdW90ZShmdWxsQ21kKX1gKTtcbiAgICAgIGF3YWl0IGV4ZWMoZnVsbENtZFswXSwgZnVsbENtZC5zbGljZSgxKSk7XG4gICAgfSBjYXRjaCAoZSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBDb3VsZCBub3Qgc2lnbiB3aXRoIGN1c3RvbSBjZXJ0aWZpY2F0ZS4gYCArXG4gICAgICAgIGBPcmlnaW5hbCBlcnJvcjogJHtlLnN0ZGVyciB8fCBlLm1lc3NhZ2V9YCk7XG4gICAgfVxuICB9XG59O1xuXG4vKipcbiAqIChSZSlzaWduIHRoZSBnaXZlbiBhcGsgZmlsZSBvbiB0aGUgbG9jYWwgZmlsZSBzeXN0ZW0gd2l0aCBlaXRoZXJcbiAqIGN1c3RvbSBvciBkZWZhdWx0IGNlcnRpZmljYXRlIGJhc2VkIG9uIF90aGlzLnVzZUtleXN0b3JlXyBwcm9wZXJ0eSB2YWx1ZVxuICogYW5kIFppcC1hbGlnbnMgaXQgYWZ0ZXIgc2lnbmluZy5cbiAqXG4gKiBAcGFyYW0ge3N0cmluZ30gYXBwUGF0aCAtIFRoZSBmdWxsIHBhdGggdG8gdGhlIGxvY2FsIC5hcGsocykgZmlsZS5cbiAqIEB0aHJvd3Mge0Vycm9yfSBJZiBzaWduaW5nIGZhaWxzLlxuICovXG5hcGtTaWduaW5nTWV0aG9kcy5zaWduID0gYXN5bmMgZnVuY3Rpb24gc2lnbiAoYXBwUGF0aCkge1xuICBpZiAoYXBwUGF0aC5lbmRzV2l0aChBUEtTX0VYVEVOU0lPTikpIHtcbiAgICBsZXQgbWVzc2FnZSA9ICdTaWduaW5nIG9mIC5hcGtzLWZpbGVzIGlzIG5vdCBzdXBwb3J0ZWQuICc7XG4gICAgaWYgKHRoaXMudXNlS2V5c3RvcmUpIHtcbiAgICAgIG1lc3NhZ2UgKz0gJ0NvbnNpZGVyIG1hbnVhbCBhcHBsaWNhdGlvbiBidW5kbGUgc2lnbmluZyB3aXRoIHRoZSBjdXN0b20ga2V5c3RvcmUgJyArXG4gICAgICAgIGBsaWtlIGl0IGlzIGRlc2NyaWJlZCBhdCAke0JVTkRMRVRPT0xfVFVUT1JJQUx9YDtcbiAgICB9IGVsc2Uge1xuICAgICAgbWVzc2FnZSArPSBgQ29uc2lkZXIgbWFudWFsIGFwcGxpY2F0aW9uIGJ1bmRsZSBzaWduaW5nIHdpdGggdGhlIGtleSBhdCAnJHtERUZBVUxUX1BSSVZBVEVfS0VZfScgYCArXG4gICAgICAgIGBhbmQgdGhlIGNlcnRpZmljYXRlIGF0ICcke0RFRkFVTFRfQ0VSVElGSUNBVEV9Jy4gUmVhZCAke0JVTkRMRVRPT0xfVFVUT1JJQUx9IGZvciBtb3JlIGRldGFpbHMuYDtcbiAgICB9XG4gICAgbG9nLndhcm4obWVzc2FnZSk7XG4gICAgcmV0dXJuO1xuICB9XG5cbiAgLy8gaXQgaXMgbmVjZXNzYXJ5IHRvIGFwcGx5IHppcGFsaWduIG9ubHkgYmVmb3JlIHNpZ25pbmdcbiAgLy8gaWYgYXBrc2lnbmVyIGlzIHVzZWRcbiAgYXdhaXQgdGhpcy56aXBBbGlnbkFwayhhcHBQYXRoKTtcblxuICBpZiAodGhpcy51c2VLZXlzdG9yZSkge1xuICAgIGF3YWl0IHRoaXMuc2lnbldpdGhDdXN0b21DZXJ0KGFwcFBhdGgpO1xuICB9IGVsc2Uge1xuICAgIGF3YWl0IHRoaXMuc2lnbldpdGhEZWZhdWx0Q2VydChhcHBQYXRoKTtcbiAgfVxufTtcblxuLyoqXG4gKiBQZXJmb3JtIHppcC1hbGlnbmluZyB0byB0aGUgZ2l2ZW4gbG9jYWwgYXBrIGZpbGUuXG4gKlxuICogQHBhcmFtIHtzdHJpbmd9IGFwayAtIFRoZSBmdWxsIHBhdGggdG8gdGhlIGxvY2FsIGFwayBmaWxlLlxuICogQHJldHVybnMge2Jvb2xlYW59IFRydWUgaWYgdGhlIGFwayBoYXMgYmVlbiBzdWNjZXNzZnVsbHkgYWxpZ25lZFxuICogb3IgZmFsc2UgaWYgdGhlIGFwayBoYXMgYmVlbiBhbHJlYWR5IGFsaWduZWQuXG4gKiBAdGhyb3dzIHtFcnJvcn0gSWYgemlwLWFsaWduIGZhaWxzLlxuICovXG5hcGtTaWduaW5nTWV0aG9kcy56aXBBbGlnbkFwayA9IGFzeW5jIGZ1bmN0aW9uIHppcEFsaWduQXBrIChhcGspIHtcbiAgYXdhaXQgdGhpcy5pbml0WmlwQWxpZ24oKTtcbiAgdHJ5IHtcbiAgICBhd2FpdCBleGVjKHRoaXMuYmluYXJpZXMuemlwYWxpZ24sIFsnLWMnLCAnNCcsIGFwa10pO1xuICAgIGxvZy5kZWJ1ZyhgJHthcGt9JyBpcyBhbHJlYWR5IHppcC1hbGlnbmVkLiBEb2luZyBub3RoaW5nYCk7XG4gICAgcmV0dXJuIGZhbHNlO1xuICB9IGNhdGNoIChlKSB7XG4gICAgbG9nLmRlYnVnKGAnJHthcGt9JyBpcyBub3QgemlwLWFsaWduZWQuIEFsaWduaW5nYCk7XG4gIH1cbiAgdHJ5IHtcbiAgICBhd2FpdCBmcy5hY2Nlc3MoYXBrLCBfZnMuV19PSyk7XG4gIH0gY2F0Y2ggKGUpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoYFRoZSBmaWxlIGF0ICcke2Fwa30nIGlzIG5vdCB3cml0ZWFibGUuIGAgK1xuICAgICAgYFBsZWFzZSBncmFudCB3cml0ZSBwZXJtaXNzaW9ucyB0byB0aGlzIGZpbGUgb3IgdG8gaXRzIHBhcmVudCBmb2xkZXIgJyR7cGF0aC5kaXJuYW1lKGFwayl9JyBgICtcbiAgICAgIGBmb3IgdGhlIEFwcGl1bSBwcm9jZXNzLCBzbyBpdCBjYW4gemlwLWFsaWduIHRoZSBmaWxlYCk7XG4gIH1cbiAgY29uc3QgYWxpZ25lZEFwayA9IGF3YWl0IHRlbXBEaXIucGF0aCh7cHJlZml4OiAnYXBwaXVtJywgc3VmZml4OiAnLnRtcCd9KTtcbiAgYXdhaXQgbWtkaXJwKHBhdGguZGlybmFtZShhbGlnbmVkQXBrKSk7XG4gIHRyeSB7XG4gICAgYXdhaXQgZXhlYyh0aGlzLmJpbmFyaWVzLnppcGFsaWduLCBbJy1mJywgJzQnLCBhcGssIGFsaWduZWRBcGtdKTtcbiAgICBhd2FpdCBmcy5tdihhbGlnbmVkQXBrLCBhcGssIHsgbWtkaXJwOiB0cnVlIH0pO1xuICAgIHJldHVybiB0cnVlO1xuICB9IGNhdGNoIChlKSB7XG4gICAgaWYgKGF3YWl0IGZzLmV4aXN0cyhhbGlnbmVkQXBrKSkge1xuICAgICAgYXdhaXQgZnMudW5saW5rKGFsaWduZWRBcGspO1xuICAgIH1cbiAgICB0aHJvdyBuZXcgRXJyb3IoYHppcEFsaWduQXBrIGZhaWxlZC4gT3JpZ2luYWwgZXJyb3I6ICR7ZS5zdGRlcnIgfHwgZS5tZXNzYWdlfWApO1xuICB9XG59O1xuXG4vKipcbiAqIEB0eXBlZGVmIHtPYmplY3R9IENlcnRDaGVja09wdGlvbnNcbiAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gcmVxdWlyZURlZmF1bHRDZXJ0IFt0cnVlXSBXaGV0aGVyIHRvIHJlcXVpcmUgdGhhdCB0aGUgZGVzdGluYXRpb24gQVBLXG4gKiBpcyBzaWduZWQgd2l0aCB0aGUgZGVmYXVsdCBBcHBpdW0gY2VydGlmaWNhdGUgb3IgYW55IHZhbGlkIGNlcnRpZmljYXRlLiBUaGlzIG9wdGlvblxuICogb25seSBoYXMgZWZmZWN0IGlmIGB1c2VLZXlzdG9yZWAgcHJvcGVydHkgaXMgdW5zZXQuXG4gKi9cblxuLyoqXG4gKiBDaGVjayBpZiB0aGUgYXBwIGlzIGFscmVhZHkgc2lnbmVkIHdpdGggdGhlIGRlZmF1bHQgQXBwaXVtIGNlcnRpZmljYXRlLlxuICpcbiAqIEBwYXJhbSB7c3RyaW5nfSBhcHBQYXRoIC0gVGhlIGZ1bGwgcGF0aCB0byB0aGUgbG9jYWwgLmFwayhzKSBmaWxlLlxuICogQHBhcmFtIHtzdHJpbmd9IHBnayAtIFRoZSBuYW1lIG9mIGFwcGxpY2F0aW9uIHBhY2thZ2UuXG4gKiBAcGFyYW0ge0NlcnRDaGVja09wdGlvbnN9IG9wdHMgLSBDZXJ0aWZpY2F0ZSBjaGVja2luZyBvcHRpb25zXG4gKiBAcmV0dXJuIHtib29sZWFufSBUcnVlIGlmIGdpdmVuIGFwcGxpY2F0aW9uIGlzIGFscmVhZHkgc2lnbmVkLlxuICovXG5hcGtTaWduaW5nTWV0aG9kcy5jaGVja0Fwa0NlcnQgPSBhc3luYyBmdW5jdGlvbiBjaGVja0Fwa0NlcnQgKGFwcFBhdGgsIHBrZywgb3B0cyA9IHt9KSB7XG4gIGxvZy5kZWJ1ZyhgQ2hlY2tpbmcgYXBwIGNlcnQgZm9yICR7YXBwUGF0aH1gKTtcbiAgaWYgKCFhd2FpdCBmcy5leGlzdHMoYXBwUGF0aCkpIHtcbiAgICBsb2cuZGVidWcoYCcke2FwcFBhdGh9JyBkb2VzIG5vdCBleGlzdGApO1xuICAgIHJldHVybiBmYWxzZTtcbiAgfVxuXG4gIGlmIChwYXRoLmV4dG5hbWUoYXBwUGF0aCkgPT09IEFQS1NfRVhURU5TSU9OKSB7XG4gICAgYXBwUGF0aCA9IGF3YWl0IHRoaXMuZXh0cmFjdEJhc2VBcGsoYXBwUGF0aCk7XG4gIH1cblxuICBjb25zdCBleHBlY3RlZEhhc2ggPSB0aGlzLnVzZUtleXN0b3JlXG4gICAgPyBhd2FpdCB0aGlzLmdldEtleXN0b3JlSGFzaChhcHBQYXRoLCBwa2cpXG4gICAgOiBERUZBVUxUX0NFUlRfSEFTSDtcblxuICBjb25zdCBoYXNoTWF0Y2hlcyA9IChhcGtzaWduZXJPdXRwdXQpID0+IHtcbiAgICBmb3IgKGNvbnN0IFtuYW1lLCB2YWx1ZV0gb2YgXy50b1BhaXJzKGV4cGVjdGVkSGFzaCkpIHtcbiAgICAgIGlmIChuZXcgUmVnRXhwKGBkaWdlc3Q6XFxcXHMrJHt2YWx1ZX1cXFxcYmAsICdpJykudGVzdChhcGtzaWduZXJPdXRwdXQpKSB7XG4gICAgICAgIGxvZy5kZWJ1ZyhgJHtuYW1lfSBoYXNoIGRpZCBtYXRjaCBmb3IgJyR7cGF0aC5iYXNlbmFtZShhcHBQYXRoKX0nYCk7XG4gICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gZmFsc2U7XG4gIH07XG5cbiAgY29uc3Qge1xuICAgIHJlcXVpcmVEZWZhdWx0Q2VydCA9IHRydWUsXG4gIH0gPSBvcHRzO1xuICB0cnkge1xuICAgIGF3YWl0IGdldEFwa3NpZ25lckZvck9zKHRoaXMpO1xuICAgIGNvbnN0IG91dHB1dCA9IGF3YWl0IHRoaXMuZXhlY3V0ZUFwa3NpZ25lcihbJ3ZlcmlmeScsICctLXByaW50LWNlcnRzJywgYXBwUGF0aF0pO1xuICAgIGNvbnN0IGhhc01hdGNoID0gaGFzaE1hdGNoZXMob3V0cHV0KTtcbiAgICBpZiAoaGFzTWF0Y2gpIHtcbiAgICAgIGxvZy5pbmZvKGAnJHthcHBQYXRofScgaXMgc2lnbmVkIHdpdGggdGhlIGAgK1xuICAgICAgICBgJHt0aGlzLnVzZUtleXN0b3JlID8gJ2tleXN0b3JlJyA6ICdkZWZhdWx0J30gY2VydGlmaWNhdGVgKTtcbiAgICB9IGVsc2Uge1xuICAgICAgbG9nLmluZm8oYCcke2FwcFBhdGh9JyBpcyBzaWduZWQgd2l0aCBhIGAgK1xuICAgICAgICBgbm9uLSR7dGhpcy51c2VLZXlzdG9yZSA/ICdrZXlzdG9yZScgOiAnZGVmYXVsdCd9IGNlcnRpZmljYXRlYCk7XG4gICAgfVxuICAgIHJldHVybiAoIXRoaXMudXNlS2V5c3RvcmUgJiYgIXJlcXVpcmVEZWZhdWx0Q2VydCkgfHwgaGFzTWF0Y2g7XG4gIH0gY2F0Y2ggKGVycikge1xuICAgIC8vIGNoZWNrIGlmIHRoZXJlIGlzIG5vIHNpZ25hdHVyZVxuICAgIGlmIChfLmluY2x1ZGVzKGVyci5zdGRlcnIsIEFQS1NJR05FUl9WRVJJRllfRkFJTCkpIHtcbiAgICAgIGxvZy5pbmZvKGAnJHthcHBQYXRofScgaXMgbm90IHNpZ25lZGApO1xuICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cbiAgICB0aHJvdyBuZXcgRXJyb3IoYENhbm5vdCB2ZXJpZnkgdGhlIHNpZ25hdHVyZSBvZiAnJHthcHBQYXRofScuIGAgK1xuICAgICAgYE9yaWdpbmFsIGVycm9yOiAke2Vyci5zdGRlcnIgfHwgZXJyLnN0ZG91dCB8fCBlcnIubWVzc2FnZX1gKTtcbiAgfVxufTtcblxuLyoqXG4gKiBAdHlwZWRlZiB7T2JqZWN0fSBLZXlzdG9yZUhhc2hcbiAqIEBwcm9wZXJ0eSB7P3N0cmluZ30gbWQ1IHRoZSBtZDUgaGFzaCB2YWx1ZSBvZiB0aGUga2V5c3RvcmVcbiAqIEBwcm9wZXJ0eSB7P3N0cmluZ30gc2hhMSB0aGUgc2hhMSBoYXNoIHZhbHVlIG9mIHRoZSBrZXlzdG9yZVxuICogQHByb3BlcnR5IHs/c3RyaW5nfSBzaGEyNTYgdGhlIHNoYTI1NiBoYXNoIHZhbHVlIG9mIHRoZSBrZXlzdG9yZVxuICogQHByb3BlcnR5IHs/c3RyaW5nfSBzaGE1MTIgdGhlIHNoYTUxMiBoYXNoIHZhbHVlIG9mIHRoZSBrZXlzdG9yZVxuICovXG5cbi8qKlxuICogUmV0cmlldmUgdGhlIHRoZSBoYXNoIG9mIHRoZSBnaXZlbiBrZXlzdG9yZS5cbiAqXG4gKiBAcmV0dXJuIHtLZXlzdG9yZUhhc2h9XG4gKiBAdGhyb3dzIHtFcnJvcn0gSWYgZ2V0dGluZyBrZXlzdG9yZSBoYXNoIGZhaWxzLlxuICovXG5hcGtTaWduaW5nTWV0aG9kcy5nZXRLZXlzdG9yZUhhc2ggPSBhc3luYyBmdW5jdGlvbiBnZXRLZXlzdG9yZUhhc2ggKCkge1xuICBsb2cuZGVidWcoYEdldHRpbmcgaGFzaCBvZiB0aGUgJyR7dGhpcy5rZXlzdG9yZVBhdGh9JyBrZXlzdG9yZWApO1xuICBjb25zdCBrZXl0b29sID0gcGF0aC5yZXNvbHZlKGF3YWl0IGdldEphdmFIb21lKCksICdiaW4nLFxuICAgIGBrZXl0b29sJHtzeXN0ZW0uaXNXaW5kb3dzKCkgPyAnLmV4ZScgOiAnJ31gKTtcbiAgaWYgKCFhd2FpdCBmcy5leGlzdHMoa2V5dG9vbCkpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoYFRoZSBrZXl0b29sIHV0aWxpdHkgY2Fubm90IGJlIGZvdW5kIGF0ICcke2tleXRvb2x9J2ApO1xuICB9XG4gIGNvbnN0IGFyZ3MgPSBbXG4gICAgJy12JywgJy1saXN0JyxcbiAgICAnLWFsaWFzJywgdGhpcy5rZXlBbGlhcyxcbiAgICAnLWtleXN0b3JlJywgdGhpcy5rZXlzdG9yZVBhdGgsXG4gICAgJy1zdG9yZXBhc3MnLCB0aGlzLmtleXN0b3JlUGFzc3dvcmRcbiAgXTtcbiAgbG9nLmluZm8oYFJ1bm5pbmcgJyR7a2V5dG9vbH0nIHdpdGggYXJndW1lbnRzOiAke3V0aWwucXVvdGUoYXJncyl9YCk7XG4gIHRyeSB7XG4gICAgY29uc3Qge3N0ZG91dH0gPSBhd2FpdCBleGVjKGtleXRvb2wsIGFyZ3MpO1xuICAgIGNvbnN0IHJlc3VsdCA9IHt9O1xuICAgIGZvciAoY29uc3QgaGFzaE5hbWUgb2YgW1NIQTUxMiwgU0hBMjU2LCBTSEExLCBNRDVdKSB7XG4gICAgICBjb25zdCBoYXNoUmUgPSBuZXcgUmVnRXhwKGBeXFxcXHMqJHtoYXNoTmFtZX06XFxcXHMqKFthLWYwLTk6XSspYCwgJ21pJyk7XG4gICAgICBjb25zdCBtYXRjaCA9IGhhc2hSZS5leGVjKHN0ZG91dCk7XG4gICAgICBpZiAoIW1hdGNoKSB7XG4gICAgICAgIGNvbnRpbnVlO1xuICAgICAgfVxuICAgICAgcmVzdWx0W2hhc2hOYW1lXSA9IG1hdGNoWzFdLnJlcGxhY2UoLzovZywgJycpLnRvTG93ZXJDYXNlKCk7XG4gICAgfVxuICAgIGlmIChfLmlzRW1wdHkocmVzdWx0KSkge1xuICAgICAgbG9nLmRlYnVnKHN0ZG91dCk7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ0Nhbm5vdCBwYXJzZSB0aGUgaGFzaCB2YWx1ZSBmcm9tIHRoZSBrZXl0b29sIG91dHB1dCcpO1xuICAgIH1cbiAgICBsb2cuZGVidWcoYEtleXN0b3JlIGhhc2g6ICR7SlNPTi5zdHJpbmdpZnkocmVzdWx0KX1gKTtcbiAgICByZXR1cm4gcmVzdWx0O1xuICB9IGNhdGNoIChlKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKGBDYW5ub3QgZ2V0IHRoZSBoYXNoIG9mICcke3RoaXMua2V5c3RvcmVQYXRofScga2V5c3RvcmUuIGAgK1xuICAgICAgYE9yaWdpbmFsIGVycm9yOiAke2Uuc3RkZXJyIHx8IGUubWVzc2FnZX1gKTtcbiAgfVxufTtcblxuZXhwb3J0IGRlZmF1bHQgYXBrU2lnbmluZ01ldGhvZHM7XG4iXSwiZmlsZSI6ImxpYi90b29scy9hcGstc2lnbmluZy5qcyIsInNvdXJjZVJvb3QiOiIuLi8uLi8uLiJ9
