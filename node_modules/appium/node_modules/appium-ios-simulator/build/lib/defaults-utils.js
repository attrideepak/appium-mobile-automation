"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.toXmlArg = toXmlArg;
exports.generateUpdateCommandArgs = generateUpdateCommandArgs;
exports.NSUserDefaults = void 0;

require("source-map-support/register");

var _lodash = _interopRequireDefault(require("lodash"));

var _xmldom = require("xmldom");

var _teen_process = require("teen_process");

var _bluebird = _interopRequireDefault(require("bluebird"));

var _logger = _interopRequireDefault(require("./logger"));

function toXmlArg(value, serialize = true) {
  let xmlDoc = null;

  if (_lodash.default.isPlainObject(value)) {
    xmlDoc = new _xmldom.DOMParser().parseFromString('<dict></dict>', 'text/xml');

    for (const [subKey, subValue] of _lodash.default.toPairs(value)) {
      const keyEl = xmlDoc.createElement('key');
      const keyTextEl = xmlDoc.createTextNode(subKey);
      keyEl.appendChild(keyTextEl);
      xmlDoc.documentElement.appendChild(keyEl);
      const subValueEl = xmlDoc.importNode(toXmlArg(subValue, false), true);
      xmlDoc.documentElement.appendChild(subValueEl);
    }
  } else if (_lodash.default.isArray(value)) {
    xmlDoc = new _xmldom.DOMParser().parseFromString('<array></array>', 'text/xml');

    for (const subValue of value) {
      const subValueEl = xmlDoc.importNode(toXmlArg(subValue, false), true);
      xmlDoc.documentElement.appendChild(subValueEl);
    }
  } else if (_lodash.default.isBoolean(value)) {
    xmlDoc = new _xmldom.DOMParser().parseFromString(value ? '<true/>' : '<false/>', 'text/xml');
  } else if (_lodash.default.isInteger(value)) {
    xmlDoc = new _xmldom.DOMParser().parseFromString(`<integer>${value}</integer>`, 'text/xml');
  } else if (_lodash.default.isNumber(value)) {
    xmlDoc = new _xmldom.DOMParser().parseFromString(`<real>${value}</real>`, 'text/xml');
  } else if (_lodash.default.isString(value)) {
    xmlDoc = new _xmldom.DOMParser().parseFromString(`<string></string>`, 'text/xml');
    const valueTextEl = xmlDoc.createTextNode(value);
    xmlDoc.documentElement.appendChild(valueTextEl);
  }

  if (!xmlDoc) {
    throw new TypeError(`The defaults value ${JSON.stringify(value)} cannot be written, ` + `because it is not known how to handle its type`);
  }

  return serialize ? new _xmldom.XMLSerializer().serializeToString(xmlDoc.documentElement) : xmlDoc.documentElement;
}

function generateUpdateCommandArgs(valuesMap) {
  const resultArgs = [];

  for (const [key, value] of _lodash.default.toPairs(valuesMap)) {
    try {
      if (_lodash.default.isPlainObject(value)) {
        const dictArgs = [key, '-dict-add'];

        for (const [subKey, subValue] of _lodash.default.toPairs(value)) {
          dictArgs.push(subKey, toXmlArg(subValue));
        }

        resultArgs.push(dictArgs);
      } else if (_lodash.default.isArray(value)) {
        const arrayArgs = [key, '-array-add'];

        for (const subValue of arrayArgs) {
          arrayArgs.push(toXmlArg(subValue));
        }

        resultArgs.push(arrayArgs);
      } else {
        resultArgs.push([key, toXmlArg(value)]);
      }
    } catch (e) {
      if (e instanceof TypeError) {
        _logger.default.warn(e.message);
      } else {
        throw e;
      }
    }
  }

  return resultArgs;
}

class NSUserDefaults {
  constructor(plist) {
    this.plist = plist;
  }

  async asJson() {
    try {
      const {
        stdout
      } = await (0, _teen_process.exec)('plutil', ['-convert', 'json', '-o', '-', this.plist]);
      return JSON.parse(stdout);
    } catch (e) {
      throw new Error(`'${this.plist}' cannot be converted to JSON. Original error: ${e.stderr || e.message}`);
    }
  }

  async update(valuesMap) {
    if (!_lodash.default.isPlainObject(valuesMap)) {
      throw new TypeError(`plist values must be a map. '${valuesMap}' is given instead`);
    }

    if (_lodash.default.isEmpty(valuesMap)) {
      return;
    }

    const commandArgs = generateUpdateCommandArgs(valuesMap);

    try {
      await _bluebird.default.all(commandArgs.map(args => (0, _teen_process.exec)('defaults', ['write', this.plist, ...args])));
    } catch (e) {
      throw new Error(`Could not write defaults into '${this.plist}'. Original error: ${e.stderr || e.message}`);
    }
  }

}

exports.NSUserDefaults = NSUserDefaults;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9kZWZhdWx0cy11dGlscy5qcyJdLCJuYW1lcyI6WyJ0b1htbEFyZyIsInZhbHVlIiwic2VyaWFsaXplIiwieG1sRG9jIiwiXyIsImlzUGxhaW5PYmplY3QiLCJET01QYXJzZXIiLCJwYXJzZUZyb21TdHJpbmciLCJzdWJLZXkiLCJzdWJWYWx1ZSIsInRvUGFpcnMiLCJrZXlFbCIsImNyZWF0ZUVsZW1lbnQiLCJrZXlUZXh0RWwiLCJjcmVhdGVUZXh0Tm9kZSIsImFwcGVuZENoaWxkIiwiZG9jdW1lbnRFbGVtZW50Iiwic3ViVmFsdWVFbCIsImltcG9ydE5vZGUiLCJpc0FycmF5IiwiaXNCb29sZWFuIiwiaXNJbnRlZ2VyIiwiaXNOdW1iZXIiLCJpc1N0cmluZyIsInZhbHVlVGV4dEVsIiwiVHlwZUVycm9yIiwiSlNPTiIsInN0cmluZ2lmeSIsIlhNTFNlcmlhbGl6ZXIiLCJzZXJpYWxpemVUb1N0cmluZyIsImdlbmVyYXRlVXBkYXRlQ29tbWFuZEFyZ3MiLCJ2YWx1ZXNNYXAiLCJyZXN1bHRBcmdzIiwia2V5IiwiZGljdEFyZ3MiLCJwdXNoIiwiYXJyYXlBcmdzIiwiZSIsImxvZyIsIndhcm4iLCJtZXNzYWdlIiwiTlNVc2VyRGVmYXVsdHMiLCJjb25zdHJ1Y3RvciIsInBsaXN0IiwiYXNKc29uIiwic3Rkb3V0IiwicGFyc2UiLCJFcnJvciIsInN0ZGVyciIsInVwZGF0ZSIsImlzRW1wdHkiLCJjb21tYW5kQXJncyIsIkIiLCJhbGwiLCJtYXAiLCJhcmdzIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7O0FBQUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBY0EsU0FBU0EsUUFBVCxDQUFtQkMsS0FBbkIsRUFBMEJDLFNBQVMsR0FBRyxJQUF0QyxFQUE0QztBQUMxQyxNQUFJQyxNQUFNLEdBQUcsSUFBYjs7QUFFQSxNQUFJQyxnQkFBRUMsYUFBRixDQUFnQkosS0FBaEIsQ0FBSixFQUE0QjtBQUMxQkUsSUFBQUEsTUFBTSxHQUFHLElBQUlHLGlC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O0FBQ0QsS0FGRCxDQUVFLE9BQU9sQixDQUFQLEVBQVU7QUFDVixZQUFNLElBQUlVLEtBQUosQ0FBVyxrQ0FBaUMsS0FBS0osS0FBTSxzQkFBcUJOLENBQUMsQ0FBQ1csTUFBRixJQUFZWCxDQUFDLENBQUNHLE9BQVEsRUFBbEcsQ0FBTjtBQUNEO0FBQ0Y7O0FBOUNrQiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBfIGZyb20gJ2xvZGFzaCc7XG5pbXBvcnQgeyBET01QYXJzZXIsIFhNTFNlcmlhbGl6ZXIgfSBmcm9tICd4bWxkb20nO1xuaW1wb3J0IHsgZXhlYyB9IGZyb20gJ3RlZW5fcHJvY2Vzcyc7XG5pbXBvcnQgQiBmcm9tICdibHVlYmlyZCc7XG5pbXBvcnQgbG9nIGZyb20gJy4vbG9nZ2VyJztcblxuLyoqXG4gKiBTZXJpYWxpemVzIHRoZSBnaXZlbiB2YWx1ZSB0byBwbGlzdC1jb21wYXRpYmxlXG4gKiBYTUwgcmVwcmVzZW50YXRpb24sIHdoaWNoIGlzIHJlYWR5IGZvciBmdXJ0aGVyIHVzYWdlXG4gKiB3aXRoIGBkZWZhdWx0c2AgY29tbWFuZCBsaW5lIHRvb2wgYXJndW1lbnRzXG4gKlxuICogQHBhcmFtIHsqfSB2YWx1ZSBUaGUgdmFsdWUgdG8gYmUgc2VyaWFsaXplZFxuICogQHBhcmFtIHtib29sZWFufSBzZXJpYWxpemUgW3RydWVdIFdoZXRoZXIgdG8gc2VyaWFsaXplIHRoZSByZXN1bHRpbmdcbiAqIFhNTCB0byBzdHJpbmcgb3IgdG8gcmV0dXJuIHJhdyBIVE1MRWxlbWVudCBpbnN0YW5jZVxuICogQHJldHVybnMge0hUTUxFbGVtZW50fHN0cmluZ30gRWl0aGVyIHN0cmluZyBvciByYXcgbm9kZSByZXByZXNlbnRhdGlvbiBvZlxuICogdGhlIGdpdmVuIHZhbHVlXG4gKiBAdGhyb3dzIHtUeXBlRXJyb3J9IElmIGl0IGlzIG5vdCBrbm93biBob3cgdG8gc2VyaWFsaXplIHRoZSBnaXZlbiB2YWx1ZVxuICovXG5mdW5jdGlvbiB0b1htbEFyZyAodmFsdWUsIHNlcmlhbGl6ZSA9IHRydWUpIHtcbiAgbGV0IHhtbERvYyA9IG51bGw7XG5cbiAgaWYgKF8uaXNQbGFpbk9iamVjdCh2YWx1ZSkpIHtcbiAgICB4bWxEb2MgPSBuZXcgRE9NUGFyc2VyKCkucGFyc2VGcm9tU3RyaW5nKCc8ZGljdD48L2RpY3Q+JywgJ3RleHQveG1sJyk7XG4gICAgZm9yIChjb25zdCBbc3ViS2V5LCBzdWJWYWx1ZV0gb2YgXy50b1BhaXJzKHZhbHVlKSkge1xuICAgICAgY29uc3Qga2V5RWwgPSB4bWxEb2MuY3JlYXRlRWxlbWVudCgna2V5Jyk7XG4gICAgICBjb25zdCBrZXlUZXh0RWwgPSB4bWxEb2MuY3JlYXRlVGV4dE5vZGUoc3ViS2V5KTtcbiAgICAgIGtleUVsLmFwcGVuZENoaWxkKGtleVRleHRFbCk7XG4gICAgICB4bWxEb2MuZG9jdW1lbnRFbGVtZW50LmFwcGVuZENoaWxkKGtleUVsKTtcbiAgICAgIGNvbnN0IHN1YlZhbHVlRWwgPSB4bWxEb2MuaW1wb3J0Tm9kZSh0b1htbEFyZyhzdWJWYWx1ZSwgZmFsc2UpLCB0cnVlKTtcbiAgICAgIHhtbERvYy5kb2N1bWVudEVsZW1lbnQuYXBwZW5kQ2hpbGQoc3ViVmFsdWVFbCk7XG4gICAgfVxuICB9IGVsc2UgaWYgKF8uaXNBcnJheSh2YWx1ZSkpIHtcbiAgICB4bWxEb2MgPSBuZXcgRE9NUGFyc2VyKCkucGFyc2VGcm9tU3RyaW5nKCc8YXJyYXk+PC9hcnJheT4nLCAndGV4dC94bWwnKTtcbiAgICBmb3IgKGNvbnN0IHN1YlZhbHVlIG9mIHZhbHVlKSB7XG4gICAgICBjb25zdCBzdWJWYWx1ZUVsID0geG1sRG9jLmltcG9ydE5vZGUodG9YbWxBcmcoc3ViVmFsdWUsIGZhbHNlKSwgdHJ1ZSk7XG4gICAgICB4bWxEb2MuZG9jdW1lbnRFbGVtZW50LmFwcGVuZENoaWxkKHN1YlZhbHVlRWwpO1xuICAgIH1cbiAgfSBlbHNlIGlmIChfLmlzQm9vbGVhbih2YWx1ZSkpIHtcbiAgICB4bWxEb2MgPSBuZXcgRE9NUGFyc2VyKCkucGFyc2VGcm9tU3RyaW5nKHZhbHVlID8gJzx0cnVlLz4nIDogJzxmYWxzZS8+JywgJ3RleHQveG1sJyk7XG4gIH0gZWxzZSBpZiAoXy5pc0ludGVnZXIodmFsdWUpKSB7XG4gICAgeG1sRG9jID0gbmV3IERPTVBhcnNlcigpLnBhcnNlRnJvbVN0cmluZyhgPGludGVnZXI+JHt2YWx1ZX08L2ludGVnZXI+YCwgJ3RleHQveG1sJyk7XG4gIH0gZWxzZSBpZiAoXy5pc051bWJlcih2YWx1ZSkpIHtcbiAgICB4bWxEb2MgPSBuZXcgRE9NUGFyc2VyKCkucGFyc2VGcm9tU3RyaW5nKGA8cmVhbD4ke3ZhbHVlfTwvcmVhbD5gLCAndGV4dC94bWwnKTtcbiAgfSBlbHNlIGlmIChfLmlzU3RyaW5nKHZhbHVlKSkge1xuICAgIHhtbERvYyA9IG5ldyBET01QYXJzZXIoKS5wYXJzZUZyb21TdHJpbmcoYDxzdHJpbmc+PC9zdHJpbmc+YCwgJ3RleHQveG1sJyk7XG4gICAgY29uc3QgdmFsdWVUZXh0RWwgPSB4bWxEb2MuY3JlYXRlVGV4dE5vZGUodmFsdWUpO1xuICAgIHhtbERvYy5kb2N1bWVudEVsZW1lbnQuYXBwZW5kQ2hpbGQodmFsdWVUZXh0RWwpO1xuICB9XG5cbiAgaWYgKCF4bWxEb2MpIHtcbiAgICB0aHJvdyBuZXcgVHlwZUVycm9yKGBUaGUgZGVmYXVsdHMgdmFsdWUgJHtKU09OLnN0cmluZ2lmeSh2YWx1ZSl9IGNhbm5vdCBiZSB3cml0dGVuLCBgICtcbiAgICAgIGBiZWNhdXNlIGl0IGlzIG5vdCBrbm93biBob3cgdG8gaGFuZGxlIGl0cyB0eXBlYCk7XG4gIH1cblxuICByZXR1cm4gc2VyaWFsaXplXG4gICAgPyBuZXcgWE1MU2VyaWFsaXplcigpLnNlcmlhbGl6ZVRvU3RyaW5nKHhtbERvYy5kb2N1bWVudEVsZW1lbnQpXG4gICAgOiB4bWxEb2MuZG9jdW1lbnRFbGVtZW50O1xufVxuXG4vKipcbiAqIEdlbmVyYXRlcyBjb21tYW5kIGxpbmUgYXJncyBmb3IgdGhlIGBkZWZhdWx0c2BcbiAqIGNvbW1hbmQgbGluZSB1dGlsaXR5IGJhc2VkIG9uIHRoZSBnaXZlbiBwcmVmZXJlbmNlIHZhbHVlcyBtYXBwaW5nLlxuICogU2VlIGh0dHBzOi8vc2hhZG93ZmlsZS5pbm9kZS5saW5rL2Jsb2cvMjAxOC8wNi9hZHZhbmNlZC1kZWZhdWx0czEtdXNhZ2UvXG4gKiBmb3IgbW9yZSBkZXRhaWxzLlxuICpcbiAqIEBwYXJhbSB7T2JqZWN0fSB2YWx1ZXNNYXAgUHJlZmVyZW5jZXMgbWFwcGluZ1xuICogQHJldHVybnMge0FycmF5PEFycmF5PHN0cmluZz4+fSBFYWNoIGl0ZW0gaW4gdGhlIGFycmF5XG4gKiBpcyB0aGUgYGRlZmF1bHRzIHdyaXRlIDxwbGlzdD5gIGNvbW1hbmQgc3VmZml4XG4gKi9cbmZ1bmN0aW9uIGdlbmVyYXRlVXBkYXRlQ29tbWFuZEFyZ3MgKHZhbHVlc01hcCkge1xuICBjb25zdCByZXN1bHRBcmdzID0gW107XG4gIGZvciAoY29uc3QgW2tleSwgdmFsdWVdIG9mIF8udG9QYWlycyh2YWx1ZXNNYXApKSB7XG4gICAgdHJ5IHtcbiAgICAgIGlmIChfLmlzUGxhaW5PYmplY3QodmFsdWUpKSB7XG4gICAgICAgIGNvbnN0IGRpY3RBcmdzID0gW2tleSwgJy1kaWN0LWFkZCddO1xuICAgICAgICBmb3IgKGNvbnN0IFtzdWJLZXksIHN1YlZhbHVlXSBvZiBfLnRvUGFpcnModmFsdWUpKSB7XG4gICAgICAgICAgZGljdEFyZ3MucHVzaChzdWJLZXksIHRvWG1sQXJnKHN1YlZhbHVlKSk7XG4gICAgICAgIH1cbiAgICAgICAgcmVzdWx0QXJncy5wdXNoKGRpY3RBcmdzKTtcbiAgICAgIH0gZWxzZSBpZiAoXy5pc0FycmF5KHZhbHVlKSkge1xuICAgICAgICBjb25zdCBhcnJheUFyZ3MgPSBba2V5LCAnLWFycmF5LWFkZCddO1xuICAgICAgICBmb3IgKGNvbnN0IHN1YlZhbHVlIG9mIGFycmF5QXJncykge1xuICAgICAgICAgIGFycmF5QXJncy5wdXNoKHRvWG1sQXJnKHN1YlZhbHVlKSk7XG4gICAgICAgIH1cbiAgICAgICAgcmVzdWx0QXJncy5wdXNoKGFycmF5QXJncyk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICByZXN1bHRBcmdzLnB1c2goW2tleSwgdG9YbWxBcmcodmFsdWUpXSk7XG4gICAgICB9XG4gICAgfSBjYXRjaCAoZSkge1xuICAgICAgaWYgKGUgaW5zdGFuY2VvZiBUeXBlRXJyb3IpIHtcbiAgICAgICAgbG9nLndhcm4oZS5tZXNzYWdlKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHRocm93IGU7XG4gICAgICB9XG4gICAgfVxuICB9XG4gIHJldHVybiByZXN1bHRBcmdzO1xufVxuXG5cbmNsYXNzIE5TVXNlckRlZmF1bHRzIHtcbiAgY29uc3RydWN0b3IgKHBsaXN0KSB7XG4gICAgdGhpcy5wbGlzdCA9IHBsaXN0O1xuICB9XG5cbiAgLyoqXG4gICAqIFJlYWRzIHRoZSBjb250ZW50IG9mIHRoZSBnaXZlbiBwbGlzdCBmaWxlIHVzaW5nIHBsdXRpbCBjb21tYW5kIGxpbmUgdG9vbFxuICAgKiBhbmQgc2VyaWFsaXplcyBpdCB0byBhIEpTT04gcmVwcmVzZW50YXRpb25cbiAgICpcbiAgICogQHJldHVybnMge09iamVjdH0gVGhlIHNlcmlhbGl6ZWQgcGxpc3QgY29udGVudFxuICAgKiBAdGhyb3dzIHtFcnJvcn0gSWYgdGhlcmUgd2FzIGFuIGVycm9yIGR1cmluZyBzZXJpYWxpemF0aW9uXG4gICAqL1xuICBhc3luYyBhc0pzb24gKCkge1xuICAgIHRyeSB7XG4gICAgICBjb25zdCB7c3Rkb3V0fSA9IGF3YWl0IGV4ZWMoJ3BsdXRpbCcsIFsnLWNvbnZlcnQnLCAnanNvbicsICctbycsICctJywgdGhpcy5wbGlzdF0pO1xuICAgICAgcmV0dXJuIEpTT04ucGFyc2Uoc3Rkb3V0KTtcbiAgICB9IGNhdGNoIChlKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYCcke3RoaXMucGxpc3R9JyBjYW5ub3QgYmUgY29udmVydGVkIHRvIEpTT04uIE9yaWdpbmFsIGVycm9yOiAke2Uuc3RkZXJyIHx8IGUubWVzc2FnZX1gKTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogVXBkYXRlcyB0aGUgY29udGVudCBvZiB0aGUgZ2l2ZW4gcGxpc3QgZmlsZS5cbiAgICogSWYgdGhlIHBsaXN0IGRvZXMgbm90IGV4aXN0IHlldCB0aGVuIGl0IGlzIGdvaW5nIHRvIGJlIGNyZWF0ZWQuXG4gICAqXG4gICAqIEBwYXJhbSB7T2JqZWN0fSB2YWx1ZXNNYXAgTWFwcGluZyBvZiBwcmVmZXJlbmNlIHZhbHVlcyB0byB1cGRhdGUuXG4gICAqIElmIGFueSBvZiBpdGVtIHZhbHVlcyBhcmUgb2YgZGljdGlvbmFyeSB0eXBlIHRoZW4gb25seSB0aGUgZmlyc3QgbGV2ZWwgZGljdGlvbmFyeSBnZXRzXG4gICAqIHVwZGF0ZWQuIEV2ZXJ5dGhpbmcgYmVsb3cgdGhpcyBsZXZlbCB3aWxsIGJlIHJlcGxhY2VkLiBUaGlzIGlzIHRoZSBrbm93biBsaW1pdGF0aW9uXG4gICAqIG9mIHRoZSBgZGVmYXVsdHNgIGNvbW1hbmQgbGluZSB0b29sLiBBIHdvcmthcm91bmQgZm9yIGl0IHdvdWxkIGJlIHRvIHJlYWQgdGhlIGN1cnJlbnRcbiAgICogcHJlZmVyZW5jZXMgbWFwcGluZyBmaXJzdCBhbmQgbWVyZ2UgaXQgd2l0aCB0aGlzIHZhbHVlLlxuICAgKiBAdGhyb3dzIHtFcnJvcn0gSWYgdGhlcmUgd2FzIGFuIGVycm9yIHdoaWxlIHVwZGF0aW5nIHRoZSBwbGlzdFxuICAgKi9cbiAgYXN5bmMgdXBkYXRlICh2YWx1ZXNNYXApIHtcbiAgICBpZiAoIV8uaXNQbGFpbk9iamVjdCh2YWx1ZXNNYXApKSB7XG4gICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKGBwbGlzdCB2YWx1ZXMgbXVzdCBiZSBhIG1hcC4gJyR7dmFsdWVzTWFwfScgaXMgZ2l2ZW4gaW5zdGVhZGApO1xuICAgIH1cbiAgICBpZiAoXy5pc0VtcHR5KHZhbHVlc01hcCkpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBjb25zdCBjb21tYW5kQXJncyA9IGdlbmVyYXRlVXBkYXRlQ29tbWFuZEFyZ3ModmFsdWVzTWFwKTtcbiAgICB0cnkge1xuICAgICAgYXdhaXQgQi5hbGwoY29tbWFuZEFyZ3MubWFwKChhcmdzKSA9PiBleGVjKCdkZWZhdWx0cycsIFsnd3JpdGUnLCB0aGlzLnBsaXN0LCAuLi5hcmdzXSkpKTtcbiAgICB9IGNhdGNoIChlKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYENvdWxkIG5vdCB3cml0ZSBkZWZhdWx0cyBpbnRvICcke3RoaXMucGxpc3R9Jy4gT3JpZ2luYWwgZXJyb3I6ICR7ZS5zdGRlcnIgfHwgZS5tZXNzYWdlfWApO1xuICAgIH1cbiAgfVxufVxuXG5cbmV4cG9ydCB7XG4gIE5TVXNlckRlZmF1bHRzLFxuICB0b1htbEFyZywgZ2VuZXJhdGVVcGRhdGVDb21tYW5kQXJncyxcbn07XG4iXSwiZmlsZSI6ImxpYi9kZWZhdWx0cy11dGlscy5qcyIsInNvdXJjZVJvb3QiOiIuLi8uLiJ9
