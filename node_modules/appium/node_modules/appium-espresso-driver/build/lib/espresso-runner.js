"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = exports.TEST_APK_PKG = exports.REQUIRED_PARAMS = exports.EspressoRunner = void 0;

require("source-map-support/register");

var _appiumBaseDriver = require("appium-base-driver");

var _asyncbox = require("asyncbox");

var _logger = _interopRequireDefault(require("./logger"));

var _serverBuilder = require("./server-builder");

var _path = _interopRequireDefault(require("path"));

var _appiumSupport = require("appium-support");

var _package = require("../../package.json");

var _bluebird = _interopRequireDefault(require("bluebird"));

var _lodash = _interopRequireDefault(require("lodash"));

var _utils = require("./utils");

var _axios = _interopRequireDefault(require("axios"));

const TEST_SERVER_ROOT = _path.default.resolve(__dirname, '..', '..', 'espresso-server');

const TEST_APK_PKG = 'io.appium.espressoserver.test';
exports.TEST_APK_PKG = TEST_APK_PKG;
const REQUIRED_PARAMS = ['adb', 'tmpDir', 'host', 'systemPort', 'devicePort', 'appPackage', 'forceEspressoRebuild'];
exports.REQUIRED_PARAMS = REQUIRED_PARAMS;
const ESPRESSO_SERVER_LAUNCH_TIMEOUT_MS = 45000;
const TARGET_PACKAGE_CONTAINER = '/data/local/tmp/espresso.apppackage';

class EspressoProxy extends _appiumBaseDriver.JWProxy {
  async proxyCommand(url, method, body = null) {
    const {
      crashed,
      exited
    } = this.instrumentationState;

    if (exited) {
      throw new _appiumBaseDriver.errors.InvalidContextError(`'${method} ${url}' cannot be proxied to Espresso server because ` + `the instrumentation process has ${crashed ? 'crashed' : 'been unexpectedly terminated'}. ` + `Check the Appium server log and the logcat output for more details`);
    }

    return await super.proxyCommand(url, method, body);
  }

}

class EspressoRunner {
  constructor(opts = {}) {
    for (let req of REQUIRED_PARAMS) {
      if (!opts || !_appiumSupport.util.hasValue(opts[req])) {
        throw new Error(`Option '${req}' is required!`);
      }

      this[req] = opts[req];
    }

    this.jwproxy = new EspressoProxy({
      server: this.host,
      port: this.systemPort,
      base: '',
      keepAlive: true
    });
    this.proxyReqRes = this.jwproxy.proxyReqRes.bind(this.jwproxy);
    this.jwproxy.instrumentationState = {
      exited: false,
      crashed: false
    };

    const modServerName = _appiumSupport.fs.sanitizeName(`${TEST_APK_PKG}_${_package.version}_${this.appPackage}_${this.adb.curDeviceId}.apk`, {
      replacement: '-'
    });

    this.modServerPath = _path.default.resolve(this.tmpDir, modServerName);
    this.showGradleLog = opts.showGradleLog;
    this.espressoBuildConfig = opts.espressoBuildConfig;
    this.serverLaunchTimeout = opts.serverLaunchTimeout || ESPRESSO_SERVER_LAUNCH_TIMEOUT_MS;
    this.androidInstallTimeout = opts.androidInstallTimeout;
    this.disableSuppressAccessibilityService = opts.disableSuppressAccessibilityService;

    if (opts.useKeystore && opts.keystorePath && opts.keystorePassword && opts.keyAlias && opts.keyPassword) {
      this.signingConfig = (0, _serverBuilder.buildServerSigningConfig)({
        keystoreFile: opts.keystorePath,
        keystorePassword: opts.keystorePassword,
        keyAlias: opts.keyAlias,
        keyPassword: opts.keyPassword
      });
    } else {
      this.signingConfig = null;
    }
  }

  async isAppPackageChanged() {
    if (!(await this.adb.fileExists(TARGET_PACKAGE_CONTAINER))) {
      _logger.default.debug('The previous target application package is unknown');

      return true;
    }

    const previousAppPackage = (await this.adb.shell(['cat', TARGET_PACKAGE_CONTAINER])).trim();

    _logger.default.debug(`The previous target application package was '${previousAppPackage}'. ` + `The current package is '${this.appPackage}'`);

    return previousAppPackage !== this.appPackage;
  }

  async installServer() {
    const appState = await this.adb.getApplicationInstallState(this.modServerPath, TEST_APK_PKG);
    const shouldUninstallApp = [this.adb.APP_INSTALL_STATE.OLDER_VERSION_INSTALLED, this.adb.APP_INSTALL_STATE.NEWER_VERSION_INSTALLED].includes(appState);
    const shouldInstallApp = shouldUninstallApp || [this.adb.APP_INSTALL_STATE.NOT_INSTALLED].includes(appState);

    if (shouldUninstallApp) {
      _logger.default.info(`Uninstalling Espresso Test Server apk from the target device (pkg: '${TEST_APK_PKG}')`);

      try {
        await this.adb.uninstallApk(TEST_APK_PKG);
      } catch (err) {
        _logger.default.warn(`Error uninstalling '${TEST_APK_PKG}': ${err.message}`);
      }
    }

    if (shouldInstallApp) {
      _logger.default.info(`Installing Espresso Test Server apk from the target device (path: '${this.modServerPath}')`);

      try {
        await this.adb.install(this.modServerPath, {
          replace: false,
          timeout: this.androidInstallTimeout
        });

        _logger.default.info(`Installed Espresso Test Server apk '${this.modServerPath}' (pkg: '${TEST_APK_PKG}')`);
      } catch (err) {
        _logger.default.errorAndThrow(`Cannot install '${this.modServerPath}' because of '${err.message}'`);
      }
    }
  }

  async installTestApk() {
    let rebuild = this.forceEspressoRebuild;

    if (rebuild) {
      _logger.default.debug(`'forceEspressoRebuild' capability is enabled`);
    } else if (await this.isAppPackageChanged()) {
      _logger.default.info(`Forcing Espresso server rebuild because of changed application package`);

      rebuild = true;
    }

    if (rebuild && (await _appiumSupport.fs.exists(this.modServerPath))) {
      _logger.default.debug(`Deleting the obsolete Espresso server package '${this.modServerPath}'`);

      await _appiumSupport.fs.unlink(this.modServerPath);
    }

    if (!(await _appiumSupport.fs.exists(this.modServerPath))) {
      await this.buildNewModServer();
    }

    const isSigned = await this.adb.checkApkCert(this.modServerPath, TEST_APK_PKG);

    if (!isSigned) {
      await this.adb.sign(this.modServerPath);
    }

    if ((rebuild || !isSigned) && (await this.adb.uninstallApk(TEST_APK_PKG))) {
      _logger.default.info('Uninstalled the obsolete Espresso server package from the device under test');
    }

    await this.installServer();
  }

  async buildNewModServer() {
    let buildConfiguration = {};

    if (this.espressoBuildConfig) {
      let buildConfigurationStr;

      if (await _appiumSupport.fs.exists(this.espressoBuildConfig)) {
        _logger.default.info(`Loading the build configuration from '${this.espressoBuildConfig}'`);

        buildConfigurationStr = await _appiumSupport.fs.readFile(this.espressoBuildConfig, 'utf8');
      } else {
        _logger.default.info(`Loading the build configuration from 'espressoBuildConfig' capability`);

        buildConfigurationStr = this.espressoBuildConfig;
      }

      try {
        buildConfiguration = JSON.parse(buildConfigurationStr);
      } catch (e) {
        _logger.default.error('Cannot parse the build configuration JSON', e);

        throw e;
      }
    }

    const dirName = _appiumSupport.fs.sanitizeName(`espresso-server-${this.adb.curDeviceId}`, {
      replacement: '-'
    });

    const serverPath = _path.default.resolve(this.tmpDir, dirName);

    _logger.default.info(`Building espresso server in '${serverPath}'`);

    _logger.default.debug(`The build folder root could be customized by changing the 'tmpDir' capability`);

    await _appiumSupport.fs.rimraf(serverPath);
    await (0, _appiumSupport.mkdirp)(serverPath);

    _logger.default.debug(`Copying espresso server template from ('${TEST_SERVER_ROOT}' to '${serverPath}')`);

    await (0, _utils.copyGradleProjectRecursively)(TEST_SERVER_ROOT, serverPath);

    _logger.default.debug('Bulding espresso server');

    await new _serverBuilder.ServerBuilder({
      serverPath,
      buildConfiguration,
      showGradleLog: this.showGradleLog,
      testAppPackage: this.appPackage,
      signingConfig: this.signingConfig
    }).build();

    const apkPath = _path.default.resolve(serverPath, 'app', 'build', 'outputs', 'apk', 'androidTest', 'debug', 'app-debug-androidTest.apk');

    _logger.default.debug(`Copying built apk from '${apkPath}' to '${this.modServerPath}'`);

    await _appiumSupport.fs.copyFile(apkPath, this.modServerPath);
  }

  async cleanupSessionLeftovers() {
    _logger.default.debug('Performing cleanup of automation leftovers');

    try {
      const {
        value
      } = (await (0, _axios.default)({
        url: `http://${this.host}:${this.systemPort}/sessions`,
        timeout: 500
      })).data;
      const activeSessionIds = value.map(sess => sess.id);

      if (activeSessionIds.length) {
        _logger.default.debug(`The following obsolete sessions are still running: ${JSON.stringify(activeSessionIds)}`);

        _logger.default.debug('Cleaning up the obsolete sessions');

        await _bluebird.default.all(activeSessionIds.map(id => (0, _axios.default)({
          url: `http://${this.host}:${this.systemPort}/session/${id}`,
          method: 'DELETE'
        })));
        await _bluebird.default.delay(1000);
      } else {
        _logger.default.debug('No obsolete sessions have been detected');
      }
    } catch (e) {
      _logger.default.debug(`No obsolete sessions have been detected (${e.message})`);
    }
  }

  async startSession(caps) {
    await this.cleanupSessionLeftovers();
    const cmd = ['shell', 'am', 'instrument', '-w', '-e', 'debug', process.env.ESPRESSO_JAVA_DEBUG === 'true'];

    if (_lodash.default.isBoolean(this.disableSuppressAccessibilityService)) {
      cmd.push('-e', 'DISABLE_SUPPRESS_ACCESSIBILITY_SERVICES', this.disableSuppressAccessibilityService);
    }

    cmd.push(`${TEST_APK_PKG}/androidx.test.runner.AndroidJUnitRunner`);

    _logger.default.info(`Starting Espresso Server v${_package.version} with cmd: adb ${cmd.join(' ')}`);

    let hasSocketError = false;
    this.instProcess = this.adb.createSubProcess(cmd);
    this.instProcess.on('exit', (code, signal) => {
      _logger.default.info(`Instrumentation process exited with code ${code} from signal ${signal}`);

      this.jwproxy.instrumentationState.exited = true;
    });
    this.instProcess.on('output', (stdout, stderr) => {
      const line = stdout || stderr;

      if (_lodash.default.isEmpty(line.trim())) {
        return;
      }

      _logger.default.debug(`[Instrumentation] ${line.trim()}`);

      if (line.toLowerCase().includes('java.net.socketexception')) {
        hasSocketError = true;
      } else if (line.includes('Process crashed')) {
        this.jwproxy.instrumentationState.crashed = true;
      }
    });
    const timer = new _appiumSupport.timing.Timer().start();
    await this.instProcess.start(0);

    _logger.default.info(`Waiting up to ${this.serverLaunchTimeout}ms for Espresso server to be online`);

    try {
      await (0, _asyncbox.waitForCondition)(async () => {
        if (hasSocketError) {
          _logger.default.errorAndThrow(`Espresso server has failed to start due to an unexpected exception. ` + `Make sure the 'INTERNET' permission is requested in the Android manifest of your ` + `application under test (<uses-permission android:name="android.permission.INTERNET" />)`);
        } else if (this.jwproxy.instrumentationState.exited) {
          _logger.default.errorAndThrow(`Espresso server process has been unexpectedly terminated. ` + `Check the Appium server log and the logcat output for more details`);
        }

        try {
          await this.jwproxy.command('/status', 'GET');
          return true;
        } catch (e) {
          return false;
        }
      }, {
        waitMs: this.serverLaunchTimeout,
        intervalMs: 500
      });
    } catch (e) {
      if (/Condition unmet/.test(e.message)) {
        _logger.default.errorAndThrow(`Timed out waiting for Espresso server to be ` + `online within ${this.serverLaunchTimeout}ms. The timeout value could be ` + `customized using 'espressoServerLaunchTimeout' capability`);
      }

      throw e;
    }

    _logger.default.info(`Espresso server is online. ` + `The initialization process took ${timer.getDuration().asMilliSeconds.toFixed(0)}ms`);

    _logger.default.info('Starting the session');

    await this.jwproxy.command('/session', 'POST', {
      capabilities: {
        firstMatch: [caps],
        alwaysMatch: {}
      }
    });
    await this.recordTargetAppPackage();
  }

  async recordTargetAppPackage() {
    await this.adb.shell([`echo "${this.appPackage}" > "${TARGET_PACKAGE_CONTAINER}"`]);

    _logger.default.info(`Recorded the target application package '${this.appPackage}' to ${TARGET_PACKAGE_CONTAINER}`);
  }

  async deleteSession() {
    _logger.default.debug('Deleting Espresso server session');

    try {
      await this.jwproxy.command('/', 'DELETE');
    } catch (err) {
      _logger.default.warn(`Did not get confirmation Espresso deleteSession worked; ` + `Error was: ${err}`);
    }

    if (this.instProcess && this.instProcess.isRunning) {
      await this.instProcess.stop();
    }
  }

}

exports.EspressoRunner = EspressoRunner;
var _default = EspressoRunner;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9lc3ByZXNzby1ydW5uZXIuanMiXSwibmFtZXMiOlsiVEVTVF9TRVJWRVJfUk9PVCIsInBhdGgiLCJyZXNvbHZlIiwiX19kaXJuYW1lIiwiVEVTVF9BUEtfUEtHIiwiUkVRVUlSRURfUEFSQU1TIiwiRVNQUkVTU09fU0VSVkVSX0xBVU5DSF9USU1FT1VUX01TIiwiVEFSR0VUX1BBQ0tBR0VfQ09OVEFJTkVSIiwiRXNwcmVzc29Qcm94eSIsIkpXUHJveHkiLCJwcm94eUNvbW1hbmQiLCJ1cmwiLCJtZXRob2QiLCJib2R5IiwiY3Jhc2hlZCIsImV4aXRlZCIsImluc3RydW1lbnRhdGlvblN0YXRlIiwiZXJyb3JzIiwiSW52YWxpZENvbnRleHRFcnJvciIsIkVzcHJlc3NvUnVubmVyIiwiY29uc3RydWN0b3IiLCJvcHRzIiwicmVxIiwidXRpbCIsImhhc1ZhbHVlIiwiRXJyb3IiLCJqd3Byb3h5Iiwic2VydmVyIiwiaG9zdCIsInBvcnQiLCJzeXN0ZW1Qb3J0IiwiYmFzZSIsImtlZXBBbGl2ZSIsInByb3h5UmVxUmVzIiwiYmluZCIsIm1vZFNlcnZlck5hbWUiLCJmcyIsInNhbml0aXplTmFtZSIsInZlcnNpb24iLCJhcHBQYWNrYWdlIiwiYWRiIiwiY3VyRGV2aWNlSWQiLCJyZXBsYWNlbWVudCIsIm1vZFNlcnZlclBhdGgiLCJ0bXBEaXIiLCJzaG93R3JhZGxlTG9nIiwiZXNwcmVzc29CdWlsZENvbmZpZyIsInNlcnZlckxhdW5jaFRpbWVvdXQiLCJhbmRyb2lkSW5zdGFsbFRpbWVvdXQiLCJkaXNhYmxlU3VwcHJlc3NBY2Nlc3NpYmlsaXR5U2VydmljZSIsInVzZUtleXN0b3JlIiwia2V5c3RvcmVQYXRoIiwia2V5c3RvcmVQYXNzd29yZCIsImtleUFsaWFzIiwia2V5UGFzc3dvcmQiLCJzaWduaW5nQ29uZmlnIiwia2V5c3RvcmVGaWxlIiwiaXNBcHBQYWNrYWdlQ2hhbmdlZCIsImZpbGVFeGlzdHMiLCJsb2dnZXIiLCJkZWJ1ZyIsInByZXZpb3VzQXBwUGFja2FnZSIsInNoZWxsIiwidHJpbSIsImluc3RhbGxTZXJ2ZXIiLCJhcHBTdGF0ZSIsImdldEFwcGxpY2F0aW9uSW5zdGFsbFN0YXRlIiwic2hvdWxkVW5pbnN0YWxsQXBwIiwiQVBQX0lOU1RBTExfU1RBVEUiLCJPTERFUl9WRVJTSU9OX0lOU1RBTExFRCIsIk5FV0VSX1ZFUlNJT05fSU5TVEFMTEVEIiwiaW5jbHVkZXMiLCJzaG91bGRJbnN0YWxsQXBwIiwiTk9UX0lOU1RBTExFRCIsImluZm8iLCJ1bmluc3RhbGxBcGsiLCJlcnIiLCJ3YXJuIiwibWVzc2FnZSIsImluc3RhbGwiLCJyZXBsYWNlIiwidGltZW91dCIsImVycm9yQW5kVGhyb3ciLCJpbnN0YWxsVGVzdEFwayIsInJlYnVpbGQiLCJmb3JjZUVzcHJlc3NvUmVidWlsZCIsImV4aXN0cyIsInVubGluayIsImJ1aWxkTmV3TW9kU2VydmVyIiwiaXNTaWduZWQiLCJjaGVja0Fwa0NlcnQiLCJzaWduIiwiYnVpbGRDb25maWd1cmF0aW9uIiwiYnVpbGRDb25maWd1cmF0aW9uU3RyIiwicmVhZEZpbGUiLCJKU09OIiwicGFyc2UiLCJlIiwiZXJyb3IiLCJkaXJOYW1lIiwic2VydmVyUGF0aCIsInJpbXJhZiIsIlNlcnZlckJ1aWxkZXIiLCJ0ZXN0QXBwUGFja2FnZSIsImJ1aWxkIiwiYXBrUGF0aCIsImNvcHlGaWxlIiwiY2xlYW51cFNlc3Npb25MZWZ0b3ZlcnMiLCJ2YWx1ZSIsImRhdGEiLCJhY3RpdmVTZXNzaW9uSWRzIiwibWFwIiwic2VzcyIsImlkIiwibGVuZ3RoIiwic3RyaW5naWZ5IiwiQiIsImFsbCIsImRlbGF5Iiwic3RhcnRTZXNzaW9uIiwiY2FwcyIsImNtZCIsInByb2Nlc3MiLCJlbnYiLCJFU1BSRVNTT19KQVZBX0RFQlVHIiwiXyIsImlzQm9vbGVhbiIsInB1c2giLCJqb2luIiwiaGFzU29ja2V0RXJyb3IiLCJpbnN0UHJvY2VzcyIsImNyZWF0ZVN1YlByb2Nlc3MiLCJvbiIsImNvZGUiLCJzaWduYWwiLCJzdGRvdXQiLCJzdGRlcnIiLCJsaW5lIiwiaXNFbXB0eSIsInRvTG93ZXJDYXNlIiwidGltZXIiLCJ0aW1pbmciLCJUaW1lciIsInN0YXJ0IiwiY29tbWFuZCIsIndhaXRNcyIsImludGVydmFsTXMiLCJ0ZXN0IiwiZ2V0RHVyYXRpb24iLCJhc01pbGxpU2Vjb25kcyIsInRvRml4ZWQiLCJjYXBhYmlsaXRpZXMiLCJmaXJzdE1hdGNoIiwiYWx3YXlzTWF0Y2giLCJyZWNvcmRUYXJnZXRBcHBQYWNrYWdlIiwiZGVsZXRlU2Vzc2lvbiIsImlzUnVubmluZyIsInN0b3AiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7O0FBQUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBR0EsTUFBTUEsZ0JBQWdCLEdBQUdDLGNBQUtDLE9BQUwsQ0FBYUMsU0FBYixFQUF3QixJQUF4QixFQUE4QixJQUE5QixFQUFvQyxpQkFBcEMsQ0FBekI7O0FBQ0EsTUFBTUMsWUFBWSxHQUFHLCtCQUFyQjs7QUFDQSxNQUFNQyxlQUFlLEdBQUcsQ0FDdEIsS0FEc0IsRUFFdEIsUUFGc0IsRUFHdEIsTUFIc0IsRUFJdEIsWUFKc0IsRUFLdEIsWUFMc0IsRUFNdEIsWUFOc0IsRUFPdEIsc0JBUHNCLENBQXhCOztBQVNBLE1BQU1DLGlDQUFpQyxHQUFHLEtBQTFDO0FBQ0EsTUFBTUMsd0JBQXdCLEdBQUcscUNBQWpDOztBQUVBLE1BQU1DLGFBQU4sU0FBNEJDLHlCQUE1QixDQUFvQztBQUNsQyxRQUFNQyxZQUFOLENBQW9CQyxHQUFwQixFQUF5QkMsTUFBekIsRUFBaUNDLElBQUksR0FBRyxJQUF4QyxFQUE4QztBQUM1QyxVQUFNO0FBQUNDLE1BQUFBLE9BQUQ7QUFBVUMsTUFBQUE7QUFBVixRQUFvQixLQUFLQyxvQkFBL0I7O0FBQ0EsUUFBSUQsTUFBSixFQUFZO0FBQ1YsWUFBTSxJQUFJRSx5QkFBT0MsbUJBQVgsQ0FBZ0MsSUFBR04sTUFBTyxJQUFHRCxHQUFJLGlEQUFsQixHQUNsQyxtQ0FBa0NHLE9BQU8sR0FBRyxTQUFILEdBQWUsOEJBQStCLElBRHJELEdBRWxDLG9FQUZHLENBQU47QUFHRDs7QUFDRCxXQUFPLE1BQU0sTUFBTUosWUFBTixDQUFtQkMsR0FBbkIsRUFBd0JDLE1BQXhCLEVBQWdDQyxJQUFoQyxDQUFiO0FBQ0Q7O0FBVGlDOztBQVlwQyxNQUFNTSxjQUFOLENBQXFCO0FBQ25CQyxFQUFBQSxXQUFXLENBQUVDLElBQUksR0FBRyxFQUFULEVBQWE7QUFDdEIsU0FBSyxJQUFJQyxHQUFULElBQWdCakIsZUFBaEIsRUFBaUM7QUFDL0IsVUFBSSxDQUFDZ0IsSUFBRCxJQUFTLENBQUNFLG9CQUFLQyxRQUFMLENBQWNILElBQUksQ0FBQ0MsR0FBRCxDQUFsQixDQUFkLEVBQXdDO0FBQ3RDLGNBQU0sSUFBSUcsS0FBSixDQUFXLFdBQVVILEdBQUksZ0JBQXpCLENBQU47QUFDRDs7QUFDRCxXQUFLQSxHQUFMLElBQVlELElBQUksQ0FBQ0MsR0FBRCxDQUFoQjtBQUNEOztBQUNELFNBQUtJLE9BQUwsR0FBZSxJQUFJbEIsYUFBSixDQUFrQjtBQUMvQm1CLE1BQUFBLE1BQU0sRUFBRSxLQUFLQyxJQURrQjtBQUUvQkMsTUFBQUEsSUFBSSxFQUFFLEtBQUtDLFVBRm9CO0FBRy9CQyxNQUFBQSxJQUFJLEVBQUUsRUFIeUI7QUFJL0JDLE1BQUFBLFNBQVMsRUFBRTtBQUpvQixLQUFsQixDQUFmO0FBTUEsU0FBS0MsV0FBTCxHQUFtQixLQUFLUCxPQUFMLENBQWFPLFdBQWIsQ0FBeUJDLElBQXpCLENBQThCLEtBQUtSLE9BQW5DLENBQW5CO0FBQ0EsU0FBS0EsT0FBTCxDQUFhVixvQkFBYixHQUFvQztBQUNsQ0QsTUFBQUEsTUFBTSxFQUFFLEtBRDBCO0FBRWxDRCxNQUFBQSxPQUFPLEVBQUU7QUFGeUIsS0FBcEM7O0FBS0EsVUFBTXFCLGFBQWEsR0FBR0Msa0JBQUdDLFlBQUgsQ0FBaUIsR0FBRWpDLFlBQWEsSUFBR2tDLGdCQUFRLElBQUcsS0FBS0MsVUFBVyxJQUFHLEtBQUtDLEdBQUwsQ0FBU0MsV0FBWSxNQUF0RixFQUE2RjtBQUNqSEMsTUFBQUEsV0FBVyxFQUFFO0FBRG9HLEtBQTdGLENBQXRCOztBQUdBLFNBQUtDLGFBQUwsR0FBcUIxQyxjQUFLQyxPQUFMLENBQWEsS0FBSzBDLE1BQWxCLEVBQTBCVCxhQUExQixDQUFyQjtBQUNBLFNBQUtVLGFBQUwsR0FBcUJ4QixJQUFJLENBQUN3QixhQUExQjtBQUNBLFNBQUtDLG1CQUFMLEdBQTJCekIsSUFBSSxDQUFDeUIsbUJBQWhDO0FBRUEsU0FBS0MsbUJBQUwsR0FBMkIxQixJQUFJLENBQUMwQixtQkFBTCxJQUE0QnpDLGlDQUF2RDtBQUNBLFNBQUswQyxxQkFBTCxHQUE2QjNCLElBQUksQ0FBQzJCLHFCQUFsQztBQUVBLFNBQUtDLG1DQUFMLEdBQTJDNUIsSUFBSSxDQUFDNEIsbUNBQWhEOztBQUdBLFFBQUk1QixJQUFJLENBQUM2QixXQUFMLElBQW9CN0IsSUFBSSxDQUFDOEIsWUFBekIsSUFBeUM5QixJQUFJLENBQUMrQixnQkFBOUMsSUFBa0UvQixJQUFJLENBQUNnQyxRQUF2RSxJQUFtRmhDLElBQUksQ0FBQ2lDLFdBQTVGLEVBQXlHO0FBQ3ZHLFdBQUtDLGFBQUwsR0FBcUIsNkNBQXlCO0FBQzVDQyxRQUFBQSxZQUFZLEVBQUVuQyxJQUFJLENBQUM4QixZQUR5QjtBQUU1Q0MsUUFBQUEsZ0JBQWdCLEVBQUUvQixJQUFJLENBQUMrQixnQkFGcUI7QUFHNUNDLFFBQUFBLFFBQVEsRUFBRWhDLElBQUksQ0FBQ2dDLFFBSDZCO0FBSTVDQyxRQUFBQSxXQUFXLEVBQUVqQyxJQUFJLENBQUNpQztBQUowQixPQUF6QixDQUFyQjtBQU1ELEtBUEQsTUFPTztBQUNMLFdBQUtDLGFBQUwsR0FBcUIsSUFBckI7QUFDRDtBQUNGOztBQUVELFFBQU1FLG1CQUFOLEdBQTZCO0FBQzNCLFFBQUksRUFBQyxNQUFNLEtBQUtqQixHQUFMLENBQVNrQixVQUFULENBQW9CbkQsd0JBQXBCLENBQVAsQ0FBSixFQUEwRDtBQUN4RG9ELHNCQUFPQyxLQUFQLENBQWEsb0RBQWI7O0FBQ0EsYUFBTyxJQUFQO0FBQ0Q7O0FBQ0QsVUFBTUMsa0JBQWtCLEdBQUcsQ0FBQyxNQUFNLEtBQUtyQixHQUFMLENBQVNzQixLQUFULENBQWUsQ0FBQyxLQUFELEVBQVF2RCx3QkFBUixDQUFmLENBQVAsRUFBMER3RCxJQUExRCxFQUEzQjs7QUFDQUosb0JBQU9DLEtBQVAsQ0FBYyxnREFBK0NDLGtCQUFtQixLQUFuRSxHQUNWLDJCQUEwQixLQUFLdEIsVUFBVyxHQUQ3Qzs7QUFFQSxXQUFPc0Isa0JBQWtCLEtBQUssS0FBS3RCLFVBQW5DO0FBQ0Q7O0FBTUQsUUFBTXlCLGFBQU4sR0FBdUI7QUFDckIsVUFBTUMsUUFBUSxHQUFHLE1BQU0sS0FBS3pCLEdBQUwsQ0FBUzBCLDBCQUFULENBQW9DLEtBQUt2QixhQUF6QyxFQUF3RHZDLFlBQXhELENBQXZCO0FBRUEsVUFBTStELGtCQUFrQixHQUFHLENBQ3pCLEtBQUszQixHQUFMLENBQVM0QixpQkFBVCxDQUEyQkMsdUJBREYsRUFFekIsS0FBSzdCLEdBQUwsQ0FBUzRCLGlCQUFULENBQTJCRSx1QkFGRixFQUd6QkMsUUFIeUIsQ0FHaEJOLFFBSGdCLENBQTNCO0FBSUEsVUFBTU8sZ0JBQWdCLEdBQUdMLGtCQUFrQixJQUFJLENBQzdDLEtBQUszQixHQUFMLENBQVM0QixpQkFBVCxDQUEyQkssYUFEa0IsRUFFN0NGLFFBRjZDLENBRXBDTixRQUZvQyxDQUEvQzs7QUFJQSxRQUFJRSxrQkFBSixFQUF3QjtBQUN0QlIsc0JBQU9lLElBQVAsQ0FBYSx1RUFBc0V0RSxZQUFhLElBQWhHOztBQUNBLFVBQUk7QUFDRixjQUFNLEtBQUtvQyxHQUFMLENBQVNtQyxZQUFULENBQXNCdkUsWUFBdEIsQ0FBTjtBQUNELE9BRkQsQ0FFRSxPQUFPd0UsR0FBUCxFQUFZO0FBQ1pqQix3QkFBT2tCLElBQVAsQ0FBYSx1QkFBc0J6RSxZQUFhLE1BQUt3RSxHQUFHLENBQUNFLE9BQVEsRUFBakU7QUFDRDtBQUNGOztBQUVELFFBQUlOLGdCQUFKLEVBQXNCO0FBQ3BCYixzQkFBT2UsSUFBUCxDQUFhLHNFQUFxRSxLQUFLL0IsYUFBYyxJQUFyRzs7QUFDQSxVQUFJO0FBQ0YsY0FBTSxLQUFLSCxHQUFMLENBQVN1QyxPQUFULENBQWlCLEtBQUtwQyxhQUF0QixFQUFxQztBQUFFcUMsVUFBQUEsT0FBTyxFQUFFLEtBQVg7QUFBa0JDLFVBQUFBLE9BQU8sRUFBRSxLQUFLakM7QUFBaEMsU0FBckMsQ0FBTjs7QUFDQVcsd0JBQU9lLElBQVAsQ0FBYSx1Q0FBc0MsS0FBSy9CLGFBQWMsWUFBV3ZDLFlBQWEsSUFBOUY7QUFDRCxPQUhELENBR0UsT0FBT3dFLEdBQVAsRUFBWTtBQUNaakIsd0JBQU91QixhQUFQLENBQXNCLG1CQUFrQixLQUFLdkMsYUFBYyxpQkFBZ0JpQyxHQUFHLENBQUNFLE9BQVEsR0FBdkY7QUFDRDtBQUNGO0FBQ0Y7O0FBRUQsUUFBTUssY0FBTixHQUF3QjtBQUN0QixRQUFJQyxPQUFPLEdBQUcsS0FBS0Msb0JBQW5COztBQUNBLFFBQUlELE9BQUosRUFBYTtBQUNYekIsc0JBQU9DLEtBQVAsQ0FBYyw4Q0FBZDtBQUNELEtBRkQsTUFFTyxJQUFJLE1BQU0sS0FBS0gsbUJBQUwsRUFBVixFQUFzQztBQUMzQ0Usc0JBQU9lLElBQVAsQ0FBYSx3RUFBYjs7QUFDQVUsTUFBQUEsT0FBTyxHQUFHLElBQVY7QUFDRDs7QUFFRCxRQUFJQSxPQUFPLEtBQUksTUFBTWhELGtCQUFHa0QsTUFBSCxDQUFVLEtBQUszQyxhQUFmLENBQVYsQ0FBWCxFQUFvRDtBQUNsRGdCLHNCQUFPQyxLQUFQLENBQWMsa0RBQWlELEtBQUtqQixhQUFjLEdBQWxGOztBQUNBLFlBQU1QLGtCQUFHbUQsTUFBSCxDQUFVLEtBQUs1QyxhQUFmLENBQU47QUFDRDs7QUFDRCxRQUFJLEVBQUUsTUFBTVAsa0JBQUdrRCxNQUFILENBQVUsS0FBSzNDLGFBQWYsQ0FBUixDQUFKLEVBQTRDO0FBQzFDLFlBQU0sS0FBSzZDLGlCQUFMLEVBQU47QUFDRDs7QUFDRCxVQUFNQyxRQUFRLEdBQUcsTUFBTSxLQUFLakQsR0FBTCxDQUFTa0QsWUFBVCxDQUFzQixLQUFLL0MsYUFBM0IsRUFBMEN2QyxZQUExQyxDQUF2Qjs7QUFDQSxRQUFJLENBQUNxRixRQUFMLEVBQWU7QUFDYixZQUFNLEtBQUtqRCxHQUFMLENBQVNtRCxJQUFULENBQWMsS0FBS2hELGFBQW5CLENBQU47QUFDRDs7QUFDRCxRQUFJLENBQUN5QyxPQUFPLElBQUksQ0FBQ0ssUUFBYixNQUEwQixNQUFNLEtBQUtqRCxHQUFMLENBQVNtQyxZQUFULENBQXNCdkUsWUFBdEIsQ0FBaEMsQ0FBSixFQUF5RTtBQUN2RXVELHNCQUFPZSxJQUFQLENBQVksNkVBQVo7QUFDRDs7QUFFRCxVQUFNLEtBQUtWLGFBQUwsRUFBTjtBQUNEOztBQUVELFFBQU13QixpQkFBTixHQUEyQjtBQUN6QixRQUFJSSxrQkFBa0IsR0FBRyxFQUF6Qjs7QUFDQSxRQUFJLEtBQUs5QyxtQkFBVCxFQUE4QjtBQUM1QixVQUFJK0MscUJBQUo7O0FBQ0EsVUFBSSxNQUFNekQsa0JBQUdrRCxNQUFILENBQVUsS0FBS3hDLG1CQUFmLENBQVYsRUFBK0M7QUFDN0NhLHdCQUFPZSxJQUFQLENBQWEseUNBQXdDLEtBQUs1QixtQkFBb0IsR0FBOUU7O0FBQ0ErQyxRQUFBQSxxQkFBcUIsR0FBRyxNQUFNekQsa0JBQUcwRCxRQUFILENBQVksS0FBS2hELG1CQUFqQixFQUFzQyxNQUF0QyxDQUE5QjtBQUNELE9BSEQsTUFHTztBQUNMYSx3QkFBT2UsSUFBUCxDQUFhLHVFQUFiOztBQUNBbUIsUUFBQUEscUJBQXFCLEdBQUcsS0FBSy9DLG1CQUE3QjtBQUNEOztBQUNELFVBQUk7QUFDRjhDLFFBQUFBLGtCQUFrQixHQUFHRyxJQUFJLENBQUNDLEtBQUwsQ0FBV0gscUJBQVgsQ0FBckI7QUFDRCxPQUZELENBRUUsT0FBT0ksQ0FBUCxFQUFVO0FBQ1Z0Qyx3QkFBT3VDLEtBQVAsQ0FBYSwyQ0FBYixFQUEwREQsQ0FBMUQ7O0FBQ0EsY0FBTUEsQ0FBTjtBQUNEO0FBQ0Y7O0FBQ0QsVUFBTUUsT0FBTyxHQUFHL0Qsa0JBQUdDLFlBQUgsQ0FBaUIsbUJBQWtCLEtBQUtHLEdBQUwsQ0FBU0MsV0FBWSxFQUF4RCxFQUEyRDtBQUN6RUMsTUFBQUEsV0FBVyxFQUFFO0FBRDRELEtBQTNELENBQWhCOztBQUdBLFVBQU0wRCxVQUFVLEdBQUduRyxjQUFLQyxPQUFMLENBQWEsS0FBSzBDLE1BQWxCLEVBQTBCdUQsT0FBMUIsQ0FBbkI7O0FBQ0F4QyxvQkFBT2UsSUFBUCxDQUFhLGdDQUErQjBCLFVBQVcsR0FBdkQ7O0FBQ0F6QyxvQkFBT0MsS0FBUCxDQUFjLCtFQUFkOztBQUNBLFVBQU14QixrQkFBR2lFLE1BQUgsQ0FBVUQsVUFBVixDQUFOO0FBQ0EsVUFBTSwyQkFBT0EsVUFBUCxDQUFOOztBQUNBekMsb0JBQU9DLEtBQVAsQ0FBYywyQ0FBMEM1RCxnQkFBaUIsU0FBUW9HLFVBQVcsSUFBNUY7O0FBQ0EsVUFBTSx5Q0FBNkJwRyxnQkFBN0IsRUFBK0NvRyxVQUEvQyxDQUFOOztBQUNBekMsb0JBQU9DLEtBQVAsQ0FBYSx5QkFBYjs7QUFDQSxVQUFNLElBQUkwQyw0QkFBSixDQUFrQjtBQUN0QkYsTUFBQUEsVUFEc0I7QUFDVlIsTUFBQUEsa0JBRFU7QUFFdEIvQyxNQUFBQSxhQUFhLEVBQUUsS0FBS0EsYUFGRTtBQUd0QjBELE1BQUFBLGNBQWMsRUFBRSxLQUFLaEUsVUFIQztBQUl0QmdCLE1BQUFBLGFBQWEsRUFBRSxLQUFLQTtBQUpFLEtBQWxCLEVBS0hpRCxLQUxHLEVBQU47O0FBTUEsVUFBTUMsT0FBTyxHQUFHeEcsY0FBS0MsT0FBTCxDQUFha0csVUFBYixFQUF5QixLQUF6QixFQUFnQyxPQUFoQyxFQUF5QyxTQUF6QyxFQUFvRCxLQUFwRCxFQUEyRCxhQUEzRCxFQUEwRSxPQUExRSxFQUFtRiwyQkFBbkYsQ0FBaEI7O0FBQ0F6QyxvQkFBT0MsS0FBUCxDQUFjLDJCQUEwQjZDLE9BQVEsU0FBUSxLQUFLOUQsYUFBYyxHQUEzRTs7QUFDQSxVQUFNUCxrQkFBR3NFLFFBQUgsQ0FBWUQsT0FBWixFQUFxQixLQUFLOUQsYUFBMUIsQ0FBTjtBQUNEOztBQUVELFFBQU1nRSx1QkFBTixHQUFpQztBQUMvQmhELG9CQUFPQyxLQUFQLENBQWEsNENBQWI7O0FBRUEsUUFBSTtBQUNGLFlBQU07QUFBQ2dELFFBQUFBO0FBQUQsVUFBVSxDQUFDLE1BQU0sb0JBQU07QUFDM0JqRyxRQUFBQSxHQUFHLEVBQUcsVUFBUyxLQUFLaUIsSUFBSyxJQUFHLEtBQUtFLFVBQVcsV0FEakI7QUFFM0JtRCxRQUFBQSxPQUFPLEVBQUU7QUFGa0IsT0FBTixDQUFQLEVBR1o0QixJQUhKO0FBSUEsWUFBTUMsZ0JBQWdCLEdBQUdGLEtBQUssQ0FBQ0csR0FBTixDQUFXQyxJQUFELElBQVVBLElBQUksQ0FBQ0MsRUFBekIsQ0FBekI7O0FBQ0EsVUFBSUgsZ0JBQWdCLENBQUNJLE1BQXJCLEVBQTZCO0FBQzNCdkQsd0JBQU9DLEtBQVAsQ0FBYyxzREFBcURtQyxJQUFJLENBQUNvQixTQUFMLENBQWVMLGdCQUFmLENBQWlDLEVBQXBHOztBQUNBbkQsd0JBQU9DLEtBQVAsQ0FBYSxtQ0FBYjs7QUFDQSxjQUFNd0Qsa0JBQUVDLEdBQUYsQ0FBTVAsZ0JBQWdCLENBQUNDLEdBQWpCLENBQXNCRSxFQUFELElBQy9CLG9CQUFNO0FBQ0p0RyxVQUFBQSxHQUFHLEVBQUcsVUFBUyxLQUFLaUIsSUFBSyxJQUFHLEtBQUtFLFVBQVcsWUFBV21GLEVBQUcsRUFEdEQ7QUFFSnJHLFVBQUFBLE1BQU0sRUFBRTtBQUZKLFNBQU4sQ0FEVSxDQUFOLENBQU47QUFPQSxjQUFNd0csa0JBQUVFLEtBQUYsQ0FBUSxJQUFSLENBQU47QUFDRCxPQVhELE1BV087QUFDTDNELHdCQUFPQyxLQUFQLENBQWEseUNBQWI7QUFDRDtBQUNGLEtBcEJELENBb0JFLE9BQU9xQyxDQUFQLEVBQVU7QUFDVnRDLHNCQUFPQyxLQUFQLENBQWMsNENBQTJDcUMsQ0FBQyxDQUFDbkIsT0FBUSxHQUFuRTtBQUNEO0FBQ0Y7O0FBRUQsUUFBTXlDLFlBQU4sQ0FBb0JDLElBQXBCLEVBQTBCO0FBQ3hCLFVBQU0sS0FBS2IsdUJBQUwsRUFBTjtBQUVBLFVBQU1jLEdBQUcsR0FBRyxDQUNWLE9BRFUsRUFFVixJQUZVLEVBRUosWUFGSSxFQUdWLElBSFUsRUFJVixJQUpVLEVBSUosT0FKSSxFQUlLQyxPQUFPLENBQUNDLEdBQVIsQ0FBWUMsbUJBQVosS0FBb0MsTUFKekMsQ0FBWjs7QUFPQSxRQUFJQyxnQkFBRUMsU0FBRixDQUFZLEtBQUs3RSxtQ0FBakIsQ0FBSixFQUEyRDtBQUN6RHdFLE1BQUFBLEdBQUcsQ0FBQ00sSUFBSixDQUFTLElBQVQsRUFBZSx5Q0FBZixFQUEwRCxLQUFLOUUsbUNBQS9EO0FBQ0Q7O0FBRUR3RSxJQUFBQSxHQUFHLENBQUNNLElBQUosQ0FBVSxHQUFFM0gsWUFBYSwwQ0FBekI7O0FBRUF1RCxvQkFBT2UsSUFBUCxDQUFhLDZCQUE0QnBDLGdCQUFRLGtCQUFpQm1GLEdBQUcsQ0FBQ08sSUFBSixDQUFTLEdBQVQsQ0FBYyxFQUFoRjs7QUFFQSxRQUFJQyxjQUFjLEdBQUcsS0FBckI7QUFFQSxTQUFLQyxXQUFMLEdBQW1CLEtBQUsxRixHQUFMLENBQVMyRixnQkFBVCxDQUEwQlYsR0FBMUIsQ0FBbkI7QUFDQSxTQUFLUyxXQUFMLENBQWlCRSxFQUFqQixDQUFvQixNQUFwQixFQUE0QixDQUFDQyxJQUFELEVBQU9DLE1BQVAsS0FBa0I7QUFDNUMzRSxzQkFBT2UsSUFBUCxDQUFhLDRDQUEyQzJELElBQUssZ0JBQWVDLE1BQU8sRUFBbkY7O0FBQ0EsV0FBSzVHLE9BQUwsQ0FBYVYsb0JBQWIsQ0FBa0NELE1BQWxDLEdBQTJDLElBQTNDO0FBQ0QsS0FIRDtBQUlBLFNBQUttSCxXQUFMLENBQWlCRSxFQUFqQixDQUFvQixRQUFwQixFQUE4QixDQUFDRyxNQUFELEVBQVNDLE1BQVQsS0FBb0I7QUFDaEQsWUFBTUMsSUFBSSxHQUFHRixNQUFNLElBQUlDLE1BQXZCOztBQUNBLFVBQUlYLGdCQUFFYSxPQUFGLENBQVVELElBQUksQ0FBQzFFLElBQUwsRUFBVixDQUFKLEVBQTRCO0FBRTFCO0FBQ0Q7O0FBRURKLHNCQUFPQyxLQUFQLENBQWMscUJBQW9CNkUsSUFBSSxDQUFDMUUsSUFBTCxFQUFZLEVBQTlDOztBQUdBLFVBQUkwRSxJQUFJLENBQUNFLFdBQUwsR0FBbUJwRSxRQUFuQixDQUE0QiwwQkFBNUIsQ0FBSixFQUE2RDtBQUMzRDBELFFBQUFBLGNBQWMsR0FBRyxJQUFqQjtBQUNELE9BRkQsTUFFTyxJQUFJUSxJQUFJLENBQUNsRSxRQUFMLENBQWMsaUJBQWQsQ0FBSixFQUFzQztBQUMzQyxhQUFLN0MsT0FBTCxDQUFhVixvQkFBYixDQUFrQ0YsT0FBbEMsR0FBNEMsSUFBNUM7QUFDRDtBQUNGLEtBZkQ7QUFpQkEsVUFBTThILEtBQUssR0FBRyxJQUFJQyxzQkFBT0MsS0FBWCxHQUFtQkMsS0FBbkIsRUFBZDtBQUNBLFVBQU0sS0FBS2IsV0FBTCxDQUFpQmEsS0FBakIsQ0FBdUIsQ0FBdkIsQ0FBTjs7QUFDQXBGLG9CQUFPZSxJQUFQLENBQWEsaUJBQWdCLEtBQUszQixtQkFBb0IscUNBQXREOztBQUNBLFFBQUk7QUFDRixZQUFNLGdDQUFpQixZQUFZO0FBQ2pDLFlBQUlrRixjQUFKLEVBQW9CO0FBQ2xCdEUsMEJBQU91QixhQUFQLENBQXNCLHNFQUFELEdBQ2xCLG1GQURrQixHQUVsQix5RkFGSDtBQUdELFNBSkQsTUFJTyxJQUFJLEtBQUt4RCxPQUFMLENBQWFWLG9CQUFiLENBQWtDRCxNQUF0QyxFQUE4QztBQUNuRDRDLDBCQUFPdUIsYUFBUCxDQUFzQiw0REFBRCxHQUNsQixvRUFESDtBQUVEOztBQUNELFlBQUk7QUFDRixnQkFBTSxLQUFLeEQsT0FBTCxDQUFhc0gsT0FBYixDQUFxQixTQUFyQixFQUFnQyxLQUFoQyxDQUFOO0FBQ0EsaUJBQU8sSUFBUDtBQUNELFNBSEQsQ0FHRSxPQUFPL0MsQ0FBUCxFQUFVO0FBQ1YsaUJBQU8sS0FBUDtBQUNEO0FBQ0YsT0FmSyxFQWVIO0FBQ0RnRCxRQUFBQSxNQUFNLEVBQUUsS0FBS2xHLG1CQURaO0FBRURtRyxRQUFBQSxVQUFVLEVBQUU7QUFGWCxPQWZHLENBQU47QUFtQkQsS0FwQkQsQ0FvQkUsT0FBT2pELENBQVAsRUFBVTtBQUNWLFVBQUksa0JBQWtCa0QsSUFBbEIsQ0FBdUJsRCxDQUFDLENBQUNuQixPQUF6QixDQUFKLEVBQXVDO0FBQ3JDbkIsd0JBQU91QixhQUFQLENBQXNCLDhDQUFELEdBQ2xCLGlCQUFnQixLQUFLbkMsbUJBQW9CLGlDQUR2QixHQUVsQiwyREFGSDtBQUdEOztBQUNELFlBQU1rRCxDQUFOO0FBQ0Q7O0FBQ0R0QyxvQkFBT2UsSUFBUCxDQUFhLDZCQUFELEdBQ1QsbUNBQWtDa0UsS0FBSyxDQUFDUSxXQUFOLEdBQW9CQyxjQUFwQixDQUFtQ0MsT0FBbkMsQ0FBMkMsQ0FBM0MsQ0FBOEMsSUFEbkY7O0FBRUEzRixvQkFBT2UsSUFBUCxDQUFZLHNCQUFaOztBQUVBLFVBQU0sS0FBS2hELE9BQUwsQ0FBYXNILE9BQWIsQ0FBcUIsVUFBckIsRUFBaUMsTUFBakMsRUFBeUM7QUFDN0NPLE1BQUFBLFlBQVksRUFBRTtBQUNaQyxRQUFBQSxVQUFVLEVBQUUsQ0FBQ2hDLElBQUQsQ0FEQTtBQUVaaUMsUUFBQUEsV0FBVyxFQUFFO0FBRkQ7QUFEK0IsS0FBekMsQ0FBTjtBQU1BLFVBQU0sS0FBS0Msc0JBQUwsRUFBTjtBQUNEOztBQUVELFFBQU1BLHNCQUFOLEdBQWdDO0FBQzlCLFVBQU0sS0FBS2xILEdBQUwsQ0FBU3NCLEtBQVQsQ0FBZSxDQUFFLFNBQVEsS0FBS3ZCLFVBQVcsUUFBT2hDLHdCQUF5QixHQUExRCxDQUFmLENBQU47O0FBQ0FvRCxvQkFBT2UsSUFBUCxDQUFhLDRDQUEyQyxLQUFLbkMsVUFBVyxRQUFPaEMsd0JBQXlCLEVBQXhHO0FBQ0Q7O0FBRUQsUUFBTW9KLGFBQU4sR0FBdUI7QUFDckJoRyxvQkFBT0MsS0FBUCxDQUFhLGtDQUFiOztBQUdBLFFBQUk7QUFDRixZQUFNLEtBQUtsQyxPQUFMLENBQWFzSCxPQUFiLENBQXFCLEdBQXJCLEVBQTBCLFFBQTFCLENBQU47QUFDRCxLQUZELENBRUUsT0FBT3BFLEdBQVAsRUFBWTtBQUNaakIsc0JBQU9rQixJQUFQLENBQWEsMERBQUQsR0FDUCxjQUFhRCxHQUFJLEVBRHRCO0FBRUQ7O0FBRUQsUUFBSSxLQUFLc0QsV0FBTCxJQUFvQixLQUFLQSxXQUFMLENBQWlCMEIsU0FBekMsRUFBb0Q7QUFDbEQsWUFBTSxLQUFLMUIsV0FBTCxDQUFpQjJCLElBQWpCLEVBQU47QUFDRDtBQUNGOztBQW5Ta0I7OztlQXVTTjFJLGMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBKV1Byb3h5LCBlcnJvcnMgfSBmcm9tICdhcHBpdW0tYmFzZS1kcml2ZXInO1xuaW1wb3J0IHsgd2FpdEZvckNvbmRpdGlvbiB9IGZyb20gJ2FzeW5jYm94JztcbmltcG9ydCBsb2dnZXIgZnJvbSAnLi9sb2dnZXInO1xuaW1wb3J0IHsgU2VydmVyQnVpbGRlciwgYnVpbGRTZXJ2ZXJTaWduaW5nQ29uZmlnIH0gZnJvbSAnLi9zZXJ2ZXItYnVpbGRlcic7XG5pbXBvcnQgcGF0aCBmcm9tICdwYXRoJztcbmltcG9ydCB7IGZzLCB1dGlsLCBta2RpcnAsIHRpbWluZyB9IGZyb20gJ2FwcGl1bS1zdXBwb3J0JztcbmltcG9ydCB7IHZlcnNpb24gfSBmcm9tICcuLi8uLi9wYWNrYWdlLmpzb24nOyAvLyBlc2xpbnQtZGlzYWJsZS1saW5lIGltcG9ydC9uby11bnJlc29sdmVkXG5pbXBvcnQgQiBmcm9tICdibHVlYmlyZCc7XG5pbXBvcnQgXyBmcm9tICdsb2Rhc2gnO1xuaW1wb3J0IHsgY29weUdyYWRsZVByb2plY3RSZWN1cnNpdmVseSB9IGZyb20gJy4vdXRpbHMnO1xuaW1wb3J0IGF4aW9zIGZyb20gJ2F4aW9zJztcblxuXG5jb25zdCBURVNUX1NFUlZFUl9ST09UID0gcGF0aC5yZXNvbHZlKF9fZGlybmFtZSwgJy4uJywgJy4uJywgJ2VzcHJlc3NvLXNlcnZlcicpO1xuY29uc3QgVEVTVF9BUEtfUEtHID0gJ2lvLmFwcGl1bS5lc3ByZXNzb3NlcnZlci50ZXN0JztcbmNvbnN0IFJFUVVJUkVEX1BBUkFNUyA9IFtcbiAgJ2FkYicsXG4gICd0bXBEaXInLFxuICAnaG9zdCcsXG4gICdzeXN0ZW1Qb3J0JyxcbiAgJ2RldmljZVBvcnQnLFxuICAnYXBwUGFja2FnZScsXG4gICdmb3JjZUVzcHJlc3NvUmVidWlsZCcsXG5dO1xuY29uc3QgRVNQUkVTU09fU0VSVkVSX0xBVU5DSF9USU1FT1VUX01TID0gNDUwMDA7XG5jb25zdCBUQVJHRVRfUEFDS0FHRV9DT05UQUlORVIgPSAnL2RhdGEvbG9jYWwvdG1wL2VzcHJlc3NvLmFwcHBhY2thZ2UnO1xuXG5jbGFzcyBFc3ByZXNzb1Byb3h5IGV4dGVuZHMgSldQcm94eSB7XG4gIGFzeW5jIHByb3h5Q29tbWFuZCAodXJsLCBtZXRob2QsIGJvZHkgPSBudWxsKSB7XG4gICAgY29uc3Qge2NyYXNoZWQsIGV4aXRlZH0gPSB0aGlzLmluc3RydW1lbnRhdGlvblN0YXRlO1xuICAgIGlmIChleGl0ZWQpIHtcbiAgICAgIHRocm93IG5ldyBlcnJvcnMuSW52YWxpZENvbnRleHRFcnJvcihgJyR7bWV0aG9kfSAke3VybH0nIGNhbm5vdCBiZSBwcm94aWVkIHRvIEVzcHJlc3NvIHNlcnZlciBiZWNhdXNlIGAgK1xuICAgICAgICBgdGhlIGluc3RydW1lbnRhdGlvbiBwcm9jZXNzIGhhcyAke2NyYXNoZWQgPyAnY3Jhc2hlZCcgOiAnYmVlbiB1bmV4cGVjdGVkbHkgdGVybWluYXRlZCd9LiBgICtcbiAgICAgICAgYENoZWNrIHRoZSBBcHBpdW0gc2VydmVyIGxvZyBhbmQgdGhlIGxvZ2NhdCBvdXRwdXQgZm9yIG1vcmUgZGV0YWlsc2ApO1xuICAgIH1cbiAgICByZXR1cm4gYXdhaXQgc3VwZXIucHJveHlDb21tYW5kKHVybCwgbWV0aG9kLCBib2R5KTtcbiAgfVxufVxuXG5jbGFzcyBFc3ByZXNzb1J1bm5lciB7XG4gIGNvbnN0cnVjdG9yIChvcHRzID0ge30pIHtcbiAgICBmb3IgKGxldCByZXEgb2YgUkVRVUlSRURfUEFSQU1TKSB7XG4gICAgICBpZiAoIW9wdHMgfHwgIXV0aWwuaGFzVmFsdWUob3B0c1tyZXFdKSkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYE9wdGlvbiAnJHtyZXF9JyBpcyByZXF1aXJlZCFgKTtcbiAgICAgIH1cbiAgICAgIHRoaXNbcmVxXSA9IG9wdHNbcmVxXTtcbiAgICB9XG4gICAgdGhpcy5qd3Byb3h5ID0gbmV3IEVzcHJlc3NvUHJveHkoe1xuICAgICAgc2VydmVyOiB0aGlzLmhvc3QsXG4gICAgICBwb3J0OiB0aGlzLnN5c3RlbVBvcnQsXG4gICAgICBiYXNlOiAnJyxcbiAgICAgIGtlZXBBbGl2ZTogdHJ1ZSxcbiAgICB9KTtcbiAgICB0aGlzLnByb3h5UmVxUmVzID0gdGhpcy5qd3Byb3h5LnByb3h5UmVxUmVzLmJpbmQodGhpcy5qd3Byb3h5KTtcbiAgICB0aGlzLmp3cHJveHkuaW5zdHJ1bWVudGF0aW9uU3RhdGUgPSB7XG4gICAgICBleGl0ZWQ6IGZhbHNlLFxuICAgICAgY3Jhc2hlZDogZmFsc2UsXG4gICAgfTtcblxuICAgIGNvbnN0IG1vZFNlcnZlck5hbWUgPSBmcy5zYW5pdGl6ZU5hbWUoYCR7VEVTVF9BUEtfUEtHfV8ke3ZlcnNpb259XyR7dGhpcy5hcHBQYWNrYWdlfV8ke3RoaXMuYWRiLmN1ckRldmljZUlkfS5hcGtgLCB7XG4gICAgICByZXBsYWNlbWVudDogJy0nLFxuICAgIH0pO1xuICAgIHRoaXMubW9kU2VydmVyUGF0aCA9IHBhdGgucmVzb2x2ZSh0aGlzLnRtcERpciwgbW9kU2VydmVyTmFtZSk7XG4gICAgdGhpcy5zaG93R3JhZGxlTG9nID0gb3B0cy5zaG93R3JhZGxlTG9nO1xuICAgIHRoaXMuZXNwcmVzc29CdWlsZENvbmZpZyA9IG9wdHMuZXNwcmVzc29CdWlsZENvbmZpZztcblxuICAgIHRoaXMuc2VydmVyTGF1bmNoVGltZW91dCA9IG9wdHMuc2VydmVyTGF1bmNoVGltZW91dCB8fCBFU1BSRVNTT19TRVJWRVJfTEFVTkNIX1RJTUVPVVRfTVM7XG4gICAgdGhpcy5hbmRyb2lkSW5zdGFsbFRpbWVvdXQgPSBvcHRzLmFuZHJvaWRJbnN0YWxsVGltZW91dDtcblxuICAgIHRoaXMuZGlzYWJsZVN1cHByZXNzQWNjZXNzaWJpbGl0eVNlcnZpY2UgPSBvcHRzLmRpc2FibGVTdXBwcmVzc0FjY2Vzc2liaWxpdHlTZXJ2aWNlO1xuXG4gICAgLy8gRXNwcmVzc28gU2VydmVyIGFwcCBuZWVkcyB0byBiZSBzaWduZWQgd2l0aCBzYW1lIGtleVN0b3JlIGFzIGFwcFBhY2thZ2VcbiAgICBpZiAob3B0cy51c2VLZXlzdG9yZSAmJiBvcHRzLmtleXN0b3JlUGF0aCAmJiBvcHRzLmtleXN0b3JlUGFzc3dvcmQgJiYgb3B0cy5rZXlBbGlhcyAmJiBvcHRzLmtleVBhc3N3b3JkKSB7XG4gICAgICB0aGlzLnNpZ25pbmdDb25maWcgPSBidWlsZFNlcnZlclNpZ25pbmdDb25maWcoe1xuICAgICAgICBrZXlzdG9yZUZpbGU6IG9wdHMua2V5c3RvcmVQYXRoLFxuICAgICAgICBrZXlzdG9yZVBhc3N3b3JkOiBvcHRzLmtleXN0b3JlUGFzc3dvcmQsXG4gICAgICAgIGtleUFsaWFzOiBvcHRzLmtleUFsaWFzLFxuICAgICAgICBrZXlQYXNzd29yZDogb3B0cy5rZXlQYXNzd29yZFxuICAgICAgfSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMuc2lnbmluZ0NvbmZpZyA9IG51bGw7XG4gICAgfVxuICB9XG5cbiAgYXN5bmMgaXNBcHBQYWNrYWdlQ2hhbmdlZCAoKSB7XG4gICAgaWYgKCFhd2FpdCB0aGlzLmFkYi5maWxlRXhpc3RzKFRBUkdFVF9QQUNLQUdFX0NPTlRBSU5FUikpIHtcbiAgICAgIGxvZ2dlci5kZWJ1ZygnVGhlIHByZXZpb3VzIHRhcmdldCBhcHBsaWNhdGlvbiBwYWNrYWdlIGlzIHVua25vd24nKTtcbiAgICAgIHJldHVybiB0cnVlO1xuICAgIH1cbiAgICBjb25zdCBwcmV2aW91c0FwcFBhY2thZ2UgPSAoYXdhaXQgdGhpcy5hZGIuc2hlbGwoWydjYXQnLCBUQVJHRVRfUEFDS0FHRV9DT05UQUlORVJdKSkudHJpbSgpO1xuICAgIGxvZ2dlci5kZWJ1ZyhgVGhlIHByZXZpb3VzIHRhcmdldCBhcHBsaWNhdGlvbiBwYWNrYWdlIHdhcyAnJHtwcmV2aW91c0FwcFBhY2thZ2V9Jy4gYCArXG4gICAgICBgVGhlIGN1cnJlbnQgcGFja2FnZSBpcyAnJHt0aGlzLmFwcFBhY2thZ2V9J2ApO1xuICAgIHJldHVybiBwcmV2aW91c0FwcFBhY2thZ2UgIT09IHRoaXMuYXBwUGFja2FnZTtcbiAgfVxuXG4gIC8qKlxuICAgKiBJbnN0YWxscyBFc3ByZXNzbyBzZXJ2ZXIgYXBrIG9uIHRvIHRoZSBkZXZpY2Ugb3IgZW11bGF0b3IuXG4gICAqIEVhY2ggYWRiIGNvbW1hbmQgdXNlcyBkZWZhdWx0IHRpbWVvdXQgYnkgdGhlbS5cbiAgICovXG4gIGFzeW5jIGluc3RhbGxTZXJ2ZXIgKCkge1xuICAgIGNvbnN0IGFwcFN0YXRlID0gYXdhaXQgdGhpcy5hZGIuZ2V0QXBwbGljYXRpb25JbnN0YWxsU3RhdGUodGhpcy5tb2RTZXJ2ZXJQYXRoLCBURVNUX0FQS19QS0cpO1xuXG4gICAgY29uc3Qgc2hvdWxkVW5pbnN0YWxsQXBwID0gW1xuICAgICAgdGhpcy5hZGIuQVBQX0lOU1RBTExfU1RBVEUuT0xERVJfVkVSU0lPTl9JTlNUQUxMRUQsXG4gICAgICB0aGlzLmFkYi5BUFBfSU5TVEFMTF9TVEFURS5ORVdFUl9WRVJTSU9OX0lOU1RBTExFRFxuICAgIF0uaW5jbHVkZXMoYXBwU3RhdGUpO1xuICAgIGNvbnN0IHNob3VsZEluc3RhbGxBcHAgPSBzaG91bGRVbmluc3RhbGxBcHAgfHwgW1xuICAgICAgdGhpcy5hZGIuQVBQX0lOU1RBTExfU1RBVEUuTk9UX0lOU1RBTExFRFxuICAgIF0uaW5jbHVkZXMoYXBwU3RhdGUpO1xuXG4gICAgaWYgKHNob3VsZFVuaW5zdGFsbEFwcCkge1xuICAgICAgbG9nZ2VyLmluZm8oYFVuaW5zdGFsbGluZyBFc3ByZXNzbyBUZXN0IFNlcnZlciBhcGsgZnJvbSB0aGUgdGFyZ2V0IGRldmljZSAocGtnOiAnJHtURVNUX0FQS19QS0d9JylgKTtcbiAgICAgIHRyeSB7XG4gICAgICAgIGF3YWl0IHRoaXMuYWRiLnVuaW5zdGFsbEFwayhURVNUX0FQS19QS0cpO1xuICAgICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICAgIGxvZ2dlci53YXJuKGBFcnJvciB1bmluc3RhbGxpbmcgJyR7VEVTVF9BUEtfUEtHfSc6ICR7ZXJyLm1lc3NhZ2V9YCk7XG4gICAgICB9XG4gICAgfVxuXG4gICAgaWYgKHNob3VsZEluc3RhbGxBcHApIHtcbiAgICAgIGxvZ2dlci5pbmZvKGBJbnN0YWxsaW5nIEVzcHJlc3NvIFRlc3QgU2VydmVyIGFwayBmcm9tIHRoZSB0YXJnZXQgZGV2aWNlIChwYXRoOiAnJHt0aGlzLm1vZFNlcnZlclBhdGh9JylgKTtcbiAgICAgIHRyeSB7XG4gICAgICAgIGF3YWl0IHRoaXMuYWRiLmluc3RhbGwodGhpcy5tb2RTZXJ2ZXJQYXRoLCB7IHJlcGxhY2U6IGZhbHNlLCB0aW1lb3V0OiB0aGlzLmFuZHJvaWRJbnN0YWxsVGltZW91dCB9KTtcbiAgICAgICAgbG9nZ2VyLmluZm8oYEluc3RhbGxlZCBFc3ByZXNzbyBUZXN0IFNlcnZlciBhcGsgJyR7dGhpcy5tb2RTZXJ2ZXJQYXRofScgKHBrZzogJyR7VEVTVF9BUEtfUEtHfScpYCk7XG4gICAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgICAgbG9nZ2VyLmVycm9yQW5kVGhyb3coYENhbm5vdCBpbnN0YWxsICcke3RoaXMubW9kU2VydmVyUGF0aH0nIGJlY2F1c2Ugb2YgJyR7ZXJyLm1lc3NhZ2V9J2ApO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIGFzeW5jIGluc3RhbGxUZXN0QXBrICgpIHtcbiAgICBsZXQgcmVidWlsZCA9IHRoaXMuZm9yY2VFc3ByZXNzb1JlYnVpbGQ7XG4gICAgaWYgKHJlYnVpbGQpIHtcbiAgICAgIGxvZ2dlci5kZWJ1ZyhgJ2ZvcmNlRXNwcmVzc29SZWJ1aWxkJyBjYXBhYmlsaXR5IGlzIGVuYWJsZWRgKTtcbiAgICB9IGVsc2UgaWYgKGF3YWl0IHRoaXMuaXNBcHBQYWNrYWdlQ2hhbmdlZCgpKSB7XG4gICAgICBsb2dnZXIuaW5mbyhgRm9yY2luZyBFc3ByZXNzbyBzZXJ2ZXIgcmVidWlsZCBiZWNhdXNlIG9mIGNoYW5nZWQgYXBwbGljYXRpb24gcGFja2FnZWApO1xuICAgICAgcmVidWlsZCA9IHRydWU7XG4gICAgfVxuXG4gICAgaWYgKHJlYnVpbGQgJiYgYXdhaXQgZnMuZXhpc3RzKHRoaXMubW9kU2VydmVyUGF0aCkpIHtcbiAgICAgIGxvZ2dlci5kZWJ1ZyhgRGVsZXRpbmcgdGhlIG9ic29sZXRlIEVzcHJlc3NvIHNlcnZlciBwYWNrYWdlICcke3RoaXMubW9kU2VydmVyUGF0aH0nYCk7XG4gICAgICBhd2FpdCBmcy51bmxpbmsodGhpcy5tb2RTZXJ2ZXJQYXRoKTtcbiAgICB9XG4gICAgaWYgKCEoYXdhaXQgZnMuZXhpc3RzKHRoaXMubW9kU2VydmVyUGF0aCkpKSB7XG4gICAgICBhd2FpdCB0aGlzLmJ1aWxkTmV3TW9kU2VydmVyKCk7XG4gICAgfVxuICAgIGNvbnN0IGlzU2lnbmVkID0gYXdhaXQgdGhpcy5hZGIuY2hlY2tBcGtDZXJ0KHRoaXMubW9kU2VydmVyUGF0aCwgVEVTVF9BUEtfUEtHKTtcbiAgICBpZiAoIWlzU2lnbmVkKSB7XG4gICAgICBhd2FpdCB0aGlzLmFkYi5zaWduKHRoaXMubW9kU2VydmVyUGF0aCk7XG4gICAgfVxuICAgIGlmICgocmVidWlsZCB8fCAhaXNTaWduZWQpICYmIGF3YWl0IHRoaXMuYWRiLnVuaW5zdGFsbEFwayhURVNUX0FQS19QS0cpKSB7XG4gICAgICBsb2dnZXIuaW5mbygnVW5pbnN0YWxsZWQgdGhlIG9ic29sZXRlIEVzcHJlc3NvIHNlcnZlciBwYWNrYWdlIGZyb20gdGhlIGRldmljZSB1bmRlciB0ZXN0Jyk7XG4gICAgfVxuXG4gICAgYXdhaXQgdGhpcy5pbnN0YWxsU2VydmVyKCk7XG4gIH1cblxuICBhc3luYyBidWlsZE5ld01vZFNlcnZlciAoKSB7XG4gICAgbGV0IGJ1aWxkQ29uZmlndXJhdGlvbiA9IHt9O1xuICAgIGlmICh0aGlzLmVzcHJlc3NvQnVpbGRDb25maWcpIHtcbiAgICAgIGxldCBidWlsZENvbmZpZ3VyYXRpb25TdHI7XG4gICAgICBpZiAoYXdhaXQgZnMuZXhpc3RzKHRoaXMuZXNwcmVzc29CdWlsZENvbmZpZykpIHtcbiAgICAgICAgbG9nZ2VyLmluZm8oYExvYWRpbmcgdGhlIGJ1aWxkIGNvbmZpZ3VyYXRpb24gZnJvbSAnJHt0aGlzLmVzcHJlc3NvQnVpbGRDb25maWd9J2ApO1xuICAgICAgICBidWlsZENvbmZpZ3VyYXRpb25TdHIgPSBhd2FpdCBmcy5yZWFkRmlsZSh0aGlzLmVzcHJlc3NvQnVpbGRDb25maWcsICd1dGY4Jyk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBsb2dnZXIuaW5mbyhgTG9hZGluZyB0aGUgYnVpbGQgY29uZmlndXJhdGlvbiBmcm9tICdlc3ByZXNzb0J1aWxkQ29uZmlnJyBjYXBhYmlsaXR5YCk7XG4gICAgICAgIGJ1aWxkQ29uZmlndXJhdGlvblN0ciA9IHRoaXMuZXNwcmVzc29CdWlsZENvbmZpZztcbiAgICAgIH1cbiAgICAgIHRyeSB7XG4gICAgICAgIGJ1aWxkQ29uZmlndXJhdGlvbiA9IEpTT04ucGFyc2UoYnVpbGRDb25maWd1cmF0aW9uU3RyKTtcbiAgICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgbG9nZ2VyLmVycm9yKCdDYW5ub3QgcGFyc2UgdGhlIGJ1aWxkIGNvbmZpZ3VyYXRpb24gSlNPTicsIGUpO1xuICAgICAgICB0aHJvdyBlO1xuICAgICAgfVxuICAgIH1cbiAgICBjb25zdCBkaXJOYW1lID0gZnMuc2FuaXRpemVOYW1lKGBlc3ByZXNzby1zZXJ2ZXItJHt0aGlzLmFkYi5jdXJEZXZpY2VJZH1gLCB7XG4gICAgICByZXBsYWNlbWVudDogJy0nLFxuICAgIH0pO1xuICAgIGNvbnN0IHNlcnZlclBhdGggPSBwYXRoLnJlc29sdmUodGhpcy50bXBEaXIsIGRpck5hbWUpO1xuICAgIGxvZ2dlci5pbmZvKGBCdWlsZGluZyBlc3ByZXNzbyBzZXJ2ZXIgaW4gJyR7c2VydmVyUGF0aH0nYCk7XG4gICAgbG9nZ2VyLmRlYnVnKGBUaGUgYnVpbGQgZm9sZGVyIHJvb3QgY291bGQgYmUgY3VzdG9taXplZCBieSBjaGFuZ2luZyB0aGUgJ3RtcERpcicgY2FwYWJpbGl0eWApO1xuICAgIGF3YWl0IGZzLnJpbXJhZihzZXJ2ZXJQYXRoKTtcbiAgICBhd2FpdCBta2RpcnAoc2VydmVyUGF0aCk7XG4gICAgbG9nZ2VyLmRlYnVnKGBDb3B5aW5nIGVzcHJlc3NvIHNlcnZlciB0ZW1wbGF0ZSBmcm9tICgnJHtURVNUX1NFUlZFUl9ST09UfScgdG8gJyR7c2VydmVyUGF0aH0nKWApO1xuICAgIGF3YWl0IGNvcHlHcmFkbGVQcm9qZWN0UmVjdXJzaXZlbHkoVEVTVF9TRVJWRVJfUk9PVCwgc2VydmVyUGF0aCk7XG4gICAgbG9nZ2VyLmRlYnVnKCdCdWxkaW5nIGVzcHJlc3NvIHNlcnZlcicpO1xuICAgIGF3YWl0IG5ldyBTZXJ2ZXJCdWlsZGVyKHtcbiAgICAgIHNlcnZlclBhdGgsIGJ1aWxkQ29uZmlndXJhdGlvbixcbiAgICAgIHNob3dHcmFkbGVMb2c6IHRoaXMuc2hvd0dyYWRsZUxvZyxcbiAgICAgIHRlc3RBcHBQYWNrYWdlOiB0aGlzLmFwcFBhY2thZ2UsXG4gICAgICBzaWduaW5nQ29uZmlnOiB0aGlzLnNpZ25pbmdDb25maWdcbiAgICB9KS5idWlsZCgpO1xuICAgIGNvbnN0IGFwa1BhdGggPSBwYXRoLnJlc29sdmUoc2VydmVyUGF0aCwgJ2FwcCcsICdidWlsZCcsICdvdXRwdXRzJywgJ2FwaycsICdhbmRyb2lkVGVzdCcsICdkZWJ1ZycsICdhcHAtZGVidWctYW5kcm9pZFRlc3QuYXBrJyk7XG4gICAgbG9nZ2VyLmRlYnVnKGBDb3B5aW5nIGJ1aWx0IGFwayBmcm9tICcke2Fwa1BhdGh9JyB0byAnJHt0aGlzLm1vZFNlcnZlclBhdGh9J2ApO1xuICAgIGF3YWl0IGZzLmNvcHlGaWxlKGFwa1BhdGgsIHRoaXMubW9kU2VydmVyUGF0aCk7XG4gIH1cblxuICBhc3luYyBjbGVhbnVwU2Vzc2lvbkxlZnRvdmVycyAoKSB7XG4gICAgbG9nZ2VyLmRlYnVnKCdQZXJmb3JtaW5nIGNsZWFudXAgb2YgYXV0b21hdGlvbiBsZWZ0b3ZlcnMnKTtcblxuICAgIHRyeSB7XG4gICAgICBjb25zdCB7dmFsdWV9ID0gKGF3YWl0IGF4aW9zKHtcbiAgICAgICAgdXJsOiBgaHR0cDovLyR7dGhpcy5ob3N0fToke3RoaXMuc3lzdGVtUG9ydH0vc2Vzc2lvbnNgLFxuICAgICAgICB0aW1lb3V0OiA1MDAsXG4gICAgICB9KSkuZGF0YTtcbiAgICAgIGNvbnN0IGFjdGl2ZVNlc3Npb25JZHMgPSB2YWx1ZS5tYXAoKHNlc3MpID0+IHNlc3MuaWQpO1xuICAgICAgaWYgKGFjdGl2ZVNlc3Npb25JZHMubGVuZ3RoKSB7XG4gICAgICAgIGxvZ2dlci5kZWJ1ZyhgVGhlIGZvbGxvd2luZyBvYnNvbGV0ZSBzZXNzaW9ucyBhcmUgc3RpbGwgcnVubmluZzogJHtKU09OLnN0cmluZ2lmeShhY3RpdmVTZXNzaW9uSWRzKX1gKTtcbiAgICAgICAgbG9nZ2VyLmRlYnVnKCdDbGVhbmluZyB1cCB0aGUgb2Jzb2xldGUgc2Vzc2lvbnMnKTtcbiAgICAgICAgYXdhaXQgQi5hbGwoYWN0aXZlU2Vzc2lvbklkcy5tYXAoKGlkKSA9PlxuICAgICAgICAgIGF4aW9zKHtcbiAgICAgICAgICAgIHVybDogYGh0dHA6Ly8ke3RoaXMuaG9zdH06JHt0aGlzLnN5c3RlbVBvcnR9L3Nlc3Npb24vJHtpZH1gLFxuICAgICAgICAgICAgbWV0aG9kOiAnREVMRVRFJyxcbiAgICAgICAgICB9KVxuICAgICAgICApKTtcbiAgICAgICAgLy8gTGV0IGFsbCBzZXNzaW9ucyB0byBiZSBwcm9wZXJseSB0ZXJtaW5hdGVkIGJlZm9yZSBjb250aW51aW5nXG4gICAgICAgIGF3YWl0IEIuZGVsYXkoMTAwMCk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBsb2dnZXIuZGVidWcoJ05vIG9ic29sZXRlIHNlc3Npb25zIGhhdmUgYmVlbiBkZXRlY3RlZCcpO1xuICAgICAgfVxuICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgIGxvZ2dlci5kZWJ1ZyhgTm8gb2Jzb2xldGUgc2Vzc2lvbnMgaGF2ZSBiZWVuIGRldGVjdGVkICgke2UubWVzc2FnZX0pYCk7XG4gICAgfVxuICB9XG5cbiAgYXN5bmMgc3RhcnRTZXNzaW9uIChjYXBzKSB7XG4gICAgYXdhaXQgdGhpcy5jbGVhbnVwU2Vzc2lvbkxlZnRvdmVycygpO1xuXG4gICAgY29uc3QgY21kID0gW1xuICAgICAgJ3NoZWxsJyxcbiAgICAgICdhbScsICdpbnN0cnVtZW50JyxcbiAgICAgICctdycsXG4gICAgICAnLWUnLCAnZGVidWcnLCBwcm9jZXNzLmVudi5FU1BSRVNTT19KQVZBX0RFQlVHID09PSAndHJ1ZScsXG4gICAgXTtcblxuICAgIGlmIChfLmlzQm9vbGVhbih0aGlzLmRpc2FibGVTdXBwcmVzc0FjY2Vzc2liaWxpdHlTZXJ2aWNlKSkge1xuICAgICAgY21kLnB1c2goJy1lJywgJ0RJU0FCTEVfU1VQUFJFU1NfQUNDRVNTSUJJTElUWV9TRVJWSUNFUycsIHRoaXMuZGlzYWJsZVN1cHByZXNzQWNjZXNzaWJpbGl0eVNlcnZpY2UpO1xuICAgIH1cblxuICAgIGNtZC5wdXNoKGAke1RFU1RfQVBLX1BLR30vYW5kcm9pZHgudGVzdC5ydW5uZXIuQW5kcm9pZEpVbml0UnVubmVyYCk7XG5cbiAgICBsb2dnZXIuaW5mbyhgU3RhcnRpbmcgRXNwcmVzc28gU2VydmVyIHYke3ZlcnNpb259IHdpdGggY21kOiBhZGIgJHtjbWQuam9pbignICcpfWApO1xuXG4gICAgbGV0IGhhc1NvY2tldEVycm9yID0gZmFsc2U7XG4gICAgLy8gc3RhcnQgdGhlIGluc3RydW1lbnRhdGlvbiBwcm9jZXNzXG4gICAgdGhpcy5pbnN0UHJvY2VzcyA9IHRoaXMuYWRiLmNyZWF0ZVN1YlByb2Nlc3MoY21kKTtcbiAgICB0aGlzLmluc3RQcm9jZXNzLm9uKCdleGl0JywgKGNvZGUsIHNpZ25hbCkgPT4ge1xuICAgICAgbG9nZ2VyLmluZm8oYEluc3RydW1lbnRhdGlvbiBwcm9jZXNzIGV4aXRlZCB3aXRoIGNvZGUgJHtjb2RlfSBmcm9tIHNpZ25hbCAke3NpZ25hbH1gKTtcbiAgICAgIHRoaXMuandwcm94eS5pbnN0cnVtZW50YXRpb25TdGF0ZS5leGl0ZWQgPSB0cnVlO1xuICAgIH0pO1xuICAgIHRoaXMuaW5zdFByb2Nlc3Mub24oJ291dHB1dCcsIChzdGRvdXQsIHN0ZGVycikgPT4ge1xuICAgICAgY29uc3QgbGluZSA9IHN0ZG91dCB8fCBzdGRlcnI7XG4gICAgICBpZiAoXy5pc0VtcHR5KGxpbmUudHJpbSgpKSkge1xuICAgICAgICAvLyBEbyBub3QgcHJpbnQgZW1wdHkgbGluZXMgaW50byB0aGUgc3lzdGVtIGxvZ1xuICAgICAgICByZXR1cm47XG4gICAgICB9XG5cbiAgICAgIGxvZ2dlci5kZWJ1ZyhgW0luc3RydW1lbnRhdGlvbl0gJHtsaW5lLnRyaW0oKX1gKTtcbiAgICAgIC8vIEEgJ1NvY2tldEV4Y2VwdGlvbicgaW5kaWNhdGVzIHRoYXQgd2UgY291bGRuJ3QgY29ubmVjdCB0byB0aGUgRXNwcmVzc28gc2VydmVyLFxuICAgICAgLy8gYmVjYXVzZSB0aGUgSU5URVJORVQgcGVybWlzc2lvbiBpcyBub3Qgc2V0XG4gICAgICBpZiAobGluZS50b0xvd2VyQ2FzZSgpLmluY2x1ZGVzKCdqYXZhLm5ldC5zb2NrZXRleGNlcHRpb24nKSkge1xuICAgICAgICBoYXNTb2NrZXRFcnJvciA9IHRydWU7XG4gICAgICB9IGVsc2UgaWYgKGxpbmUuaW5jbHVkZXMoJ1Byb2Nlc3MgY3Jhc2hlZCcpKSB7XG4gICAgICAgIHRoaXMuandwcm94eS5pbnN0cnVtZW50YXRpb25TdGF0ZS5jcmFzaGVkID0gdHJ1ZTtcbiAgICAgIH1cbiAgICB9KTtcblxuICAgIGNvbnN0IHRpbWVyID0gbmV3IHRpbWluZy5UaW1lcigpLnN0YXJ0KCk7XG4gICAgYXdhaXQgdGhpcy5pbnN0UHJvY2Vzcy5zdGFydCgwKTtcbiAgICBsb2dnZXIuaW5mbyhgV2FpdGluZyB1cCB0byAke3RoaXMuc2VydmVyTGF1bmNoVGltZW91dH1tcyBmb3IgRXNwcmVzc28gc2VydmVyIHRvIGJlIG9ubGluZWApO1xuICAgIHRyeSB7XG4gICAgICBhd2FpdCB3YWl0Rm9yQ29uZGl0aW9uKGFzeW5jICgpID0+IHtcbiAgICAgICAgaWYgKGhhc1NvY2tldEVycm9yKSB7XG4gICAgICAgICAgbG9nZ2VyLmVycm9yQW5kVGhyb3coYEVzcHJlc3NvIHNlcnZlciBoYXMgZmFpbGVkIHRvIHN0YXJ0IGR1ZSB0byBhbiB1bmV4cGVjdGVkIGV4Y2VwdGlvbi4gYCArXG4gICAgICAgICAgICBgTWFrZSBzdXJlIHRoZSAnSU5URVJORVQnIHBlcm1pc3Npb24gaXMgcmVxdWVzdGVkIGluIHRoZSBBbmRyb2lkIG1hbmlmZXN0IG9mIHlvdXIgYCArXG4gICAgICAgICAgICBgYXBwbGljYXRpb24gdW5kZXIgdGVzdCAoPHVzZXMtcGVybWlzc2lvbiBhbmRyb2lkOm5hbWU9XCJhbmRyb2lkLnBlcm1pc3Npb24uSU5URVJORVRcIiAvPilgKTtcbiAgICAgICAgfSBlbHNlIGlmICh0aGlzLmp3cHJveHkuaW5zdHJ1bWVudGF0aW9uU3RhdGUuZXhpdGVkKSB7XG4gICAgICAgICAgbG9nZ2VyLmVycm9yQW5kVGhyb3coYEVzcHJlc3NvIHNlcnZlciBwcm9jZXNzIGhhcyBiZWVuIHVuZXhwZWN0ZWRseSB0ZXJtaW5hdGVkLiBgICtcbiAgICAgICAgICAgIGBDaGVjayB0aGUgQXBwaXVtIHNlcnZlciBsb2cgYW5kIHRoZSBsb2djYXQgb3V0cHV0IGZvciBtb3JlIGRldGFpbHNgKTtcbiAgICAgICAgfVxuICAgICAgICB0cnkge1xuICAgICAgICAgIGF3YWl0IHRoaXMuandwcm94eS5jb21tYW5kKCcvc3RhdHVzJywgJ0dFVCcpO1xuICAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICB9XG4gICAgICB9LCB7XG4gICAgICAgIHdhaXRNczogdGhpcy5zZXJ2ZXJMYXVuY2hUaW1lb3V0LFxuICAgICAgICBpbnRlcnZhbE1zOiA1MDAsXG4gICAgICB9KTtcbiAgICB9IGNhdGNoIChlKSB7XG4gICAgICBpZiAoL0NvbmRpdGlvbiB1bm1ldC8udGVzdChlLm1lc3NhZ2UpKSB7XG4gICAgICAgIGxvZ2dlci5lcnJvckFuZFRocm93KGBUaW1lZCBvdXQgd2FpdGluZyBmb3IgRXNwcmVzc28gc2VydmVyIHRvIGJlIGAgK1xuICAgICAgICAgIGBvbmxpbmUgd2l0aGluICR7dGhpcy5zZXJ2ZXJMYXVuY2hUaW1lb3V0fW1zLiBUaGUgdGltZW91dCB2YWx1ZSBjb3VsZCBiZSBgICtcbiAgICAgICAgICBgY3VzdG9taXplZCB1c2luZyAnZXNwcmVzc29TZXJ2ZXJMYXVuY2hUaW1lb3V0JyBjYXBhYmlsaXR5YCk7XG4gICAgICB9XG4gICAgICB0aHJvdyBlO1xuICAgIH1cbiAgICBsb2dnZXIuaW5mbyhgRXNwcmVzc28gc2VydmVyIGlzIG9ubGluZS4gYCArXG4gICAgICBgVGhlIGluaXRpYWxpemF0aW9uIHByb2Nlc3MgdG9vayAke3RpbWVyLmdldER1cmF0aW9uKCkuYXNNaWxsaVNlY29uZHMudG9GaXhlZCgwKX1tc2ApO1xuICAgIGxvZ2dlci5pbmZvKCdTdGFydGluZyB0aGUgc2Vzc2lvbicpO1xuXG4gICAgYXdhaXQgdGhpcy5qd3Byb3h5LmNvbW1hbmQoJy9zZXNzaW9uJywgJ1BPU1QnLCB7XG4gICAgICBjYXBhYmlsaXRpZXM6IHtcbiAgICAgICAgZmlyc3RNYXRjaDogW2NhcHNdLFxuICAgICAgICBhbHdheXNNYXRjaDoge31cbiAgICAgIH1cbiAgICB9KTtcbiAgICBhd2FpdCB0aGlzLnJlY29yZFRhcmdldEFwcFBhY2thZ2UoKTtcbiAgfVxuXG4gIGFzeW5jIHJlY29yZFRhcmdldEFwcFBhY2thZ2UgKCkge1xuICAgIGF3YWl0IHRoaXMuYWRiLnNoZWxsKFtgZWNobyBcIiR7dGhpcy5hcHBQYWNrYWdlfVwiID4gXCIke1RBUkdFVF9QQUNLQUdFX0NPTlRBSU5FUn1cImBdKTtcbiAgICBsb2dnZXIuaW5mbyhgUmVjb3JkZWQgdGhlIHRhcmdldCBhcHBsaWNhdGlvbiBwYWNrYWdlICcke3RoaXMuYXBwUGFja2FnZX0nIHRvICR7VEFSR0VUX1BBQ0tBR0VfQ09OVEFJTkVSfWApO1xuICB9XG5cbiAgYXN5bmMgZGVsZXRlU2Vzc2lvbiAoKSB7XG4gICAgbG9nZ2VyLmRlYnVnKCdEZWxldGluZyBFc3ByZXNzbyBzZXJ2ZXIgc2Vzc2lvbicpO1xuICAgIC8vIHJlbHkgb24gandwcm94eSdzIGludGVsbGlnZW5jZSB0byBrbm93IHdoYXQgd2UncmUgdGFsa2luZyBhYm91dCBhbmRcbiAgICAvLyBkZWxldGUgdGhlIGN1cnJlbnQgc2Vzc2lvblxuICAgIHRyeSB7XG4gICAgICBhd2FpdCB0aGlzLmp3cHJveHkuY29tbWFuZCgnLycsICdERUxFVEUnKTtcbiAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgIGxvZ2dlci53YXJuKGBEaWQgbm90IGdldCBjb25maXJtYXRpb24gRXNwcmVzc28gZGVsZXRlU2Vzc2lvbiB3b3JrZWQ7IGAgK1xuICAgICAgICAgIGBFcnJvciB3YXM6ICR7ZXJyfWApO1xuICAgIH1cblxuICAgIGlmICh0aGlzLmluc3RQcm9jZXNzICYmIHRoaXMuaW5zdFByb2Nlc3MuaXNSdW5uaW5nKSB7XG4gICAgICBhd2FpdCB0aGlzLmluc3RQcm9jZXNzLnN0b3AoKTtcbiAgICB9XG4gIH1cbn1cblxuZXhwb3J0IHsgRXNwcmVzc29SdW5uZXIsIFJFUVVJUkVEX1BBUkFNUywgVEVTVF9BUEtfUEtHIH07XG5leHBvcnQgZGVmYXVsdCBFc3ByZXNzb1J1bm5lcjtcbiJdLCJmaWxlIjoibGliL2VzcHJlc3NvLXJ1bm5lci5qcyIsInNvdXJjZVJvb3QiOiIuLi8uLiJ9
